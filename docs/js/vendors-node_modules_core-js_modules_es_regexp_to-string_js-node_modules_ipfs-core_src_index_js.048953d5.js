/*! For license information please see vendors-node_modules_core-js_modules_es_regexp_to-string_js-node_modules_ipfs-core_src_index_js.048953d5.js.LICENSE.txt */
(self.webpackChunksourcedao_pc_dapp=self.webpackChunksourcedao_pc_dapp||[]).push([["vendors-node_modules_core-js_modules_es_regexp_to-string_js-node_modules_ipfs-core_src_index_js"],{12200:(e,t,r)=>{"use strict";var n=r(82784);const s="undefined"!=typeof BigUint64Array,i=Symbol(),o=1024;function a(e,t){const r=new Uint32Array(e),n=new Uint16Array(e);var s=r[t+-4>>>2]>>>1,i=t>>>1;if(s<=o)return String.fromCharCode.apply(String,n.subarray(i,i+s));const a=[];do{const e=n[i+o-1],t=e>=55296&&e<56320?1023:o;a.push(String.fromCharCode.apply(String,n.subarray(i,i+=t))),s-=t}while(s>o);return a.join("")+String.fromCharCode.apply(String,n.subarray(i,i+s))}function c(e){const t={};function r(e,t){return e?a(e.buffer,t):"<yet unknown>"}const s=e.env=e.env||{};return s.abort=s.abort||function(e,n,i,o){const a=t.memory||s.memory;throw Error("abort: "+r(a,e)+" at "+r(a,n)+":"+i+":"+o)},s.trace=s.trace||function(e,i){const o=t.memory||s.memory;n.log("trace: "+r(o,e)+(i?" ":"")+Array.prototype.slice.call(arguments,2,2+i).join(", "))},e.Math=e.Math||Math,e.Date=e.Date||Date,t}function l(e,t){const r=t.exports,n=r.memory,i=r.table,o=r.__alloc,c=r.__retain,l=r.__rtti_base||-1;function h(e){const t=new Uint32Array(n.buffer);if((e>>>=0)>=t[l>>>2])throw Error("invalid id: "+e);return t[(l+4>>>2)+2*e]}function d(e){const t=new Uint32Array(n.buffer);if((e>>>=0)>=t[l>>>2])throw Error("invalid id: "+e);return t[(l+4>>>2)+2*e+1]}function u(e){return 31-Math.clz32(e>>>5&31)}function f(e,t,r){const s=n.buffer;if(r)switch(e){case 2:return new Float32Array(s);case 3:return new Float64Array(s)}else switch(e){case 0:return new(t?Int8Array:Uint8Array)(s);case 1:return new(t?Int16Array:Uint16Array)(s);case 2:return new(t?Int32Array:Uint32Array)(s);case 3:return new(t?BigInt64Array:BigUint64Array)(s)}throw Error("unsupported align: "+e)}function g(e){const t=new Uint32Array(n.buffer),r=t[e+-8>>>2],s=h(r);if(!(1&s))throw Error("not an array: "+r);const i=u(s);var o=t[e+4>>>2];const a=2&s?t[e+12>>>2]:t[o+-4>>>2]>>>i;return f(i,1024&s,2048&s).subarray(o>>>=i,o+a)}function y(e,t,r){return new e(m(e,t,r))}function m(e,t,r){const s=n.buffer,i=new Uint32Array(s),o=i[r+4>>>2];return new e(s,o,i[o+-4>>>2]>>>t)}return e.__allocString=function(e){const t=e.length,r=o(t<<1,1),s=new Uint16Array(n.buffer);for(var i=0,a=r>>>1;i<t;++i)s[a+i]=e.charCodeAt(i);return r},e.__getString=function(e){const t=n.buffer;if(1!==new Uint32Array(t)[e+-8>>>2])throw Error("not a string: "+e);return a(t,e)},e.__allocArray=function(e,t){const r=h(e);if(!(3&r))throw Error("not an array: "+e+" @ "+r);const s=u(r),i=t.length,a=o(i<<s,0),l=o(2&r?16:12,e),d=new Uint32Array(n.buffer);d[l+0>>>2]=c(a),d[l+4>>>2]=a,d[l+8>>>2]=i<<s,2&r&&(d[l+12>>>2]=i);const p=f(s,1024&r,2048&r);if(8192&r)for(let e=0;e<i;++e)p[(a>>>s)+e]=c(t[e]);else p.set(t,a>>>s);return l},e.__getArrayView=g,e.__getArray=function(e){const t=g(e),r=t.length,n=new Array(r);for(let e=0;e<r;e++)n[e]=t[e];return n},e.__getArrayBuffer=function(e){const t=n.buffer,r=new Uint32Array(t)[e+-4>>>2];return t.slice(e,e+r)},e.__getInt8Array=y.bind(null,Int8Array,0),e.__getInt8ArrayView=m.bind(null,Int8Array,0),e.__getUint8Array=y.bind(null,Uint8Array,0),e.__getUint8ArrayView=m.bind(null,Uint8Array,0),e.__getUint8ClampedArray=y.bind(null,Uint8ClampedArray,0),e.__getUint8ClampedArrayView=m.bind(null,Uint8ClampedArray,0),e.__getInt16Array=y.bind(null,Int16Array,1),e.__getInt16ArrayView=m.bind(null,Int16Array,1),e.__getUint16Array=y.bind(null,Uint16Array,1),e.__getUint16ArrayView=m.bind(null,Uint16Array,1),e.__getInt32Array=y.bind(null,Int32Array,2),e.__getInt32ArrayView=m.bind(null,Int32Array,2),e.__getUint32Array=y.bind(null,Uint32Array,2),e.__getUint32ArrayView=m.bind(null,Uint32Array,2),s&&(e.__getInt64Array=y.bind(null,BigInt64Array,3),e.__getInt64ArrayView=m.bind(null,BigInt64Array,3),e.__getUint64Array=y.bind(null,BigUint64Array,3),e.__getUint64ArrayView=m.bind(null,BigUint64Array,3)),e.__getFloat32Array=y.bind(null,Float32Array,2),e.__getFloat32ArrayView=m.bind(null,Float32Array,2),e.__getFloat64Array=y.bind(null,Float64Array,3),e.__getFloat64ArrayView=m.bind(null,Float64Array,3),e.__instanceof=function(e,t){const r=new Uint32Array(n.buffer);var s=r[e+-8>>>2];if(s<=r[l>>>2])do{if(s==t)return!0}while(s=d(s));return!1},e.memory=e.memory||n,e.table=e.table||i,p(r,e)}function h(e){return"undefined"!=typeof Response&&e instanceof Response}async function d(e,t){return h(e=await e)?u(e,t):l(c(t||(t={})),await WebAssembly.instantiate(e instanceof WebAssembly.Module?e:await WebAssembly.compile(e),t))}async function u(e,t){return WebAssembly.instantiateStreaming?l(c(t||(t={})),(await WebAssembly.instantiateStreaming(e,t)).instance):d(h(e=await e)?e.arrayBuffer():e,t)}function p(e,t){var r=t?Object.create(t):{},n=e.__argumentsLength?function(t){e.__argumentsLength.value=t}:e.__setArgumentsLength||e.__setargc||function(){};for(let t in e){if(!Object.prototype.hasOwnProperty.call(e,t))continue;const s=e[t];let o=t.split("."),a=r;for(;o.length>1;){let e=o.shift();Object.prototype.hasOwnProperty.call(a,e)||(a[e]={}),a=a[e]}let c=o[0],l=c.indexOf("#");if(l>=0){let r=c.substring(0,l),o=a[r];if(void 0===o||!o.prototype){let e=function(...t){return e.wrap(e.prototype.constructor(0,...t))};e.prototype={valueOf:function(){return this[i]}},e.wrap=function(t){return Object.create(e.prototype,{[i]:{value:t,writable:!1}})},o&&Object.getOwnPropertyNames(o).forEach((t=>Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t)))),a[r]=e}if(c=c.substring(l+1),a=a[r].prototype,/^(get|set):/.test(c)){if(!Object.prototype.hasOwnProperty.call(a,c=c.substring(4))){let r=e[t.replace("set:","get:")],n=e[t.replace("get:","set:")];Object.defineProperty(a,c,{get:function(){return r(this[i])},set:function(e){n(this[i],e)},enumerable:!0})}}else"constructor"===c?(a[c]=(...e)=>(n(e.length),s(...e))).original=s:(a[c]=function(...e){return n(e.length),s(this[i],...e)}).original=s}else/^(get|set):/.test(c)?Object.prototype.hasOwnProperty.call(a,c=c.substring(4))||Object.defineProperty(a,c,{get:e[t.replace("set:","get:")],set:e[t.replace("get:","set:")],enumerable:!0}):"function"==typeof s&&s!==n?(a[c]=(...e)=>(n(e.length),s(...e))).original=s:a[c]=s}return r}t.instantiate=d,t.instantiateSync=function(e,t){return l(c(t||(t={})),new WebAssembly.Instance(e instanceof WebAssembly.Module?e:new WebAssembly.Module(e),t))},t.instantiateStreaming=u,t.demangle=p},43161:(e,t,r)=>{"use strict";e.exports=r(7758)},7758:(e,t,r)=>{"use strict";var n=t;function s(){n.util._configure(),n.Writer._configure(n.BufferWriter),n.Reader._configure(n.BufferReader)}n.build="minimal",n.Writer=r(14640),n.BufferWriter=r(39429),n.Reader=r(69375),n.BufferReader=r(12626),n.util=r(42427),n.rpc=r(68029),n.roots=r(88346),n.configure=s,s()},69375:(e,t,r)=>{"use strict";e.exports=c;var n,s=r(42427),i=s.LongBits,o=s.utf8;function a(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function c(e){this.buf=e,this.pos=0,this.len=e.length}var l,h="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new c(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new c(e);throw Error("illegal buffer")},d=function(){return s.Buffer?function(e){return(c.create=function(e){return s.Buffer.isBuffer(e)?new n(e):h(e)})(e)}:h};function u(){var e=new i(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw a(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw a(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new i(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var e=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var e=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},c.prototype.bytes=function(){var e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw a(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,r):t===r?new this.buf.constructor(0):this._slice.call(this.buf,t,r)},c.prototype.string=function(){var e=this.bytes();return o.read(e,0,e.length)},c.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw a(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},c._configure=function(e){n=e,c.create=d(),n._configure();var t=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return u.call(this)[t](!1)},uint64:function(){return u.call(this)[t](!0)},sint64:function(){return u.call(this).zzDecode()[t](!1)},fixed64:function(){return f.call(this)[t](!0)},sfixed64:function(){return f.call(this)[t](!1)}})}},12626:(e,t,r)=>{"use strict";e.exports=i;var n=r(69375);(i.prototype=Object.create(n.prototype)).constructor=i;var s=r(42427);function i(e){n.call(this,e)}i._configure=function(){s.Buffer&&(i.prototype._slice=s.Buffer.prototype.slice)},i.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},i._configure()},88346:e=>{"use strict";e.exports={}},68029:(e,t,r)=>{"use strict";t.Service=r(6830)},6830:(e,t,r)=>{"use strict";e.exports=s;var n=r(42427);function s(e,t,r){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");n.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(r)}(s.prototype=Object.create(n.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,r,s,i,o){if(!i)throw TypeError("request must be specified");var a=this;if(!o)return n.asPromise(e,a,t,r,s,i);if(a.rpcImpl)try{return a.rpcImpl(t,r[a.requestDelimited?"encodeDelimited":"encode"](i).finish(),(function(e,r){if(e)return a.emit("error",e,t),o(e);if(null!==r){if(!(r instanceof s))try{r=s[a.responseDelimited?"decodeDelimited":"decode"](r)}catch(e){return a.emit("error",e,t),o(e)}return a.emit("data",r,t),o(null,r)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){o(e)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},25212:(e,t,r)=>{"use strict";e.exports=s;var n=r(42427);function s(e,t){this.lo=e>>>0,this.hi=t>>>0}var i=s.zero=new s(0,0);i.toNumber=function(){return 0},i.zzEncode=i.zzDecode=function(){return this},i.length=function(){return 1};var o=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(e){if(0===e)return i;var t=e<0;t&&(e=-e);var r=e>>>0,n=(e-r)/4294967296>>>0;return t&&(n=~n>>>0,r=~r>>>0,++r>4294967295&&(r=0,++n>4294967295&&(n=0))),new s(r,n)},s.from=function(e){if("number"==typeof e)return s.fromNumber(e);if(n.isString(e)){if(!n.Long)return s.fromNumber(parseInt(e,10));e=n.Long.fromString(e)}return e.low||e.high?new s(e.low>>>0,e.high>>>0):i},s.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,r=~this.hi>>>0;return t||(r=r+1>>>0),-(t+4294967296*r)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(e){return n.Long?new n.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var a=String.prototype.charCodeAt;s.fromHash=function(e){return e===o?i:new s((a.call(e,0)|a.call(e,1)<<8|a.call(e,2)<<16|a.call(e,3)<<24)>>>0,(a.call(e,4)|a.call(e,5)<<8|a.call(e,6)<<16|a.call(e,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},s.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},s.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return 0===r?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}},42427:function(e,t,r){"use strict";var n=t;function s(e,t,r){for(var n=Object.keys(t),s=0;s<n.length;++s)void 0!==e[n[s]]&&r||(e[n[s]]=t[n[s]]);return e}function i(e){function t(e,r){if(!(this instanceof t))return new t(e,r);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),r&&s(this,r)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}n.asPromise=r(12835),n.base64=r(82968),n.EventEmitter=r(25560),n.float=r(14278),n.inquire=r(33149),n.utf8=r(48301),n.pool=r(66765),n.LongBits=r(25212),n.isNode=Boolean(void 0!==r.g&&r.g&&r.g.process&&r.g.process.versions&&r.g.process.versions.node),n.global=n.isNode&&r.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},n.isString=function(e){return"string"==typeof e||e instanceof String},n.isObject=function(e){return e&&"object"==typeof e},n.isset=n.isSet=function(e,t){var r=e[t];return!(null==r||!e.hasOwnProperty(t))&&("object"!=typeof r||(Array.isArray(r)?r.length:Object.keys(r).length)>0)},n.Buffer=function(){try{var e=n.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(e){return"number"==typeof e?n.Buffer?n._Buffer_allocUnsafe(e):new n.Array(e):n.Buffer?n._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(e){return e?n.LongBits.from(e).toHash():n.LongBits.zeroHash},n.longFromHash=function(e,t){var r=n.LongBits.fromHash(e);return n.Long?n.Long.fromBits(r.lo,r.hi,t):r.toNumber(Boolean(t))},n.merge=s,n.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},n.newError=i,n.ProtocolError=i("ProtocolError"),n.oneOfGetter=function(e){for(var t={},r=0;r<e.length;++r)t[e[r]]=1;return function(){for(var e=Object.keys(this),r=e.length-1;r>-1;--r)if(1===t[e[r]]&&void 0!==this[e[r]]&&null!==this[e[r]])return e[r]}},n.oneOfSetter=function(e){return function(t){for(var r=0;r<e.length;++r)e[r]!==t&&delete this[e[r]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var e=n.Buffer;e?(n._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,r){return new e(t,r)},n._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):n._Buffer_from=n._Buffer_allocUnsafe=null}},14640:(e,t,r)=>{"use strict";e.exports=d;var n,s=r(42427),i=s.LongBits,o=s.base64,a=s.utf8;function c(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}function l(){}function h(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var u=function(){return s.Buffer?function(){return(d.create=function(){return new n})()}:function(){return new d}};function p(e,t,r){t[r]=255&e}function f(e,t){this.len=e,this.next=void 0,this.val=t}function g(e,t,r){for(;e.hi;)t[r++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[r++]=127&e.lo|128,e.lo=e.lo>>>7;t[r++]=e.lo}function y(e,t,r){t[r]=255&e,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}d.create=u(),d.alloc=function(e){return new s.Array(e)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(e,t,r){return this.tail=this.tail.next=new c(e,t,r),this.len+=t,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(e,t,r){for(;e>127;)t[r++]=127&e|128,e>>>=7;t[r]=e},d.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new f((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},d.prototype.int32=function(e){return e<0?this._push(g,10,i.fromNumber(e)):this.uint32(e)},d.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},d.prototype.uint64=function(e){var t=i.from(e);return this._push(g,t.length(),t)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(e){var t=i.from(e).zzEncode();return this._push(g,t.length(),t)},d.prototype.bool=function(e){return this._push(p,1,e?1:0)},d.prototype.fixed32=function(e){return this._push(y,4,e>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(e){var t=i.from(e);return this._push(y,4,t.lo)._push(y,4,t.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(e){return this._push(s.float.writeFloatLE,4,e)},d.prototype.double=function(e){return this._push(s.float.writeDoubleLE,8,e)};var m=s.Array.prototype.set?function(e,t,r){t.set(e,r)}:function(e,t,r){for(var n=0;n<e.length;++n)t[r+n]=e[n]};d.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(p,1,0);if(s.isString(e)){var r=d.alloc(t=o.length(e));o.decode(e,r,0),e=r}return this.uint32(t)._push(m,t,e)},d.prototype.string=function(e){var t=a.length(e);return t?this.uint32(t)._push(a.write,t,e):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new h(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r&&(this.tail.next=e.next,this.tail=t,this.len+=r),this},d.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),r=0;e;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t},d._configure=function(e){n=e,d.create=u(),n._configure()}},39429:(e,t,r)=>{"use strict";e.exports=i;var n=r(14640);(i.prototype=Object.create(n.prototype)).constructor=i;var s=r(42427);function i(){n.call(this)}function o(e,t,r){e.length<40?s.utf8.write(e,t,r):t.utf8Write?t.utf8Write(e,r):t.write(e,r)}i._configure=function(){i.alloc=s._Buffer_allocUnsafe,i.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(e,t,r){t.set(e,r)}:function(e,t,r){if(e.copy)e.copy(t,r,0,e.length);else for(var n=0;n<e.length;)t[r++]=e[n++]}},i.prototype.bytes=function(e){s.isString(e)&&(e=s._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(i.writeBytesBuffer,t,e),this},i.prototype.string=function(e){var t=s.Buffer.byteLength(e);return this.uint32(t),t&&this._push(o,t,e),this},i._configure()},3024:(e,t)=>{"use strict";const r=Math.exp;e.exports=function(e){if("number"!=typeof e)throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,n,s=0,i=0,o=0,a={push:function(a,c){if(n){const l=1-r(-(a-n)/e),h=c-t;t=l*c+(1-l)*t,s=(1-l)*(s+h*(l*h)),i=Math.sqrt(s),o=t+l*h}else t=c;n=a},movingAverage:function(){return t},variance:function(){return s},deviation:function(){return i},forecast:function(){return o}};return a}},12618:(e,t,r)=>{"use strict";const{fromCallback:n}=r(39874),s=r(39296),{getCallback:i,getOptions:o}=r(53862),a=Symbol("promise"),c=Symbol("status"),l=Symbol("operations"),h=Symbol("finishClose"),d=Symbol("closeCallbacks");t.AbstractChainedBatch=class{constructor(e){if("object"!=typeof e||null===e)throw new TypeError("The first argument must be an abstract-level database, received "+(null===e?"null":typeof e));this[l]=[],this[d]=[],this[c]="open",this[h]=this[h].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[l].length}put(e,t,r){if("open"!==this[c])throw new s("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e)||this.db._checkValue(t);if(n)throw n;const i=r&&null!=r.sublevel?r.sublevel:this.db,o=r,a=i.keyEncoding(r&&r.keyEncoding),h=i.valueEncoding(r&&r.valueEncoding),d=a.format;r={...r,keyEncoding:d,valueEncoding:h.format},i!==this.db&&(r.sublevel=null);const u=i.prefixKey(a.encode(e),d),p=h.encode(t);return this._put(u,p,r),this[l].push({...o,type:"put",key:e,value:t}),this}_put(e,t,r){}del(e,t){if("open"!==this[c])throw new s("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const r=this.db._checkKey(e);if(r)throw r;const n=t&&null!=t.sublevel?t.sublevel:this.db,i=t,o=n.keyEncoding(t&&t.keyEncoding),a=o.format;return t={...t,keyEncoding:a},n!==this.db&&(t.sublevel=null),this._del(n.prefixKey(o.encode(e),a),t),this[l].push({...i,type:"del",key:e}),this}_del(e,t){}clear(){if("open"!==this[c])throw new s("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[l]=[],this}_clear(){}write(e,t){return t=i(e,t),t=n(t,a),e=o(e),"open"!==this[c]?this.nextTick(t,new s("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):0===this.length?this.close(t):(this[c]="writing",this._write(e,(e=>{this[c]="closing",this[d].push((()=>t(e))),e||this.db.emit("batch",this[l]),this._close(this[h])}))),t[a]}_write(e,t){}close(e){return e=n(e,a),"closing"===this[c]?this[d].push(e):"closed"===this[c]?this.nextTick(e):(this[d].push(e),"writing"!==this[c]&&(this[c]="closing",this._close(this[h]))),e[a]}_close(e){this.nextTick(e)}[h](){this[c]="closed",this.db.detachResource(this);const e=this[d];this[d]=[];for(const t of e)t()}}},40060:(e,t,r)=>{"use strict";var n=r(82784);const{fromCallback:s}=r(39874),i=r(39296),{getOptions:o,getCallback:a}=r(53862),c=Symbol("promise"),l=Symbol("callback"),h=Symbol("working"),d=Symbol("handleOne"),u=Symbol("handleMany"),p=Symbol("autoClose"),f=Symbol("finishWork"),g=Symbol("returnMany"),y=Symbol("closing"),m=Symbol("handleClose"),w=Symbol("closed"),b=Symbol("closeCallbacks"),_=Symbol("keyEncoding"),E=Symbol("valueEncoding"),v=Symbol("abortOnClose"),k=Symbol("legacy"),S=Symbol("keys"),R=Symbol("values"),I=Symbol("limit"),T=Symbol("count"),A=Object.freeze({}),P=()=>{};let D=!1;class O{constructor(e,t,r){if("object"!=typeof e||null===e)throw new TypeError("The first argument must be an abstract-level database, received "+(null===e?"null":typeof e));if("object"!=typeof t||null===t)throw new TypeError("The second argument must be an options object");this[w]=!1,this[b]=[],this[h]=!1,this[y]=!1,this[p]=!1,this[l]=null,this[d]=this[d].bind(this),this[u]=this[u].bind(this),this[m]=this[m].bind(this),this[_]=t[_],this[E]=t[E],this[k]=r,this[I]=Number.isInteger(t.limit)&&t.limit>=0?t.limit:1/0,this[T]=0,this[v]=!!t.abortOnClose,this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get count(){return this[T]}get limit(){return this[I]}next(e){let t;if(void 0===e)t=new Promise(((t,r)=>{e=(e,n,s)=>{e?r(e):this[k]?void 0===n&&void 0===s?t():t([n,s]):t(n)}}));else if("function"!=typeof e)throw new TypeError("Callback must be a function");return this[y]?this.nextTick(e,new i("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[h]?this.nextTick(e,new i("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[h]=!0,this[l]=e,this[T]>=this[I]?this.nextTick(this[d],null):this._next(this[d])),t}_next(e){this.nextTick(e)}nextv(e,t,r){return r=a(t,r),r=s(r,c),t=o(t,A),Number.isInteger(e)?(this[y]?this.nextTick(r,new i("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[h]?this.nextTick(r,new i("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(e<1&&(e=1),this[I]<1/0&&(e=Math.min(e,this[I]-this[T])),this[h]=!0,this[l]=r,e<=0?this.nextTick(this[u],null,[]):this._nextv(e,t,this[u])),r[c]):(this.nextTick(r,new TypeError("The first argument 'size' must be an integer")),r[c])}_nextv(e,t,r){const n=[],s=(t,i,o)=>t?r(t):(this[k]?void 0===i&&void 0===o:void 0===i)?r(null,n):(n.push(this[k]?[i,o]:i),void(n.length===e?r(null,n):this._next(s)));this._next(s)}all(e,t){return t=a(e,t),t=s(t,c),e=o(e,A),this[y]?this.nextTick(t,new i("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[h]?this.nextTick(t,new i("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[h]=!0,this[l]=t,this[p]=!0,this[T]>=this[I]?this.nextTick(this[u],null,[]):this._all(e,this[u])),t[c]}_all(e,t){let r=this[T];const n=[],s=()=>{const e=this[I]<1/0?Math.min(1e3,this[I]-r):1e3;e<=0?this.nextTick(t,null,n):this._nextv(e,A,i)},i=(e,i)=>{e?t(e):0===i.length?t(null,n):(n.push.apply(n,i),r+=i.length,s())};s()}[f](){const e=this[l];return this[v]&&null===e?P:(this[h]=!1,this[l]=null,this[y]&&this._close(this[m]),e)}[g](e,t,r){this[p]?this.close(e.bind(null,t,r)):e(t,r)}seek(e,t){if(t=o(t,A),this[y]);else{if(this[h])throw new i("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const r=this.db.keyEncoding(t.keyEncoding||this[_]),n=r.format;t.keyEncoding!==n&&(t={...t,keyEncoding:n});const s=this.db.prefixKey(r.encode(e),n);this._seek(s,t)}}}_seek(e,t){throw new i("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(e){return e=s(e,c),this[w]?this.nextTick(e):this[y]?this[b].push(e):(this[y]=!0,this[b].push(e),this[h]?this[v]&&this[f]()(new i("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[m])),e[c]}_close(e){this.nextTick(e)}[m](){this[w]=!0,this.db.detachResource(this);const e=this[b];this[b]=[];for(const t of e)t()}async*[Symbol.asyncIterator](){try{let e;for(;void 0!==(e=await this.next());)yield e}finally{this[w]||await this.close()}}}class N extends O{constructor(e,t){super(e,t,!0),this[S]=!1!==t.keys,this[R]=!1!==t.values}[d](e,t,r){const n=this[f]();if(e)return n(e);try{t=this[S]&&void 0!==t?this[_].decode(t):void 0,r=this[R]&&void 0!==r?this[E].decode(r):void 0}catch(e){return n(new C("entry",e))}void 0===t&&void 0===r||this[T]++,n(null,t,r)}[u](e,t){const r=this[f]();if(e)return this[g](r,e);try{for(const e of t){const t=e[0],r=e[1];e[0]=this[S]&&void 0!==t?this[_].decode(t):void 0,e[1]=this[R]&&void 0!==r?this[E].decode(r):void 0}}catch(e){return this[g](r,new C("entries",e))}this[T]+=t.length,this[g](r,null,t)}end(e){return D||void 0===n||(D=!0,n.warn(new i("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}}class C extends i{constructor(e,t){super(`Iterator could not decode ${e}`,{code:"LEVEL_DECODE_ERROR",cause:t})}}for(const e of["_ended property","_nexting property","_end method"])Object.defineProperty(N.prototype,e.split(" ")[0],{get(){throw new i(`The ${e} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new i(`The ${e} has been removed`,{code:"LEVEL_LEGACY"})}});N.keyEncoding=_,N.valueEncoding=E,t.AbstractIterator=N,t.AbstractKeyIterator=class extends O{constructor(e,t){super(e,t,!1)}[d](e,t){const r=this[f]();if(e)return r(e);try{t=void 0!==t?this[_].decode(t):void 0}catch(e){return r(new C("key",e))}void 0!==t&&this[T]++,r(null,t)}[u](e,t){const r=this[f]();if(e)return this[g](r,e);try{for(let e=0;e<t.length;e++){const r=t[e];t[e]=void 0!==r?this[_].decode(r):void 0}}catch(e){return this[g](r,new C("keys",e))}this[T]+=t.length,this[g](r,null,t)}},t.AbstractValueIterator=class extends O{constructor(e,t){super(e,t,!1)}[d](e,t){const r=this[f]();if(e)return r(e);try{t=void 0!==t?this[E].decode(t):void 0}catch(e){return r(new C("value",e))}void 0!==t&&this[T]++,r(null,t)}[u](e,t){const r=this[f]();if(e)return this[g](r,e);try{for(let e=0;e<t.length;e++){const r=t[e];t[e]=void 0!==r?this[E].decode(r):void 0}}catch(e){return this[g](r,new C("values",e))}this[T]+=t.length,this[g](r,null,t)}}},35028:(e,t,r)=>{"use strict";const{supports:n}=r(28976),{Transcoder:s}=r(29893),{EventEmitter:i}=r(3894),{fromCallback:o}=r(39874),a=r(39296),{AbstractIterator:c}=r(40060),{DefaultKeyIterator:l,DefaultValueIterator:h}=r(81350),{DeferredIterator:d,DeferredKeyIterator:u,DeferredValueIterator:p}=r(26760),{DefaultChainedBatch:f}=r(97341),{getCallback:g,getOptions:y}=r(53862),m=r(10646),w=Symbol("promise"),b=Symbol("landed"),_=Symbol("resources"),E=Symbol("closeResources"),v=Symbol("operations"),k=Symbol("undefer"),S=Symbol("deferOpen"),R=Symbol("options"),I=Symbol("status"),T=Symbol("defaultOptions"),A=Symbol("transcoder"),P=Symbol("keyEncoding"),D=Symbol("valueEncoding"),O=()=>{};class N extends i{constructor(e,t){if(super(),"object"!=typeof e||null===e)throw new TypeError("The first argument 'manifest' must be an object");t=y(t);const{keyEncoding:r,valueEncoding:i,passive:o,...a}=t;this[_]=new Set,this[v]=[],this[S]=!0,this[R]=a,this[I]="opening",this.supports=n(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:!1!==e.snapshots,permanence:!1!==e.permanence,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[A]=new s(L(this)),this[P]=this[A].encoding(r||"utf8"),this[D]=this[A].encoding(i||"utf8");for(const e of this[A].encodings())this.supports.encodings[e.commonName]||(this.supports.encodings[e.commonName]=!0);this[T]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[P].commonName,valueEncoding:this[D].commonName}),key:Object.freeze({keyEncoding:this[P].commonName})},this.nextTick((()=>{this[S]&&this.open({passive:!1},O)}))}get status(){return this[I]}keyEncoding(e){return this[A].encoding(null!=e?e:this[P])}valueEncoding(e){return this[A].encoding(null!=e?e:this[D])}open(e,t){t=g(e,t),t=o(t,w),(e={...this[R],...y(e)}).createIfMissing=!1!==e.createIfMissing,e.errorIfExists=!!e.errorIfExists;const r=e=>{"closing"===this[I]||"opening"===this[I]?this.once(b,e?()=>r(e):r):"open"!==this[I]?t(new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:e})):t()};return e.passive?"opening"===this[I]?this.once(b,r):this.nextTick(r):"closed"===this[I]||this[S]?(this[S]=!1,this[I]="opening",this.emit("opening"),this._open(e,(e=>{if(e)return this[I]="closed",this[E]((()=>{this.emit(b),r(e)})),void this[k]();this[I]="open",this[k](),this.emit(b),"open"===this[I]&&this.emit("open"),"open"===this[I]&&this.emit("ready"),r()}))):"open"===this[I]?this.nextTick(r):this.once(b,(()=>this.open(e,t))),t[w]}_open(e,t){this.nextTick(t)}close(e){e=o(e,w);const t=r=>{"opening"===this[I]||"closing"===this[I]?this.once(b,r?t(r):t):"closed"!==this[I]?e(new a("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:r})):e()};if("open"===this[I]){this[I]="closing",this.emit("closing");const e=e=>{this[I]="open",this[k](),this.emit(b),t(e)};this[E]((()=>{this._close((r=>{if(r)return e(r);this[I]="closed",this[k](),this.emit(b),"closed"===this[I]&&this.emit("closed"),t()}))}))}else"closed"===this[I]?this.nextTick(t):this.once(b,(()=>this.close(e)));return e[w]}[E](e){if(0===this[_].size)return this.nextTick(e);let t=this[_].size,r=!0;const n=()=>{0==--t&&(r?this.nextTick(e):e())};for(const e of this[_])e.close(n);r=!1,this[_].clear()}_close(e){this.nextTick(e)}get(e,t,r){if(r=g(t,r),r=o(r,w),t=y(t,this[T].entry),"opening"===this[I])return this.defer((()=>this.get(e,t,r))),r[w];if(M(this,r))return r[w];const n=this._checkKey(e);if(n)return this.nextTick(r,n),r[w];const s=this.keyEncoding(t.keyEncoding),i=this.valueEncoding(t.valueEncoding),c=s.format,l=i.format;return t.keyEncoding===c&&t.valueEncoding===l||(t=Object.assign({},t,{keyEncoding:c,valueEncoding:l})),this._get(this.prefixKey(s.encode(e),c),t,((e,t)=>{if(e)return("LEVEL_NOT_FOUND"===e.code||e.notFound||/NotFound/i.test(e))&&(e.code||(e.code="LEVEL_NOT_FOUND"),e.notFound||(e.notFound=!0),e.status||(e.status=404)),r(e);try{t=i.decode(t)}catch(e){return r(new a("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:e}))}r(null,t)})),r[w]}_get(e,t,r){this.nextTick(r,new Error("NotFound"))}getMany(e,t,r){if(r=g(t,r),r=o(r,w),t=y(t,this[T].entry),"opening"===this[I])return this.defer((()=>this.getMany(e,t,r))),r[w];if(M(this,r))return r[w];if(!Array.isArray(e))return this.nextTick(r,new TypeError("The first argument 'keys' must be an array")),r[w];if(0===e.length)return this.nextTick(r,null,[]),r[w];const n=this.keyEncoding(t.keyEncoding),s=this.valueEncoding(t.valueEncoding),i=n.format,c=s.format;t.keyEncoding===i&&t.valueEncoding===c||(t=Object.assign({},t,{keyEncoding:i,valueEncoding:c}));const l=new Array(e.length);for(let t=0;t<e.length;t++){const s=e[t],o=this._checkKey(s);if(o)return this.nextTick(r,o),r[w];l[t]=this.prefixKey(n.encode(s),i)}return this._getMany(l,t,((e,t)=>{if(e)return r(e);try{for(let e=0;e<t.length;e++)void 0!==t[e]&&(t[e]=s.decode(t[e]))}catch(e){return r(new a(`Could not decode one or more of ${t.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:e}))}r(null,t)})),r[w]}_getMany(e,t,r){this.nextTick(r,null,new Array(e.length).fill(void 0))}put(e,t,r,n){if(n=g(r,n),n=o(n,w),r=y(r,this[T].entry),"opening"===this[I])return this.defer((()=>this.put(e,t,r,n))),n[w];if(M(this,n))return n[w];const s=this._checkKey(e)||this._checkValue(t);if(s)return this.nextTick(n,s),n[w];const i=this.keyEncoding(r.keyEncoding),a=this.valueEncoding(r.valueEncoding),c=i.format,l=a.format;r.keyEncoding===c&&r.valueEncoding===l||(r=Object.assign({},r,{keyEncoding:c,valueEncoding:l}));const h=this.prefixKey(i.encode(e),c),d=a.encode(t);return this._put(h,d,r,(r=>{if(r)return n(r);this.emit("put",e,t),n()})),n[w]}_put(e,t,r,n){this.nextTick(n)}del(e,t,r){if(r=g(t,r),r=o(r,w),t=y(t,this[T].key),"opening"===this[I])return this.defer((()=>this.del(e,t,r))),r[w];if(M(this,r))return r[w];const n=this._checkKey(e);if(n)return this.nextTick(r,n),r[w];const s=this.keyEncoding(t.keyEncoding),i=s.format;return t.keyEncoding!==i&&(t=Object.assign({},t,{keyEncoding:i})),this._del(this.prefixKey(s.encode(e),i),t,(t=>{if(t)return r(t);this.emit("del",e),r()})),r[w]}_del(e,t,r){this.nextTick(r)}batch(e,t,r){if(!arguments.length){if("opening"===this[I])return new f(this);if("open"!==this[I])throw new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(r="function"==typeof e?e:g(t,r),r=o(r,w),t=y(t,this[T].empty),"opening"===this[I])return this.defer((()=>this.batch(e,t,r))),r[w];if(M(this,r))return r[w];if(!Array.isArray(e))return this.nextTick(r,new TypeError("The first argument 'operations' must be an array")),r[w];if(0===e.length)return this.nextTick(r),r[w];const n=new Array(e.length),{keyEncoding:s,valueEncoding:i,...c}=t;for(let t=0;t<e.length;t++){if("object"!=typeof e[t]||null===e[t])return this.nextTick(r,new TypeError("A batch operation must be an object")),r[w];const o=Object.assign({},e[t]);if("put"!==o.type&&"del"!==o.type)return this.nextTick(r,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),r[w];const a=this._checkKey(o.key);if(a)return this.nextTick(r,a),r[w];const c=null!=o.sublevel?o.sublevel:this,l=c.keyEncoding(o.keyEncoding||s),h=l.format;if(o.key=c.prefixKey(l.encode(o.key),h),o.keyEncoding=h,"put"===o.type){const e=this._checkValue(o.value);if(e)return this.nextTick(r,e),r[w];const t=c.valueEncoding(o.valueEncoding||i);o.value=t.encode(o.value),o.valueEncoding=t.format}c!==this&&(o.sublevel=null),n[t]=o}return this._batch(n,c,(t=>{if(t)return r(t);this.emit("batch",e),r()})),r[w]}_batch(e,t,r){this.nextTick(r)}sublevel(e,t){return this._sublevel(e,C.defaults(t))}_sublevel(e,t){return new C(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=g(e,t),t=o(t,w),e=y(e,this[T].empty),"opening"===this[I])return this.defer((()=>this.clear(e,t))),t[w];if(M(this,t))return t[w];const r=e,n=this.keyEncoding(e.keyEncoding);return(e=m(e,n)).keyEncoding=n.format,0===e.limit?this.nextTick(t):this._clear(e,(e=>{if(e)return t(e);this.emit("clear",r),t()})),t[w]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if((e=m(e,t)).keys=!1!==e.keys,e.values=!1!==e.values,e[c.keyEncoding]=t,e[c.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,"opening"===this[I])return new d(this,e);if("open"!==this[I])throw new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new c(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if((e=m(e,t))[c.keyEncoding]=t,e[c.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,"opening"===this[I])return new u(this,e);if("open"!==this[I])throw new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new l(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if((e=m(e,t))[c.keyEncoding]=t,e[c.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,"opening"===this[I])return new p(this,e);if("open"!==this[I])throw new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new h(this,e)}defer(e){if("function"!=typeof e)throw new TypeError("The first argument must be a function");this[v].push(e)}[k](){if(0===this[v].length)return;const e=this[v];this[v]=[];for(const t of e)t()}attachResource(e){if("object"!=typeof e||null===e||"function"!=typeof e.close)throw new TypeError("The first argument must be a resource object");this[_].add(e)}detachResource(e){this[_].delete(e)}_chainedBatch(){return new f(this)}_checkKey(e){if(null==e)return new a("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(null==e)return new a("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}}N.prototype.nextTick=r(30919);const{AbstractSublevel:C}=r(9728)({AbstractLevel:N});t.AbstractLevel=N,t.AbstractSublevel=C;const M=function(e,t){return"open"!==e[I]&&(e.nextTick(t,new a("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0)},L=function(e){return Object.keys(e.supports.encodings).filter((t=>!!e.supports.encodings[t]))}},61206:(e,t,r)=>{"use strict";t.AbstractLevel=r(35028).AbstractLevel,t.AbstractSublevel=r(35028).AbstractSublevel,t.AbstractIterator=r(40060).AbstractIterator,t.AbstractKeyIterator=r(40060).AbstractKeyIterator,t.AbstractValueIterator=r(40060).AbstractValueIterator,t.AbstractChainedBatch=r(12618).AbstractChainedBatch},12422:(e,t,r)=>{"use strict";const{AbstractIterator:n,AbstractKeyIterator:s,AbstractValueIterator:i}=r(40060),o=Symbol("unfix"),a=Symbol("iterator"),c=Symbol("handleOne"),l=Symbol("handleMany"),h=Symbol("callback");class d extends n{constructor(e,t,r,n){super(e,t),this[a]=r,this[o]=n,this[c]=this[c].bind(this),this[l]=this[l].bind(this),this[h]=null}[c](e,t,r){const n=this[h];if(e)return n(e);void 0!==t&&(t=this[o](t)),n(e,t,r)}[l](e,t){const r=this[h];if(e)return r(e);for(const e of t){const t=e[0];void 0!==t&&(e[0]=this[o](t))}r(e,t)}}class u extends s{constructor(e,t,r,n){super(e,t),this[a]=r,this[o]=n,this[c]=this[c].bind(this),this[l]=this[l].bind(this),this[h]=null}[c](e,t){const r=this[h];if(e)return r(e);void 0!==t&&(t=this[o](t)),r(e,t)}[l](e,t){const r=this[h];if(e)return r(e);for(let e=0;e<t.length;e++){const r=t[e];void 0!==r&&(t[e]=this[o](r))}r(e,t)}}class p extends i{constructor(e,t,r){super(e,t),this[a]=r}}for(const e of[d,u])e.prototype._next=function(e){this[h]=e,this[a].next(this[c])},e.prototype._nextv=function(e,t,r){this[h]=r,this[a].nextv(e,t,this[l])},e.prototype._all=function(e,t){this[h]=t,this[a].all(e,this[l])};for(const e of[p])e.prototype._next=function(e){this[a].next(e)},e.prototype._nextv=function(e,t,r){this[a].nextv(e,t,r)},e.prototype._all=function(e,t){this[a].all(e,t)};for(const e of[d,u,p])e.prototype._seek=function(e,t){this[a].seek(e,t)},e.prototype._close=function(e){this[a].close(e)};t.AbstractSublevelIterator=d,t.AbstractSublevelKeyIterator=u,t.AbstractSublevelValueIterator=p},9728:(e,t,r)=>{"use strict";const n=r(39296),{Buffer:s}=r(83107)||{},{AbstractSublevelIterator:i,AbstractSublevelKeyIterator:o,AbstractSublevelValueIterator:a}=r(12422),c=Symbol("prefix"),l=Symbol("upperBound"),h=Symbol("prefixRange"),d=Symbol("parent"),u=Symbol("unfix"),p=new TextEncoder,f={separator:"!"};e.exports=function({AbstractLevel:e}){class t extends e{static defaults(e){if("string"==typeof e)throw new n("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(e&&e.open)throw new n("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return null==e?f:e.separator?e:{...e,separator:"!"}}constructor(e,r,s){const{separator:i,manifest:o,...a}=t.defaults(s);r=b(r,i);const h=i.charCodeAt(0)+1,f=e[d]||e;if(!p.encode(r).every((e=>e>h&&e<127)))throw new n(`Prefix must use bytes > ${h} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(g(f,o),a);const y=(e.prefix||"")+i+r+i,_=y.slice(0,-1)+String.fromCharCode(h);this[d]=f,this[c]=new m(y),this[l]=new m(_),this[u]=new w,this.nextTick=f.nextTick}prefixKey(e,t){if("utf8"===t)return this[c].utf8+e;if(0===e.byteLength)return this[c][t];if("view"===t){const t=this[c].view,r=new Uint8Array(t.byteLength+e.byteLength);return r.set(t,0),r.set(e,t.byteLength),r}{const t=this[c].buffer;return s.concat([t,e],t.byteLength+e.byteLength)}}[h](e,t){void 0!==e.gte?e.gte=this.prefixKey(e.gte,t):void 0!==e.gt?e.gt=this.prefixKey(e.gt,t):e.gte=this[c][t],void 0!==e.lte?e.lte=this.prefixKey(e.lte,t):void 0!==e.lt?e.lt=this.prefixKey(e.lt,t):e.lte=this[l][t]}get prefix(){return this[c].utf8}get db(){return this[d]}_open(e,t){this[d].open({passive:!0},t)}_put(e,t,r,n){this[d].put(e,t,r,n)}_get(e,t,r){this[d].get(e,t,r)}_getMany(e,t,r){this[d].getMany(e,t,r)}_del(e,t,r){this[d].del(e,t,r)}_batch(e,t,r){this[d].batch(e,t,r)}_clear(e,t){this[h](e,e.keyEncoding),this[d].clear(e,t)}_iterator(e){this[h](e,e.keyEncoding);const t=this[d].iterator(e),r=this[u].get(this[c].utf8.length,e.keyEncoding);return new i(this,e,t,r)}_keys(e){this[h](e,e.keyEncoding);const t=this[d].keys(e),r=this[u].get(this[c].utf8.length,e.keyEncoding);return new o(this,e,t,r)}_values(e){this[h](e,e.keyEncoding);const t=this[d].values(e);return new a(this,e,t)}}return{AbstractSublevel:t}};const g=function(e,t){return{...e.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...t,encodings:{utf8:y(e,"utf8"),buffer:y(e,"buffer"),view:y(e,"view")}}},y=function(e,t){return!!e.supports.encodings[t]&&e.keyEncoding(t).name===t};class m{constructor(e){this.utf8=e,this.view=p.encode(e),this.buffer=s?s.from(this.view.buffer,0,this.view.byteLength):{}}}class w{constructor(){this.cache=new Map}get(e,t){let r=this.cache.get(t);return void 0===r&&(r="view"===t?function(e,t){return t.subarray(e)}.bind(null,e):function(e,t){return t.slice(e)}.bind(null,e),this.cache.set(t,r)),r}}const b=function(e,t){let r=0,n=e.length;for(;r<n&&e[r]===t;)r++;for(;n>r&&e[n-1]===t;)n--;return e.slice(r,n)}},53862:(e,t)=>{"use strict";t.getCallback=function(e,t){return"function"==typeof e?e:t},t.getOptions=function(e,t){return"object"==typeof e&&null!==e?e:void 0!==t?t:{}}},97341:(e,t,r)=>{"use strict";const{AbstractChainedBatch:n}=r(12618),s=r(39296),i=Symbol("encoded");t.DefaultChainedBatch=class extends n{constructor(e){super(e),this[i]=[]}_put(e,t,r){this[i].push({...r,type:"put",key:e,value:t})}_del(e,t){this[i].push({...t,type:"del",key:e})}_clear(){this[i]=[]}_write(e,t){"opening"===this.db.status?this.db.defer((()=>this._write(e,t))):"open"===this.db.status?0===this[i].length?this.nextTick(t):this.db._batch(this[i],e,t):this.nextTick(t,new s("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}}},81350:(e,t,r)=>{"use strict";const{AbstractKeyIterator:n,AbstractValueIterator:s}=r(40060),i=Symbol("iterator"),o=Symbol("callback"),a=Symbol("handleOne"),c=Symbol("handleMany");class l extends n{constructor(e,t){super(e,t),this[i]=e.iterator({...t,keys:!0,values:!1}),this[a]=this[a].bind(this),this[c]=this[c].bind(this)}}class h extends s{constructor(e,t){super(e,t),this[i]=e.iterator({...t,keys:!1,values:!0}),this[a]=this[a].bind(this),this[c]=this[c].bind(this)}}for(const e of[l,h]){const t=e===l,r=t?e=>e[0]:e=>e[1];e.prototype._next=function(e){this[o]=e,this[i].next(this[a])},e.prototype[a]=function(e,r,n){const s=this[o];e?s(e):s(null,t?r:n)},e.prototype._nextv=function(e,t,r){this[o]=r,this[i].nextv(e,t,this[c])},e.prototype._all=function(e,t){this[o]=t,this[i].all(e,this[c])},e.prototype[c]=function(e,t){const n=this[o];e?n(e):n(null,t.map(r))},e.prototype._seek=function(e,t){this[i].seek(e,t)},e.prototype._close=function(e){this[i].close(e)}}t.DefaultKeyIterator=l,t.DefaultValueIterator=h},26760:(e,t,r)=>{"use strict";const{AbstractIterator:n,AbstractKeyIterator:s,AbstractValueIterator:i}=r(40060),o=r(39296),a=Symbol("nut"),c=Symbol("undefer"),l=Symbol("factory");class h extends n{constructor(e,t){super(e,t),this[a]=null,this[l]=()=>e.iterator(t),this.db.defer((()=>this[c]()))}}class d extends s{constructor(e,t){super(e,t),this[a]=null,this[l]=()=>e.keys(t),this.db.defer((()=>this[c]()))}}class u extends i{constructor(e,t){super(e,t),this[a]=null,this[l]=()=>e.values(t),this.db.defer((()=>this[c]()))}}for(const e of[h,d,u])e.prototype[c]=function(){"open"===this.db.status&&(this[a]=this[l]())},e.prototype._next=function(e){null!==this[a]?this[a].next(e):"opening"===this.db.status?this.db.defer((()=>this._next(e))):this.nextTick(e,new o("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._nextv=function(e,t,r){null!==this[a]?this[a].nextv(e,t,r):"opening"===this.db.status?this.db.defer((()=>this._nextv(e,t,r))):this.nextTick(r,new o("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._all=function(e,t){null!==this[a]?this[a].all(t):"opening"===this.db.status?this.db.defer((()=>this._all(e,t))):this.nextTick(t,new o("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._seek=function(e,t){null!==this[a]?this[a]._seek(e,t):"opening"===this.db.status&&this.db.defer((()=>this._seek(e,t)))},e.prototype._close=function(e){null!==this[a]?this[a].close(e):"opening"===this.db.status?this.db.defer((()=>this._close(e))):this.nextTick(e)};t.DeferredIterator=h,t.DeferredKeyIterator=d,t.DeferredValueIterator=u},30919:(e,t,r)=>{"use strict";const n=r(94715);e.exports=function(e,...t){0===t.length?n(e):n((()=>e(...t)))}},10646:(e,t,r)=>{"use strict";const n=r(39296),s=Object.prototype.hasOwnProperty,i=new Set(["lt","lte","gt","gte"]);e.exports=function(e,t){const r={};for(const o in e)if(s.call(e,o)&&"keyEncoding"!==o&&"valueEncoding"!==o){if("start"===o||"end"===o)throw new n(`The legacy range option '${o}' has been removed`,{code:"LEVEL_LEGACY"});if("encoding"===o)throw new n("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});i.has(o)?r[o]=t.encode(e[o]):r[o]=e[o]}return r.reverse=!!r.reverse,r.limit=Number.isInteger(r.limit)&&r.limit>=0?r.limit:-1,r}},16276:e=>{"use strict";e.exports=async e=>{const t=[];for await(const r of e)t.push(r);return t}},80630:e=>{"use strict";e.exports=async e=>{for await(const t of e);}},19418:e=>{"use strict";e.exports=async function*(e,t){for await(const r of e)await t(r)&&(yield r)}},68274:(e,t,r)=>{"use strict";const{AbstractLevel:n}=r(61206),s=r(39296),i=r(25161),{fromCallback:o}=r(39874),{Iterator:a}=r(77655),c=r(64741),l=r(57034),h=r(5644),d="level-js-",u=Symbol("idb"),p=Symbol("namePrefix"),f=Symbol("location"),g=Symbol("version"),y=Symbol("store"),m=Symbol("onComplete"),w=Symbol("promise");class b extends n{constructor(e,t,r){if("function"==typeof t||"function"==typeof r)throw new s("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:n,version:i,...o}=t||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},o),"string"!=typeof e)throw new Error("constructor requires a location string argument");this[f]=e,this[p]=null==n?d:n,this[g]=parseInt(i||1,10),this[u]=null}get location(){return this[f]}get namePrefix(){return this[p]}get version(){return this[g]}get db(){return this[u]}get type(){return"browser-level"}_open(e,t){const r=indexedDB.open(this[p]+this[f],this[g]);r.onerror=function(){t(r.error||new Error("unknown error"))},r.onsuccess=()=>{this[u]=r.result,t()},r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this[f])||t.createObjectStore(this[f])}}[y](e){return this[u].transaction([this[f]],e).objectStore(this[f])}[m](e,t){const r=e.transaction;r.onabort=function(){t(r.error||new Error("aborted by user"))},r.oncomplete=function(){t(null,e.result)}}_get(e,t,r){const n=this[y]("readonly");let i;try{i=n.get(e)}catch(e){return this.nextTick(r,e)}this[m](i,(function(e,t){return e?r(e):void 0===t?r(new s("Entry not found",{code:"LEVEL_NOT_FOUND"})):void r(null,c(t))}))}_getMany(e,t,r){const n=this[y]("readonly"),s=e.map((e=>t=>{let r;try{r=n.get(e)}catch(e){return t(e)}r.onsuccess=()=>{const e=r.result;t(null,void 0===e?e:c(e))},r.onerror=e=>{e.stopPropagation(),t(r.error)}}));i(s,16,r)}_del(e,t,r){const n=this[y]("readwrite");let s;try{s=n.delete(e)}catch(e){return this.nextTick(r,e)}this[m](s,r)}_put(e,t,r,n){const s=this[y]("readwrite");let i;try{i=s.put(t,e)}catch(e){return this.nextTick(n,e)}this[m](i,n)}_iterator(e){return new a(this,this[f],e)}_batch(e,t,r){const n=this[y]("readwrite"),s=n.transaction;let i,o=0;s.onabort=function(){r(i||s.error||new Error("aborted by user"))},s.oncomplete=function(){r()},function t(){const r=e[o++],a=r.key;let c;try{c="del"===r.type?n.delete(a):n.put(r.value,a)}catch(e){return i=e,void s.abort()}o<e.length?c.onsuccess=t:"function"==typeof s.commit&&s.commit()}()}_clear(e,t){let r,n;try{r=h(e)}catch(e){return this.nextTick(t)}if(e.limit>=0)return l(this,this[f],r,e,t);try{const e=this[y]("readwrite");n=r?e.delete(r):e.clear()}catch(e){return this.nextTick(t,e)}this[m](n,t)}_close(e){this[u].close(),this.nextTick(e)}}b.destroy=function(e,t,r){"function"==typeof t&&(r=t,t=d),r=o(r,w);const n=indexedDB.deleteDatabase(t+e);return n.onsuccess=function(){r()},n.onerror=function(e){r(e)},r[w]},t.BrowserLevel=b},77655:(e,t,r)=>{"use strict";const{AbstractIterator:n}=r(61206),s=r(5644),i=r(64741),o=Symbol("cache"),a=Symbol("finished"),c=Symbol("options"),l=Symbol("currentOptions"),h=Symbol("position"),d=Symbol("location"),u=Symbol("first"),p={};function f(e){"function"==typeof e.commit&&e.commit()}t.Iterator=class extends n{constructor(e,t,r){super(e,r),this[o]=[],this[a]=0===this.limit,this[c]=r,this[l]={...r},this[h]=void 0,this[d]=t,this[u]=!0}_nextv(e,t,r){if(this[u]=!1,this[a])return this.nextTick(r,null,[]);if(this[o].length>0)return e=Math.min(e,this[o].length),this.nextTick(r,null,this[o].splice(0,e));let n;void 0!==this[h]&&(this[c].reverse?(this[l].lt=this[h],this[l].lte=void 0):(this[l].gt=this[h],this[l].gte=void 0));try{n=s(this[l])}catch(e){return this[a]=!0,this.nextTick(r,null,[])}const p=this.db.db.transaction([this[d]],"readonly"),g=p.objectStore(this[d]),y=[];if(this[c].reverse)g[!this[c].values&&g.openKeyCursor?"openKeyCursor":"openCursor"](n,"prev").onsuccess=t=>{const r=t.target.result;if(r){const{key:t,value:n}=r;this[h]=t,y.push([this[c].keys&&void 0!==t?i(t):void 0,this[c].values&&void 0!==n?i(n):void 0]),y.length<e?r.continue():f(p)}else this[a]=!0};else{let t,r;const s=()=>{if(void 0===t||void 0===r)return;const n=Math.max(t.length,r.length);0===n||e===1/0?this[a]=!0:this[h]=t[n-1],y.length=n;for(let e=0;e<n;e++){const n=t[e],s=r[e];y[e]=[this[c].keys&&void 0!==n?i(n):void 0,this[c].values&&void 0!==s?i(s):void 0]}f(p)};this[c].keys||e<1/0?g.getAllKeys(n,e<1/0?e:void 0).onsuccess=e=>{t=e.target.result,s()}:(t=[],this.nextTick(s)),this[c].values?g.getAll(n,e<1/0?e:void 0).onsuccess=e=>{r=e.target.result,s()}:(r=[],this.nextTick(s))}p.onabort=()=>{r(p.error||new Error("aborted by user")),r=null},p.oncomplete=()=>{r(null,y),r=null}}_next(e){if(this[o].length>0){const[t,r]=this[o].shift();this.nextTick(e,null,t,r)}else if(this[a])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[u]&&(this[u]=!1,t=1),this._nextv(t,p,((t,r)=>{if(t)return e(t);this[o]=r,this._next(e)}))}}_all(e,t){this[u]=!1;const r=this[o].splice(0,this[o].length),n=this.limit-this.count-r.length;if(n<=0)return this.nextTick(t,null,r);this._nextv(n,p,((e,n)=>{if(e)return t(e);r.length>0&&(n=r.concat(n)),t(null,n)}))}_seek(e,t){let r;this[u]=!0,this[o]=[],this[a]=!1,this[h]=void 0,this[l]={...this[c]};try{r=s(this[c])}catch(e){return void(this[a]=!0)}null===r||r.includes(e)?this[c].reverse?this[l].lte=e:this[l].gte=e:this[a]=!0}}},57034:e=>{"use strict";e.exports=function(e,t,r,n,s){if(0===n.limit)return e.nextTick(s);const i=e.db.transaction([t],"readwrite"),o=i.objectStore(t);let a=0;i.oncomplete=function(){s()},i.onabort=function(){s(i.error||new Error("aborted by user"))};const c=o.openKeyCursor?"openKeyCursor":"openCursor",l=n.reverse?"prev":"next";o[c](r,l).onsuccess=function(e){const t=e.target.result;t&&(o.delete(t.key).onsuccess=function(){(n.limit<=0||++a<n.limit)&&t.continue()})}}},64741:e=>{"use strict";const t=new TextEncoder;e.exports=function(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):t.encode(e)}},5644:e=>{"use strict";e.exports=function(e){const t=void 0!==e.gte?e.gte:void 0!==e.gt?e.gt:void 0,r=void 0!==e.lte?e.lte:void 0!==e.lt?e.lt:void 0,n=void 0===e.gte,s=void 0===e.lte;return void 0!==t&&void 0!==r?IDBKeyRange.bound(t,r,n,s):void 0!==t?IDBKeyRange.lowerBound(t,n):void 0!==r?IDBKeyRange.upperBound(r,s):null}},13434:e=>{"use strict";e.exports=function(e,t){return"string"==typeof e?o(e):"number"==typeof e?i(e,t):null},e.exports.format=i,e.exports.parse=o;var t=/\B(?=(\d{3})+(?!\d))/g,r=/(?:\.0*|(\.[^0]+)0+)$/,n={b:1,kb:1024,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)},s=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i;function i(e,s){if(!Number.isFinite(e))return null;var i=Math.abs(e),o=s&&s.thousandsSeparator||"",a=s&&s.unitSeparator||"",c=s&&void 0!==s.decimalPlaces?s.decimalPlaces:2,l=Boolean(s&&s.fixedDecimals),h=s&&s.unit||"";h&&n[h.toLowerCase()]||(h=i>=n.pb?"PB":i>=n.tb?"TB":i>=n.gb?"GB":i>=n.mb?"MB":i>=n.kb?"KB":"B");var d=(e/n[h.toLowerCase()]).toFixed(c);return l||(d=d.replace(r,"$1")),o&&(d=d.split(".").map((function(e,r){return 0===r?e.replace(t,o):e})).join(".")),d+a+h}function o(e){if("number"==typeof e&&!isNaN(e))return e;if("string"!=typeof e)return null;var t,r=s.exec(e),i="b";return r?(t=parseFloat(r[1]),i=r[4].toLowerCase()):(t=parseInt(e,10),i="b"),isNaN(t)?null:Math.floor(n[i]*t)}},39874:(e,t,r)=>{"use strict";var n=r(31728);t.fromCallback=function(e,t){if(void 0===e){var r=new Promise((function(t,r){e=function(e,n){e?r(e):t(n)}}));e[void 0!==t?t:"promise"]=r}else if("function"!=typeof e)throw new TypeError("Callback must be a function");return e},t.fromPromise=function(e,t){if(void 0===t)return e;e.then((function(e){n((()=>t(null,e)))})).catch((function(e){n((()=>t(e)))}))}},31728:e=>{e.exports="function"==typeof queueMicrotask?queueMicrotask:e=>Promise.resolve().then(e)},51006:(e,t,r)=>{var n=r(86189),s=r(41015),i=r(29122),o=r(30831),a=RegExp.prototype;e.exports=function(e){var t=e.flags;return void 0!==t||"flags"in a||s(e,"flags")||!i(a,e)?t:n(o,e)}},23803:(e,t,r)=>{"use strict";var n=r(85863).PROPER,s=r(94678),i=r(48127),o=r(48303),a=r(91073),c=r(51006),l="toString",h=RegExp.prototype[l],d=a((function(){return"/a/b"!=h.call({source:"a",flags:"b"})})),u=n&&h.name!=l;(d||u)&&s(RegExp.prototype,l,(function(){var e=i(this);return"/"+o(e.source)+"/"+o(c(e))}),{unsafe:!0})},63246:e=>{"use strict";e.exports=async function*(e,t){for await(const r of e)yield t(r)}},86119:(e,t,r)=>{"use strict";const n=r(53204);e.exports=async function*(...e){const t=n();setTimeout((async()=>{try{await Promise.all(e.map((async e=>{for await(const r of e)t.push(r)}))),t.end()}catch(e){t.end(e)}}),0),yield*t}},53204:(e,t,r)=>{const n=r(98502);e.exports=e=>{let t;"function"==typeof(e=e||{})?(t=e,e={}):t=e.onEnd;let r,s,i,o=new n;const a=e=>s?s(e):(o.push(e),r),c=e=>i?r:a({done:!1,value:e}),l=e=>i?r:(i=!0,e?(e=>(o=new n,s?s({error:e}):(o.push({error:e}),r)))(e):a({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:()=>{if(!o.isEmpty()){if(e.writev){let e;const t=[];for(;!o.isEmpty();){if(e=o.shift(),e.error)throw e.error;t.push(e.value)}return{done:e.done,value:t}}const t=o.shift();if(t.error)throw t.error;return t}return i?{done:!0}:new Promise(((t,n)=>{s=i=>(s=null,i.error?n(i.error):e.writev&&!i.done?t({done:i.done,value:[i.value]}):t(i),r)}))},return:()=>(o=new n,l(),{done:!0}),throw:e=>(l(e),{done:!0}),push:c,end:l},!t)return r;const h=r;return r={[Symbol.asyncIterator](){return this},next:()=>h.next(),throw:e=>(h.throw(e),t&&(t(e),t=null),{done:!0}),return:()=>(h.return(),t&&(t(),t=null),{done:!0}),push:c,end:e=>(h.end(e),t&&(t(e),t=null),r)},r}},19301:e=>{"use strict";function t(e,t){t=t||{},this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(e)&&this._fromArray(e)}t.prototype.peekAt=function(e){var t=e;if(t===(0|t)){var r=this.size();if(!(t>=r||t<-r))return t<0&&(t+=r),t=this._head+t&this._capacityMask,this._list[t]}},t.prototype.get=function(e){return this.peekAt(e)},t.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},t.prototype.peekFront=function(){return this.peek()},t.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(t.prototype,"length",{get:function(){return this.size()}}),t.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.unshift=function(e){if(void 0===e)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}},t.prototype.push=function(e){if(void 0===e)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var r=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),r}},t.prototype.removeOne=function(e){var t=e;if(t===(0|t)&&this._head!==this._tail){var r=this.size(),n=this._list.length;if(!(t>=r||t<-r)){t<0&&(t+=r),t=this._head+t&this._capacityMask;var s,i=this._list[t];if(e<r/2){for(s=e;s>0;s--)this._list[t]=this._list[t=t-1+n&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+n&this._capacityMask}else{for(s=r-1-e;s>0;s--)this._list[t]=this._list[t=t+1+n&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+n&this._capacityMask}return i}}},t.prototype.remove=function(e,t){var r,n=e,s=t;if(n===(0|n)&&this._head!==this._tail){var i=this.size(),o=this._list.length;if(!(n>=i||n<-i||t<1)){if(n<0&&(n+=i),1===t||!t)return(r=new Array(1))[0]=this.removeOne(n),r;if(0===n&&n+t>=i)return r=this.toArray(),this.clear(),r;var a;for(n+t>i&&(t=i-n),r=new Array(t),a=0;a<t;a++)r[a]=this._list[this._head+n+a&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===i){for(this._tail=this._tail-t+o&this._capacityMask,a=t;a>0;a--)this._list[n=n+1+o&this._capacityMask]=void 0;return r}if(0===e){for(this._head=this._head+t+o&this._capacityMask,a=t-1;a>0;a--)this._list[n=n+1+o&this._capacityMask]=void 0;return r}if(n<i/2){for(this._head=this._head+e+t+o&this._capacityMask,a=e;a>0;a--)this.unshift(this._list[n=n-1+o&this._capacityMask]);for(n=this._head-1+o&this._capacityMask;s>0;)this._list[n=n-1+o&this._capacityMask]=void 0,s--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+o&this._capacityMask,a=i-(t+e);a>0;a--)this.push(this._list[n++]);for(n=this._tail;s>0;)this._list[n=n+1+o&this._capacityMask]=void 0,s--}return this._head<2&&this._tail>1e4&&this._tail<=o>>>2&&this._shrinkArray(),r}}},t.prototype.splice=function(e,t){var r=e;if(r===(0|r)){var n=this.size();if(r<0&&(r+=n),!(r>n)){if(arguments.length>2){var s,i,o,a=arguments.length,c=this._list.length,l=2;if(!n||r<n/2){for(i=new Array(r),s=0;s<r;s++)i[s]=this._list[this._head+s&this._capacityMask];for(0===t?(o=[],r>0&&(this._head=this._head+r+c&this._capacityMask)):(o=this.remove(r,t),this._head=this._head+r+c&this._capacityMask);a>l;)this.unshift(arguments[--a]);for(s=r;s>0;s--)this.unshift(i[s-1])}else{var h=(i=new Array(n-(r+t))).length;for(s=0;s<h;s++)i[s]=this._list[this._head+r+t+s&this._capacityMask];for(0===t?(o=[],r!=n&&(this._tail=this._head+r+c&this._capacityMask)):(o=this.remove(r,t),this._tail=this._tail-h+c&this._capacityMask);l<a;)this.push(arguments[l++]);for(s=0;s<h;s++)this.push(i[s])}return o}return this.remove(r,t)}}},t.prototype.clear=function(){this._head=0,this._tail=0},t.prototype.isEmpty=function(){return this._head===this._tail},t.prototype.toArray=function(){return this._copyArray(!1)},t.prototype._fromArray=function(e){for(var t=0;t<e.length;t++)this.push(e[t])},t.prototype._copyArray=function(e){var t,r=[],n=this._list,s=n.length;if(e||this._head>this._tail){for(t=this._head;t<s;t++)r.push(n[t]);for(t=0;t<this._tail;t++)r.push(n[t])}else for(t=this._head;t<this._tail;t++)r.push(n[t]);return r},t.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1},t.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},e.exports=t},93765:function(e){e.exports=function(e,t,r,n,s){for(t=t.split?t.split("."):t,n=0;n<t.length;n++)e=e?e[t[n]]:s;return e===s?r:e}},122:(e,t)=>{"use strict";function r(e,t=r.BASE){const n=e.length;for(let r=0;r<n;r++)t^=e.charCodeAt(r),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0}Object.defineProperty(t,"__esModule",{value:!0}),r.BASE=2166136261,t.default=r,e.exports=r},26205:e=>{e.exports=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,r=Object.create(null),n=Object.create(null);function s(s,i){r[s]=i,++t>=e&&(t=0,n=r,r=Object.create(null))}return{has:function(e){return void 0!==r[e]||void 0!==n[e]},remove:function(e){void 0!==r[e]&&(r[e]=void 0),void 0!==n[e]&&(n[e]=void 0)},get:function(e){var t=r[e];return void 0!==t?t:void 0!==(t=n[e])?(s(e,t),t):void 0},set:function(e,t){void 0!==r[e]?r[e]=t:s(e,t)},clear:function(){r=Object.create(null),n=Object.create(null)}}}},27697:(e,t,r)=>{"use strict";var n=r(46039);const s=r(66830),i="object"==typeof window&&"object"==typeof document&&9===document.nodeType,o=s(),a=i&&!o,c=o&&!i,l=o&&i,h=void 0!==n&&void 0!==n.release&&"node"===n.release.name&&!o,d="function"==typeof importScripts&&"undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,u=void 0!==n&&void 0!==n.env&&!1,p="undefined"!=typeof navigator&&"ReactNative"===navigator.product;e.exports={isTest:u,isElectron:o,isElectronMain:c,isElectronRenderer:l,isNode:h,isBrowser:a,isWebWorker:d,isEnvWithDom:i,isReactNative:p}},97119:(e,t,r)=>{"use strict";e.exports=r(81661)},36074:(e,t,r)=>{"use strict";const n=r(6963);async function*s(e,t){const r=new n,s=await r.get(e,t);yield*s.iterator()}e.exports=(e,t)=>({path:decodeURIComponent(new URL(e).pathname.split("/").pop()||""),content:s(e,t)})},6963:(e,t,r)=>{"use strict";const{fetch:n,Request:s,Headers:i}=r(72349),{TimeoutError:o,HTTPError:a}=r(2228),c=r(76768).bind({ignoreUndefined:!0}),{URL:l,URLSearchParams:h}=r(21963),d=r(92360),u={throwHttpErrors:!0,credentials:"same-origin"};class p{constructor(e={}){this.opts=c(u,e)}async fetch(e,t={}){const r=c(this.opts,t),u=new i(r.headers);if("string"!=typeof e&&!(e instanceof l||e instanceof s))throw new TypeError("`resource` must be a string, URL, or Request");const p=new l(e.toString(),r.base),{searchParams:y,transformSearchParams:m,json:w}=r;y&&(p.search="function"==typeof m?m(new h(r.searchParams)):new h(r.searchParams)),w&&(r.body=JSON.stringify(r.json),u.set("content-type","application/json"));const b=new AbortController,_=d([b.signal,r.signal]),E=await((e,t,r)=>{if(void 0===t)return e;const n=Date.now(),s=()=>Date.now()-n>=t;return new Promise(((n,i)=>{const a=setTimeout((()=>{s()&&(i(new o),r.abort())}),t),c=e=>t=>{clearTimeout(a),s()?i(new o):e(t)};e.then(c(n),c(i))}))})(n(p.toString(),{...r,signal:_,timeout:void 0,headers:u}),r.timeout,b);if(!E.ok&&r.throwHttpErrors)throw r.handleError&&await r.handleError(E),new a(E);return E.iterator=async function*(){yield*g(E.body)},E.ndjson=async function*(){for await(const e of f(E.iterator()))t.transform?yield t.transform(e):yield e},E}post(e,t={}){return this.fetch(e,{...t,method:"POST"})}get(e,t={}){return this.fetch(e,{...t,method:"GET"})}put(e,t={}){return this.fetch(e,{...t,method:"PUT"})}delete(e,t={}){return this.fetch(e,{...t,method:"DELETE"})}options(e,t={}){return this.fetch(e,{...t,method:"OPTIONS"})}}const f=async function*(e){const t=new TextDecoder;let r="";for await(const n of e){r+=t.decode(n,{stream:!0});const e=r.split(/\r?\n/);for(let t=0;t<e.length-1;t++){const r=e[t].trim();r.length>0&&(yield JSON.parse(r))}r=e[e.length-1]}r+=t.decode(),r=r.trim(),0!==r.length&&(yield JSON.parse(r))},g=e=>{if(w(e)){const t=e[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:t.next.bind(t),return:r=>(e.destroy(),"function"==typeof t.return?t.return():Promise.resolve({done:!0,value:r}))})}}if(m(e)){const t=e.getReader();return async function*(){try{for(;;){const{done:e,value:r}=await t.read();if(e)return;r&&(yield r)}}finally{t.releaseLock()}}()}if(y(e))return e;throw new TypeError("Body can't be converted to AsyncIterable")},y=e=>"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator],m=e=>e&&"function"==typeof e.getReader,w=e=>Object.prototype.hasOwnProperty.call(e,"readable")&&Object.prototype.hasOwnProperty.call(e,"writable");p.HTTPError=a,p.TimeoutError=o,p.streamToAsyncIterator=g,p.post=(e,t)=>new p(t).post(e,t),p.get=(e,t)=>new p(t).get(e,t),p.put=(e,t)=>new p(t).put(e,t),p.delete=(e,t)=>new p(t).delete(e,t),p.options=(e,t)=>new p(t).options(e,t),e.exports=p},2228:(e,t)=>{"use strict";class r extends Error{constructor(e="Request timed out"){super(e),this.name="TimeoutError"}}t.TimeoutError=r;class n extends Error{constructor(e="The operation was aborted."){super(e),this.name="AbortError"}}t.AbortError=n;class s extends Error{constructor(e){super(e.statusText),this.name="HTTPError",this.response=e}}t.HTTPError=s},72349:(e,t,r)=>{"use strict";const{TimeoutError:n,AbortError:s}=r(2228),{Response:i,Request:o,Headers:a,default:c}=r(97119),l=c,h=e=>{const t=new a;for(const r of e.trim().split(/[\r\n]+/)){const e=r.indexOf(": ");e>0&&t.set(r.slice(0,e),r.slice(e+1))}return t};class d extends i{constructor(e,t,r){super(t,r),Object.defineProperty(this,"url",{value:e})}}e.exports={fetch:(e,t={})=>null!=t.onUploadProgress?((e,t={})=>{const r=new XMLHttpRequest;r.open(t.method||"GET",e.toString(),!0);const{timeout:o,headers:c}=t;if(o&&o>0&&o<1/0&&(r.timeout=o),null!=t.overrideMimeType&&r.overrideMimeType(t.overrideMimeType),c)for(const[e,t]of new a(c))r.setRequestHeader(e,t);return t.signal&&(t.signal.onabort=()=>r.abort()),t.onUploadProgress&&(r.upload.onprogress=t.onUploadProgress),r.responseType="arraybuffer",new Promise(((e,o)=>{const a=t=>{switch(t.type){case"error":e(i.error());break;case"load":e(new d(r.responseURL,r.response,{status:r.status,statusText:r.statusText,headers:h(r.getAllResponseHeaders())}));break;case"timeout":o(new n);break;case"abort":o(new s)}};r.onerror=a,r.onload=a,r.ontimeout=a,r.onabort=a,r.send(t.body)}))})(e,t):l(e,t),Request:o,Headers:a}},20757:e=>{"use strict";var t=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i;e.exports=function(e,r){if(null==r&&(r=!1),e.length<2)return!1;if(e.length>255)return!1;var n=e[e.length-1];if(r){if("."!==n)return!1}else if("."===n)return!1;return t.test(e)}},78814:e=>{"use strict";e.exports={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:8,RTLD_LOCAL:4,E2BIG:7,EACCES:13,EADDRINUSE:48,EADDRNOTAVAIL:49,EAFNOSUPPORT:47,EAGAIN:35,EALREADY:37,EBADF:9,EBADMSG:94,EBUSY:16,ECANCELED:89,ECHILD:10,ECONNABORTED:53,ECONNREFUSED:61,ECONNRESET:54,EDEADLK:11,EDESTADDRREQ:39,EDOM:33,EDQUOT:69,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:65,EIDRM:90,EILSEQ:92,EINPROGRESS:36,EINTR:4,EINVAL:22,EIO:5,EISCONN:56,EISDIR:21,ELOOP:62,EMFILE:24,EMLINK:31,EMSGSIZE:40,EMULTIHOP:95,ENAMETOOLONG:63,ENETDOWN:50,ENETRESET:52,ENETUNREACH:51,ENFILE:23,ENOBUFS:55,ENODATA:96,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:77,ENOLINK:97,ENOMEM:12,ENOMSG:91,ENOPROTOOPT:42,ENOSPC:28,ENOSR:98,ENOSTR:99,ENOSYS:78,ENOTCONN:57,ENOTDIR:20,ENOTEMPTY:66,ENOTSOCK:38,ENOTSUP:45,ENOTTY:25,ENXIO:6,EOPNOTSUPP:102,EOVERFLOW:84,EPERM:1,EPIPE:32,EPROTO:100,EPROTONOSUPPORT:43,EPROTOTYPE:41,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:70,ETIME:101,ETIMEDOUT:60,ETXTBSY:26,EWOULDBLOCK:35,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:10,SIGFPE:8,SIGKILL:9,SIGUSR1:30,SIGSEGV:11,SIGUSR2:31,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:20,SIGCONT:19,SIGSTOP:17,SIGTSTP:18,SIGTTIN:21,SIGTTOU:22,SIGURG:16,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:23,SIGINFO:29,SIGSYS:12,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:512,O_EXCL:2048,UV_FS_O_FILEMAP:0,O_NOCTTY:131072,O_TRUNC:1024,O_APPEND:8,O_DIRECTORY:1048576,O_NOFOLLOW:256,O_SYNC:128,O_DSYNC:4194304,O_SYMLINK:2097152,O_NONBLOCK:4,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:269488383,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}},26665:(e,t,r)=>{"use strict";const n=r(68239),{EventEmitter:s}=r(3894);function i(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0,n=e.length;r<n;++r)if(e[r]!==t[r])return!1;return!0}function o(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array")}class a extends s{constructor(e={}){super(),this.localNodeId=e.localNodeId||n(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||a.distance,this.arbiter=e.arbiter||a.arbiter,this.metadata=Object.assign({},e.metadata),o("option.localNodeId as parameter 1",this.localNodeId),this.root={contacts:[],dontSplit:!1,left:null,right:null}}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let r=0,n=0;const s=Math.min(e.length,t.length),i=Math.max(e.length,t.length);for(;n<s;++n)r=256*r+(e[n]^t[n]);for(;n<i;++n)r=256*r+255;return r}add(e){o("contact.id",(e||{}).id);let t=0,r=this.root;for(;null===r.contacts;)r=this._determineNode(r,e.id,t++);const n=this._indexOf(r,e.id);return n>=0?(this._update(r,n,e),this):r.contacts.length<this.numberOfNodesPerKBucket?(r.contacts.push(e),this.emit("added",e),this):r.dontSplit?(this.emit("ping",r.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(r,t),this.add(e))}closest(e,t=1/0){if(o("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let r=[];for(let n=[this.root],s=0;n.length>0&&r.length<t;){const t=n.pop();if(null===t.contacts){const r=this._determineNode(t,e,s++);n.push(t.left===r?t.right:t.left),n.push(r)}else r=r.concat(t.contacts)}return r.map((t=>[this.distance(t.id,e),t])).sort(((e,t)=>e[0]-t[0])).slice(0,t).map((e=>e[1]))}count(){let e=0;for(const t=[this.root];t.length>0;){const r=t.pop();null===r.contacts?t.push(r.right,r.left):e+=r.contacts.length}return e}_determineNode(e,t,r){const n=r>>3,s=r%8;return t.length<=n&&0!==s?e.left:t[n]&1<<7-s?e.right:e.left}get(e){o("id",e);let t=0,r=this.root;for(;null===r.contacts;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);return n>=0?r.contacts[n]:null}_indexOf(e,t){for(let r=0;r<e.contacts.length;++r)if(i(e.contacts[r].id,t))return r;return-1}remove(e){o("the id as parameter 1",e);let t=0,r=this.root;for(;null===r.contacts;)r=this._determineNode(r,e,t++);const n=this._indexOf(r,e);if(n>=0){const e=r.contacts.splice(n,1)[0];this.emit("removed",e)}return this}_split(e,t){e.left={contacts:[],dontSplit:!1,left:null,right:null},e.right={contacts:[],dontSplit:!1,left:null,right:null};for(const r of e.contacts)this._determineNode(e,r.id,t).contacts.push(r);e.contacts=null;const r=this._determineNode(e,this.localNodeId,t);(e.left===r?e.right:e.left).dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const r=t.pop();null===r.contacts?t.push(r.right,r.left):e=e.concat(r.contacts)}return e}*toIterable(){for(const e=[this.root];e.length>0;){const t=e.pop();null===t.contacts?e.push(t.right,t.left):yield*t.contacts}}_update(e,t,r){if(!i(e.contacts[t].id,r.id))throw new Error("wrong index for _update");const n=e.contacts[t],s=this.arbiter(n,r);s===n&&n!==r||(e.contacts.splice(t,1),e.contacts.push(s),this.emit("updated",n,s))}}e.exports=a},28976:(e,t)=>{"use strict";t.supports=function(...e){const t=e.reduce(((e,t)=>Object.assign(e,t)),{});return Object.assign(t,{snapshots:t.snapshots||!1,permanence:t.permanence||!1,seek:t.seek||!1,clear:t.clear||!1,getMany:t.getMany||!1,keyIterator:t.keyIterator||!1,valueIterator:t.valueIterator||!1,iteratorNextv:t.iteratorNextv||!1,iteratorAll:t.iteratorAll||!1,status:t.status||!1,createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,deferredOpen:t.deferredOpen||!1,promises:t.promises||!1,streams:t.streams||!1,encodings:Object.assign({},t.encodings),events:Object.assign({},t.events),additionalMethods:Object.assign({},t.additionalMethods)})}},29893:(e,t,r)=>{"use strict";const n=r(39296),s=r(94697),{Encoding:i}=r(2333),{BufferFormat:o,ViewFormat:a,UTF8Format:c}=r(50396),l=Symbol("formats"),h=Symbol("encodings"),d=new Set(["buffer","view","utf8"]);t.Transcoder=class{constructor(e){if(!Array.isArray(e))throw new TypeError("The first argument 'formats' must be an array");if(!e.every((e=>d.has(e))))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'");this[h]=new Map,this[l]=new Set(e);for(const e in s)try{this.encoding(e)}catch(e){if("LEVEL_ENCODING_NOT_SUPPORTED"!==e.code)throw e}}encodings(){return Array.from(new Set(this[h].values()))}encoding(e){let t=this[h].get(e);if(void 0===t){if("string"==typeof e&&""!==e){if(t=p[e],!t)throw new n(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if("object"!=typeof e||null===e)throw new TypeError("First argument 'encoding' must be a string or object");t=function(e){if(e instanceof i)return e;const t="type"in e&&"string"==typeof e.type?e.type:void 0,r=e.name||t||"anonymous-"+f++;switch(function(e){return"format"in e&&void 0!==e.format?e.format:"buffer"in e&&"boolean"==typeof e.buffer?e.buffer?"buffer":"utf8":"code"in e&&Number.isInteger(e.code)?"view":"buffer"}(e)){case"view":return new a({...e,name:r});case"utf8":return new c({...e,name:r});case"buffer":return new o({...e,name:r});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}(e)}const{name:r,format:s}=t;if(!this[l].has(s))if(this[l].has("view"))t=t.createViewTranscoder();else if(this[l].has("buffer"))t=t.createBufferTranscoder();else{if(!this[l].has("utf8"))throw new n(`Encoding '${r}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});t=t.createUTF8Transcoder()}for(const n of[e,r,t.name,t.commonName])this[h].set(n,t)}return t}};const u={binary:s.buffer,"utf-8":s.utf8},p={...s,...u};let f=0},2333:(e,t,r)=>{"use strict";const n=r(39296),s=new Set(["buffer","view","utf8"]);t.Encoding=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,"function"!=typeof this.encode)throw new TypeError("The 'encode' property must be a function");if("function"!=typeof this.decode)throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),"string"!=typeof this.name||""===this.name)throw new TypeError("The 'name' property must be a string");if("string"!=typeof this.format||!s.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new n(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new n(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new n(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}}},94697:(e,t,r)=>{"use strict";const{Buffer:n}=r(83107)||{Buffer:{isBuffer:()=>!1}},{textEncoder:s,textDecoder:i}=r(58833)(),{BufferFormat:o,ViewFormat:a,UTF8Format:c}=r(50396),l=e=>e;t.utf8=new c({encode:function(e){return n.isBuffer(e)?e.toString("utf8"):ArrayBuffer.isView(e)?i.decode(e):String(e)},decode:l,name:"utf8",createViewTranscoder(){return new a({encode:function(e){return ArrayBuffer.isView(e)?e:s.encode(e)},decode:function(e){return i.decode(e)},name:`${this.name}+view`})},createBufferTranscoder(){return new o({encode:function(e){return n.isBuffer(e)?e:ArrayBuffer.isView(e)?n.from(e.buffer,e.byteOffset,e.byteLength):n.from(String(e),"utf8")},decode:function(e){return e.toString("utf8")},name:`${this.name}+buffer`})}}),t.json=new c({encode:JSON.stringify,decode:JSON.parse,name:"json"}),t.buffer=new o({encode:function(e){return n.isBuffer(e)?e:ArrayBuffer.isView(e)?n.from(e.buffer,e.byteOffset,e.byteLength):n.from(String(e),"utf8")},decode:l,name:"buffer",createViewTranscoder(){return new a({encode:function(e){return ArrayBuffer.isView(e)?e:n.from(String(e),"utf8")},decode:function(e){return n.from(e.buffer,e.byteOffset,e.byteLength)},name:`${this.name}+view`})}}),t.view=new a({encode:function(e){return ArrayBuffer.isView(e)?e:s.encode(e)},decode:l,name:"view",createBufferTranscoder(){return new o({encode:function(e){return n.isBuffer(e)?e:ArrayBuffer.isView(e)?n.from(e.buffer,e.byteOffset,e.byteLength):n.from(String(e),"utf8")},decode:l,name:`${this.name}+buffer`})}}),t.hex=new o({encode:function(e){return n.isBuffer(e)?e:n.from(String(e),"hex")},decode:function(e){return e.toString("hex")},name:"hex"}),t.base64=new o({encode:function(e){return n.isBuffer(e)?e:n.from(String(e),"base64")},decode:function(e){return e.toString("base64")},name:"base64"})},50396:(e,t,r)=>{"use strict";const{Buffer:n}=r(83107)||{},{Encoding:s}=r(2333),i=r(58833);class o extends s{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new a({encode:this.encode,decode:e=>this.decode(n.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}}class a extends s{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new o({encode:e=>{const t=this.encode(e);return n.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}}t.BufferFormat=o,t.ViewFormat=a,t.UTF8Format=class extends s{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new o({encode:e=>n.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=i();return new a({encode:t=>e.encode(this.encode(t)),decode:e=>this.decode(t.decode(e)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}}},58833:e=>{"use strict";let t=null;e.exports=function(){return null===t&&(t={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),t}},35562:(e,t,r)=>{t.Level=r(68274).BrowserLevel},39296:e=>{"use strict";e.exports=class extends Error{constructor(e,t){super(e||""),"object"==typeof t&&null!==t&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}},11042:(e,t,r)=>{e.exports=r(16822)},16822:function(e,t){!function(r,n){"use strict";var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(e){if(!Array.isArray(e)&&!ArrayBuffer.isView(e))return!1;for(var t=0;t<e.length;t++)if(!Number.isInteger(e[t])||e[t]<0||e[t]>255)return!1;return!0}function o(e,t){return(65535&e)*t+(((e>>>16)*t&65535)<<16)}function a(e,t){return e<<t|e>>>32-t}function c(e){return e=o(e^=e>>>16,2246822507),(e=o(e^=e>>>13,3266489909))^e>>>16}function l(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var r=[0,0,0,0];return r[3]+=e[3]+t[3],r[2]+=r[3]>>>16,r[3]&=65535,r[2]+=e[2]+t[2],r[1]+=r[2]>>>16,r[2]&=65535,r[1]+=e[1]+t[1],r[0]+=r[1]>>>16,r[1]&=65535,r[0]+=e[0]+t[0],r[0]&=65535,[r[0]<<16|r[1],r[2]<<16|r[3]]}function h(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var r=[0,0,0,0];return r[3]+=e[3]*t[3],r[2]+=r[3]>>>16,r[3]&=65535,r[2]+=e[2]*t[3],r[1]+=r[2]>>>16,r[2]&=65535,r[2]+=e[3]*t[2],r[1]+=r[2]>>>16,r[2]&=65535,r[1]+=e[1]*t[3],r[0]+=r[1]>>>16,r[1]&=65535,r[1]+=e[2]*t[2],r[0]+=r[1]>>>16,r[1]&=65535,r[1]+=e[3]*t[1],r[0]+=r[1]>>>16,r[1]&=65535,r[0]+=e[0]*t[3]+e[1]*t[2]+e[2]*t[1]+e[3]*t[0],r[0]&=65535,[r[0]<<16|r[1],r[2]<<16|r[3]]}function d(e,t){return 32==(t%=64)?[e[1],e[0]]:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t|e[0]>>>32-t]:(t-=32,[e[1]<<t|e[0]>>>32-t,e[0]<<t|e[1]>>>32-t])}function u(e,t){return 0==(t%=64)?e:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t]:[e[1]<<t-32,0]}function p(e,t){return[e[0]^t[0],e[1]^t[1]]}function f(e){return e=p(e,[0,e[0]>>>1]),e=p(e=h(e,[4283543511,3981806797]),[0,e[0]>>>1]),p(e=h(e,[3301882366,444984403]),[0,e[0]>>>1])}s.x86.hash32=function(e,t){if(s.inputValidation&&!i(e))return n;t=t||0;for(var r=e.length%4,l=e.length-r,h=t,d=0,u=3432918353,p=461845907,f=0;f<l;f+=4)d=o(d=e[f]|e[f+1]<<8|e[f+2]<<16|e[f+3]<<24,u),d=o(d=a(d,15),p),h=o(h=a(h^=d,13),5)+3864292196;switch(d=0,r){case 3:d^=e[f+2]<<16;case 2:d^=e[f+1]<<8;case 1:d=o(d^=e[f],u),h^=d=o(d=a(d,15),p)}return(h=c(h^=e.length))>>>0},s.x86.hash128=function(e,t){if(s.inputValidation&&!i(e))return n;t=t||0;for(var r=e.length%16,l=e.length-r,h=t,d=t,u=t,p=t,f=0,g=0,y=0,m=0,w=597399067,b=2869860233,_=951274213,E=2716044179,v=0;v<l;v+=16)f=e[v]|e[v+1]<<8|e[v+2]<<16|e[v+3]<<24,g=e[v+4]|e[v+5]<<8|e[v+6]<<16|e[v+7]<<24,y=e[v+8]|e[v+9]<<8|e[v+10]<<16|e[v+11]<<24,m=e[v+12]|e[v+13]<<8|e[v+14]<<16|e[v+15]<<24,f=a(f=o(f,w),15),h=a(h^=f=o(f,b),19),h=o(h+=d,5)+1444728091,g=a(g=o(g,b),16),d=a(d^=g=o(g,_),17),d=o(d+=u,5)+197830471,y=a(y=o(y,_),17),u=a(u^=y=o(y,E),15),u=o(u+=p,5)+2530024501,m=a(m=o(m,E),18),p=a(p^=m=o(m,w),13),p=o(p+=h,5)+850148119;switch(f=0,g=0,y=0,m=0,r){case 15:m^=e[v+14]<<16;case 14:m^=e[v+13]<<8;case 13:m=o(m^=e[v+12],E),p^=m=o(m=a(m,18),w);case 12:y^=e[v+11]<<24;case 11:y^=e[v+10]<<16;case 10:y^=e[v+9]<<8;case 9:y=o(y^=e[v+8],_),u^=y=o(y=a(y,17),E);case 8:g^=e[v+7]<<24;case 7:g^=e[v+6]<<16;case 6:g^=e[v+5]<<8;case 5:g=o(g^=e[v+4],b),d^=g=o(g=a(g,16),_);case 4:f^=e[v+3]<<24;case 3:f^=e[v+2]<<16;case 2:f^=e[v+1]<<8;case 1:f=o(f^=e[v],w),h^=f=o(f=a(f,15),b)}return h^=e.length,h+=d^=e.length,h+=u^=e.length,d+=h+=p^=e.length,u+=h,p+=h,h=c(h),h+=d=c(d),h+=u=c(u),d+=h+=p=c(p),u+=h,p+=h,("00000000"+(h>>>0).toString(16)).slice(-8)+("00000000"+(d>>>0).toString(16)).slice(-8)+("00000000"+(u>>>0).toString(16)).slice(-8)+("00000000"+(p>>>0).toString(16)).slice(-8)},s.x64.hash128=function(e,t){if(s.inputValidation&&!i(e))return n;t=t||0;for(var r=e.length%16,o=e.length-r,a=[0,t],c=[0,t],g=[0,0],y=[0,0],m=[2277735313,289559509],w=[1291169091,658871167],b=0;b<o;b+=16)g=[e[b+4]|e[b+5]<<8|e[b+6]<<16|e[b+7]<<24,e[b]|e[b+1]<<8|e[b+2]<<16|e[b+3]<<24],y=[e[b+12]|e[b+13]<<8|e[b+14]<<16|e[b+15]<<24,e[b+8]|e[b+9]<<8|e[b+10]<<16|e[b+11]<<24],g=d(g=h(g,m),31),a=l(a=d(a=p(a,g=h(g,w)),27),c),a=l(h(a,[0,5]),[0,1390208809]),y=d(y=h(y,w),33),c=l(c=d(c=p(c,y=h(y,m)),31),a),c=l(h(c,[0,5]),[0,944331445]);switch(g=[0,0],y=[0,0],r){case 15:y=p(y,u([0,e[b+14]],48));case 14:y=p(y,u([0,e[b+13]],40));case 13:y=p(y,u([0,e[b+12]],32));case 12:y=p(y,u([0,e[b+11]],24));case 11:y=p(y,u([0,e[b+10]],16));case 10:y=p(y,u([0,e[b+9]],8));case 9:y=h(y=p(y,[0,e[b+8]]),w),c=p(c,y=h(y=d(y,33),m));case 8:g=p(g,u([0,e[b+7]],56));case 7:g=p(g,u([0,e[b+6]],48));case 6:g=p(g,u([0,e[b+5]],40));case 5:g=p(g,u([0,e[b+4]],32));case 4:g=p(g,u([0,e[b+3]],24));case 3:g=p(g,u([0,e[b+2]],16));case 2:g=p(g,u([0,e[b+1]],8));case 1:g=h(g=p(g,[0,e[b]]),m),a=p(a,g=h(g=d(g,31),w))}return a=l(a=p(a,[0,e.length]),c=p(c,[0,e.length])),c=l(c,a),a=l(a=f(a),c=f(c)),c=l(c,a),("00000000"+(a[0]>>>0).toString(16)).slice(-8)+("00000000"+(a[1]>>>0).toString(16)).slice(-8)+("00000000"+(c[0]>>>0).toString(16)).slice(-8)+("00000000"+(c[1]>>>0).toString(16)).slice(-8)},e.exports&&(t=e.exports=s),t.murmurHash3=s}()},97975:e=>{"use strict";function t(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}e.exports=function(e){var r=void 0,n=void 0;function s(e){if(!(e instanceof Object))throw new Error('Target "'+e+'" is not an object');n=e}function i(e){Object.keys(e).forEach((function(t){var r=e[t];if("function"!=typeof r)throw new Error('Trap "'+t+": "+r+'" is not a function');if(!Reflect[t])throw new Error('Trap "'+t+": "+r+'" is not a valid trap')})),r=e}s((function(){})),e&&s(e),i(Reflect);var o=new Proxy({},{get:function(e,s){return function(){for(var e=arguments.length,i=Array(e),o=0;o<e;o++)i[o]=arguments[o];return r[s].apply(null,[n].concat(t(i.slice(1))))}}});return{setTarget:s,setHandler:i,getTarget:function(){return n},getHandler:function(){return r},proxy:new Proxy(n,o)}}},81661:(e,t,r)=>{"use strict";globalThis.fetch&&globalThis.Headers&&globalThis.Request&&globalThis.Response?e.exports={default:globalThis.fetch,Headers:globalThis.Headers,Request:globalThis.Request,Response:globalThis.Response}:e.exports={default:r(52515).default,Headers:r(52515).Headers,Request:r(52515).Request,Response:r(52515).Response}},52515:(e,t)=>{"use strict";var r=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==r)return r;throw new Error("unable to locate global object")}();e.exports=t=r.fetch,r.fetch&&(t.default=r.fetch.bind(r)),t.Headers=r.Headers,t.Request=r.Request,t.Response=r.Response},39026:(e,t,r)=>{"use strict";e.exports=r(43228)},43228:(e,t,r)=>{"use strict";var n=t;function s(){n.util._configure(),n.Writer._configure(n.BufferWriter),n.Reader._configure(n.BufferReader)}n.build="minimal",n.Writer=r(74374),n.BufferWriter=r(71913),n.Reader=r(6418),n.BufferReader=r(42250),n.util=r(96259),n.rpc=r(45260),n.roots=r(11497),n.configure=s,s()},11497:e=>{"use strict";e.exports={}},45260:(e,t,r)=>{"use strict";t.Service=r(34245)},34245:(e,t,r)=>{"use strict";e.exports=s;var n=r(96259);function s(e,t,r){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");n.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(r)}(s.prototype=Object.create(n.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,r,s,i,o){if(!i)throw TypeError("request must be specified");var a=this;if(!o)return n.asPromise(e,a,t,r,s,i);if(a.rpcImpl)try{return a.rpcImpl(t,r[a.requestDelimited?"encodeDelimited":"encode"](i).finish(),(function(e,r){if(e)return a.emit("error",e,t),o(e);if(null!==r){if(!(r instanceof s))try{r=s[a.responseDelimited?"decodeDelimited":"decode"](r)}catch(e){return a.emit("error",e,t),o(e)}return a.emit("data",r,t),o(null,r)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){o(e)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},94715:(e,t,r)=>{let n;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:r.g):e=>(n||(n=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))},45125:(e,t,r)=>{const{instantiate:n}=r(12200);function s(e={}){if(!s.supported)return null;var t=new Uint8Array([0,97,115,109,1,0,0,0,1,78,14,96,2,127,126,0,96,1,127,1,126,96,2,127,127,0,96,1,127,1,127,96,1,127,0,96,2,127,127,1,127,96,3,127,127,127,1,127,96,0,0,96,3,127,127,127,0,96,0,1,127,96,4,127,127,127,127,0,96,5,127,127,127,127,127,1,127,96,1,126,1,127,96,2,126,126,1,126,2,13,1,3,101,110,118,5,97,98,111,114,116,0,10,3,54,53,2,2,8,9,3,5,2,8,6,5,3,4,2,6,9,12,13,2,5,11,3,2,3,2,3,2,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,6,7,7,4,4,5,3,1,0,1,6,47,9,127,1,65,0,11,127,1,65,0,11,127,0,65,3,11,127,0,65,4,11,127,1,65,0,11,127,1,65,0,11,127,1,65,0,11,127,0,65,240,2,11,127,0,65,6,11,7,240,5,41,6,109,101,109,111,114,121,2,0,7,95,95,97,108,108,111,99,0,10,8,95,95,114,101,116,97,105,110,0,11,9,95,95,114,101,108,101,97,115,101,0,12,9,95,95,99,111,108,108,101,99,116,0,51,11,95,95,114,116,116,105,95,98,97,115,101,3,7,13,73,110,116,51,50,65,114,114,97,121,95,73,68,3,2,13,85,105,110,116,56,65,114,114,97,121,95,73,68,3,3,6,100,101,103,114,101,101,0,16,3,109,111,100,0,17,5,82,97,98,105,110,3,8,16,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,0,21,16,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,0,22,21,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,23,21,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,24,14,82,97,98,105,110,35,103,101,116,58,119,112,111,115,0,25,14,82,97,98,105,110,35,115,101,116,58,119,112,111,115,0,26,15,82,97,98,105,110,35,103,101,116,58,99,111,117,110,116,0,27,15,82,97,98,105,110,35,115,101,116,58,99,111,117,110,116,0,28,13,82,97,98,105,110,35,103,101,116,58,112,111,115,0,29,13,82,97,98,105,110,35,115,101,116,58,112,111,115,0,30,15,82,97,98,105,110,35,103,101,116,58,115,116,97,114,116,0,31,15,82,97,98,105,110,35,115,101,116,58,115,116,97,114,116,0,32,16,82,97,98,105,110,35,103,101,116,58,100,105,103,101,115,116,0,33,16,82,97,98,105,110,35,115,101,116,58,100,105,103,101,115,116,0,34,21,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,35,21,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,36,22,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,37,22,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,38,31,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,39,31,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,40,20,82,97,98,105,110,35,103,101,116,58,112,111,108,121,110,111,109,105,97,108,0,41,20,82,97,98,105,110,35,115,101,116,58,112,111,108,121,110,111,109,105,97,108,0,42,17,82,97,98,105,110,35,103,101,116,58,109,105,110,115,105,122,101,0,43,17,82,97,98,105,110,35,115,101,116,58,109,105,110,115,105,122,101,0,44,17,82,97,98,105,110,35,103,101,116,58,109,97,120,115,105,122,101,0,45,17,82,97,98,105,110,35,115,101,116,58,109,97,120,115,105,122,101,0,46,14,82,97,98,105,110,35,103,101,116,58,109,97,115,107,0,47,14,82,97,98,105,110,35,115,101,116,58,109,97,115,107,0,48,17,82,97,98,105,110,35,99,111,110,115,116,114,117,99,116,111,114,0,20,17,82,97,98,105,110,35,102,105,110,103,101,114,112,114,105,110,116,0,49,8,1,50,10,165,31,53,199,1,1,4,127,32,1,40,2,0,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,3,65,4,107,118,65,16,115,33,4,32,3,65,7,107,11,33,3,32,1,40,2,20,33,2,32,1,40,2,16,34,5,4,64,32,5,32,2,54,2,20,11,32,2,4,64,32,2,32,5,54,2,16,11,32,1,32,0,32,4,32,3,65,4,116,106,65,2,116,106,40,2,96,70,4,64,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,2,54,2,96,32,2,69,4,64,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,65,127,115,113,34,1,54,2,4,32,1,69,4,64,32,0,32,0,40,2,0,65,1,32,3,116,65,127,115,113,54,2,0,11,11,11,11,226,2,1,6,127,32,1,40,2,0,33,3,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,34,5,65,1,113,4,64,32,3,65,124,113,65,16,106,32,5,65,124,113,106,34,2,65,240,255,255,255,3,73,4,64,32,0,32,4,16,1,32,1,32,2,32,3,65,3,113,114,34,3,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,33,5,11,11,32,3,65,2,113,4,64,32,1,65,4,107,40,2,0,34,2,40,2,0,34,6,65,124,113,65,16,106,32,3,65,124,113,106,34,7,65,240,255,255,255,3,73,4,64,32,0,32,2,16,1,32,2,32,7,32,6,65,3,113,114,34,3,54,2,0,32,2,33,1,11,11,32,4,32,5,65,2,114,54,2,0,32,4,65,4,107,32,1,54,2,0,32,0,32,3,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,2,65,4,107,118,65,16,115,33,4,32,2,65,7,107,11,34,3,65,4,116,32,4,106,65,2,116,106,40,2,96,33,2,32,1,65,0,54,2,16,32,1,32,2,54,2,20,32,2,4,64,32,2,32,1,54,2,16,11,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,1,54,2,96,32,0,32,0,40,2,0,65,1,32,3,116,114,54,2,0,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,114,54,2,4,11,119,1,1,127,32,2,2,127,32,0,40,2,160,12,34,2,4,64,32,2,32,1,65,16,107,70,4,64,32,2,40,2,0,33,3,32,1,65,16,107,33,1,11,11,32,1,11,107,34,2,65,48,73,4,64,15,11,32,1,32,3,65,2,113,32,2,65,32,107,65,1,114,114,54,2,0,32,1,65,0,54,2,16,32,1,65,0,54,2,20,32,1,32,2,106,65,16,107,34,2,65,2,54,2,0,32,0,32,2,54,2,160,12,32,0,32,1,16,2,11,155,1,1,3,127,35,0,34,0,69,4,64,65,1,63,0,34,0,74,4,127,65,1,32,0,107,64,0,65,0,72,5,65,0,11,4,64,0,11,65,176,3,34,0,65,0,54,2,0,65,208,15,65,0,54,2,0,3,64,32,1,65,23,73,4,64,32,1,65,2,116,65,176,3,106,65,0,54,2,4,65,0,33,2,3,64,32,2,65,16,73,4,64,32,1,65,4,116,32,2,106,65,2,116,65,176,3,106,65,0,54,2,96,32,2,65,1,106,33,2,12,1,11,11,32,1,65,1,106,33,1,12,1,11,11,65,176,3,65,224,15,63,0,65,16,116,16,3,65,176,3,36,0,11,32,0,11,45,0,32,0,65,240,255,255,255,3,79,4,64,65,32,65,224,0,65,201,3,65,29,16,0,0,11,32,0,65,15,106,65,112,113,34,0,65,16,32,0,65,16,75,27,11,169,1,1,1,127,32,0,32,1,65,128,2,73,4,127,32,1,65,4,118,33,1,65,0,5,32,1,65,248,255,255,255,1,73,4,64,32,1,65,1,65,27,32,1,103,107,116,106,65,1,107,33,1,11,32,1,65,31,32,1,103,107,34,2,65,4,107,118,65,16,115,33,1,32,2,65,7,107,11,34,2,65,2,116,106,40,2,4,65,127,32,1,116,113,34,1,4,127,32,0,32,1,104,32,2,65,4,116,106,65,2,116,106,40,2,96,5,32,0,40,2,0,65,127,32,2,65,1,106,116,113,34,1,4,127,32,0,32,0,32,1,104,34,0,65,2,116,106,40,2,4,104,32,0,65,4,116,106,65,2,116,106,40,2,96,5,65,0,11,11,11,111,1,1,127,63,0,34,2,32,1,65,248,255,255,255,1,73,4,127,32,1,65,1,65,27,32,1,103,107,116,65,1,107,106,5,32,1,11,65,16,32,0,40,2,160,12,32,2,65,16,116,65,16,107,71,116,106,65,255,255,3,106,65,128,128,124,113,65,16,118,34,1,32,2,32,1,74,27,64,0,65,0,72,4,64,32,1,64,0,65,0,72,4,64,0,11,11,32,0,32,2,65,16,116,63,0,65,16,116,16,3,11,113,1,2,127,32,1,40,2,0,34,3,65,124,113,32,2,107,34,4,65,32,79,4,64,32,1,32,2,32,3,65,2,113,114,54,2,0,32,2,32,1,65,16,106,106,34,1,32,4,65,16,107,65,1,114,54,2,0,32,0,32,1,16,2,5,32,1,32,3,65,126,113,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,32,1,65,16,106,32,1,40,2,0,65,124,113,106,40,2,0,65,125,113,54,2,0,11,11,91,1,2,127,32,0,32,1,16,5,34,4,16,6,34,3,69,4,64,65,1,36,1,65,0,36,1,32,0,32,4,16,6,34,3,69,4,64,32,0,32,4,16,7,32,0,32,4,16,6,33,3,11,11,32,3,65,0,54,2,4,32,3,32,2,54,2,8,32,3,32,1,54,2,12,32,0,32,3,16,1,32,0,32,3,32,4,16,8,32,3,11,13,0,16,4,32,0,32,1,16,9,65,16,106,11,33,1,1,127,32,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,18,0,32,0,65,172,3,75,4,64,32,0,65,16,107,16,52,11,11,140,3,1,1,127,2,64,32,1,69,13,0,32,0,65,0,58,0,0,32,0,32,1,106,65,1,107,65,0,58,0,0,32,1,65,2,77,13,0,32,0,65,1,106,65,0,58,0,0,32,0,65,2,106,65,0,58,0,0,32,0,32,1,106,34,2,65,2,107,65,0,58,0,0,32,2,65,3,107,65,0,58,0,0,32,1,65,6,77,13,0,32,0,65,3,106,65,0,58,0,0,32,0,32,1,106,65,4,107,65,0,58,0,0,32,1,65,8,77,13,0,32,1,65,0,32,0,107,65,3,113,34,1,107,33,2,32,0,32,1,106,34,0,65,0,54,2,0,32,0,32,2,65,124,113,34,1,106,65,4,107,65,0,54,2,0,32,1,65,8,77,13,0,32,0,65,4,106,65,0,54,2,0,32,0,65,8,106,65,0,54,2,0,32,0,32,1,106,34,2,65,12,107,65,0,54,2,0,32,2,65,8,107,65,0,54,2,0,32,1,65,24,77,13,0,32,0,65,12,106,65,0,54,2,0,32,0,65,16,106,65,0,54,2,0,32,0,65,20,106,65,0,54,2,0,32,0,65,24,106,65,0,54,2,0,32,0,32,1,106,34,2,65,28,107,65,0,54,2,0,32,2,65,24,107,65,0,54,2,0,32,2,65,20,107,65,0,54,2,0,32,2,65,16,107,65,0,54,2,0,32,0,32,0,65,4,113,65,24,106,34,2,106,33,0,32,1,32,2,107,33,1,3,64,32,1,65,32,79,4,64,32,0,66,0,55,3,0,32,0,65,8,106,66,0,55,3,0,32,0,65,16,106,66,0,55,3,0,32,0,65,24,106,66,0,55,3,0,32,1,65,32,107,33,1,32,0,65,32,106,33,0,12,1,11,11,11,11,178,1,1,3,127,32,1,65,240,255,255,255,3,32,2,118,75,4,64,65,144,1,65,192,1,65,23,65,56,16,0,0,11,32,1,32,2,116,34,3,65,0,16,10,34,2,32,3,16,13,32,0,69,4,64,65,12,65,2,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,2,34,1,32,0,40,2,0,34,4,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,32,4,16,12,11,32,0,32,1,54,2,0,32,0,32,2,54,2,4,32,0,32,3,54,2,8,32,0,11,46,1,2,127,65,12,65,5,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,65,128,2,65,3,16,14,11,9,0,65,63,32,0,121,167,107,11,49,1,2,127,65,63,32,1,121,167,107,33,2,3,64,65,63,32,0,121,167,107,32,2,107,34,3,65,0,78,4,64,32,0,32,1,32,3,172,134,133,33,0,12,1,11,11,32,0,11,40,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,163,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,65,0,58,0,0,11,38,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,152,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,45,0,0,11,254,5,2,1,127,4,126,32,0,69,4,64,65,232,0,65,6,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,24,32,0,66,0,55,3,32,32,0,66,0,55,3,40,32,0,66,0,55,3,48,32,0,66,0,55,3,56,32,0,66,0,55,3,64,32,0,66,0,55,3,72,32,0,66,0,55,3,80,32,0,66,0,55,3,88,32,0,66,0,55,3,96,32,0,32,2,173,55,3,80,32,0,32,3,173,55,3,88,65,12,65,4,16,10,34,2,65,172,3,75,4,64,32,2,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,32,4,65,0,16,14,33,2,32,0,40,2,0,16,12,32,0,32,2,54,2,0,32,0,32,4,54,2,4,32,0,66,1,32,1,173,134,66,1,125,55,3,96,32,0,66,243,130,183,218,216,230,232,30,55,3,72,35,4,69,4,64,65,0,33,2,3,64,32,2,65,128,2,72,4,64,32,2,65,255,1,113,173,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,65,0,33,4,3,64,32,4,32,0,40,2,4,65,1,107,72,4,64,32,6,66,8,134,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,32,4,65,1,106,33,4,12,1,11,11,35,6,40,2,4,32,2,65,3,116,106,32,6,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,63,32,0,41,3,72,121,167,107,172,33,7,65,0,33,2,3,64,32,2,65,128,2,72,4,64,35,5,33,1,32,2,172,32,7,134,34,8,33,6,65,63,32,0,41,3,72,34,9,121,167,107,33,3,3,64,65,63,32,6,121,167,107,32,3,107,34,4,65,0,78,4,64,32,6,32,9,32,4,172,134,133,33,6,12,1,11,11,32,1,40,2,4,32,2,65,3,116,106,32,6,32,8,132,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,1,36,4,11,32,0,66,0,55,3,24,32,0,66,0,55,3,32,65,0,33,2,3,64,32,2,32,0,40,2,4,72,4,64,32,0,40,2,0,32,2,16,18,32,2,65,1,106,33,2,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,6,66,45,136,167,65,3,116,106,41,3,0,32,6,66,8,134,66,1,132,133,55,3,40,32,0,11,38,1,1,127,32,0,40,2,0,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,55,1,2,127,32,1,32,0,40,2,0,34,2,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,16,12,11,32,0,32,1,54,2,0,11,7,0,32,0,40,2,4,11,9,0,32,0,32,1,54,2,4,11,7,0,32,0,40,2,8,11,9,0,32,0,32,1,54,2,8,11,7,0,32,0,41,3,16,11,9,0,32,0,32,1,55,3,16,11,7,0,32,0,41,3,24,11,9,0,32,0,32,1,55,3,24,11,7,0,32,0,41,3,32,11,9,0,32,0,32,1,55,3,32,11,7,0,32,0,41,3,40,11,9,0,32,0,32,1,55,3,40,11,7,0,32,0,41,3,48,11,9,0,32,0,32,1,55,3,48,11,7,0,32,0,41,3,56,11,9,0,32,0,32,1,55,3,56,11,7,0,32,0,41,3,64,11,9,0,32,0,32,1,55,3,64,11,7,0,32,0,41,3,72,11,9,0,32,0,32,1,55,3,72,11,7,0,32,0,41,3,80,11,9,0,32,0,32,1,55,3,80,11,7,0,32,0,41,3,88,11,9,0,32,0,32,1,55,3,88,11,7,0,32,0,41,3,96,11,9,0,32,0,32,1,55,3,96,11,172,4,2,5,127,1,126,32,2,65,172,3,75,4,64,32,2,65,16,107,34,4,32,4,40,2,4,65,1,106,54,2,4,11,32,2,33,4,65,0,33,2,32,1,40,2,8,33,5,32,1,40,2,4,33,6,3,64,2,127,65,0,33,3,3,64,32,3,32,5,72,4,64,32,3,32,6,106,45,0,0,33,1,32,0,40,2,0,32,0,40,2,8,16,19,33,7,32,0,40,2,8,32,0,40,2,0,40,2,4,106,32,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,7,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,1,173,32,8,66,8,134,132,133,55,3,40,32,0,32,0,41,3,16,66,1,124,55,3,16,32,0,32,0,41,3,24,66,1,124,55,3,24,32,0,41,3,16,32,0,41,3,80,90,4,127,32,0,41,3,40,32,0,41,3,96,131,80,5,65,0,11,4,127,65,1,5,32,0,41,3,16,32,0,41,3,88,90,11,4,64,32,0,32,0,41,3,32,55,3,48,32,0,32,0,41,3,16,55,3,56,32,0,32,0,41,3,40,55,3,64,65,0,33,1,3,64,32,1,32,0,40,2,4,72,4,64,32,0,40,2,0,32,1,16,18,32,1,65,1,106,33,1,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,8,66,8,134,66,1,132,133,55,3,40,32,3,65,1,106,12,3,11,32,3,65,1,106,33,3,12,1,11,11,65,127,11,34,1,65,0,78,4,64,32,5,32,1,107,33,5,32,1,32,6,106,33,6,32,2,34,1,65,1,106,33,2,32,4,40,2,4,32,1,65,2,116,106,32,0,41,3,56,62,2,0,12,1,11,11,32,4,11,10,0,16,15,36,5,16,15,36,6,11,3,0,1,11,73,1,2,127,32,0,40,2,4,34,1,65,255,255,255,255,0,113,34,2,65,1,70,4,64,32,0,65,16,106,16,53,32,0,32,0,40,2,0,65,1,114,54,2,0,35,0,32,0,16,2,5,32,0,32,2,65,1,107,32,1,65,128,128,128,128,127,113,114,54,2,4,11,11,58,0,2,64,2,64,2,64,32,0,65,8,107,40,2,0,14,7,0,0,1,1,1,1,1,2,11,15,11,32,0,40,2,0,34,0,4,64,32,0,65,172,3,79,4,64,32,0,65,16,107,16,52,11,11,15,11,0,11,11,137,3,7,0,65,16,11,55,40,0,0,0,1,0,0,0,1,0,0,0,40,0,0,0,97,0,108,0,108,0,111,0,99,0,97,0,116,0,105,0,111,0,110,0,32,0,116,0,111,0,111,0,32,0,108,0,97,0,114,0,103,0,101,0,65,208,0,11,45,30,0,0,0,1,0,0,0,1,0,0,0,30,0,0,0,126,0,108,0,105,0,98,0,47,0,114,0,116,0,47,0,116,0,108,0,115,0,102,0,46,0,116,0,115,0,65,128,1,11,43,28,0,0,0,1,0,0,0,1,0,0,0,28,0,0,0,73,0,110,0,118,0,97,0,108,0,105,0,100,0,32,0,108,0,101,0,110,0,103,0,116,0,104,0,65,176,1,11,53,38,0,0,0,1,0,0,0,1,0,0,0,38,0,0,0,126,0,108,0,105,0,98,0,47,0,97,0,114,0,114,0,97,0,121,0,98,0,117,0,102,0,102,0,101,0,114,0,46,0,116,0,115,0,65,240,1,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,73,0,110,0,100,0,101,0,120,0,32,0,111,0,117,0,116,0,32,0,111,0,102,0,32,0,114,0,97,0,110,0,103,0,101,0,65,176,2,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,126,0,108,0,105,0,98,0,47,0,116,0,121,0,112,0,101,0,100,0,97,0,114,0,114,0,97,0,121,0,46,0,116,0,115,0,65,240,2,11,53,7,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,145,4,0,0,2,0,0,0,49,0,0,0,2,0,0,0,17,1,0,0,2,0,0,0,16,0,34,16,115,111,117,114,99,101,77,97,112,112,105,110,103,85,82,76,16,46,47,114,97,98,105,110,46,119,97,115,109,46,109,97,112]);return n(new Response(new Blob([t],{type:"application/wasm"})),e)}s.supported="undefined"!=typeof WebAssembly,e.exports=s},28232:(e,t,r)=>{const n=r(92673),s=r(45125);e.exports={Rabin:n,create:async(e,t,r,i,o)=>{const a=await s();return new n(a,e,t,r,i,o)}}},92673:e=>{e.exports=class{constructor(e,t=12,r=8192,n=32768,s=64,i){this.bits=t,this.min=r,this.max=n,this.asModule=e,this.rabin=new e.Rabin(t,r,n,s,i),this.polynomial=i}fingerprint(e){const{__retain:t,__release:r,__allocArray:n,__getInt32Array:s,Int32Array_ID:i,Uint8Array_ID:o}=this.asModule,a=t(n(i,new Int32Array(Math.ceil(e.length/this.min)))),c=t(n(o,e)),l=s(this.rabin.fingerprint(c,a));r(c),r(a);const h=l.indexOf(0);return h>=0?l.subarray(0,h):l}}},68239:(e,t,r)=>{"use strict";var n=r(46039),s=65536,i=r(62666).Buffer,o=r.g.crypto||r.g.msCrypto;o&&o.getRandomValues?e.exports=function(e,t){if(e>4294967295)throw new RangeError("requested too many random bytes");var r=i.allocUnsafe(e);if(e>0)if(e>s)for(var a=0;a<e;a+=s)o.getRandomValues(r.slice(a,a+s));else o.getRandomValues(r);return"function"==typeof t?n.nextTick((function(){t(null,r)})):r}:e.exports=function(){throw new Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}},25161:(e,t,r)=>{e.exports=function(e,t,r){if("number"!=typeof t)throw new Error("second argument must be a Number");let s,i,o,a,c,l,h=!0;function d(e){function t(){r&&r(e,s),r=null}h?n(t):t()}function u(t,r,n){if(s[t]=n,r&&(c=!0),0==--o||r)d(r);else if(!c&&l<i){let t;a?(t=a[l],l+=1,e[t]((function(e,r){u(t,e,r)}))):(t=l,l+=1,e[t]((function(e,r){u(t,e,r)})))}}Array.isArray(e)?(s=[],o=i=e.length):(a=Object.keys(e),s={},o=i=a.length),l=t,o?a?a.some((function(r,n){return e[r]((function(e,t){u(r,e,t)})),n===t-1})):e.some((function(e,r){return e((function(e,t){u(r,e,t)})),r===t-1})):d(null),h=!1};const n=r(94715)},62666:(e,t,r)=>{var n=r(83107),s=n.Buffer;function i(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return s(e,t,r)}s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?e.exports=n:(i(n,t),t.Buffer=o),o.prototype=Object.create(s.prototype),i(s,o),o.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return s(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=s(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return s(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},92891:e=>{"use strict";function t(e,t){return e+r(t)}function r(e){let t=e;return t-=t>>1&1431655765,t=(858993459&t)+(t>>2&858993459),16843009*(t+(t>>4)&252645135)>>24}function n(e,t){return e[0]-t[0]}function s(e){return e[1]}e.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let r=this._internalPositionFor(e,!1);if(void 0===t)-1!==r&&(this._unsetInternalPos(r),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let n=!1;-1===r?(r=this._data.length,this._setBit(e),this._changedData=!0):n=!0,this._setInternalPos(r,e,t,n),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(-1!==t)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,r=new Array(this.length);for(;t<this.length;)r[t]=e(this.get(t),t,this),t++;return r}reduce(e,t){let r=0,n=t;for(;r<this.length;)n=e(n,this.get(r),r),r++;return n}find(e){let t,r,n=0;for(;n<this.length&&!t;)r=this.get(n),t=e(r),n++;return t?r:void 0}_internalPositionFor(e,n){const s=this._bytePosFor(e,n);if(s>=this._bitArrays.length)return-1;const i=this._bitArrays[s],o=e-7*s;return(i&1<<o)>0?this._bitArrays.slice(0,s).reduce(t,0)+r(i&~(4294967295<<o+1))-1:-1}_bytePosFor(e,t){const r=Math.floor(e/7),n=r+1;for(;!t&&this._bitArrays.length<n;)this._bitArrays.push(0);return r}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-7*t}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-7*t)}_setInternalPos(e,t,r,n){const s=this._data,i=[t,r];if(n)this._sortData(),s[e]=i;else{if(s.length)if(s[s.length-1][0]>=t)s.push(i);else if(s[0][0]<=t)s.unshift(i);else{const e=Math.round(s.length/2);this._data=s.slice(0,e).concat(i).concat(s.slice(e))}else this._data.push(i);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(n),this._changedData=!1}bitField(){const e=[];let t,r=8,n=0,s=0;const i=this._bitArrays.slice();for(;i.length||n;){0===n&&(t=i.shift(),n=7);const o=Math.min(n,r);s|=(t&~(255<<o))<<8-r,t>>>=o,n-=o,r-=o,r&&(n||i.length)||(e.push(s),s=0,r=8)}for(var o=e.length-1;o>0&&0===e[o];o--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(s)}}},18901:e=>{e.exports=e=>{if(e[Symbol.asyncIterator])return e;if(e.getReader)return async function*(){const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)return;yield r}}finally{t.releaseLock()}}();throw new Error("unknown stream")}},77877:e=>{e.exports=function e(t,r){var n,s=0,i=0,o=r=r||0,a=t.length;do{if(o>=a)throw e.bytes=0,new RangeError("Could not decode varint");n=t[o++],s+=i<28?(127&n)<<i:(127&n)*Math.pow(2,i),i+=7}while(n>=128);return e.bytes=o-r,s}},96608:e=>{e.exports=function e(r,n,s){n=n||[];for(var i=s=s||0;r>=t;)n[s++]=255&r|128,r/=128;for(;-128&r;)n[s++]=255&r|128,r>>>=7;return n[s]=0|r,e.bytes=s-i+1,n};var t=Math.pow(2,31)},70393:(e,t,r)=>{e.exports={encode:r(96608),decode:r(77877),encodingLength:r(38559)}},38559:e=>{var t=Math.pow(2,7),r=Math.pow(2,14),n=Math.pow(2,21),s=Math.pow(2,28),i=Math.pow(2,35),o=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<r?2:e<n?3:e<s?4:e<i?5:e<o?6:e<a?7:e<c?8:e<l?9:10}},56566:(e,t,r)=>{"use strict";const n=r(70393);e.exports=e=>{if(!(e instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const t=[];for(;e.length>0;){const r=n.decode(e);t.push(r),e=e.slice(n.decode.bytes)}return t}},64482:function(e,t,r){"use strict";var n,s,i;s=[r(43161)],void 0===(i="function"==typeof(n=function(e){var t=e.Reader,r=e.Writer,n=e.util,s=e.roots.default||(e.roots.default={});return s.RPC=function(){function i(e){if(this.subscriptions=[],this.messages=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.subscriptions=n.emptyArray,i.prototype.messages=n.emptyArray,i.prototype.control=null,Object.defineProperty(i.prototype,"_control",{get:n.oneOfGetter(o=["control"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){if(t||(t=r.create()),null!=e.subscriptions&&e.subscriptions.length)for(var n=0;n<e.subscriptions.length;++n)s.RPC.SubOpts.encode(e.subscriptions[n],t.uint32(10).fork()).ldelim();if(null!=e.messages&&e.messages.length)for(n=0;n<e.messages.length;++n)s.RPC.Message.encode(e.messages[n],t.uint32(18).fork()).ldelim();return null!=e.control&&Object.hasOwnProperty.call(e,"control")&&s.RPC.ControlMessage.encode(e.control,t.uint32(26).fork()).ldelim(),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.subscriptions&&i.subscriptions.length||(i.subscriptions=[]),i.subscriptions.push(s.RPC.SubOpts.decode(e,e.uint32()));break;case 2:i.messages&&i.messages.length||(i.messages=[]),i.messages.push(s.RPC.Message.decode(e,e.uint32()));break;case 3:i.control=s.RPC.ControlMessage.decode(e,e.uint32());break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC)return e;var t=new s.RPC;if(e.subscriptions){if(!Array.isArray(e.subscriptions))throw TypeError(".RPC.subscriptions: array expected");t.subscriptions=[];for(var r=0;r<e.subscriptions.length;++r){if("object"!=typeof e.subscriptions[r])throw TypeError(".RPC.subscriptions: object expected");t.subscriptions[r]=s.RPC.SubOpts.fromObject(e.subscriptions[r])}}if(e.messages){if(!Array.isArray(e.messages))throw TypeError(".RPC.messages: array expected");for(t.messages=[],r=0;r<e.messages.length;++r){if("object"!=typeof e.messages[r])throw TypeError(".RPC.messages: object expected");t.messages[r]=s.RPC.Message.fromObject(e.messages[r])}}if(null!=e.control){if("object"!=typeof e.control)throw TypeError(".RPC.control: object expected");t.control=s.RPC.ControlMessage.fromObject(e.control)}return t},i.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.subscriptions=[],r.messages=[]),e.subscriptions&&e.subscriptions.length){r.subscriptions=[];for(var n=0;n<e.subscriptions.length;++n)r.subscriptions[n]=s.RPC.SubOpts.toObject(e.subscriptions[n],t)}if(e.messages&&e.messages.length)for(r.messages=[],n=0;n<e.messages.length;++n)r.messages[n]=s.RPC.Message.toObject(e.messages[n],t);return null!=e.control&&e.hasOwnProperty("control")&&(r.control=s.RPC.ControlMessage.toObject(e.control,t),t.oneofs&&(r._control="control")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i.SubOpts=function(){function i(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.subscribe=null,i.prototype.topic=null,Object.defineProperty(i.prototype,"_subscribe",{get:n.oneOfGetter(o=["subscribe"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_topic",{get:n.oneOfGetter(o=["topic"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){return t||(t=r.create()),null!=e.subscribe&&Object.hasOwnProperty.call(e,"subscribe")&&t.uint32(8).bool(e.subscribe),null!=e.topic&&Object.hasOwnProperty.call(e,"topic")&&t.uint32(18).string(e.topic),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.SubOpts;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.subscribe=e.bool();break;case 2:i.topic=e.string();break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC.SubOpts)return e;var t=new s.RPC.SubOpts;return null!=e.subscribe&&(t.subscribe=Boolean(e.subscribe)),null!=e.topic&&(t.topic=String(e.topic)),t},i.toObject=function(e,t){t||(t={});var r={};return null!=e.subscribe&&e.hasOwnProperty("subscribe")&&(r.subscribe=e.subscribe,t.oneofs&&(r._subscribe="subscribe")),null!=e.topic&&e.hasOwnProperty("topic")&&(r.topic=e.topic,t.oneofs&&(r._topic="topic")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.Message=function(){function i(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.from=null,i.prototype.data=null,i.prototype.seqno=null,i.prototype.topic="",i.prototype.signature=null,i.prototype.key=null,Object.defineProperty(i.prototype,"_from",{get:n.oneOfGetter(o=["from"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_data",{get:n.oneOfGetter(o=["data"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_seqno",{get:n.oneOfGetter(o=["seqno"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_signature",{get:n.oneOfGetter(o=["signature"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_key",{get:n.oneOfGetter(o=["key"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){return t||(t=r.create()),null!=e.from&&Object.hasOwnProperty.call(e,"from")&&t.uint32(10).bytes(e.from),null!=e.data&&Object.hasOwnProperty.call(e,"data")&&t.uint32(18).bytes(e.data),null!=e.seqno&&Object.hasOwnProperty.call(e,"seqno")&&t.uint32(26).bytes(e.seqno),t.uint32(34).string(e.topic),null!=e.signature&&Object.hasOwnProperty.call(e,"signature")&&t.uint32(42).bytes(e.signature),null!=e.key&&Object.hasOwnProperty.call(e,"key")&&t.uint32(50).bytes(e.key),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var i=void 0===r?e.len:e.pos+r,o=new s.RPC.Message;e.pos<i;){var a=e.uint32();switch(a>>>3){case 1:o.from=e.bytes();break;case 2:o.data=e.bytes();break;case 3:o.seqno=e.bytes();break;case 4:o.topic=e.string();break;case 5:o.signature=e.bytes();break;case 6:o.key=e.bytes();break;default:e.skipType(7&a)}}if(!o.hasOwnProperty("topic"))throw n.ProtocolError("missing required 'topic'",{instance:o});return o},i.fromObject=function(e){if(e instanceof s.RPC.Message)return e;var t=new s.RPC.Message;return null!=e.from&&("string"==typeof e.from?n.base64.decode(e.from,t.from=n.newBuffer(n.base64.length(e.from)),0):e.from.length&&(t.from=e.from)),null!=e.data&&("string"==typeof e.data?n.base64.decode(e.data,t.data=n.newBuffer(n.base64.length(e.data)),0):e.data.length&&(t.data=e.data)),null!=e.seqno&&("string"==typeof e.seqno?n.base64.decode(e.seqno,t.seqno=n.newBuffer(n.base64.length(e.seqno)),0):e.seqno.length&&(t.seqno=e.seqno)),null!=e.topic&&(t.topic=String(e.topic)),null!=e.signature&&("string"==typeof e.signature?n.base64.decode(e.signature,t.signature=n.newBuffer(n.base64.length(e.signature)),0):e.signature.length&&(t.signature=e.signature)),null!=e.key&&("string"==typeof e.key?n.base64.decode(e.key,t.key=n.newBuffer(n.base64.length(e.key)),0):e.key.length&&(t.key=e.key)),t},i.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(r.topic=""),null!=e.from&&e.hasOwnProperty("from")&&(r.from=t.bytes===String?n.base64.encode(e.from,0,e.from.length):t.bytes===Array?Array.prototype.slice.call(e.from):e.from,t.oneofs&&(r._from="from")),null!=e.data&&e.hasOwnProperty("data")&&(r.data=t.bytes===String?n.base64.encode(e.data,0,e.data.length):t.bytes===Array?Array.prototype.slice.call(e.data):e.data,t.oneofs&&(r._data="data")),null!=e.seqno&&e.hasOwnProperty("seqno")&&(r.seqno=t.bytes===String?n.base64.encode(e.seqno,0,e.seqno.length):t.bytes===Array?Array.prototype.slice.call(e.seqno):e.seqno,t.oneofs&&(r._seqno="seqno")),null!=e.topic&&e.hasOwnProperty("topic")&&(r.topic=e.topic),null!=e.signature&&e.hasOwnProperty("signature")&&(r.signature=t.bytes===String?n.base64.encode(e.signature,0,e.signature.length):t.bytes===Array?Array.prototype.slice.call(e.signature):e.signature,t.oneofs&&(r._signature="signature")),null!=e.key&&e.hasOwnProperty("key")&&(r.key=t.bytes===String?n.base64.encode(e.key,0,e.key.length):t.bytes===Array?Array.prototype.slice.call(e.key):e.key,t.oneofs&&(r._key="key")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.ControlMessage=function(){function i(e){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return i.prototype.ihave=n.emptyArray,i.prototype.iwant=n.emptyArray,i.prototype.graft=n.emptyArray,i.prototype.prune=n.emptyArray,i.encode=function(e,t){if(t||(t=r.create()),null!=e.ihave&&e.ihave.length)for(var n=0;n<e.ihave.length;++n)s.RPC.ControlIHave.encode(e.ihave[n],t.uint32(10).fork()).ldelim();if(null!=e.iwant&&e.iwant.length)for(n=0;n<e.iwant.length;++n)s.RPC.ControlIWant.encode(e.iwant[n],t.uint32(18).fork()).ldelim();if(null!=e.graft&&e.graft.length)for(n=0;n<e.graft.length;++n)s.RPC.ControlGraft.encode(e.graft[n],t.uint32(26).fork()).ldelim();if(null!=e.prune&&e.prune.length)for(n=0;n<e.prune.length;++n)s.RPC.ControlPrune.encode(e.prune[n],t.uint32(34).fork()).ldelim();return t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.ControlMessage;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.ihave&&i.ihave.length||(i.ihave=[]),i.ihave.push(s.RPC.ControlIHave.decode(e,e.uint32()));break;case 2:i.iwant&&i.iwant.length||(i.iwant=[]),i.iwant.push(s.RPC.ControlIWant.decode(e,e.uint32()));break;case 3:i.graft&&i.graft.length||(i.graft=[]),i.graft.push(s.RPC.ControlGraft.decode(e,e.uint32()));break;case 4:i.prune&&i.prune.length||(i.prune=[]),i.prune.push(s.RPC.ControlPrune.decode(e,e.uint32()));break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC.ControlMessage)return e;var t=new s.RPC.ControlMessage;if(e.ihave){if(!Array.isArray(e.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");t.ihave=[];for(var r=0;r<e.ihave.length;++r){if("object"!=typeof e.ihave[r])throw TypeError(".RPC.ControlMessage.ihave: object expected");t.ihave[r]=s.RPC.ControlIHave.fromObject(e.ihave[r])}}if(e.iwant){if(!Array.isArray(e.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");for(t.iwant=[],r=0;r<e.iwant.length;++r){if("object"!=typeof e.iwant[r])throw TypeError(".RPC.ControlMessage.iwant: object expected");t.iwant[r]=s.RPC.ControlIWant.fromObject(e.iwant[r])}}if(e.graft){if(!Array.isArray(e.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");for(t.graft=[],r=0;r<e.graft.length;++r){if("object"!=typeof e.graft[r])throw TypeError(".RPC.ControlMessage.graft: object expected");t.graft[r]=s.RPC.ControlGraft.fromObject(e.graft[r])}}if(e.prune){if(!Array.isArray(e.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");for(t.prune=[],r=0;r<e.prune.length;++r){if("object"!=typeof e.prune[r])throw TypeError(".RPC.ControlMessage.prune: object expected");t.prune[r]=s.RPC.ControlPrune.fromObject(e.prune[r])}}return t},i.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.ihave=[],r.iwant=[],r.graft=[],r.prune=[]),e.ihave&&e.ihave.length){r.ihave=[];for(var n=0;n<e.ihave.length;++n)r.ihave[n]=s.RPC.ControlIHave.toObject(e.ihave[n],t)}if(e.iwant&&e.iwant.length)for(r.iwant=[],n=0;n<e.iwant.length;++n)r.iwant[n]=s.RPC.ControlIWant.toObject(e.iwant[n],t);if(e.graft&&e.graft.length)for(r.graft=[],n=0;n<e.graft.length;++n)r.graft[n]=s.RPC.ControlGraft.toObject(e.graft[n],t);if(e.prune&&e.prune.length)for(r.prune=[],n=0;n<e.prune.length;++n)r.prune[n]=s.RPC.ControlPrune.toObject(e.prune[n],t);return r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.ControlIHave=function(){function i(e){if(this.messageIDs=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.topicID=null,i.prototype.messageIDs=n.emptyArray,Object.defineProperty(i.prototype,"_topicID",{get:n.oneOfGetter(o=["topicID"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){if(t||(t=r.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),null!=e.messageIDs&&e.messageIDs.length)for(var n=0;n<e.messageIDs.length;++n)t.uint32(18).bytes(e.messageIDs[n]);return t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.ControlIHave;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.topicID=e.string();break;case 2:i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),i.messageIDs.push(e.bytes());break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC.ControlIHave)return e;var t=new s.RPC.ControlIHave;if(null!=e.topicID&&(t.topicID=String(e.topicID)),e.messageIDs){if(!Array.isArray(e.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");t.messageIDs=[];for(var r=0;r<e.messageIDs.length;++r)"string"==typeof e.messageIDs[r]?n.base64.decode(e.messageIDs[r],t.messageIDs[r]=n.newBuffer(n.base64.length(e.messageIDs[r])),0):e.messageIDs[r].length&&(t.messageIDs[r]=e.messageIDs[r])}return t},i.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.messageIDs=[]),null!=e.topicID&&e.hasOwnProperty("topicID")&&(r.topicID=e.topicID,t.oneofs&&(r._topicID="topicID")),e.messageIDs&&e.messageIDs.length){r.messageIDs=[];for(var s=0;s<e.messageIDs.length;++s)r.messageIDs[s]=t.bytes===String?n.base64.encode(e.messageIDs[s],0,e.messageIDs[s].length):t.bytes===Array?Array.prototype.slice.call(e.messageIDs[s]):e.messageIDs[s]}return r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.ControlIWant=function(){function i(e){if(this.messageIDs=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return i.prototype.messageIDs=n.emptyArray,i.encode=function(e,t){if(t||(t=r.create()),null!=e.messageIDs&&e.messageIDs.length)for(var n=0;n<e.messageIDs.length;++n)t.uint32(10).bytes(e.messageIDs[n]);return t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.ControlIWant;e.pos<n;){var o=e.uint32();o>>>3==1?(i.messageIDs&&i.messageIDs.length||(i.messageIDs=[]),i.messageIDs.push(e.bytes())):e.skipType(7&o)}return i},i.fromObject=function(e){if(e instanceof s.RPC.ControlIWant)return e;var t=new s.RPC.ControlIWant;if(e.messageIDs){if(!Array.isArray(e.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");t.messageIDs=[];for(var r=0;r<e.messageIDs.length;++r)"string"==typeof e.messageIDs[r]?n.base64.decode(e.messageIDs[r],t.messageIDs[r]=n.newBuffer(n.base64.length(e.messageIDs[r])),0):e.messageIDs[r].length&&(t.messageIDs[r]=e.messageIDs[r])}return t},i.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.messageIDs=[]),e.messageIDs&&e.messageIDs.length){r.messageIDs=[];for(var s=0;s<e.messageIDs.length;++s)r.messageIDs[s]=t.bytes===String?n.base64.encode(e.messageIDs[s],0,e.messageIDs[s].length):t.bytes===Array?Array.prototype.slice.call(e.messageIDs[s]):e.messageIDs[s]}return r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.ControlGraft=function(){function i(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.topicID=null,Object.defineProperty(i.prototype,"_topicID",{get:n.oneOfGetter(o=["topicID"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){return t||(t=r.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.ControlGraft;e.pos<n;){var o=e.uint32();o>>>3==1?i.topicID=e.string():e.skipType(7&o)}return i},i.fromObject=function(e){if(e instanceof s.RPC.ControlGraft)return e;var t=new s.RPC.ControlGraft;return null!=e.topicID&&(t.topicID=String(e.topicID)),t},i.toObject=function(e,t){t||(t={});var r={};return null!=e.topicID&&e.hasOwnProperty("topicID")&&(r.topicID=e.topicID,t.oneofs&&(r._topicID="topicID")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.ControlPrune=function(){function i(e){if(this.peers=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.topicID=null,i.prototype.peers=n.emptyArray,i.prototype.backoff=null,Object.defineProperty(i.prototype,"_topicID",{get:n.oneOfGetter(o=["topicID"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_backoff",{get:n.oneOfGetter(o=["backoff"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){if(t||(t=r.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),null!=e.peers&&e.peers.length)for(var n=0;n<e.peers.length;++n)s.RPC.PeerInfo.encode(e.peers[n],t.uint32(18).fork()).ldelim();return null!=e.backoff&&Object.hasOwnProperty.call(e,"backoff")&&t.uint32(24).uint64(e.backoff),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.ControlPrune;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.topicID=e.string();break;case 2:i.peers&&i.peers.length||(i.peers=[]),i.peers.push(s.RPC.PeerInfo.decode(e,e.uint32()));break;case 3:i.backoff=e.uint64();break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC.ControlPrune)return e;var t=new s.RPC.ControlPrune;if(null!=e.topicID&&(t.topicID=String(e.topicID)),e.peers){if(!Array.isArray(e.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");t.peers=[];for(var r=0;r<e.peers.length;++r){if("object"!=typeof e.peers[r])throw TypeError(".RPC.ControlPrune.peers: object expected");t.peers[r]=s.RPC.PeerInfo.fromObject(e.peers[r])}}return null!=e.backoff&&(n.Long?(t.backoff=n.Long.fromValue(e.backoff)).unsigned=!0:"string"==typeof e.backoff?t.backoff=parseInt(e.backoff,10):"number"==typeof e.backoff?t.backoff=e.backoff:"object"==typeof e.backoff&&(t.backoff=new n.LongBits(e.backoff.low>>>0,e.backoff.high>>>0).toNumber(!0))),t},i.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.peers=[]),null!=e.topicID&&e.hasOwnProperty("topicID")&&(r.topicID=e.topicID,t.oneofs&&(r._topicID="topicID")),e.peers&&e.peers.length){r.peers=[];for(var i=0;i<e.peers.length;++i)r.peers[i]=s.RPC.PeerInfo.toObject(e.peers[i],t)}return null!=e.backoff&&e.hasOwnProperty("backoff")&&("number"==typeof e.backoff?r.backoff=t.longs===String?String(e.backoff):e.backoff:r.backoff=t.longs===String?n.Long.prototype.toString.call(e.backoff):t.longs===Number?new n.LongBits(e.backoff.low>>>0,e.backoff.high>>>0).toNumber(!0):e.backoff,t.oneofs&&(r._backoff="backoff")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i.PeerInfo=function(){function i(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}var o;return i.prototype.peerID=null,i.prototype.signedPeerRecord=null,Object.defineProperty(i.prototype,"_peerID",{get:n.oneOfGetter(o=["peerID"]),set:n.oneOfSetter(o)}),Object.defineProperty(i.prototype,"_signedPeerRecord",{get:n.oneOfGetter(o=["signedPeerRecord"]),set:n.oneOfSetter(o)}),i.encode=function(e,t){return t||(t=r.create()),null!=e.peerID&&Object.hasOwnProperty.call(e,"peerID")&&t.uint32(10).bytes(e.peerID),null!=e.signedPeerRecord&&Object.hasOwnProperty.call(e,"signedPeerRecord")&&t.uint32(18).bytes(e.signedPeerRecord),t},i.decode=function(e,r){e instanceof t||(e=t.create(e));for(var n=void 0===r?e.len:e.pos+r,i=new s.RPC.PeerInfo;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:i.peerID=e.bytes();break;case 2:i.signedPeerRecord=e.bytes();break;default:e.skipType(7&o)}}return i},i.fromObject=function(e){if(e instanceof s.RPC.PeerInfo)return e;var t=new s.RPC.PeerInfo;return null!=e.peerID&&("string"==typeof e.peerID?n.base64.decode(e.peerID,t.peerID=n.newBuffer(n.base64.length(e.peerID)),0):e.peerID.length&&(t.peerID=e.peerID)),null!=e.signedPeerRecord&&("string"==typeof e.signedPeerRecord?n.base64.decode(e.signedPeerRecord,t.signedPeerRecord=n.newBuffer(n.base64.length(e.signedPeerRecord)),0):e.signedPeerRecord.length&&(t.signedPeerRecord=e.signedPeerRecord)),t},i.toObject=function(e,t){t||(t={});var r={};return null!=e.peerID&&e.hasOwnProperty("peerID")&&(r.peerID=t.bytes===String?n.base64.encode(e.peerID,0,e.peerID.length):t.bytes===Array?Array.prototype.slice.call(e.peerID):e.peerID,t.oneofs&&(r._peerID="peerID")),null!=e.signedPeerRecord&&e.hasOwnProperty("signedPeerRecord")&&(r.signedPeerRecord=t.bytes===String?n.base64.encode(e.signedPeerRecord,0,e.signedPeerRecord.length):t.bytes===Array?Array.prototype.slice.call(e.signedPeerRecord):e.signedPeerRecord,t.oneofs&&(r._signedPeerRecord="signedPeerRecord")),r},i.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},i}(),i}(),s})?n.apply(t,s):n)||(e.exports=i)},43478:e=>{!function(){e.exports=y;var t=86400,r=3200,n=1168776,s=t*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",h=Math.trunc||function(e){var t=e-e%1;return 0==t&&(e<0||0===e&&1/e!=1/0)?-0:t},d=y.prototype,u=(y.fromDate=function(e){return new y(+e)},y.fromInt64BE=E(0,1,2,3,0,4),y.fromInt64LE=E(3,2,1,0,4,0),y.fromString=function(e){var t,r=new y;if(e=(e+="").replace(/^\s*[+\-]?\d+/,(function(e){var t=1970+((e=+e)-1970)%400;return r.year=e-t,t})).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,(function(e,r,n){return r<0&&(n*=-1),t=6e4*(60*+r+ +n),""})).replace(/\.\d+$/,(function(e){return r.nano=+(e+l).substr(1,9),""})).split(/\D+/),1<e.length?e[1]--:e[1]=0,r.time=t=Date.UTC.apply(Date,e)-(t||0),isNaN(t))throw new TypeError("Invalid Date");return m(r)},y.fromTimeT=function(e){return b(e,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(e){return this.nano+=+e||0,this},d.getNano=function(){var e=m(this);return(e.time%1e3*c+ +e.nano+1e9)%1e9},d.getTimeT=function(){var e=m(this),s=Math.floor(e.time/1e3);return(e=e.year)&&(s+=e*n*t/r),s},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return w(m(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(e){var t=this,r=t.toDate(),n={H:function(){return k(r.getUTCHours())},L:function(){return S(r.getUTCMilliseconds(),3)},M:function(){return k(r.getUTCMinutes())},N:function(){return S(t.getNano(),9)},S:function(){return k(r.getUTCSeconds())},Y:function(){var e=t.getYear();return 999999<e?"+"+e:9999<e?"+"+S(e,6):0<=e?S(e,4):-999999<=e?"-"+S(-e,6):e},a:function(){return f[r.getUTCDay()]},b:function(){return p[r.getUTCMonth()]},d:function(){return k(r.getUTCDate())},e:function(){return function(e){return(9<e?"":" ")+(0|e)}(r.getUTCDate())},m:function(){return k(r.getUTCMonth()+1)}};return function e(t){return t.replace(/%./g,(function(t){var r=t[1],s=g[r];return r=n[r],s?e(s):r?r():t}))}(e||u)},d.writeInt64BE=_(0,1,2,3,0,4),d.writeInt64LE=_(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:"\n",R:"%H:%M",T:"%H:%M:%S",t:"\t",X:"%T",Z:"GMT",z:"+0000"};return y;function y(e,t,r){var n=this;if(!(n instanceof y))return new y(e,t,r);n.time=+e||0,n.nano=+t||0,n.year=+r||0,m(n)}function m(e){var t,n,s,a=e.year,l=e.time,d=e.nano,u=((d<0||c<=d)&&(d-=(n=Math.floor(d/c))*c,l+=n,n=1),a%r);return(l<-o||o<l||u)&&((t=h(l/i))&&(a+=t*r,l-=t*i),(s=w(l)).setUTCFullYear(u+s.getUTCFullYear()),s=(l=+s)+(t=h((a-=u)/r))*i,t&&-o<=s&&s<=o&&(a-=t*r,l=s),n=1),n&&(e.year=a,e.time=l,e.nano=d),e}function w(e){var t=new Date(0);return t.setTime(e),t}function b(e,t){e=+e||0;var n=h((t=(0|t)*a)/s)+h(e/s);return(e=h((t=t%s+e%s)/s))&&(n+=e,t-=e*s),new y(1e3*t,0,n*r)}function _(e,s,i,o,c,l){return function(e,s){var i=m(this);v(e=e||new Array(8),s|=0);var o=Math.floor(i.time/1e3),u=(i=i.year*(n*t/r),h(i/a)+h(o/a));return i=i%a+o%a,(o=Math.floor(i/a))&&(u+=o,i-=o*a),d(e,s+c,u),d(e,s+l,i),e};function d(t,r,n){t[r+e]=n>>24&255,t[r+s]=n>>16&255,t[r+i]=n>>8&255,t[r+o]=255&n}}function E(e,t,r,n,s,i){return function(e,t){v(e,t|=0);var r=o(e,t+s);return b(o(e,t+i),r)};function o(s,i){return 16777216*s[i+e]+(s[i+t]<<16|s[i+r]<<8|s[i+n])}}function v(e,t){if(null==(e=e&&e.length))throw new TypeError("Invalid Buffer");if(e<t+8)throw new RangeError("Out of range")}function k(e){return(9<e?"":"0")+(0|e)}function S(e,t){return(l+(0|e)).substr(-t)}}()},76538:(e,t,r)=>{"use strict";r.d(t,{Ue:()=>VA});var n={};r.r(n),r.d(n,{code:()=>Re,createLink:()=>ke,createNode:()=>ve,decode:()=>Te,encode:()=>Ie,name:()=>Se,prepare:()=>_e,validate:()=>Ee});var s={};r.r(s),r.d(s,{code:()=>rr,decode:()=>sr,encode:()=>nr,name:()=>tr});var i={};r.r(i),r.d(i,{code:()=>gr,decode:()=>mr,encode:()=>yr,format:()=>wr,name:()=>fr,parse:()=>_r,stringify:()=>wr});var o={};r.r(o),r.d(o,{code:()=>Pr,decode:()=>Mr,encode:()=>Cr,name:()=>Ar,toGeneral:()=>Nr});var a={};r.r(a),r.d(a,{InvalidValueError:()=>Kf,MissingRepoOptionsError:()=>Wf,NonReversibleMigrationError:()=>Hf,NotInitializedRepoError:()=>Gf,RequiredParameterError:()=>qf});var c={};r.r(c),r.d(c,{identity:()=>ky});var l={};r.r(l),r.d(l,{base2:()=>Sy});var h={};r.r(h),r.d(h,{base8:()=>Ry});var d={};r.r(d),r.d(d,{base10:()=>Iy});var u={};r.r(u),r.d(u,{base16:()=>Ty,base16upper:()=>Ay});var p={};r.r(p),r.d(p,{base32:()=>Py,base32hex:()=>Cy,base32hexpad:()=>Ly,base32hexpadupper:()=>xy,base32hexupper:()=>My,base32pad:()=>Oy,base32padupper:()=>Ny,base32upper:()=>Dy,base32z:()=>By});var f={};r.r(f),r.d(f,{base36:()=>Uy,base36upper:()=>zy});var g={};r.r(g),r.d(g,{base58btc:()=>jy,base58flickr:()=>Fy});var y={};r.r(y),r.d(y,{base64:()=>Vy,base64pad:()=>$y,base64url:()=>Hy,base64urlpad:()=>Gy});var m={};r.r(m),r.d(m,{base256emoji:()=>Zy});var w={};r.r(w),r.d(w,{sha256:()=>gm,sha512:()=>ym});var b={};r.r(b),r.d(b,{identity:()=>wm});var _={};r.r(_),r.d(_,{code:()=>_m,decode:()=>vm,encode:()=>Em,name:()=>bm});var E={};r.r(E),r.d(E,{code:()=>Im,decode:()=>Am,encode:()=>Tm,name:()=>Rm});var v={};r.r(v),r.d(v,{identity:()=>Ow});var k={};r.r(k),r.d(k,{base2:()=>Nw});var S={};r.r(S),r.d(S,{base8:()=>Cw});var R={};r.r(R),r.d(R,{base10:()=>Mw});var I={};r.r(I),r.d(I,{base16:()=>Lw,base16upper:()=>xw});var T={};r.r(T),r.d(T,{base32:()=>Bw,base32hex:()=>Fw,base32hexpad:()=>$w,base32hexpadupper:()=>Hw,base32hexupper:()=>Vw,base32pad:()=>zw,base32padupper:()=>jw,base32upper:()=>Uw,base32z:()=>Gw});var A={};r.r(A),r.d(A,{base36:()=>qw,base36upper:()=>Kw});var P={};r.r(P),r.d(P,{base58btc:()=>Ww,base58flickr:()=>Zw});var D={};r.r(D),r.d(D,{base64:()=>Yw,base64pad:()=>Jw,base64url:()=>Qw,base64urlpad:()=>Xw});var O={};r.r(O),r.d(O,{base256emoji:()=>nb});var N={};r.r(N),r.d(N,{sha256:()=>kb,sha512:()=>Sb});var C={};r.r(C),r.d(C,{identity:()=>Ib});var M={};r.r(M),r.d(M,{code:()=>Ab,decode:()=>Db,encode:()=>Pb,name:()=>Tb});var L={};r.r(L),r.d(L,{code:()=>Mb,decode:()=>xb,encode:()=>Lb,name:()=>Cb});var x={};r.r(x),r.d(x,{abortedError:()=>TA,notFoundError:()=>IA});var B=r(40726),U=r(27697),z=r(16099),j=r(77514),F=r(39026);const V=F.Reader,$=F.Writer,H=F.util,G=F.roots["ipfs-unixfs"]||(F.roots["ipfs-unixfs"]={}),q=G.Data=(()=>{function e(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.Type=0,e.prototype.Data=H.newBuffer([]),e.prototype.filesize=H.Long?H.Long.fromBits(0,0,!0):0,e.prototype.blocksizes=H.emptyArray,e.prototype.hashType=H.Long?H.Long.fromBits(0,0,!0):0,e.prototype.fanout=H.Long?H.Long.fromBits(0,0,!0):0,e.prototype.mode=0,e.prototype.mtime=null,e.encode=function(e,t){if(t||(t=$.create()),t.uint32(8).int32(e.Type),null!=e.Data&&Object.hasOwnProperty.call(e,"Data")&&t.uint32(18).bytes(e.Data),null!=e.filesize&&Object.hasOwnProperty.call(e,"filesize")&&t.uint32(24).uint64(e.filesize),null!=e.blocksizes&&e.blocksizes.length)for(var r=0;r<e.blocksizes.length;++r)t.uint32(32).uint64(e.blocksizes[r]);return null!=e.hashType&&Object.hasOwnProperty.call(e,"hashType")&&t.uint32(40).uint64(e.hashType),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(48).uint64(e.fanout),null!=e.mode&&Object.hasOwnProperty.call(e,"mode")&&t.uint32(56).uint32(e.mode),null!=e.mtime&&Object.hasOwnProperty.call(e,"mtime")&&G.UnixTime.encode(e.mtime,t.uint32(66).fork()).ldelim(),t},e.decode=function(e,t){e instanceof V||(e=V.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new G.Data;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.Type=e.int32();break;case 2:n.Data=e.bytes();break;case 3:n.filesize=e.uint64();break;case 4:if(n.blocksizes&&n.blocksizes.length||(n.blocksizes=[]),2==(7&s))for(var i=e.uint32()+e.pos;e.pos<i;)n.blocksizes.push(e.uint64());else n.blocksizes.push(e.uint64());break;case 5:n.hashType=e.uint64();break;case 6:n.fanout=e.uint64();break;case 7:n.mode=e.uint32();break;case 8:n.mtime=G.UnixTime.decode(e,e.uint32());break;default:e.skipType(7&s)}}if(!n.hasOwnProperty("Type"))throw H.ProtocolError("missing required 'Type'",{instance:n});return n},e.fromObject=function(e){if(e instanceof G.Data)return e;var t=new G.Data;switch(e.Type){case"Raw":case 0:t.Type=0;break;case"Directory":case 1:t.Type=1;break;case"File":case 2:t.Type=2;break;case"Metadata":case 3:t.Type=3;break;case"Symlink":case 4:t.Type=4;break;case"HAMTShard":case 5:t.Type=5}if(null!=e.Data&&("string"==typeof e.Data?H.base64.decode(e.Data,t.Data=H.newBuffer(H.base64.length(e.Data)),0):e.Data.length&&(t.Data=e.Data)),null!=e.filesize&&(H.Long?(t.filesize=H.Long.fromValue(e.filesize)).unsigned=!0:"string"==typeof e.filesize?t.filesize=parseInt(e.filesize,10):"number"==typeof e.filesize?t.filesize=e.filesize:"object"==typeof e.filesize&&(t.filesize=new H.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0))),e.blocksizes){if(!Array.isArray(e.blocksizes))throw TypeError(".Data.blocksizes: array expected");t.blocksizes=[];for(var r=0;r<e.blocksizes.length;++r)H.Long?(t.blocksizes[r]=H.Long.fromValue(e.blocksizes[r])).unsigned=!0:"string"==typeof e.blocksizes[r]?t.blocksizes[r]=parseInt(e.blocksizes[r],10):"number"==typeof e.blocksizes[r]?t.blocksizes[r]=e.blocksizes[r]:"object"==typeof e.blocksizes[r]&&(t.blocksizes[r]=new H.LongBits(e.blocksizes[r].low>>>0,e.blocksizes[r].high>>>0).toNumber(!0))}if(null!=e.hashType&&(H.Long?(t.hashType=H.Long.fromValue(e.hashType)).unsigned=!0:"string"==typeof e.hashType?t.hashType=parseInt(e.hashType,10):"number"==typeof e.hashType?t.hashType=e.hashType:"object"==typeof e.hashType&&(t.hashType=new H.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0))),null!=e.fanout&&(H.Long?(t.fanout=H.Long.fromValue(e.fanout)).unsigned=!0:"string"==typeof e.fanout?t.fanout=parseInt(e.fanout,10):"number"==typeof e.fanout?t.fanout=e.fanout:"object"==typeof e.fanout&&(t.fanout=new H.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0))),null!=e.mode&&(t.mode=e.mode>>>0),null!=e.mtime){if("object"!=typeof e.mtime)throw TypeError(".Data.mtime: object expected");t.mtime=G.UnixTime.fromObject(e.mtime)}return t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.blocksizes=[]),t.defaults){if(r.Type=t.enums===String?"Raw":0,t.bytes===String?r.Data="":(r.Data=[],t.bytes!==Array&&(r.Data=H.newBuffer(r.Data))),H.Long){var n=new H.Long(0,0,!0);r.filesize=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else r.filesize=t.longs===String?"0":0;H.Long?(n=new H.Long(0,0,!0),r.hashType=t.longs===String?n.toString():t.longs===Number?n.toNumber():n):r.hashType=t.longs===String?"0":0,H.Long?(n=new H.Long(0,0,!0),r.fanout=t.longs===String?n.toString():t.longs===Number?n.toNumber():n):r.fanout=t.longs===String?"0":0,r.mode=0,r.mtime=null}if(null!=e.Type&&e.hasOwnProperty("Type")&&(r.Type=t.enums===String?G.Data.DataType[e.Type]:e.Type),null!=e.Data&&e.hasOwnProperty("Data")&&(r.Data=t.bytes===String?H.base64.encode(e.Data,0,e.Data.length):t.bytes===Array?Array.prototype.slice.call(e.Data):e.Data),null!=e.filesize&&e.hasOwnProperty("filesize")&&("number"==typeof e.filesize?r.filesize=t.longs===String?String(e.filesize):e.filesize:r.filesize=t.longs===String?H.Long.prototype.toString.call(e.filesize):t.longs===Number?new H.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0):e.filesize),e.blocksizes&&e.blocksizes.length){r.blocksizes=[];for(var s=0;s<e.blocksizes.length;++s)"number"==typeof e.blocksizes[s]?r.blocksizes[s]=t.longs===String?String(e.blocksizes[s]):e.blocksizes[s]:r.blocksizes[s]=t.longs===String?H.Long.prototype.toString.call(e.blocksizes[s]):t.longs===Number?new H.LongBits(e.blocksizes[s].low>>>0,e.blocksizes[s].high>>>0).toNumber(!0):e.blocksizes[s]}return null!=e.hashType&&e.hasOwnProperty("hashType")&&("number"==typeof e.hashType?r.hashType=t.longs===String?String(e.hashType):e.hashType:r.hashType=t.longs===String?H.Long.prototype.toString.call(e.hashType):t.longs===Number?new H.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0):e.hashType),null!=e.fanout&&e.hasOwnProperty("fanout")&&("number"==typeof e.fanout?r.fanout=t.longs===String?String(e.fanout):e.fanout:r.fanout=t.longs===String?H.Long.prototype.toString.call(e.fanout):t.longs===Number?new H.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0):e.fanout),null!=e.mode&&e.hasOwnProperty("mode")&&(r.mode=e.mode),null!=e.mtime&&e.hasOwnProperty("mtime")&&(r.mtime=G.UnixTime.toObject(e.mtime,t)),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),e})(),K=(G.UnixTime=(()=>{function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.Seconds=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.FractionalNanoseconds=0,e.encode=function(e,t){return t||(t=$.create()),t.uint32(8).int64(e.Seconds),null!=e.FractionalNanoseconds&&Object.hasOwnProperty.call(e,"FractionalNanoseconds")&&t.uint32(21).fixed32(e.FractionalNanoseconds),t},e.decode=function(e,t){e instanceof V||(e=V.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new G.UnixTime;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.Seconds=e.int64();break;case 2:n.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&s)}}if(!n.hasOwnProperty("Seconds"))throw H.ProtocolError("missing required 'Seconds'",{instance:n});return n},e.fromObject=function(e){if(e instanceof G.UnixTime)return e;var t=new G.UnixTime;return null!=e.Seconds&&(H.Long?(t.Seconds=H.Long.fromValue(e.Seconds)).unsigned=!1:"string"==typeof e.Seconds?t.Seconds=parseInt(e.Seconds,10):"number"==typeof e.Seconds?t.Seconds=e.Seconds:"object"==typeof e.Seconds&&(t.Seconds=new H.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber())),null!=e.FractionalNanoseconds&&(t.FractionalNanoseconds=e.FractionalNanoseconds>>>0),t},e.toObject=function(e,t){t||(t={});var r={};if(t.defaults){if(H.Long){var n=new H.Long(0,0,!1);r.Seconds=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else r.Seconds=t.longs===String?"0":0;r.FractionalNanoseconds=0}return null!=e.Seconds&&e.hasOwnProperty("Seconds")&&("number"==typeof e.Seconds?r.Seconds=t.longs===String?String(e.Seconds):e.Seconds:r.Seconds=t.longs===String?H.Long.prototype.toString.call(e.Seconds):t.longs===Number?new H.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber():e.Seconds),null!=e.FractionalNanoseconds&&e.hasOwnProperty("FractionalNanoseconds")&&(r.FractionalNanoseconds=e.FractionalNanoseconds),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),G.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.MimeType="",e.encode=function(e,t){return t||(t=$.create()),null!=e.MimeType&&Object.hasOwnProperty.call(e,"MimeType")&&t.uint32(10).string(e.MimeType),t},e.decode=function(e,t){e instanceof V||(e=V.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new G.Metadata;e.pos<r;){var s=e.uint32();s>>>3==1?n.MimeType=e.string():e.skipType(7&s)}return n},e.fromObject=function(e){if(e instanceof G.Metadata)return e;var t=new G.Metadata;return null!=e.MimeType&&(t.MimeType=String(e.MimeType)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(r.MimeType=""),null!=e.MimeType&&e.hasOwnProperty("MimeType")&&(r.MimeType=e.MimeType),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),q),W=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],Z=["directory","hamt-sharded-directory"],Y=parseInt("0644",8),J=parseInt("0755",8);function Q(e){if(null!=e)return"number"==typeof e?4095&e:"0"===(e=e.toString()).substring(0,1)?4095&parseInt(e,8):4095&parseInt(e,10)}function X(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const r=e.getTime(),n=Math.floor(r/1e3);t={secs:n,nsecs:1e3*(r-1e3*n)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw j(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}class ee{static unmarshal(e){const t=K.decode(e),r=K.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),n=new ee({type:W[r.Type],data:r.Data,blockSizes:r.blocksizes,mode:r.mode,mtime:r.mtime?{secs:r.mtime.Seconds,nsecs:r.mtime.FractionalNanoseconds}:void 0});return n._originalMode=r.mode||0,n}constructor(e={type:"file"}){const{type:t,data:r,blockSizes:n,hashType:s,fanout:i,mtime:o,mode:a}=e;if(t&&!W.includes(t))throw j(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=r,this.hashType=s,this.fanout=i,this.blockSizes=n||[],this._originalMode=0,this.mode=Q(a),o&&(this.mtime=X(o),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?J:Y;const t=Q(e);void 0!==t&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&Z.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach((t=>{e+=t})),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=K.DataType.Raw;break;case"directory":e=K.DataType.Directory;break;case"file":e=K.DataType.File;break;case"metadata":e=K.DataType.Metadata;break;case"symlink":e=K.DataType.Symlink;break;case"hamt-sharded-directory":e=K.DataType.HAMTShard;break;default:throw j(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t,r,n=this.data;if(this.data&&this.data.length||(n=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(Q(this.mode)||0),t!==Y||this.isDirectory()||(t=void 0),t===J&&this.isDirectory()&&(t=void 0)),null!=this.mtime){const e=X(this.mtime);e&&(r={Seconds:e.secs,FractionalNanoseconds:e.nsecs},0===r.FractionalNanoseconds&&delete r.FractionalNanoseconds)}const s={Type:e,Data:n,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:r};return K.encode(s).finish()}}var te=r(96582);const re=new TextDecoder;function ne(e,t){let r=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");const s=e[t++];if(r+=n<28?(127&s)<<n:(127&s)*2**n,s<128)break}return[r,t]}function se(e,t){let r;[r,t]=ne(e,t);const n=t+r;if(r<0||n<0)throw new Error("protobuf: invalid length");if(n>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,n),n]}function ie(e,t){let r;return[r,t]=ne(e,t),[7&r,r>>3,t]}function oe(e){const t={},r=e.length;let n=0;for(;n<r;){let r,s;if([r,s,n]=ie(e,n),1===s){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Hash`);if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,n]=se(e,n)}else if(2===s){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Name`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=se(e,n),t.Name=re.decode(s)}else{if(3!==s)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Tsize`);[t.Tsize,n]=ne(e,n)}}if(n>r)throw new Error("protobuf: (PBLink) unexpected end of data");return t}const ae=new TextEncoder,ce=2**32;function le(e,t){let r=t.length;if("number"==typeof e.Tsize){if(e.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(e.Tsize))throw new Error("Tsize too large for encoding");r=de(t,r,e.Tsize)-1,t[r]=24}if("string"==typeof e.Name){const n=ae.encode(e.Name);r-=n.length,t.set(n,r),r=de(t,r,n.length)-1,t[r]=18}return e.Hash&&(r-=e.Hash.length,t.set(e.Hash,r),r=de(t,r,e.Hash.length)-1,t[r]=10),t.length-r}function he(e){let t=0;if(e.Hash){const r=e.Hash.length;t+=1+r+ue(r)}if("string"==typeof e.Name){const r=ae.encode(e.Name).length;t+=1+r+ue(r)}return"number"==typeof e.Tsize&&(t+=1+ue(e.Tsize)),t}function de(e,t,r){const n=t-=ue(r);for(;r>=2147483648;)e[t++]=127&r|128,r/=128;for(;r>=128;)e[t++]=127&r|128,r>>>=7;return e[t]=r,n}function ue(e){return e%2==0&&e++,Math.floor((function(e){let t=0;return e>=ce&&(e=Math.floor(e/ce),t=32),e>=65536&&(e>>>=16,t+=16),e>=256&&(e>>>=8,t+=8),t+pe[e]}(e)+6)/7)}const pe=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],fe=["Data","Links"],ge=["Hash","Name","Tsize"],ye=new TextEncoder;function me(e,t){if(e===t)return 0;const r=e.Name?ye.encode(e.Name):[],n=t.Name?ye.encode(t.Name):[];let s=r.length,i=n.length;for(let e=0,t=Math.min(s,i);e<t;++e)if(r[e]!==n[e]){s=r[e],i=n[e];break}return s<i?-1:i<s?1:0}function we(e,t){return!Object.keys(e).some((e=>!t.includes(e)))}function be(e){if("object"==typeof e.asCID){const t=te.k.asCID(e);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if("object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(e.Hash){let r=te.k.asCID(e.Hash);try{r||("string"==typeof e.Hash?r=te.k.parse(e.Hash):e.Hash instanceof Uint8Array&&(r=te.k.decode(e.Hash)))}catch(e){throw new TypeError(`Invalid DAG-PB form: ${e.message}`)}r&&(t.Hash=r)}if(!t.Hash)throw new TypeError("Invalid DAG-PB form");return"string"==typeof e.Name&&(t.Name=e.Name),"number"==typeof e.Tsize&&(t.Tsize=e.Tsize),t}function _e(e){if((e instanceof Uint8Array||"string"==typeof e)&&(e={Data:e}),"object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(void 0!==e.Data)if("string"==typeof e.Data)t.Data=ye.encode(e.Data);else{if(!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form");t.Data=e.Data}if(void 0!==e.Links){if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form");t.Links=e.Links.map(be),t.Links.sort(me)}else t.Links=[];return t}function Ee(e){if(!e||"object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");if(!we(e,fe))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(void 0!==e.Data&&!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be a Uint8Array)");if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form (Links must be an array)");for(let t=0;t<e.Links.length;t++){const r=e.Links[t];if(!r||"object"!=typeof r||Array.isArray(r))throw new TypeError("Invalid DAG-PB form (bad link object)");if(!we(r,ge))throw new TypeError("Invalid DAG-PB form (extraneous properties on link object)");if(!r.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(r.Hash.asCID!==r.Hash)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(void 0!==r.Name&&"string"!=typeof r.Name)throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(void 0!==r.Tsize&&("number"!=typeof r.Tsize||r.Tsize%1!=0))throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t>0&&-1===me(r,e.Links[t-1]))throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function ve(e,t=[]){return _e({Data:e,Links:t})}function ke(e,t,r){return be({Hash:r,Name:e,Tsize:t})}const Se="dag-pb",Re=112;function Ie(e){Ee(e);const t={};return e.Links&&(t.Links=e.Links.map((e=>{const t={};return e.Hash&&(t.Hash=e.Hash.bytes),void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),e.Data&&(t.Data=e.Data),function(e){const t=function(e){let t=0;if(e.Data){const r=e.Data.length;t+=1+r+ue(r)}if(e.Links)for(const r of e.Links){const e=he(r);t+=1+e+ue(e)}return t}(e),r=new Uint8Array(t);let n=t;if(e.Data&&(n-=e.Data.length,r.set(e.Data,n),n=de(r,n,e.Data.length)-1,r[n]=10),e.Links)for(let t=e.Links.length-1;t>=0;t--){const s=le(e.Links[t],r.subarray(0,n));n-=s,n=de(r,n,s)-1,r[n]=18}return r}(t)}function Te(e){const t=function(e){const t=e.length;let r,n,s=0,i=!1;for(;s<t;){let t,o;if([t,o,s]=ie(e,s),2!==t)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${t}`);if(1===o){if(n)throw new Error("protobuf: (PBNode) duplicate Data section");[n,s]=se(e,s),r&&(i=!0)}else{if(2!==o)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${o}`);{if(i)throw new Error("protobuf: (PBNode) duplicate Links section");let t;r||(r=[]),[t,s]=se(e,s),r.push(oe(t))}}}if(s>t)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return n&&(o.Data=n),o.Links=r||[],o}(e),r={};return t.Data&&(r.Data=t.Data),t.Links&&(r.Links=t.Links.map((e=>{const t={};try{t.Hash=te.k.decode(e.Hash)}catch(e){}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),r}const Ae=["string","number","bigint","symbol"],Pe=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];class De{constructor(e,t,r){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}De.uint=new De(0,"uint",!0),De.negint=new De(1,"negint",!0),De.bytes=new De(2,"bytes",!0),De.string=new De(3,"string",!0),De.array=new De(4,"array",!1),De.map=new De(5,"map",!1),De.tag=new De(6,"tag",!1),De.float=new De(7,"float",!0),De.false=new De(7,"false",!0),De.true=new De(7,"true",!0),De.null=new De(7,"null",!0),De.undefined=new De(7,"undefined",!0),De.break=new De(7,"break",!0);class Oe{constructor(e,t,r){this.type=e,this.value=t,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const Ne=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.isBuffer,Ce=new TextDecoder,Me=new TextEncoder;function Le(e){return Ne&&globalThis.Buffer.isBuffer(e)}function xe(e){return e instanceof Uint8Array?Le(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e:Uint8Array.from(e)}const Be=Ne?(e,t,r)=>r-t>64?globalThis.Buffer.from(e.subarray(t,r)).toString("utf8"):He(e,t,r):(e,t,r)=>r-t>64?Ce.decode(e.subarray(t,r)):He(e,t,r),Ue=Ne?e=>e.length>64?globalThis.Buffer.from(e):$e(e):e=>e.length>64?Me.encode(e):$e(e),ze=e=>Uint8Array.from(e),je=Ne?(e,t,r)=>Le(e)?new Uint8Array(e.subarray(t,r)):e.slice(t,r):(e,t,r)=>e.slice(t,r),Fe=Ne?(e,t)=>(e=e.map((e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e))),xe(globalThis.Buffer.concat(e,t))):(e,t)=>{const r=new Uint8Array(t);let n=0;for(let t of e)n+t.length>r.length&&(t=t.subarray(0,r.length-n)),r.set(t,n),n+=t.length;return r},Ve=Ne?e=>globalThis.Buffer.allocUnsafe(e):e=>new Uint8Array(e);function $e(e,t=1/0){let r;const n=e.length;let s=null;const i=[];for(let o=0;o<n;++o){if(r=e.charCodeAt(o),r>55295&&r<57344){if(!s){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&i.push(239,191,189);continue}s=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),s=r;continue}r=65536+(s-55296<<10|r-56320)}else s&&(t-=3)>-1&&i.push(239,191,189);if(s=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function He(e,t,r){const n=[];for(;t<r;){const s=e[t];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(t+o<=r){let r,n,a,c;switch(o){case 1:s<128&&(i=s);break;case 2:r=e[t+1],128==(192&r)&&(c=(31&s)<<6|63&r,c>127&&(i=c));break;case 3:r=e[t+1],n=e[t+2],128==(192&r)&&128==(192&n)&&(c=(15&s)<<12|(63&r)<<6|63&n,c>2047&&(c<55296||c>57343)&&(i=c));break;case 4:r=e[t+1],n=e[t+2],a=e[t+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(c=(15&s)<<18|(63&r)<<12|(63&n)<<6|63&a,c>65535&&c<1114112&&(i=c))}}null===i?(i=65533,o=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|1023&i),n.push(i),t+=o}return Ge(n)}function Ge(e){const t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=4096));return r}class qe{constructor(e=256){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),null!==this._initReuseChunk&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const r=t.length-(this.maxCursor-this.cursor)-1;t.set(e,r)}else{if(t){const e=t.length-(this.maxCursor-this.cursor)-1;e<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,e),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=Ve(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,null===this._initReuseChunk&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(1===this.chunks.length){const r=this.chunks[0];e&&this.cursor>r.length/2?(t=this.cursor===r.length?r:r.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=je(r,0,this.cursor)}else t=Fe(this.chunks,this.cursor);return e&&this.reset(),t}}const Ke="CBOR decode error:",We="CBOR encode error:",Ze=[];function Ye(e,t,r){if(e.length-t<r)throw new Error(`${Ke} not enough data for type`)}Ze[23]=1,Ze[24]=2,Ze[25]=3,Ze[26]=5,Ze[27]=9;const Je=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Qe(e,t,r){Ye(e,t,1);const n=e[t];if(!0===r.strict&&n<Je[0])throw new Error(`${Ke} integer encoded in more bytes than necessary (strict decode)`);return n}function Xe(e,t,r){Ye(e,t,2);const n=e[t]<<8|e[t+1];if(!0===r.strict&&n<Je[1])throw new Error(`${Ke} integer encoded in more bytes than necessary (strict decode)`);return n}function et(e,t,r){Ye(e,t,4);const n=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];if(!0===r.strict&&n<Je[2])throw new Error(`${Ke} integer encoded in more bytes than necessary (strict decode)`);return n}function tt(e,t,r){Ye(e,t,8);const n=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3],s=16777216*e[t+4]+(e[t+5]<<16)+(e[t+6]<<8)+e[t+7],i=(BigInt(n)<<BigInt(32))+BigInt(s);if(!0===r.strict&&i<Je[3])throw new Error(`${Ke} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(!0===r.allowBigInt)return i;throw new Error(`${Ke} integers outside of the safe integer range are not supported`)}function rt(e,t){return nt(e,0,t.value)}function nt(e,t,r){if(r<Je[0]){const n=Number(r);e.push([t|n])}else if(r<Je[1]){const n=Number(r);e.push([24|t,n])}else if(r<Je[2]){const n=Number(r);e.push([25|t,n>>>8,255&n])}else if(r<Je[3]){const n=Number(r);e.push([26|t,n>>>24&255,n>>>16&255,n>>>8&255,255&n])}else{const n=BigInt(r);if(!(n<Je[4]))throw new Error(`${Ke} encountered BigInt larger than allowable range`);{const r=[27|t,0,0,0,0,0,0,0];let s=Number(n&BigInt(4294967295)),i=Number(n>>BigInt(32)&BigInt(4294967295));r[8]=255&s,s>>=8,r[7]=255&s,s>>=8,r[6]=255&s,s>>=8,r[5]=255&s,r[4]=255&i,i>>=8,r[3]=255&i,i>>=8,r[2]=255&i,i>>=8,r[1]=255&i,e.push(r)}}}rt.encodedSize=function(e){return nt.encodedSize(e.value)},nt.encodedSize=function(e){return e<Je[0]?1:e<Je[1]?2:e<Je[2]?3:e<Je[3]?5:9},rt.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};const st=BigInt(-1),it=BigInt(1);function ot(e,t){const r=t.value,n="bigint"==typeof r?r*st-it:-1*r-1;nt(e,t.type.majorEncoded,n)}function at(e,t,r,n){Ye(e,t,r+n);const s=je(e,t+r,t+r+n);return new Oe(De.bytes,s,r+n)}function ct(e,t,r,n){return at(e,t,1,r)}function lt(e){return void 0===e.encodedBytes&&(e.encodedBytes=e.type===De.string?Ue(e.value):e.value),e.encodedBytes}function ht(e,t){const r=lt(t);nt(e,t.type.majorEncoded,r.length),e.push(r)}function dt(e,t,r,n,s){const i=r+n;Ye(e,t,i);const o=new Oe(De.string,Be(e,t+r,t+i),i);return!0===s.retainStringBytes&&(o.byteValue=je(e,t+r,t+i)),o}function ut(e,t,r,n){return dt(e,t,1,r,n)}ot.encodedSize=function(e){const t=e.value,r="bigint"==typeof t?t*st-it:-1*t-1;return r<Je[0]?1:r<Je[1]?2:r<Je[2]?3:r<Je[3]?5:9},ot.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0},ht.encodedSize=function(e){const t=lt(e);return nt.encodedSize(t.length)+t.length},ht.compareTokens=function(e,t){return r=lt(e),n=lt(t),r.length<n.length?-1:r.length>n.length?1:function(e,t){if(Le(e)&&Le(t))return e.compare(t);for(let r=0;r<e.length;r++)if(e[r]!==t[r])return e[r]<t[r]?-1:1;return 0}(r,n);var r,n};const pt=ht;function ft(e,t,r,n){return new Oe(De.array,n,r)}function gt(e,t,r,n){return ft(0,0,1,r)}function yt(e,t){nt(e,De.array.majorEncoded,t.value)}function mt(e,t,r,n){return new Oe(De.map,n,r)}function wt(e,t,r,n){return mt(0,0,1,r)}function bt(e,t){nt(e,De.map.majorEncoded,t.value)}function _t(e,t,r,n){return new Oe(De.tag,r,1)}function Et(e,t){nt(e,De.tag.majorEncoded,t.value)}function vt(e,t,r){if(r){if(!1===r.allowNaN&&Number.isNaN(e))throw new Error(`${Ke} NaN values are not supported`);if(!1===r.allowInfinity&&(e===1/0||e===-1/0))throw new Error(`${Ke} Infinity values are not supported`)}return new Oe(De.float,e,t)}function kt(e,t,r){const n=t.value;if(!1===n)e.push([20|De.float.majorEncoded]);else if(!0===n)e.push([21|De.float.majorEncoded]);else if(null===n)e.push([22|De.float.majorEncoded]);else if(void 0===n)e.push([23|De.float.majorEncoded]);else{let t,i=!1;r&&!0===r.float64||(Tt(n),t=At(It,1),n===t||Number.isNaN(n)?(It[0]=249,e.push(It.slice(0,3)),i=!0):(Pt(n),t=Dt(It,1),n===t&&(It[0]=250,e.push(It.slice(0,5)),i=!0))),i||(s=n,Rt.setFloat64(0,s,!1),t=Ot(It,1),It[0]=251,e.push(It.slice(0,9)))}var s}yt.compareTokens=rt.compareTokens,yt.encodedSize=function(e){return nt.encodedSize(e.value)},bt.compareTokens=rt.compareTokens,bt.encodedSize=function(e){return nt.encodedSize(e.value)},Et.compareTokens=rt.compareTokens,Et.encodedSize=function(e){return nt.encodedSize(e.value)},kt.encodedSize=function(e,t){const r=e.value;if(!1===r||!0===r||null==r)return 1;if(!t||!0!==t.float64){Tt(r);let e=At(It,1);if(r===e||Number.isNaN(r))return 3;if(Pt(r),e=Dt(It,1),r===e)return 5}return 9};const St=new ArrayBuffer(9),Rt=new DataView(St,1),It=new Uint8Array(St,0);function Tt(e){if(e===1/0)Rt.setUint16(0,31744,!1);else if(e===-1/0)Rt.setUint16(0,64512,!1);else if(Number.isNaN(e))Rt.setUint16(0,32256,!1);else{Rt.setFloat32(0,e);const t=Rt.getUint32(0),r=(2139095040&t)>>23,n=8388607&t;if(255===r)Rt.setUint16(0,31744,!1);else if(0===r)Rt.setUint16(0,(2147483648&e)>>16|n>>13,!1);else{const e=r-127;e<-24?Rt.setUint16(0,0):e<-14?Rt.setUint16(0,(2147483648&t)>>16|1<<24+e,!1):Rt.setUint16(0,(2147483648&t)>>16|e+15<<10|n>>13,!1)}}}function At(e,t){if(e.length-t<2)throw new Error(`${Ke} not enough data for float16`);const r=(e[t]<<8)+e[t+1];if(31744===r)return 1/0;if(64512===r)return-1/0;if(32256===r)return NaN;const n=r>>10&31,s=1023&r;let i;return i=0===n?s*2**-24:31!==n?(s+1024)*2**(n-25):0===s?1/0:NaN,32768&r?-i:i}function Pt(e){Rt.setFloat32(0,e,!1)}function Dt(e,t){if(e.length-t<4)throw new Error(`${Ke} not enough data for float32`);const r=(e.byteOffset||0)+t;return new DataView(e.buffer,r,4).getFloat32(0,!1)}function Ot(e,t){if(e.length-t<8)throw new Error(`${Ke} not enough data for float64`);const r=(e.byteOffset||0)+t;return new DataView(e.buffer,r,8).getFloat64(0,!1)}function Nt(e,t,r){throw new Error(`${Ke} encountered invalid minor (${r}) for major ${e[t]>>>5}`)}function Ct(e){return()=>{throw new Error(`${Ke} ${e}`)}}kt.compareTokens=rt.compareTokens;const Mt=[];for(let e=0;e<=23;e++)Mt[e]=Nt;Mt[24]=function(e,t,r,n){return new Oe(De.uint,Qe(e,t+1,n),2)},Mt[25]=function(e,t,r,n){return new Oe(De.uint,Xe(e,t+1,n),3)},Mt[26]=function(e,t,r,n){return new Oe(De.uint,et(e,t+1,n),5)},Mt[27]=function(e,t,r,n){return new Oe(De.uint,tt(e,t+1,n),9)},Mt[28]=Nt,Mt[29]=Nt,Mt[30]=Nt,Mt[31]=Nt;for(let e=32;e<=55;e++)Mt[e]=Nt;Mt[56]=function(e,t,r,n){return new Oe(De.negint,-1-Qe(e,t+1,n),2)},Mt[57]=function(e,t,r,n){return new Oe(De.negint,-1-Xe(e,t+1,n),3)},Mt[58]=function(e,t,r,n){return new Oe(De.negint,-1-et(e,t+1,n),5)},Mt[59]=function(e,t,r,n){const s=tt(e,t+1,n);if("bigint"!=typeof s){const e=-1-s;if(e>=Number.MIN_SAFE_INTEGER)return new Oe(De.negint,e,9)}if(!0!==n.allowBigInt)throw new Error(`${Ke} integers outside of the safe integer range are not supported`);return new Oe(De.negint,st-BigInt(s),9)},Mt[60]=Nt,Mt[61]=Nt,Mt[62]=Nt,Mt[63]=Nt;for(let e=64;e<=87;e++)Mt[e]=ct;Mt[88]=function(e,t,r,n){return at(e,t,2,Qe(e,t+1,n))},Mt[89]=function(e,t,r,n){return at(e,t,3,Xe(e,t+1,n))},Mt[90]=function(e,t,r,n){return at(e,t,5,et(e,t+1,n))},Mt[91]=function(e,t,r,n){const s=tt(e,t+1,n);if("bigint"==typeof s)throw new Error(`${Ke} 64-bit integer bytes lengths not supported`);return at(e,t,9,s)},Mt[92]=Nt,Mt[93]=Nt,Mt[94]=Nt,Mt[95]=Ct("indefinite length bytes/strings are not supported");for(let e=96;e<=119;e++)Mt[e]=ut;Mt[120]=function(e,t,r,n){return dt(e,t,2,Qe(e,t+1,n),n)},Mt[121]=function(e,t,r,n){return dt(e,t,3,Xe(e,t+1,n),n)},Mt[122]=function(e,t,r,n){return dt(e,t,5,et(e,t+1,n),n)},Mt[123]=function(e,t,r,n){const s=tt(e,t+1,n);if("bigint"==typeof s)throw new Error(`${Ke} 64-bit integer string lengths not supported`);return dt(e,t,9,s,n)},Mt[124]=Nt,Mt[125]=Nt,Mt[126]=Nt,Mt[127]=Ct("indefinite length bytes/strings are not supported");for(let e=128;e<=151;e++)Mt[e]=gt;Mt[152]=function(e,t,r,n){return ft(0,0,2,Qe(e,t+1,n))},Mt[153]=function(e,t,r,n){return ft(0,0,3,Xe(e,t+1,n))},Mt[154]=function(e,t,r,n){return ft(0,0,5,et(e,t+1,n))},Mt[155]=function(e,t,r,n){const s=tt(e,t+1,n);if("bigint"==typeof s)throw new Error(`${Ke} 64-bit integer array lengths not supported`);return ft(0,0,9,s)},Mt[156]=Nt,Mt[157]=Nt,Mt[158]=Nt,Mt[159]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ke} indefinite length items not allowed`);return ft(0,0,1,1/0)};for(let e=160;e<=183;e++)Mt[e]=wt;Mt[184]=function(e,t,r,n){return mt(0,0,2,Qe(e,t+1,n))},Mt[185]=function(e,t,r,n){return mt(0,0,3,Xe(e,t+1,n))},Mt[186]=function(e,t,r,n){return mt(0,0,5,et(e,t+1,n))},Mt[187]=function(e,t,r,n){const s=tt(e,t+1,n);if("bigint"==typeof s)throw new Error(`${Ke} 64-bit integer map lengths not supported`);return mt(0,0,9,s)},Mt[188]=Nt,Mt[189]=Nt,Mt[190]=Nt,Mt[191]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ke} indefinite length items not allowed`);return mt(0,0,1,1/0)};for(let e=192;e<=215;e++)Mt[e]=_t;Mt[216]=function(e,t,r,n){return new Oe(De.tag,Qe(e,t+1,n),2)},Mt[217]=function(e,t,r,n){return new Oe(De.tag,Xe(e,t+1,n),3)},Mt[218]=function(e,t,r,n){return new Oe(De.tag,et(e,t+1,n),5)},Mt[219]=function(e,t,r,n){return new Oe(De.tag,tt(e,t+1,n),9)},Mt[220]=Nt,Mt[221]=Nt,Mt[222]=Nt,Mt[223]=Nt;for(let e=224;e<=243;e++)Mt[e]=Ct("simple values are not supported");Mt[244]=Nt,Mt[245]=Nt,Mt[246]=Nt,Mt[247]=function(e,t,r,n){if(!1===n.allowUndefined)throw new Error(`${Ke} undefined values are not supported`);return!0===n.coerceUndefinedToNull?new Oe(De.null,null,1):new Oe(De.undefined,void 0,1)},Mt[248]=Ct("simple values are not supported"),Mt[249]=function(e,t,r,n){return vt(At(e,t+1),3,n)},Mt[250]=function(e,t,r,n){return vt(Dt(e,t+1),5,n)},Mt[251]=function(e,t,r,n){return vt(Ot(e,t+1),9,n)},Mt[252]=Nt,Mt[253]=Nt,Mt[254]=Nt,Mt[255]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ke} indefinite length items not allowed`);return new Oe(De.break,void 0,1)};const Lt=[];for(let e=0;e<24;e++)Lt[e]=new Oe(De.uint,e,1);for(let e=-1;e>=-24;e--)Lt[31-e]=new Oe(De.negint,e,1);Lt[64]=new Oe(De.bytes,new Uint8Array(0),1),Lt[96]=new Oe(De.string,"",1),Lt[128]=new Oe(De.array,0,1),Lt[160]=new Oe(De.map,0,1),Lt[244]=new Oe(De.false,!1,1),Lt[245]=new Oe(De.true,!0,1),Lt[246]=new Oe(De.null,null,1);var xt=r(82784);const Bt={float64:!1,mapSorter:function(e,t){const r=Array.isArray(e[0])?e[0][0]:e[0],n=Array.isArray(t[0])?t[0][0]:t[0];if(r.type!==n.type)return r.type.compare(n.type);const s=r.type.major,i=Ut[s].compareTokens(r,n);return 0===i&&xt.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i},quickEncodeToken:function(e){switch(e.type){case De.false:return ze([244]);case De.true:return ze([245]);case De.null:return ze([246]);case De.bytes:return e.value.length?void 0:ze([64]);case De.string:return""===e.value?ze([96]):void 0;case De.array:return 0===e.value?ze([128]):void 0;case De.map:return 0===e.value?ze([160]):void 0;case De.uint:return e.value<24?ze([Number(e.value)]):void 0;case De.negint:if(e.value>=-24)return ze([31-Number(e.value)])}}},Ut=function(){const e=[];return e[De.uint.major]=rt,e[De.negint.major]=ot,e[De.bytes.major]=ht,e[De.string.major]=pt,e[De.array.major]=yt,e[De.map.major]=bt,e[De.tag.major]=Et,e[De.float.major]=kt,e}(),zt=new qe;class jt{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do{if(t.obj===e)return!0}while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${We} object contains circular references`);return new jt(t,e)}}const Ft={null:new Oe(De.null,null),undefined:new Oe(De.undefined,void 0),true:new Oe(De.true,!0),false:new Oe(De.false,!1),emptyArray:new Oe(De.array,0),emptyMap:new Oe(De.map,0)},Vt={number:(e,t,r,n)=>Number.isInteger(e)&&Number.isSafeInteger(e)?new Oe(e>=0?De.uint:De.negint,e):new Oe(De.float,e),bigint:(e,t,r,n)=>e>=BigInt(0)?new Oe(De.uint,e):new Oe(De.negint,e),Uint8Array:(e,t,r,n)=>new Oe(De.bytes,e),string:(e,t,r,n)=>new Oe(De.string,e),boolean:(e,t,r,n)=>e?Ft.true:Ft.false,null:(e,t,r,n)=>Ft.null,undefined:(e,t,r,n)=>Ft.undefined,ArrayBuffer:(e,t,r,n)=>new Oe(De.bytes,new Uint8Array(e)),DataView:(e,t,r,n)=>new Oe(De.bytes,new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),Array(e,t,r,n){if(!e.length)return!0===r.addBreakTokens?[Ft.emptyArray,new Oe(De.break)]:Ft.emptyArray;n=jt.createCheck(n,e);const s=[];let i=0;for(const t of e)s[i++]=$t(t,r,n);return r.addBreakTokens?[new Oe(De.array,e.length),s,new Oe(De.break)]:[new Oe(De.array,e.length),s]},Object(e,t,r,n){const s="Object"!==t,i=s?e.keys():Object.keys(e),o=s?e.size:i.length;if(!o)return!0===r.addBreakTokens?[Ft.emptyMap,new Oe(De.break)]:Ft.emptyMap;n=jt.createCheck(n,e);const a=[];let c=0;for(const t of i)a[c++]=[$t(t,r,n),$t(s?e.get(t):e[t],r,n)];return function(e,t){t.mapSorter&&e.sort(t.mapSorter)}(a,r),r.addBreakTokens?[new Oe(De.map,o),a,new Oe(De.break)]:[new Oe(De.map,o),a]}};Vt.Map=Vt.Object,Vt.Buffer=Vt.Uint8Array;for(const e of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Vt[`${e}Array`]=Vt.DataView;function $t(e,t={},r){const n=function(e){if(null===e)return"null";if(void 0===e)return"undefined";if(!0===e||!1===e)return"boolean";const t=typeof e;if(Ae.includes(t))return t;if("function"===t)return"Function";if(Array.isArray(e))return"Array";if(function(e){return e&&e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer.call(null,e)}(e))return"Buffer";return function(e){const t=Object.prototype.toString.call(e).slice(8,-1);if(Pe.includes(t))return t}(e)||"Object"}(e),s=t&&t.typeEncoders&&t.typeEncoders[n]||Vt[n];if("function"==typeof s){const i=s(e,n,t,r);if(null!=i)return i}const i=Vt[n];if(!i)throw new Error(`${We} unsupported type: ${n}`);return i(e,n,t,r)}function Ht(e,t,r,n){if(Array.isArray(t))for(const s of t)Ht(e,s,r,n);else r[t.type.major](e,t,n)}function Gt(e,t,r){const n=$t(e,r);if(!Array.isArray(n)&&r.quickEncodeToken){const e=r.quickEncodeToken(n);if(e)return e;const s=t[n.type.major];if(s.encodedSize){const e=s.encodedSize(n,r),t=new qe(e);if(s(t,n,r),1!==t.chunks.length)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return xe(t.chunks[0])}}return zt.reset(),Ht(zt,n,t,r),zt.toBytes(!0)}function qt(e,t){return t=Object.assign({},Bt,t),Gt(e,Ut,t)}const Kt={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class Wt{constructor(e,t={}){this.pos=0,this.data=e,this.options=t}done(){return this.pos>=this.data.length}next(){const e=this.data[this.pos];let t=Lt[e];if(void 0===t){const r=Mt[e];if(!r)throw new Error(`${Ke} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const n=31&e;t=r(this.data,this.pos,n,this.options)}return this.pos+=t.encodedLength,t}}const Zt=Symbol.for("DONE"),Yt=Symbol.for("BREAK");function Jt(e,t){if(e.done())return Zt;const r=e.next();if(r.type===De.break)return Yt;if(r.type.terminal)return r.value;if(r.type===De.array)return function(e,t,r){const n=[];for(let s=0;s<e.value;s++){const i=Jt(t,r);if(i===Yt){if(e.value===1/0)break;throw new Error(`${Ke} got unexpected break to lengthed array`)}if(i===Zt)throw new Error(`${Ke} found array but not enough entries (got ${s}, expected ${e.value})`);n[s]=i}return n}(r,e,t);if(r.type===De.map)return function(e,t,r){const n=!0===r.useMaps,s=n?void 0:{},i=n?new Map:void 0;for(let o=0;o<e.value;o++){const a=Jt(t,r);if(a===Yt){if(e.value===1/0)break;throw new Error(`${Ke} got unexpected break to lengthed map`)}if(a===Zt)throw new Error(`${Ke} found map but not enough entries (got ${o} [no key], expected ${e.value})`);if(!0!==n&&"string"!=typeof a)throw new Error(`${Ke} non-string keys not supported (got ${typeof a})`);const c=Jt(t,r);if(c===Zt)throw new Error(`${Ke} found map but not enough entries (got ${o} [no value], expected ${e.value})`);n?i.set(a,c):s[a]=c}return n?i:s}(r,e,t);if(r.type===De.tag){if(t.tags&&"function"==typeof t.tags[r.value]){const n=Jt(e,t);return t.tags[r.value](n)}throw new Error(`${Ke} tag not supported (${r.value})`)}throw new Error("unsupported")}function Qt(e,t){if(!(e instanceof Uint8Array))throw new Error(`${Ke} data to decode must be a Uint8Array`);const r=(t=Object.assign({},Kt,t)).tokenizer||new Wt(e,t),n=Jt(r,t);if(n===Zt)throw new Error(`${Ke} did not find any content to decode`);if(n===Yt)throw new Error(`${Ke} got unexpected break`);if(!r.done())throw new Error(`${Ke} too many terminals, data makes no sense`);return n}const Xt={float64:!0,typeEncoders:{Object:function(e){if(e.asCID!==e&&e["/"]!==e.bytes)return null;const t=te.k.asCID(e);if(!t)return null;const r=new Uint8Array(t.bytes.byteLength+1);return r.set(t.bytes,1),[new Oe(De.tag,42),new Oe(De.bytes,r)]},undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(e){if(Number.isNaN(e))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(e===1/0||e===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}},er={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,tags:[]};er.tags[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return te.k.decode(e.subarray(1))};const tr="dag-cbor",rr=113,nr=e=>qt(e,Xt),sr=e=>Qt(e,er);var ir=r(61058),or=r(47408);class ar extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===De.array&&(t.elements++,1!==t.elements&&e.push([44])),t.type===De.map&&(t.elements++,1!==t.elements&&(t.elements%2==1?e.push([44]):e.push([58]))))}[De.uint.major](e,t){this.prefix(e);const r=String(t.value),n=[];for(let e=0;e<r.length;e++)n[e]=r.charCodeAt(e);e.push(n)}[De.negint.major](e,t){this[De.uint.major](e,t)}[De.bytes.major](e,t){throw new Error(`${We} unsupported type: Uint8Array`)}[De.string.major](e,t){this.prefix(e);const r=Ue(JSON.stringify(t.value));e.push(r.length>32?xe(r):r)}[De.array.major](e,t){this.prefix(e),this.inRecursive.push({type:De.array,elements:0}),e.push([91])}[De.map.major](e,t){this.prefix(e),this.inRecursive.push({type:De.map,elements:0}),e.push([123])}[De.tag.major](e,t){}[De.float.major](e,t){if("break"===t.type.name){const t=this.inRecursive.pop();if(t){if(t.type===De.array)e.push([93]);else{if(t.type!==De.map)throw new Error("Unexpected recursive type; this should not happen!");e.push([125])}return}throw new Error("Unexpected break; this should not happen!")}if(void 0===t.value)throw new Error(`${We} unsupported type: undefined`);if(this.prefix(e),"true"===t.type.name)return void e.push([116,114,117,101]);if("false"===t.type.name)return void e.push([102,97,108,115,101]);if("null"===t.type.name)return void e.push([110,117,108,108]);const r=String(t.value),n=[];let s=!1;for(let e=0;e<r.length;e++)n[e]=r.charCodeAt(e),s||46!==n[e]&&101!==n[e]&&69!==n[e]||(s=!0);s||(n.push(46),n.push(48)),e.push(n)}}const cr={addBreakTokens:!0,mapSorter:function(e,t){if(Array.isArray(e[0])||Array.isArray(t[0]))throw new Error(`${We} complex map keys are not supported`);const r=e[0],n=t[0];if(r.type!==De.string||n.type!==De.string)throw new Error(`${We} non-string map keys are not supported`);if(r<n)return-1;if(r>n)return 1;throw new Error(`${We} unexpected duplicate map keys, this is not supported`)}};class lr{constructor(e,t={}){this.pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}done(){return this.pos>=this.data.length}ch(){return this.data[this.pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;32===e||9===e||13===e||10===e;)e=this.data[++this.pos]}expect(e){if(this.data.length-this.pos<e.length)throw new Error(`${Ke} unexpected end of input at position ${this.pos}`);for(let t=0;t<e.length;t++)if(this.data[this.pos++]!==e[t])throw new Error(`${Ke} unexpected token at position ${this.pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this.pos;let t=!1,r=!1;const n=e=>{for(;!this.done();){const t=this.ch();if(!e.includes(t))break;this.pos++}};if(45===this.ch()&&(t=!0,this.pos++),48===this.ch()){if(this.pos++,46!==this.ch())return new Oe(De.uint,0,this.pos-e);this.pos++,r=!0}if(n([48,49,50,51,52,53,54,55,56,57]),t&&this.pos===e+1)throw new Error(`${Ke} unexpected token at position ${this.pos}`);if(!this.done()&&46===this.ch()){if(r)throw new Error(`${Ke} unexpected token at position ${this.pos}`);r=!0,this.pos++,n([48,49,50,51,52,53,54,55,56,57])}this.done()||101!==this.ch()&&69!==this.ch()||(r=!0,this.pos++,this.done()||43!==this.ch()&&45!==this.ch()||this.pos++,n([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this.pos)),i=parseFloat(s);return r?new Oe(De.float,i,this.pos-e):!0!==this.options.allowBigInt||Number.isSafeInteger(i)?new Oe(i>=0?De.uint:De.negint,i,this.pos-e):new Oe(i>=0?De.uint:De.negint,BigInt(s),this.pos-e)}parseString(){if(34!==this.ch())throw new Error(`${Ke} unexpected character at position ${this.pos}; this shouldn't happen`);this.pos++;for(let e=this.pos,t=0;e<this.data.length&&t<65536;e++,t++){const r=this.data[e];if(92===r||r<32||r>=128)break;if(34===r){const r=String.fromCharCode.apply(null,this.data.subarray(this.pos,e));return this.pos=e+1,new Oe(De.string,r,t)}}const e=this.pos,t=[],r=()=>{if(this.pos+4>=this.data.length)throw new Error(`${Ke} unexpected end of unicode escape sequence at position ${this.pos}`);let e=0;for(let t=0;t<4;t++){let t=this.ch();if(t>=48&&t<=57)t-=48;else if(t>=97&&t<=102)t=t-97+10;else{if(!(t>=65&&t<=70))throw new Error(`${Ke} unexpected unicode escape character at position ${this.pos}`);t=t-65+10}e=16*e+t,this.pos++}return e},n=()=>{const e=this.ch();let r,n,s,i,o=null,a=e>239?4:e>223?3:e>191?2:1;if(this.pos+a>this.data.length)throw new Error(`${Ke} unexpected unicode sequence at position ${this.pos}`);switch(a){case 1:e<128&&(o=e);break;case 2:r=this.data[this.pos+1],128==(192&r)&&(i=(31&e)<<6|63&r,i>127&&(o=i));break;case 3:r=this.data[this.pos+1],n=this.data[this.pos+2],128==(192&r)&&128==(192&n)&&(i=(15&e)<<12|(63&r)<<6|63&n,i>2047&&(i<55296||i>57343)&&(o=i));break;case 4:r=this.data[this.pos+1],n=this.data[this.pos+2],s=this.data[this.pos+3],128==(192&r)&&128==(192&n)&&128==(192&s)&&(i=(15&e)<<18|(63&r)<<12|(63&n)<<6|63&s,i>65535&&i<1114112&&(o=i))}null===o?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|1023&o),t.push(o),this.pos+=a};for(;!this.done();){const s=this.ch();let i;switch(s){case 92:if(this.pos++,this.done())throw new Error(`${Ke} unexpected string termination at position ${this.pos}`);switch(i=this.ch(),this.pos++,i){case 34:case 39:case 92:case 47:t.push(i);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(r());break;default:throw new Error(`${Ke} unexpected string escape character at position ${this.pos}`)}break;case 34:return this.pos++,new Oe(De.string,Ge(t),this.pos-e);default:if(s<32)throw new Error(`${Ke} invalid control character at position ${this.pos}`);s<128?(t.push(s),this.pos++):n()}}throw new Error(`${Ke} unexpected end of string at position ${this.pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this.pos++,new Oe(De.map,1/0,1);case 91:return this.modeStack.push("array-start"),this.pos++,new Oe(De.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Oe(De.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Oe(De.false,!1,5);case 116:return this.expect([116,114,117,101]),new Oe(De.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${Ke} unexpected character at position ${this.pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":if(this.modeStack.pop(),93===this.ch())return this.pos++,this.skipWhitespace(),new Oe(De.break,void 0,1);if(44!==this.ch())throw new Error(`${Ke} unexpected character at position ${this.pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue();case"array-start":return this.modeStack.pop(),93===this.ch()?(this.pos++,this.skipWhitespace(),new Oe(De.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(125===this.ch())return this.modeStack.pop(),this.pos++,this.skipWhitespace(),new Oe(De.break,void 0,1);if(44!==this.ch())throw new Error(`${Ke} unexpected character at position ${this.pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this.pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),125===this.ch())return this.pos++,this.skipWhitespace(),new Oe(De.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),58!==this.ch())throw new Error(`${Ke} unexpected character at position ${this.pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${Ke} unexpected parse state at position ${this.pos}; this shouldn't happen`)}}}function hr(e){const t=or.base64.encode(e).slice(1);return[new Oe(De.map,1/0,1),new Oe(De.string,"/",1),new Oe(De.map,1/0,1),new Oe(De.string,"bytes",5),new Oe(De.string,t,t.length),new Oe(De.break,void 0,1),new Oe(De.break,void 0,1)]}const dr={typeEncoders:{Object:function(e){if(e.asCID!==e&&e["/"]!==e.bytes)return null;const t=ir.k0.asCID(e);if(!t)return null;const r=t.toString();return[new Oe(De.map,1/0,1),new Oe(De.string,"/",1),new Oe(De.string,r,r.length),new Oe(De.break,void 0,1)]},Uint8Array:hr,Buffer:hr,undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(e){if(Number.isNaN(e))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(e===1/0||e===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}};class ur extends lr{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===De.map){const e=this._next();if(e.type===De.string&&"/"===e.value){const e=this._next();if(e.type===De.string){if(this._next().type!==De.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new Oe(De.tag,42,0)}if(e.type===De.map){const e=this._next();if(e.type===De.string&&"bytes"===e.value){const e=this._next();if(e.type===De.string){for(let e=0;e<2;e++)if(this._next().type!==De.break)throw new Error("Invalid encoded Bytes form");const t=or.base64.decode(`m${e.value}`);return new Oe(De.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const pr={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,tags:[]};pr.tags[42]=ir.k0.parse;const fr="dag-json",gr=297,yr=e=>{return t=e,r=dr,r=Object.assign({},cr,r),Gt(t,new ar,r);var t,r},mr=e=>function(e,t){return Qt(e,t=Object.assign({tokenizer:new lr(e,t)},t))}(e,Object.assign(pr,{tokenizer:new ur(e,pr)})),wr=e=>br.decode(yr(e)),br=new TextDecoder,_r=e=>mr(Er.encode(e)),Er=new TextEncoder;function vr(e){return or.base64url.encode(e).slice(1)}function kr(e){return or.base64url.decode(`u${e}`)}function Sr(e){const t={signature:kr(e.signature)};return e.header&&(t.header=e.header),e.protected&&(t.protected=kr(e.protected)),t}function Rr(e){const t={signature:vr(e.signature)};return e.header&&(t.header=e.header),e.protected&&(t.protected=vr(e.protected)),t}function Ir(e){const t={};return e.encrypted_key&&(t.encrypted_key=kr(e.encrypted_key)),e.header&&(t.header=e.header),t}function Tr(e){const t={};return e.encrypted_key&&(t.encrypted_key=vr(e.encrypted_key)),e.header&&(t.header=e.header),t}const Ar="dag-jose",Pr=133;function Dr(e){return"payload"in e&&"string"==typeof e.payload&&"signatures"in e&&Array.isArray(e.signatures)}function Or(e){return"ciphertext"in e&&"string"==typeof e.ciphertext&&"iv"in e&&"string"==typeof e.iv&&"protected"in e&&"string"==typeof e.protected&&"tag"in e&&"string"==typeof e.tag}function Nr(e){if("string"==typeof e){const t=e.split(".");if(3===t.length)return function(e){const[t,r,n]=e;return{payload:r,signatures:[{protected:t,signature:n}],link:te.k.decode(kr(r))}}(t);if(5===t.length)return function(e){const[t,r,n,s,i]=e,o={ciphertext:s,iv:n,protected:t,tag:i};return r&&(o.recipients=[{encrypted_key:r}]),o}(t);throw new Error("Not a valid JOSE string")}if(Dr(e)||Or(e))return e;throw new Error("Not a valid unencoded JOSE object")}function Cr(e){let t;if("string"==typeof e&&(e=Nr(e)),Dr(e))t=function(e){const t=kr(e.payload);try{te.k.decode(t)}catch(e){throw new Error("Not a valid DagJWS")}return{payload:t,signatures:e.signatures.map(Sr)}}(e);else{if(!Or(e))throw new Error("Not a valid JOSE object");t=function(e){const t={ciphertext:kr(e.ciphertext),protected:kr(e.protected),iv:kr(e.iv),tag:kr(e.tag)};return e.aad&&(t.aad=kr(e.aad)),e.recipients&&(t.recipients=e.recipients.map(Ir)),e.unprotected&&(t.unprotected=e.unprotected),t}(e)}return new Uint8Array(nr(t))}function Mr(e){let t;try{t=sr(e)}catch(e){throw new Error("Not a valid DAG-JOSE object")}if("payload"in(r=t)&&r.payload instanceof Uint8Array&&"signatures"in r&&Array.isArray(r.signatures))return function(e){const t={payload:vr(e.payload),signatures:e.signatures.map(Rr)};return t.link=te.k.decode(new Uint8Array(e.payload)),t}(t);if(function(e){return"ciphertext"in e&&e.ciphertext instanceof Uint8Array&&"iv"in e&&e.iv instanceof Uint8Array&&"protected"in e&&e.protected instanceof Uint8Array&&"tag"in e&&e.tag instanceof Uint8Array}(t))return function(e){const t={ciphertext:vr(e.ciphertext),protected:vr(e.protected),iv:vr(e.iv),tag:vr(e.tag)};return e.aad&&(t.aad=vr(e.aad)),e.recipients&&(t.recipients=e.recipients.map(Tr)),e.unprotected&&(t.unprotected=e.unprotected),t}(t);throw new Error("Not a valid DAG-JOSE object");var r}var Lr=r(39797),xr=r(14957);class Br extends Error{constructor(e="not initialized"){super(e),this.name="NotInitializedError",this.code=Br.code}}Br.code="ERR_NOT_INITIALIZED";class Ur extends Error{constructor(e="cannot initialize an initializing node"){super(e),this.name="AlreadyInitializingError",this.code=zr.code}}Ur.code="ERR_ALREADY_INITIALIZING";class zr extends Error{constructor(e="cannot re-initialize an initialized node"){super(e),this.name="AlreadyInitializedError",this.code=zr.code}}zr.code="ERR_ALREADY_INITIALIZED";class jr extends Error{constructor(e="not started"){super(e),this.name="NotStartedError",this.code=jr.code}}jr.code="ERR_NOT_STARTED";class Fr extends Error{constructor(e="cannot start, already startin"){super(e),this.name="AlreadyStartingError",this.code=Fr.code}}Fr.code="ERR_ALREADY_STARTING";class Vr extends Error{constructor(e="cannot start, already started"){super(e),this.name="AlreadyStartedError",this.code=Vr.code}}Vr.code="ERR_ALREADY_STARTED";class $r extends Error{constructor(e="not enabled"){super(e),this.name="NotEnabledError",this.code=$r.code}}$r.code="ERR_NOT_ENABLED";var Hr=r(53376),Gr=r(12964),qr=r(79350),Kr=r(55574),Wr=r(15378),Zr=r(31587),Yr=r(32152),Jr=r(21963),Qr=r(50973);const Xr=/^\/(ip[fn]s)\/([^/?#]+)/,en=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,tn=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function rn(e){try{return on(e)?Boolean(te.k.parse(e)):e instanceof Uint8Array?Boolean(te.k.decode(e)):Boolean(te.k.asCID(e))}catch{return!1}}function nn(e,t,r=1,n=2){const s=an(e);if(!1===s)return!1;const i=s.match(t);if(null==i)return!1;if("ipfs"!==i[r])return!1;let o=i[n];return null!=o&&t===en&&(o=o.toLowerCase()),rn(o)}function sn(e,t,r=1,n=2){const s=an(e);if(!1===s)return!1;const i=s.match(t);if(null==i)return!1;if("ipns"!==i[r])return!1;let o=i[n];if(null!=o&&t===en){if(o=o.toLowerCase(),rn(o))return!0;try{!o.includes(".")&&o.includes("-")&&(o=o.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:e}=new Jr.URL(`http://${o}`);return tn.test(e)}catch(e){return!1}}return!0}function on(e){return"string"==typeof e}function an(e){return e instanceof Uint8Array?(0,Qr.B)(e,"base58btc"):!!on(e)&&e}const cn=e=>nn(e,Xr)||sn(e,Xr),ln=e=>sn(e,Xr);var hn=r(48443),dn=r(92360);let un=/(-?(?:\d+\.?\d*|\d*\.?\d+)(?:e[-+]?\d+)?)\s*([\p{L}]*)/giu;function pn(e="",t="ms"){var r=null;return(e=(e+"").replace(/(\d)[,_](\d)/g,"$1$2")).replace(un,(function(e,t,n){(n=fn(n))&&(r=(r||0)+parseFloat(t,10)*n)})),r&&r/(fn(t)||1)}function fn(e){return pn[e]||pn[e.toLowerCase().replace(/s$/,"")]}pn.nanosecond=pn.ns=1e-6,pn["s"]=pn["s"]=pn.us=pn.microsecond=.001,pn.millisecond=pn.ms=pn[""]=1,pn.second=pn.sec=pn.s=1e3*pn.ms,pn.minute=pn.min=pn.m=60*pn.s,pn.hour=pn.hr=pn.h=60*pn.m,pn.day=pn.d=24*pn.h,pn.week=pn.wk=pn.w=7*pn.d,pn.month=pn.b=30.4375*pn.d,pn.year=pn.yr=pn.y=365.25*pn.d;const gn=pn;class yn extends Error{constructor(e="request timed out"){super(e),this.name="TimeoutError",this.code=yn.code}}function mn(e,t){return(...r)=>{const n=r[null==t?r.length-1:t];if(!n||!n.timeout)return e(...r);const s="string"==typeof n.timeout?gn(n.timeout):n.timeout,i=new Gr.TimeoutController(s);n.signal=(0,dn.anySignal)([n.signal,i.signal]);const o=e(...r),a=new Promise(((e,t)=>{i.signal.addEventListener("abort",(()=>{t(new yn)}))})),c=Date.now(),l=()=>{if(i.signal.aborted)throw new yn;if(Date.now()-c>s)throw i.abort(),new yn};return o[Symbol.asyncIterator]?async function*(){const e=o[Symbol.asyncIterator]();try{for(;;){const{value:t,done:r}=await Promise.race([e.next(),a]);if(r)break;l(),yield t}}catch(e){throw l(),e}finally{i.clear(),e.return&&e.return()}}():(async()=>{try{const e=await Promise.race([o,a]);return l(),e}catch(e){throw l(),e}finally{i.clear()}})()}}yn.code="ERR_TIMEOUT";const wn="/ipfs/";function bn(e){if(e instanceof Uint8Array)try{e=te.k.decode(e)}catch(e){throw j(e,"ERR_INVALID_CID")}let t=te.k.asCID(e);if(t)return{cid:t,path:void 0};(e=e.toString()).startsWith(wn)&&(e=e.substring(wn.length));const r=e.split("/");let n;try{t=te.k.parse(r.shift()||"")}catch(e){throw j(e,"ERR_INVALID_CID")}return r.length&&(n=`/${r.join("/")}`),{cid:t,path:n}}const _n="This command must be run in online mode. Try running 'ipfs daemon' first.",En=new hn.s("/local/filesroot"),vn=262144,kn=e=>e instanceof Uint8Array?te.k.decode(e).toString():(0===(e=e.toString()).indexOf("/ipfs/")&&(e=e.substring("/ipfs/".length)),"/"===e.charAt(e.length-1)&&(e=e.substring(0,e.length-1)),e),Sn=async function(e,t,r,n={}){const{cid:s,path:i}=bn(r);i&&(n.path=i);let o=s,a=n.path||"";if(a.startsWith("/")&&(a=a.substring(1)),n.path)try{for await(const{value:r,remainderPath:i}of Tn(s,n.path,t,e,{signal:n.signal})){if(!te.k.asCID(r))break;a=i,o=r}}catch(e){throw e.message.startsWith("Object has no property")&&(e.message=`no link named "${a.split("/")[0]}" under ${o}`,e.code="ERR_NO_LINK"),e}return{cid:o,remainderPath:a||""}},Rn=e=>{if("file"!==e.type&&"directory"!==e.type&&"raw"!==e.type)throw new Error(`Unknown node type '${e.type}'`);const t={cid:e.cid,path:e.path,name:e.name,size:e.size,type:"file"};return"directory"===e.type&&(t.type="dir"),"file"===e.type&&(t.size=e.unixfs.fileSize()),"file"!==e.type&&"directory"!==e.type||(t.mode=e.unixfs.mode,void 0!==e.unixfs.mtime&&(t.mtime=e.unixfs.mtime)),t},In=mn((async(e,t)=>await e)),Tn=async function*(e,t,r,n,s){const i=async e=>{const t=await r.getCodec(e.code),i=await n.blocks.get(e,s);return t.decode(i)},o=t.split("/").filter(Boolean);let a=await i(e),c=e;for(;o.length;){const r=o.shift();if(!r)throw j(new Error(`Could not resolve path "${t}"`),"ERR_INVALID_PATH");if(e.code===Re&&Array.isArray(a.Links)){const e=a.Links.find((e=>e.Name===r));if(e){yield{value:e.Hash,remainderPath:o.join("/")},a=await i(e.Hash),c=e.Hash;continue}}if(!Object.prototype.hasOwnProperty.call(a,r))throw j(new Error(`no link named "${r}" under ${c}`),"ERR_NO_LINK");a=a[r],yield{value:a,remainderPath:o.join("/")},te.k.asCID(a)&&(c=a,a=await i(a))}yield{value:a,remainderPath:""}};class An{static create({start:e,stop:t}){return new An(e,t)}static async start(e,t){const{state:r,activate:n}=e;switch(r.status){case"stopped":try{const r=n(t);e.state={status:"starting",ready:r};const s=await r;return e.state={status:"started",value:s},s}catch(t){throw e.state={status:"stopped"},t}case"starting":throw new Fr;case"started":throw new Vr;case"stopping":return await r.ready,await An.start(e,t);default:return An.panic(e)}}static async stop(e){const{state:t,deactivate:r}=e;switch(t.status){case"stopped":break;case"starting":try{await t.ready}catch(e){}return await An.stop(e);case"stopping":return await t.ready;case"started":r&&await r(t.value),e.state={status:"stopped"};break;default:An.panic(t)}}static try({state:e}){return"started"===e.status?e.value:null}static async use({state:e},t){switch(e.status){case"started":return e.value;case"starting":return await In(e.ready,t);default:throw new jr}}static panic({state:e}){const t=JSON.stringify({status:e.status});throw RangeError(`Service in invalid state ${t}, should never happen if you see this please report a bug`)}constructor(e,t){this.activate=e,this.deactivate=t,this.state={status:"stopped"}}async use(e){return await An.use(this,e)}try(){return An.try(this)}}var Pn=r(26205),Dn=r(77026),On=r(6963);const Nn=new class{constructor(e){this.lru=Pn(e)}get(e){const t=this.lru.get(e);if(t)return t.expire&&t.expire<Date.now()?void this.lru.remove(e):t.value}set(e,t,r){this.lru.set(e,{value:t,expire:Date.now()+r})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}(1e3),Cn=new(Dn.Z.default?Dn.Z.default:Dn.Z)({concurrency:4}),Mn=e=>{if(e.Path)return e.Path;throw new Error(e.Message)};var Ln=r(44141);async function xn(e){let t;for await(const r of e)t=r;return t}async function*Bn(e){if(null==e)throw j(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT");const t=te.k.asCID(e);if(t)yield Un({cid:t});else{if(!(e instanceof String||"string"==typeof e)){if(null!=e.cid||null!=e.path)return yield Un(e);if(Symbol.iterator in e){const t=e[Symbol.iterator](),r=t.next();if(r.done)return t;if(te.k.asCID(r.value)||r.value instanceof String||"string"==typeof r.value){yield Un({cid:r.value});for(const e of t)yield Un({cid:e});return}if(null!=r.value.cid||null!=r.value.path){yield Un(r.value);for(const e of t)yield Un(e);return}throw j(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}if(Symbol.asyncIterator in e){const t=e[Symbol.asyncIterator](),r=await t.next();if(r.done)return t;if(te.k.asCID(r.value)||r.value instanceof String||"string"==typeof r.value){yield Un({cid:r.value});for await(const e of t)yield Un({cid:e});return}if(null!=r.value.cid||null!=r.value.path){yield Un(r.value);for await(const e of t)yield Un(e);return}throw j(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}throw j(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}yield Un({path:e})}}function Un(e){const t=e.cid||`${e.path}`;if(!t)throw j(new Error("Unexpected input: Please path either a CID or an IPFS path"),"ERR_UNEXPECTED_INPUT");const r={path:t,recursive:!1!==e.recursive};return null!=e.metadata&&(r.metadata=e.metadata),r}const zn={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"};function jn(e,t,r){const n={type:e,cid:t};return r&&(n.metadata=r),n}class Fn{constructor({codecs:e,repo:t}){const r=function({repo:e,codecs:t}){return mn((async function*(r,n={}){const s=async function*(){for await(const{path:n,recursive:s,metadata:i}of Bn(r)){const{cid:r}=await Sn(e,t,n),{reason:o}=await e.pins.isPinnedWithType(r,[zn.recursive,zn.direct]);if("recursive"===o&&!s)throw new Error(`${r} already pinned recursively`);s?await e.pins.pinRecursively(r,{metadata:i}):await e.pins.pinDirectly(r,{metadata:i}),yield r}};if(!Boolean(n.lock))return void(yield*s());const i=await e.gcLock.readLock();try{yield*s()}finally{i()}}))}({codecs:e,repo:t});this.addAll=r,this.add=function({addAll:e}){return(t,r={})=>{let n;const s=te.k.asCID(t);return n=e(s?[{cid:s,...r}]:[{path:t.toString(),...r}],r),xn(n)}}({addAll:r});const n=function({repo:e,codecs:t}){return mn((async function*(r,n={}){const s=await e.gcLock.readLock();try{for await(const{path:n,recursive:s}of Bn(r)){const{cid:r}=await Sn(e,t,n),{pinned:i,reason:o}=await e.pins.isPinnedWithType(r,zn.all);if(!i)throw new Error(`${r} is not pinned`);switch(o){case zn.recursive:if(!s)throw new Error(`${r} is pinned recursively`);await e.pins.unpin(r),yield r;break;case zn.direct:await e.pins.unpin(r),yield r;break;default:throw new Error(`${r} is pinned indirectly under ${o}`)}}}finally{s()}}))}({codecs:e,repo:t});this.rmAll=n,this.rm=function({rmAll:e}){return async function(t,r={}){const n=await xn(e([{path:t,...r}],r));if(!n)throw new Error("CID expected");return n}}({rmAll:n}),this.ls=function({repo:e,codecs:t}){return mn((async function*(r={}){let n=zn.all;if(r.type&&(n=r.type,!Object.keys(zn).includes(n)))throw j(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(r.paths){let s=!1;for await(const{path:i}of Bn(r.paths)){const{cid:r}=await Sn(e,t,i),{reason:o,pinned:a,parent:c,metadata:l}=await e.pins.isPinnedWithType(r,n);if(!a)throw j(new Error(`path '${i}' is not pinned`),"ERR_NOT_PINNED");switch(o){case zn.direct:case zn.recursive:s=!0,yield jn(o,r,l);break;default:s=!0,yield jn(`${zn.indirect} through ${c}`,r,l)}}if(!s)throw new Error("No match found")}else{if(n===zn.recursive||n===zn.all)for await(const{cid:t,metadata:r}of e.pins.recursiveKeys())yield jn(zn.recursive,t,r);if(n===zn.indirect||n===zn.all)for await(const t of e.pins.indirectKeys(r))yield jn(zn.indirect,t);if(n===zn.direct||n===zn.all)for await(const{cid:t,metadata:r}of e.pins.directKeys())yield jn(zn.direct,t,r)}}))}({codecs:e,repo:t}),this.remote={add:(e,t={})=>Promise.reject(new Error("Not implemented")),ls:async function*(e,t={}){return Promise.reject(new Error("Not implemented"))},rm:(e,t={})=>Promise.reject(new Error("Not implemented")),rmAll:(e,t={})=>Promise.reject(new Error("Not implemented")),service:{add:(e,t)=>Promise.reject(new Error("Not implemented")),rm:(e,t={})=>Promise.reject(new Error("Not implemented")),ls:(e={})=>Promise.reject(new Error("Not implemented"))}}}}var Vn=r(22915),$n=r(93613),Hn=r(6245),Gn=r(43478),qn=r(17619);const Kn="ERR_UNRECOGNIZED_VALIDITY",Wn="ERR_SIGNATURE_VERIFICATION",Zn="ERR_UNDEFINED_PARAMETER";var Yn,Jn=r(92255);!function(e){let t,r,n;!function(e){e.EOL="EOL"}(t=e.ValidityType||(e.ValidityType={})),function(e){e[e.EOL=0]="EOL"}(r||(r={})),function(e){e.codec=()=>(0,Jn.Ji)(r)}(t=e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==n&&(n=(0,Jn.yw)(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.value&&(r.uint32(10),r.bytes(t.value)),null!=t.signature&&(r.uint32(18),r.bytes(t.signature)),null!=t.validityType&&(r.uint32(24),e.ValidityType.codec().encode(t.validityType,r)),null!=t.validity&&(r.uint32(34),r.bytes(t.validity)),null!=t.sequence&&(r.uint32(40),r.uint64(t.sequence)),null!=t.ttl&&(r.uint32(48),r.uint64(t.ttl)),null!=t.pubKey&&(r.uint32(58),r.bytes(t.pubKey)),null!=t.signatureV2&&(r.uint32(66),r.bytes(t.signatureV2)),null!=t.data&&(r.uint32(74),r.bytes(t.data)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{const n={},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const r=t.uint32();switch(r>>>3){case 1:n.value=t.bytes();break;case 2:n.signature=t.bytes();break;case 3:n.validityType=e.ValidityType.codec().decode(t);break;case 4:n.validity=t.bytes();break;case 5:n.sequence=t.uint64();break;case 6:n.ttl=t.uint64();break;case 7:n.pubKey=t.bytes();break;case 8:n.signatureV2=t.bytes();break;case 9:n.data=t.bytes();break;default:t.skipType(7&r)}}return n}))),n),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(Yn||(Yn={}));var Qn=r(44527);const Xn=(0,z.kg)("ipns:utils"),es=(0,Hr.m)("/ipns/");function ts(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),r=String(e).trim().match(t);if(null==r)throw new Error("Invalid format");const n=parseInt(r[1],10),s=parseInt(r[2],10)-1,i=parseInt(r[3],10),o=parseInt(r[4],10),a=parseInt(r[5],10),c=parseInt(r[6],10),l=parseInt(r[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}const rs=e=>{const t=(0,Hr.m)("ipns-signature:");return(0,Qn.z)([t,e])},ns=e=>{const t=Yn.decode(e);return null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),{value:t.value??new Uint8Array(0),signature:t.signature??new Uint8Array(0),validityType:t.validityType??Yn.ValidityType.EOL,validity:t.validity??new Uint8Array(0),sequence:t.sequence??0n,pubKey:t.pubKey,ttl:t.ttl??void 0,signatureV2:t.signatureV2,data:t.data}},ss=e=>(0,Qn.z)([es,e.toBytes()]),is=(0,z.kg)("ipns"),os=Lr.identity.code,as="/ipns/",cs=as.length,ls=e=>new hn.s(`/ipns/${(e=>Kr.base32upper.encode(e).slice(1))(e)}`),hs=async(e,t,r,n)=>{try{const s=((e,t,r)=>{const n=(0,Hr.m)(t);return(0,Qn.z)([e,r,n])})(t,r,n);return await e.sign(s)}catch(e){throw is.error("record signature creation failed",e),j(new Error("record signature creation failed"),"ERR_SIGNATURE_CREATION")}},ds=(0,z.kg)("ipfs:ipns:publisher"),us=(0,$n.notFoundError)().code,ps=36e5;class fs{constructor(e,t){this._routing=e,this._datastore=t}async publishWithEOL(e,t,r,n){const s=await this._updateOrCreateRecord(e,t,r,n);return this._putRecordToRouting(s,e,n)}publish(e,t,r){return this.publishWithEOL(e,t,ps,r)}async _putRecordToRouting(e,t,r){if(!(0,Vn.I)(t)){const e="peerId received is not valid";throw ds.error(e),j(new Error(e),"ERR_INVALID_PEER_ID")}if(null==t.publicKey)throw j(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const n=ss(t);return await this._publishEntry(n,e,r),e}async _publishEntry(e,t,r){try{const n=await this._routing.put(e,t,r);return ds(`ipns record for ${(0,Qr.B)(e,"base32")} was stored in the routing`),n}catch(t){const r=`ipns record for ${(0,Qr.B)(e,"base32")} could not be stored in the routing - ${t.stack}`;throw ds.error(r),ds.error(t),j(new Error(r),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(e,t={}){if(!(0,Vn.I)(e)){const e="peerId received is not valid";throw ds.error(e),j(new Error(e),"ERR_INVALID_PEER_ID")}const r=!1!==t.checkRouting;try{const t=await this._datastore.get(ls(e.toBytes()));return this._unmarshalData(t)}catch(t){if(t.code!==us){const t=`unexpected error getting the ipns record ${e.toString()} from datastore`;throw ds.error(t),j(new Error(t),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!r)throw j(t,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const t=ss(e),r=await this._routing.get(t);return this._unmarshalData(r)}catch(e){throw ds.error(e),e}}}_unmarshalData(e){try{return ns(e)}catch(e){throw j(e,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(e,t,r,n){if(!(0,Vn.I)(e)){const e="peerId received is not valid";throw ds.error(e),j(new Error(e),"ERR_INVALID_PEER_ID")}const s={checkRouting:!0};let i;try{i=await this._getPublished(e,s)}catch(t){if(t.code!==us){const r=`unexpected error when determining the last published IPNS record for ${e.toString()} ${t.stack}`;throw ds.error(r),j(new Error(r),"ERR_DETERMINING_PUBLISHED_RECORD")}}let o,a=0n;i&&void 0!==i.sequence&&(a=(0,Hn.f)(i.value,t)?i.sequence:i.sequence+BigInt(1));try{o=await(async(e,t,r,n)=>{const s=new Gn(Date.now()+Number(n)),i=Yn.ValidityType.EOL,[o,a]=n.toString().split("."),c=BigInt(o)*BigInt(1e5)+BigInt(a??"0");return await(async(e,t,r,n,s,i)=>{r=BigInt(r);const o=(0,Hr.m)(s.toString());if(null==e.privateKey)throw j(new Error("Missing private key"),"ERR_MISSING_PRIVATE_KEY");const a=await(0,qn.unmarshalPrivateKey)(e.privateKey),c=await hs(a,t,n,o),l=((e,t,r,n,s)=>{let i;if(r!==Yn.ValidityType.EOL)throw j(new Error("Unknown validity type"),Kn);return i=0,qt({Value:e,Validity:t,ValidityType:0,Sequence:n,TTL:s})})(t,o,n,r,i),h=rs(l),d={value:t,signature:c,validityType:n,validity:o,sequence:r,ttl:i,signatureV2:await a.sign(h),data:l};if(null!=e.publicKey){const t=Wr.Jx(e.toBytes());t.code===os&&(0,Hn.f)(e.publicKey,t.digest)||(d.pubKey=e.publicKey)}return is("ipns entry for %b created",t),d})(e,t,r,i,s,c)})(e,t,a,r)}catch(e){const r=`ipns record for ${t} could not be created`;throw ds.error(e),j(new Error(r),"ERR_CREATING_IPNS_RECORD")}try{const r=(c=o,Yn.encode(c));return await this._datastore.put(ls(e.toBytes()),r,n),ds(`ipns record for ${(0,Qr.B)(t,"base32")} was stored in the datastore`),r}catch(e){const r=`ipns record for ${t} could not be stored in the datastore`;throw ds.error(r),j(new Error(r),"ERR_STORING_IN_DATASTORE")}var c}}fs.defaultRecordLifetime=ps;const gs=(0,z.kg)("ipfs:ipns:republisher");class ys{constructor(e,t,r,n,s={pass:""}){this._publisher=e,this._datastore=t,this._peerId=r,this._keychain=n,this._options=s,this._republishHandle=null}async start(){if(this._republishHandle)throw j(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const e={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:t=>{e._timeoutId=setTimeout((async()=>{e._timeoutId=null;try{e._inflightTask=e._task(),await e._inflightTask,e._task&&e.runPeriodically(t)}catch(e){gs.error(e)}}),t())},cancel:async()=>{null!=e._timeoutId&&clearTimeout(e._timeoutId),e._task=null,await e._inflightTask}},{pass:t}=this._options;let r=!0;e._task=async()=>{const e=new Gr.TimeoutController(3e4);try{await this._republishEntries(this._peerId,t,{signal:e.signal})}finally{e.clear()}},e.runPeriodically((()=>r?(r=!1,this._options.initialBroadcastInterval||6e4):this._options.broadcastInterval||144e5)),this._republishHandle=e}async stop(){const e=this._republishHandle;if(!e)throw j(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await e.cancel()}async _republishEntries(e,t,r){try{await this._republishEntry(e,r)}catch(e){const t="cannot republish entry for the node's private key";return void gs.error(t)}if(t)try{const e=await this._keychain.listKeys();for(const n of e){if("self"===n.name)continue;const e=await this._keychain.exportKey(n.name,t),s=await(0,qn.importKey)(e,t),i=await(0,Ln.y5)(s.public.bytes,s.bytes);await this._republishEntry(i,r)}}catch(e){gs.error(e)}}async _republishEntry(e,t){try{const r=await this._getPreviousValue(e);await this._publisher.publishWithEOL(e,r,864e5,t)}catch(e){if("ERR_NO_ENTRY_FOUND"===e.code)return;throw e}}async _getPreviousValue(e){if(!(0,Vn.I)(e))throw j(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const t=await this._datastore.get(ls(e.toBytes()));if(!(t instanceof Uint8Array))throw j(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return ns(t).value}catch(e){throw gs.error(e),j(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(t){if(t&&t.notFound)throw j(new Error(`no previous entry for record with id: ${e.toString()}`),"ERR_NO_ENTRY_FOUND");throw t}}}const ms=(0,z.kg)("ipns:validator"),ws=async(e,t)=>{const r=(e=>(0,Ln.cv)(e.slice(es.length)))(e),n=ns(t),s=await(async(e,t)=>{if(null==t||null==e){const e=new Error("one or more of the provided parameters are not defined");throw Xn.error(e),j(e,Zn)}let r;if(null!=t.pubKey){try{r=(0,qn.unmarshalPublicKey)(t.pubKey)}catch(e){throw Xn.error(e),e}if(!(await(0,Ln.y5)(t.pubKey)).equals(e))throw j(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=e.publicKey&&(r=(0,qn.unmarshalPublicKey)(e.publicKey));if(null!=r)return r;throw j(new Error("no public key is available"),Zn)})(r,n);await(async(e,t)=>{const{value:r,validityType:n,validity:s}=t;let i,o,a;if(null==t.signatureV2||null==t.data)throw j(new Error("missing data or signatureV2"),Wn);o=t.signatureV2,i=rs(t.data),(e=>{if(null==e.data)throw j(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");const t=(e=>{const t=Qt(e);if(0!==t.ValidityType)throw j(new Error("Unknown validity type"),Kn);return t.ValidityType=Yn.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t})(e.data);if(!(0,Hn.f)(t.Value,e.value))throw j(new Error('Field "value" did not match between protobuf and CBOR'),Wn);if(!(0,Hn.f)(t.Validity,e.validity))throw j(new Error('Field "validity" did not match between protobuf and CBOR'),Wn);if(t.ValidityType!==e.validityType)throw j(new Error('Field "validityType" did not match between protobuf and CBOR'),Wn);if(t.Sequence!==e.sequence)throw j(new Error('Field "sequence" did not match between protobuf and CBOR'),Wn);if(t.TTL!==e.ttl)throw j(new Error('Field "ttl" did not match between protobuf and CBOR'),Wn)})(t);try{a=await e.verify(i,o)}catch(e){a=!1}if(!a)throw ms.error("record signature verification failed"),j(new Error("record signature verification failed"),Wn);if(null!=s&&n===Yn.ValidityType.EOL){let e;try{e=ts((0,Qr.B)(s))}catch(e){throw ms.error("unrecognized validity format (not an rfc3339 format)"),j(new Error("unrecognized validity format (not an rfc3339 format)"),"ERR_UNRECOGNIZED_FORMAT")}if(e.getTime()<Date.now())throw ms.error("record has expired"),j(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=n)throw ms.error("unrecognized validity type"),j(new Error("unrecognized validity type"),Kn);ms("ipns entry for %b is valid",r)})(s,n)},bs=(0,z.kg)("ipfs:ipns:resolver"),_s=$n.notFoundError().code;class Es{constructor(e){this._routing=e}async resolve(e,t={}){if("string"!=typeof e)throw j(new Error("invalid name"),"ERR_INVALID_NAME");const r=t.recursive&&"true"===t.recursive.toString(),n=e.split("/");if(3!==n.length||""!==n[0])throw j(new Error("invalid name"),"ERR_INVALID_NAME");const s=n[2];let i=1/0;r&&(i=32);const o=await this.resolver(s,i,t);return bs(`${e} was locally resolved correctly`),o}async resolver(e,t,r){if(0===t){const e="could not resolve name (recursion limit of 32 exceeded)";throw bs.error(e),j(new Error(e),"ERR_RESOLVE_RECURSION_LIMIT")}const n=await this._resolveName(e,r),s=n.split("/");return"ipfs"!==s[1]&&t?this.resolver(s[2],t-1,r):n}async _resolveName(e,t){const r=(0,Ln.jE)(e),n=ss(r);let s;try{s=await this._routing.get(n,t)}catch(t){if(bs.error("could not get record from routing",t),t.code===_s)throw j(new Error(`record requested for ${e} was not found in the network`),"ERR_NO_RECORD_FOUND");throw j(new Error(`unexpected error getting the ipns record ${r.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(r,s)}async _validateRecord(e,t){await ws((0,Qn.z)([(0,Hr.m)("/ipns/"),e.toBytes()]),t);const r=ns(t);return(0,Qr.B)(r.value)}}class vs{constructor(e){this.lru=Pn(e)}get(e){const t=this.lru.get(e);if(t)return t.expire&&t.expire<Date.now()?void this.lru.remove(e):t.value}set(e,t,r){this.lru.set(e,{value:t,expire:Date.now()+r})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}const ks=(0,z.kg)("ipfs:ipns");class Ss{constructor(e,t,r,n,s){this.publisher=new fs(e,t),this.republisher=new ys(this.publisher,t,r,n,s),this.resolver=new Es(e),this.cache=new vs(1e3),this.routing=e}async publish(e,t,r=fs.defaultRecordLifetime,n){try{await this.publisher.publishWithEOL(e,t,r,n),ks(`IPNS value ${(0,Qr.B)(t,"base32")} was published correctly`);const s=e.toString(),i=parseFloat(r),o=i<6e4?i:6e4;return this.cache.set(s,t,o),ks(`IPNS value ${(0,Qr.B)(t,"base32")} was cached correctly`),{name:s,value:t}}catch(e){throw ks.error(e),e}}async resolve(e,t={}){if("string"!=typeof e)throw j(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!t.nocache&&!t.recursive){const t=e.split("/")[2],r=this.cache.get(t);if(r)return r}try{const r=await this.resolver.resolve(e,t);return ks(`IPNS record from ${e} was resolved correctly`),r}catch(e){throw ks.error(e),e}}async initializeKeyspace(e,t,r){return this.publish(e,t,fs.defaultRecordLifetime,r)}}var Rs=r(19450),Is=r(52762),Ts=r(5075);const As=(0,z.kg)("datastore:core:tiered");class Ps extends Rs.e{constructor(e){super(),this.stores=e.slice()}async open(){try{await Promise.all(this.stores.map((e=>e.open())))}catch(e){throw $n.dbOpenFailedError()}}async put(e,t,r){try{await Promise.all(this.stores.map((n=>n.put(e,t,r))))}catch(e){throw $n.dbWriteFailedError()}}async get(e,t){for(const r of this.stores)try{const n=await r.get(e,t);if(n)return n}catch(e){As.error(e)}throw $n.notFoundError()}async has(e,t){for(const r of this.stores)if(await r.has(e,t))return!0;return!1}async delete(e,t){try{await Promise.all(this.stores.map((r=>r.delete(e,t))))}catch(e){throw $n.dbDeleteFailedError()}}async*putMany(e,t={}){let r;const n=this.stores.map((e=>{const n=(0,Is.d)({objectMode:!0});return Ts(e.putMany(n,t)).catch((e=>{r=e})),n}));try{for await(const t of e){if(r)throw r;n.forEach((e=>e.push(t))),yield t}}finally{n.forEach((e=>e.end()))}}async*deleteMany(e,t={}){let r;const n=this.stores.map((e=>{const n=(0,Is.d)({objectMode:!0});return Ts(e.deleteMany(n,t)).catch((e=>{r=e})),n}));try{for await(const t of e){if(r)throw r;n.forEach((e=>e.push(t))),yield t}}finally{n.forEach((e=>e.end()))}}async close(){await Promise.all(this.stores.map((e=>e.close())))}batch(){const e=this.stores.map((e=>e.batch()));return{put:(t,r)=>{e.forEach((e=>e.put(t,r)))},delete:t=>{e.forEach((e=>e.delete(t)))},commit:async t=>{for(const r of e)await r.commit(t)}}}query(e,t){return this.stores[this.stores.length-1].query(e,t)}queryKeys(e,t){return this.stores[this.stores.length-1].queryKeys(e,t)}}var Ds=r(93765);const Os=(e,t)=>{const r=t.map(((e,t)=>({entry:Yn.decode(e),index:t})));return r.sort(((e,t)=>{if(null!=e.entry.signatureV2&&null==t.entry.signatureV2)return-1;if(null==e.entry.signatureV2&&null!=t.entry.signatureV2)return 1;const r=e.entry.sequence??0n,n=t.entry.sequence??0n;if(r>n)return-1;if(r<n)return 1;const s=e.entry.validity??new Uint8Array(0),i=t.entry.validity??new Uint8Array(0),o=ts((0,Qr.B)(s)),a=ts((0,Qr.B)(i));return o.getTime()>a.getTime()?-1:o.getTime()<a.getTime()?1:0})),r[0].index};var Ns=r(59833);r(63246),new hn.s("SHARDING"),new hn.s("_README"),r(40057);var Cs=r(6043);r(86119),r(59231);const Ms="/record/";function Ls(e){return(0,Qr.B)(e,"base32")}function xs(e){("string"==typeof e||e instanceof String)&&(e=(0,Hr.m)(e.toString()));const t=(0,Qr.B)(e,"base64url");return`${Ms}${t}`}const Bs=(0,z.kg)("datastore-pubsub:publisher");class Us extends Rs.e{constructor(e,t,r,n,s,i){if(super(),!n)throw j(new TypeError("missing validator"),"ERR_INVALID_PARAMETERS");if("function"!=typeof n)throw j(new TypeError("missing validate function"),"ERR_INVALID_PARAMETERS");if("function"!=typeof s)throw j(new TypeError("missing select function"),"ERR_INVALID_PARAMETERS");if(i&&"function"!=typeof i)throw j(new TypeError("invalid subscriptionKeyFn received"),"ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=t,this._peerId=r,this._validator=n,this._selector=s,this._handleSubscriptionKeyFn=i,this._onMessage=this._onMessage.bind(this),this._pubsub.addEventListener("message",this._onMessage)}async put(e,t,r){if(!(e instanceof Uint8Array)){const e="datastore key does not have a valid format";throw Bs.error(e),j(new Error(e),"ERR_INVALID_DATASTORE_KEY")}if(!(t instanceof Uint8Array)){const e="received value is not a Uint8Array";throw Bs.error(e),j(new Error(e),"ERR_INVALID_VALUE_RECEIVED")}const n=xs(e);Bs(`publish value for topic ${n}`),await this._pubsub.publish(n,t)}async get(e,t){if(!(e instanceof Uint8Array)){const e="datastore key does not have a valid format";throw Bs.error(e),j(new Error(e),"ERR_INVALID_DATASTORE_KEY")}const r=xs(e),n=await this._pubsub.getTopics();if(n&&Array.isArray(n)&&n.indexOf(r)>-1)return this._getLocal(e,t);try{await this._pubsub.subscribe(r)}catch(e){const t=`cannot subscribe topic ${r}`;throw Bs.error(t),j(new Error(t),"ERR_SUBSCRIBING_TOPIC")}return Bs(`subscribed values for key ${r}`),this._getLocal(e)}unsubscribe(e){const t=xs(e);return this._pubsub.unsubscribe(t)}async _getLocal(e,t){const r=new hn.s("/"+Ls(e),!1);let n;try{n=await this._datastore.get(r,t)}catch(e){if("ERR_NOT_FOUND"!==e.code){const e=`unexpected error getting the ipns record for ${r.toString()}`;throw Bs.error(e),j(new Error(e),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}const t=`local record requested was not found for ${r.toString()}`;throw Bs.error(t),j(new Error(t),"ERR_NOT_FOUND")}if(!(n instanceof Uint8Array)){const e="found record that we couldn't convert to a value";throw Bs.error(e),j(new Error(e),"ERR_INVALID_RECORD_RECEIVED")}return n}async _onMessage(e){const t=e.detail;if("signed"!==t.type)return void Bs.error("unsigned message received, this module can only work with signed messages");const{data:r,from:n,topic:s}=t;let i;try{i=function(e){if(e.substring(0,Ms.length)!==Ms)throw j(new Error("topic received is not from a record"),"ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");const t=e.substring(Ms.length);return(0,Hr.m)(t,"base64url")}(s)}catch(e){return void Bs.error(e)}if(Bs(`message received for topic ${s}`),this._peerId.equals(n))Bs("message discarded as it is from the same peer");else{if(this._handleSubscriptionKeyFn){let e;try{e=await this._handleSubscriptionKeyFn(i)}catch(e){return void Bs.error("message discarded by the subscriptionKeyFn")}i=e}try{await this._storeIfSubscriptionIsBetter(i,r)}catch(e){Bs.error(e)}}}async _storeIfSubscriptionIsBetter(e,t,r){let n=!1;try{n=await this._isBetter(e,t)}catch(e){if("ERR_NOT_VALID_RECORD"!==e.code)throw e}n&&await this._storeRecord(e,t,r)}async _validateRecord(e,t){return this._validator(e,t)}async _selectRecord(e,t){return 0===await this._selector(e,t)}async _isBetter(e,t){try{await this._validateRecord(e,t)}catch(e){const t="record received through pubsub is not valid";throw Bs.error(t),j(new Error(t),"ERR_NOT_VALID_RECORD")}const r=new hn.s(e);let n;try{n=await this._getLocal(r.uint8Array())}catch(e){return!0}return!(0,Hn.f)(n,t)&&this._selectRecord(e,[n,t])}async _storeRecord(e,t,r){const n=new hn.s("/"+Ls(e),!1);await this._datastore.put(n,t,r),Bs(`record for ${xs(e)} was stored in the datastore`)}}const zs=(0,z.kg)("ipfs:ipns:pubsub");class js{constructor(e,t,r){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new Us(e,t,r,ws,Os,this._handleSubscriptionKey)}async put(e,t,r){try{await this._pubsubDs.put(e,t,r)}catch(e){throw zs.error(e),e}}async get(e,t){let r,n;try{r=await this._pubsubDs.get(e,t)}catch(e){n=e}const s=e.slice(0,cs);if((0,Qr.B)(s)===as){const t=qr.base58btc.encode(e).substring(1),r=qr.base58btc.encode(e.slice(cs)).substring(1);this._subscriptions[t]=r,zs(`subscribed to pubsub topic ${t}, id ${r}`)}if(n)throw n;return r}_handleSubscriptionKey(e){e instanceof Uint8Array&&(e=(0,Qr.B)(e,"base58btc"));const t=this._subscriptions[e];if(!t)throw j(new Error(`key ${e} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return ss((0,Ln.jE)(t))}catch(e){throw zs.error(e),e}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map((e=>`${as}${e}`))}async cancel(e){if("string"!=typeof e)throw j(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");e.startsWith(as)&&(e=e.substring(cs));const t=Object.keys(this._subscriptions).find((t=>this._subscriptions[t]===e));if(!t)return{canceled:!1};const r=(0,Hr.m)(t);return this._pubsubDs.unsubscribe(r),delete this._subscriptions[t],zs(`unsubscribed pubsub ${t}: ${e}`),{canceled:!0}}}var Fs;function Vs(e){const t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),s=String(e.getUTCHours()).padStart(2,"0"),i=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),a=e.getUTCMilliseconds();return`${t}-${r}-${n}T${s}:${i}:${o}.${String(1e3*a*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=(0,Jn.yw)(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),(!0===r.writeDefaults||null!=e.key&&e.key.byteLength>0)&&(t.uint32(10),t.bytes(e.key)),(!0===r.writeDefaults||null!=e.value&&e.value.byteLength>0)&&(t.uint32(18),t.bytes(e.value)),!0!==r.writeDefaults&&""===e.timeReceived||(t.uint32(42),t.string(e.timeReceived)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(Fs||(Fs={}));class $s{constructor(e,t,r){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return Fs.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:Vs(this.timeReceived)}}static deserialize(e){const t=Fs.decode(e);return new $s(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=function(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),r=String(e).trim().match(t);if(null==r)throw new Error("Invalid format");const n=parseInt(r[1],10),s=parseInt(r[2],10)-1,i=parseInt(r[3],10),o=parseInt(r[4],10),a=parseInt(r[5],10),c=parseInt(r[6],10),l=parseInt(r[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}(e.timeReceived);if(null==e.key)throw new Error("key missing from deserialized object");if(null==e.value)throw new Error("value missing from deserialized object");return new $s(e.key,e.value,t)}}const Hs=(0,z.kg)("ipfs:ipns:offline-datastore");class Gs{constructor(e){this._datastore=e,this.stores=[]}async put(e,t,r){if(!(e instanceof Uint8Array))throw j(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(t instanceof Uint8Array))throw j(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let n;try{n=this._routingKey(e)}catch(e){throw Hs.error(e),j(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=new $s(e,t,new Date);await this._datastore.put(n,s.serialize(),r)}async get(e,t){if(!(e instanceof Uint8Array))throw j(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let r;try{r=this._routingKey(e)}catch(e){throw Hs.error(e),j(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const n=await this._datastore.get(r,t);let s;try{s=$s.deserialize(n)}catch(e){throw Hs.error(e),e}return s.value}_routingKey(e){return new hn.s("/dht/record/"+(0,Qr.B)(e,"base32"),!1)}}var qs=r(49484);const Ks=(0,z.kg)("ipfs:ipns:dht-datastore");class Ws{constructor(e){this._dht=e}async put(e,t,r){try{await(0,qs.Z)(this._dht.put(e,t,r))}catch(e){throw Ks.error(e),e}}async get(e,t){for await(const r of this._dht.get(e,t))if("VALUE"===r.name)return r.value;throw(0,$n.notFoundError)()}}const Zs=(0,z.kg)("ipfs:components:ipns");class Ys{constructor(e={pass:""}){this.options=e,this.offline=null,this.online=null}getIPNS(){const e=this.online||this.offline;if(e)return e;throw new Br}get routing(){return this.getIPNS().routing}startOffline({repo:e,peerId:t,keychain:r}){if(null!=this.offline)throw new zr;Zs("initializing IPNS keyspace (offline)");const n=new Gs(e.datastore),s=new Ss(n,e.datastore,t,r,this.options);this.offline=s}async startOnline({libp2p:e,repo:t,peerId:r,keychain:n}){if(null!=this.online)throw new zr;const s=function({libp2p:e,repo:t,peerId:r,options:n}){const s=[];let i;if(Ds(n,"EXPERIMENTAL.ipnsPubsub",!1)&&(i=new js(e.pubsub,t.datastore,r),s.push(i)),!0!==Ds(n,"offline",!1)&&["dht","dhtclient","dhtserver"].includes(Ds(n,"config.Routing.Type","none"))&&s.push(new Ws(e.dht)),Ds(n,"offline",!1)||0===s.length){const e=new Gs(t.datastore);s.push(e)}return new Ps(s)}({libp2p:e,repo:t,peerId:r,options:this.options}),i=new Ss(s,t.datastore,r,n,this.options);await i.republisher.start(),this.online=i}async stop(){const e=this.online;e&&(await e.republisher.stop(),this.online=null)}publish(e,t,r,n){return this.getIPNS().publish(e,t,r,n)}resolve(e,t){return this.getIPNS().resolve(e,t)}initializeKeyspace(e,t,r){return this.getIPNS().initializeKeyspace(e,t,r)}}async function Js({ipns:e,repo:t,codecs:r},n,s){if(ln(n))return e.resolve(n);const{cid:i,path:o}=bn(n);await(0,qs.Z)(Tn(i,o||"",r,t,s))}const Qs=(0,z.kg)("ipfs:name:publish");var Xs=r(53950),ei=r(20757);const ti=B.Z.bind({ignoreUndefined:!0}),ri=(0,z.kg)("ipfs:name:resolve"),ni=(e,t)=>t.length>0?e+"/"+t.join("/"):e;function si(e,t){if(!e||!t||!t.ipnsPubsub)throw j(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(e.routing instanceof js)return e.routing;const r=(e.routing.stores||[]).find((e=>e instanceof js));if(!r)throw j(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return r}class ii{constructor({ipns:e,options:t}){this.cancel=function({ipns:e,options:t}){const r=t.EXPERIMENTAL;return mn((async function(t,n={}){return si(e,r).cancel(t,n)}))}({ipns:e,options:t}),this.state=function({ipns:e,options:t}){const r=t.EXPERIMENTAL;return mn((async function(t={}){try{return{enabled:Boolean(si(e,r))}}catch(e){return{enabled:!1}}}))}({ipns:e,options:t}),this.subs=function({ipns:e,options:t}){const r=t.EXPERIMENTAL;return mn((async function(t={}){return si(e,r).getSubscriptions(t)}))}({ipns:e,options:t})}}class oi{constructor({dns:e,ipns:t,repo:r,codecs:n,peerId:s,isOnline:i,keychain:o,options:a}){this.publish=function({ipns:e,repo:t,codecs:r,peerId:n,isOnline:s,keychain:i}){const o=async e=>{let t;if("self"===e&&null!=n.privateKey)t=await(0,qn.unmarshalPrivateKey)(n.privateKey);else try{const r=await i.exportKey(e,"temp");t=await(0,qn.importKey)(r,"temp")}catch(e){throw Qs.error(e),j(e,"ERR_CANNOT_GET_KEY")}return(0,Ln.y5)(t.public.bytes,t.bytes)};return mn((async function(n,i={}){const a=!(!1===i.resolve),c=i.lifetime||"24h",l=i.key||"self";if(!s())throw j(new Error(_n),"OFFLINE_ERROR");try{n=(e=>{if(te.k.asCID(e))return`/ipfs/${e}`;const t=e.toString();try{return`/ipfs/${te.k.parse(t)}`}catch{}if(cn(t))return t;throw j(new Error(`invalid path: ${e}`),"ERR_BAD_PATH")})(n)}catch(e){throw Qs.error(e),e}let h=0;try{h=gn(c)||0,h=parseFloat(h.toFixed(6))}catch(e){throw Qs.error(e),e}const d=await Promise.all([o(l),a?Js({ipns:e,repo:t,codecs:r},n):Promise.resolve()]),u=(0,Hr.m)(n),p=await e.publish(d[0],u,h,i);return{name:p.name,value:(0,Qr.B)(p.value)}}))}({ipns:t,repo:r,codecs:n,peerId:s,isOnline:i,keychain:o}),this.resolve=function({dns:e,ipns:t,isOnline:r,options:{offline:n}}){return mn((async function*(s,i={}){if(i=ti({nocache:!1,recursive:!0},i),n&&i&&i.nocache)throw j(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!r()&&!n)throw j(new Error(_n),"OFFLINE_ERROR");let o=s.toString();o.startsWith("/ipns/")||(o=`/ipns/${o}`);let[a,c,...l]=o.slice(1).split("/");try{if("1"===c.substring(0,1)){const e=(0,Ln.jE)(c),t=Wr.Jx(e.toBytes());c=te.k.createV1(114,t).toString(Xs.base36)}else{const e=te.k.parse(c);1===e.version&&(c=e.toString(Xs.base36))}}catch(t){if(ei(c))return void(yield ni(await e(c,i),l));throw ri.error(t),j(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const h=await t.resolve(`/${a}/${c}`,i);yield ni(h instanceof Uint8Array?(0,Qr.B)(h):h,l)}))}({dns:e,ipns:t,isOnline:i,options:a}),this.pubsub=new ii({ipns:t,options:a})}}const ai=(0,$n.notFoundError)().code,ci="<dst>";async function*li(e,t,r,n,s){const i=await e(n,s),{cid:o}=bn(i),a=null!=s.maxDepth?s.maxDepth:1/0,c=s.unique||!1;for await(const e of async function*(e,t,r,n,s,i){const o=new Set;yield*async function*r(a,c){const l=c+1;if(!(l>n))try{for await(const n of async function*(e,t,r,n){const s=await e.blocks.get(r,n),i=(await t.getCodec(r.code)).decode(s),o=r.code===Re,a=[];for(const[e,t]of di(i,a)){if(o){const r=e.match(/^Links\/(\d+)\/Hash$/);if(r){const e=Number(r[1]);if(e<i.Links.length){yield{name:i.Links[e].Name,cid:t};continue}}}yield{name:e,cid:t}}}(e,t,a.cid,i))yield{parent:a,node:n,isDuplicate:s&&o.has(n.cid.toString())},s&&o.add(n.cid.toString()),yield*r(n,l)}catch(e){throw e.code===ai&&(e.message=`Could not find object with CID: ${a.cid}`),e}}({cid:r},0)}(t,r,o,a,c,s))e.parent&&(e.isDuplicate||(yield{ref:hi(e.parent.cid,e.node.cid,e.node.name,s.format)}))}function hi(e,t,r="",n=ci){let s=n.replace(/<src>/g,e.toString());return s=s.replace(/<dst>/g,t.toString()),s=s.replace(/<linkname>/g,r),s}const di=function*(e,t){if(null!=e&&!(e instanceof Uint8Array)){for(const[r,n]of Object.entries(e)){const e=[...t,r];if(null!=n&&"object"==typeof n)if(Array.isArray(n))for(const[t,r]of n.entries()){const n=[...e,t],s=te.k.asCID(r);s?yield[n.join("/"),s]:"object"==typeof r&&(yield*di(r,n))}else{const t=te.k.asCID(n);t?yield[e.join("/"),t]:yield*di(n,e)}}return[]}};function ui({repo:e}){return mn((async function*(t={}){for await(const r of e.blocks.queryKeys({},{signal:t.signal}))yield{ref:r.toString()}}))}function pi({network:e}){return mn((async function(t={}){const r=(await e.use(t)).bitswap,n=r.stat().snapshot;return{provideBufLen:parseInt(n.providesBufferLength.toString()),blocksReceived:BigInt(n.blocksReceived.toString()),wantlist:Array.from(r.getWantlist()).map((e=>e[1].cid)),peers:r.peers(),dupBlksReceived:BigInt(n.dupBlksReceived.toString()),dupDataReceived:BigInt(n.dupDataReceived.toString()),dataReceived:BigInt(n.dataReceived.toString()),blocksSent:BigInt(n.blocksSent.toString()),dataSent:BigInt(n.dataSent.toString())}}))}class fi{constructor({network:e}){this.wantlist=function({network:e}){return mn((async function(t={}){const{bitswap:r}=await e.use(t),n=r.getWantlist();return Array.from(n).map((e=>e[1].cid))}))}({network:e}),this.wantlistForPeer=function({network:e}){return mn((async function(t,r={}){const{bitswap:n}=await e.use(r),s=n.wantlistForPeer(t);return Array.from(s).map((e=>e[1].cid))}))}({network:e}),this.unwant=function({network:e}){return mn((async function(t,r={}){const{bitswap:n}=await e.use(r);return Array.isArray(t)||(t=[t]),n.unwant(t)}))}({network:e}),this.stat=pi({network:e})}}function gi(e){try{return Yr.Cz.matches(e)}catch(e){return!1}}class yi{constructor({repo:e}){this.add=function({repo:e}){return mn((async function(t,r={}){if(!gi(t))throw new Error(`${t} is not a valid Multiaddr`);const n=await e.config.getAll(r),s=n.Bootstrap||[];return s.push(t.toString()),n.Bootstrap=Array.from(new Set(s)).sort(((e,t)=>e.localeCompare(t))),await e.config.replace(n),{Peers:[t]}}))}({repo:e}),this.list=function({repo:e}){return mn((async function(t={}){return{Peers:(await e.config.get("Bootstrap",t)||[]).map((e=>(0,Zr.HM)(e)))}}))}({repo:e}),this.rm=function({repo:e}){return mn((async function(t,r={}){if(!gi(t))throw new Error(`${t} is not a valid Multiaddr`);const n=await e.config.getAll(r);return n.Bootstrap=(n.Bootstrap||[]).filter((e=>e.toString()!==t.toString())),await e.config.replace(n),{Peers:[t]}}))}({repo:e}),this.clear=function({repo:e}){return mn((async function(t={}){const r=await e.config.getAll(t),n=r.Bootstrap||[];return r.Bootstrap=[],await e.config.replace(r),{Peers:n.map((e=>(0,Zr.HM)(e)))}}))}({repo:e}),this.reset=function({repo:e}){return mn((async function(t={}){const r=await e.config.getAll(t);return r.Bootstrap=["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],await e.config.replace(r),{Peers:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"].map((e=>(0,Zr.HM)(e)))}}))}({repo:e})}}var mi=r(58525);const wi=globalThis.CustomEvent??Event;async function*bi(e,t={}){let r=t.concurrency??1/0;r<1&&(r=1/0);const n=null!=t.ordered&&t.ordered,s=new EventTarget,i=[];let o,a=(0,mi.Z)(),c=(0,mi.Z)(),l=!1,h=!1;function d(){return n?i[0]?.done:Boolean(i.find((e=>e.done)))}function*u(){for(;i.length>0&&i[0].done;){const e=i[0];if(i.shift(),!e.ok)throw h=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*p(){for(;d();)for(let e=0;e<i.length;e++)if(i[e].done){const t=i[e];if(i.splice(e,1),e--,!t.ok)throw h=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(s.addEventListener("task-complete",(()=>{c.resolve()})),Promise.resolve().then((async()=>{try{for await(const t of e){if(i.length===r&&(a=(0,mi.Z)(),await a.promise),h)break;const e={done:!1};i.push(e),t().then((t=>{e.done=!0,e.ok=!0,e.value=t,s.dispatchEvent(new wi("task-complete"))}),(t=>{e.done=!0,e.err=t,s.dispatchEvent(new wi("task-complete"))}))}l=!0,s.dispatchEvent(new wi("task-complete"))}catch(e){o=e,s.dispatchEvent(new wi("task-complete"))}}));;){if(d()||(c=(0,mi.Z)(),await c.promise),null!=o)throw o;if(n?yield*u():yield*p(),l&&0===i.length)break}}var _i=r(97856),Ei=r(90193),vi=r(26629);function ki(e){return e instanceof Uint8Array?te.k.decode(e):te.k.parse(e.toString())}class Si{constructor({codecs:e,hashers:t,preload:r,repo:n}){this.get=function({preload:e,repo:t}){return mn((async function(r,n={}){return!1!==n.preload&&e(r),t.blocks.get(r,n)}))}({preload:r,repo:n}),this.put=function({codecs:e,hashers:t,repo:r,preload:n}){return mn((async function(s,i={}){const o=i.pin?await r.gcLock.readLock():null;try{const a=null!=i.version?i.version:0,c=i.format||(0===a?"dag-pb":"raw"),l=await t.getHasher(i.mhtype||"sha2-256"),h=await l.digest(s),d=await e.getCodec(c),u=te.k.create(a,d.code,h);return await r.blocks.put(u,s,{signal:i.signal}),!1!==i.preload&&n(u),!0===i.pin&&await r.pins.pinRecursively(u,{signal:i.signal}),u}finally{o&&o()}}))}({codecs:e,hashers:t,preload:r,repo:n}),this.rm=function({repo:e}){return mn((async function*(t,r={}){Array.isArray(t)||(t=[t]);const n=await e.gcLock.writeLock();try{yield*(0,vi.zG)(t,(t=>(0,_i.Z)(t,(t=>async()=>{const n={cid:t=ki(t)};try{if(!await e.blocks.has(t))throw j(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await e.blocks.delete(t)}catch(e){r.force||(e.message=`cannot remove ${t}: ${e.message}`,n.error=e)}return n}))),(e=>bi(e,{concurrency:8})),(e=>(0,Ei.Z)(e,(()=>!r.quiet))))}finally{n()}}))}({repo:n}),this.stat=function({repo:e,preload:t}){return mn((async function(r,n={}){return r=ki(r),!1!==n.preload&&t(r),{cid:r,size:(await e.blocks.get(r)).length}}))}({preload:r,repo:n})}}async function*Ri(e,t={}){const r=e.getReader();try{for(;;){const e=await r.read();if(e.done)return;yield e.value}}finally{!0!==t.preventCancel&&await r.cancel(),r.releaseLock()}}function Ii(e){const[t,r]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push:e=>{n.push(e)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[r](){return this}}}var Ti=r(63855);function Ai(e){return ArrayBuffer.isView(e)||e instanceof ArrayBuffer}function Pi(e){return e.constructor&&("Blob"===e.constructor.name||"File"===e.constructor.name)&&"function"==typeof e.stream}function Di(e){return"object"==typeof e&&(e.path||e.content)}const Oi=e=>e&&"function"==typeof e.getReader;async function*Ni(e){yield e}async function Ci(e){if(Ai(e))return Ni(Mi(e));if("string"==typeof e||e instanceof String)return Ni(Mi(e.toString()));if(Pi(e))return"function"==typeof(t=e).stream?Ri(t.stream()):Ri(new Response(t).body);var t;if(Oi(e)&&(e=Ri(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const t=Ii(e),{value:r,done:n}=await t.peek();if(n)return Ni(new Uint8Array(0));if(t.push(r),Number.isInteger(r))return Ni(Uint8Array.from(await(0,Ti.Z)(t)));if(Ai(r)||"string"==typeof r||r instanceof String)return(0,_i.Z)(t,Mi)}throw j(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT")}function Mi(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Array.isArray(e)?Uint8Array.from(e):(0,Hr.m)(e.toString())}async function Li(e,t){const{path:r,mode:n,mtime:s,content:i}=e,o={path:r||"",mode:Q(n),mtime:X(s)};return i?o.content=await t(i):r||(o.content=await t(e)),o}function xi(e){return async function*(e,t){if(null==e)throw j(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT");if("string"==typeof e||e instanceof String)yield Li(e.toString(),t);else if(Ai(e)||Pi(e))yield Li(e,t);else{if(Oi(e)&&(e=Ri(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const r=Ii(e),{value:n,done:s}=await r.peek();if(s)return void(yield{content:[]});if(r.push(n),Number.isInteger(n)||Ai(n)||"string"==typeof n||n instanceof String)return void(yield Li(r,t));throw j(new Error("Unexpected input: multiple items passed - if you are using ipfs.add, please use ipfs.addAll instead"),"ERR_UNEXPECTED_INPUT")}if(!Di(e))throw j(new Error('Unexpected input: cannot convert "'+typeof e+'" into ImportCandidate'),"ERR_UNEXPECTED_INPUT");yield Li(e,t)}}(e,Ci)}async function*Bi(e,t=1){let r=[];t<1&&(t=1);for await(const n of e)for(r.push(n);r.length>=t;)yield r.slice(0,t),r=r.slice(t);for(;r.length>0;)yield r.slice(0,t),r=r.slice(t)}async function*Ui(e,t=1){for await(const r of Bi(e,t)){const e=r.map((async e=>await e().then((e=>({ok:!0,value:e})),(e=>({ok:!1,err:e})))));for(let t=0;t<e.length;t++){const r=await e[t];if(!r.ok)throw r.err;yield r.value}}}var zi=r(48081),ji=r(40600),Fi=r(11042);(0,ji.D)({name:"murmur3-32",code:35,encode:e=>function(e){const t=new Array(4);for(let r=0;r<4;r++)t[r]=255&e,e>>=8;return new Uint8Array(t)}(Fi.x86.hash32(e))});const Vi=(0,ji.D)({name:"murmur3-128",code:34,encode:e=>ir.aI.fromHex(Fi.x64.hash128(e))});(0,ji.D)({name:"murmur3-x64-64",code:34,encode:e=>ir.aI.fromHex(Fi.x64.hash128(e)).subarray(0,8)});const $i={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:zi.sha256,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:async function(e){return(await Vi.encode(e)).slice(0,8).reverse()},hamtHashCode:34,hamtBucketBits:8},Hi=async(e,t,r)=>{r.codec||(r.codec=n),r.hasher||(r.hasher=zi.sha256),void 0===r.cidVersion&&(r.cidVersion=1),r.codec===n&&r.hasher!==zi.sha256&&(r.cidVersion=1);const s=await r.hasher.digest(e),i=te.k.create(r.cidVersion,r.codec.code,s);return r.onlyHash||await t.put(i,e,{signal:r.signal}),i},Gi=async(e,t,r)=>{const n=new ee({type:"directory",mtime:e.mtime,mode:e.mode}),s=Ie(_e({Data:n.marshal()}));return{cid:await Hi(s,t,r),path:e.path,unixfs:n,size:s.length}};var qi=r(89534);async function Ki(e,t,r){const n=[];for await(const s of Bi(e,r.maxChildrenPerNode))n.push(await t(s));return n.length>1?Ki(n,t,r):n[0]}class Wi{constructor(e,t,r=0){this.maxDepth=e,this.layerRepeat=t,this.currentDepth=1,this.iteration=r,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:e,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const e=this._findParent(this.node,this.currentDepth);return!e||(this._addNextNodeToParent(e),!1)}_addNextNodeToParent(e){this.parent=e;const t={children:[],depth:e.depth+1,parent:e,maxDepth:this.maxDepth,maxChildren:Math.floor(e.children.length/this.layerRepeat)*this.layerRepeat};e.children.push(t),this.currentDepth=t.depth,this.node=t}append(e){this.node.data=e}reduce(e){return this._reduce(this.root,e)}async _reduce(e,t){let r=[];return e.children.length&&(r=await Promise.all(e.children.filter((e=>e.data)).map((e=>this._reduce(e,t))))),t((e.data||[]).concat(r))}_findParent(e,t){const r=e.parent;if(r&&0!==r.depth)return r.children.length!==r.maxChildren&&r.maxChildren?r:this._findParent(r,t)}}class Zi extends Wi{constructor(e){super(0,e),this.root.depth=0,this.currentDepth=1}addChild(e){this.root.children.push(e)}reduce(e){return e((this.root.data||[]).concat(this.root.children))}}const Yi=async function*(e,t,r){for await(let s of e.content)yield async()=>{let i;r.progress(s.length,e.path);const o={codec:n,cidVersion:r.cidVersion,hasher:r.hasher,onlyHash:r.onlyHash};return r.rawLeaves?(o.codec=qi,o.cidVersion=1):(i=new ee({type:r.leafType,data:s}),s=Ie({Data:i.marshal(),Links:[]})),{cid:await Hi(s,t,o),unixfs:i,size:s.length}}},Ji={flat:async function(e,t){return t(await(0,Ti.Z)(e))},balanced:function(e,t,r){return Ki(e,t,r)},trickle:async function(e,t,r){const n=new Zi(r.layerRepeat);let s=0,i=1,o=n;for await(const a of Bi(e,r.maxChildrenPerNode))o.isFull()&&(o!==n&&n.addChild(await o.reduce(t)),s&&s%r.layerRepeat==0&&i++,o=new Wi(i,r.layerRepeat,s),s++),o.append(a);return o&&o!==n&&n.addChild(await o.reduce(t)),n.reduce(t)}},Qi=function(e,t,r){const s=Ji[r.strategy];if(!s)throw j(new Error(`Unknown importer build strategy name: ${r.strategy}`),"ERR_BAD_STRATEGY");return s(async function*(e,t,r){let n,s,i=-1;s="function"==typeof r.bufferImporter?r.bufferImporter:Yi;for await(const o of Ui(s(e,t,r),r.blockWriteConcurrency))i++,0!==i?(1===i&&n&&(yield n,n=null),yield o):n=o;n&&(n.single=!0,yield n)}(e,t,r),((e,t,r)=>async function(s){if(1===s.length&&s[0].single&&r.reduceSingleLeafToSelf){const i=s[0];if(void 0!==e.mtime||void 0!==e.mode){let s=await t.get(i.cid);i.unixfs=new ee({type:"file",mtime:e.mtime,mode:e.mode,data:s}),s=Ie(_e({Data:i.unixfs.marshal()})),i.cid=await Hi(s,t,{...r,codec:n,hasher:r.hasher,cidVersion:r.cidVersion}),i.size=s.length}return{cid:i.cid,path:e.path,unixfs:i.unixfs,size:i.size}}const i=new ee({type:"file",mtime:e.mtime,mode:e.mode}),o=s.filter((e=>!(e.cid.code!==qi.code||!e.size)||!(!e.unixfs||e.unixfs.data||!e.unixfs.fileSize())||Boolean(e.unixfs&&e.unixfs.data&&e.unixfs.data.length))).map((e=>e.cid.code===qi.code?(i.addBlockSize(e.size),{Name:"",Tsize:e.size,Hash:e.cid}):(e.unixfs&&e.unixfs.data?i.addBlockSize(e.unixfs.data.length):i.addBlockSize(e.unixfs&&e.unixfs.fileSize()||0),{Name:"",Tsize:e.size,Hash:e.cid}))),a={Data:i.marshal(),Links:o},c=Ie(_e(a));return{cid:await Hi(c,t,r),path:e.path,unixfs:i,size:c.length+a.Links.reduce(((e,t)=>e+t.Tsize),0)}})(e,t,r),r)};var Xi=r(58407),eo=r(28232);const to=async function*(e,t){let r,n,s;if(t.minChunkSize&&t.maxChunkSize&&t.avgChunkSize)s=t.avgChunkSize,r=t.minChunkSize,n=t.maxChunkSize;else{if(!t.avgChunkSize)throw j(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");s=t.avgChunkSize,r=s/3,n=s+s/2}if(r<16)throw j(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");n<r&&(n=r),s<r&&(s=r);const i=Math.floor(Math.log2(s));for await(const s of async function*(e,t){const r=await(0,eo.create)(t.bits,t.min,t.max,t.window),n=new Xi.H;for await(const t of e){n.append(t);const e=r.fingerprint(t);for(let t=0;t<e.length;t++){const r=e[t],s=n.slice(0,r);n.consume(r),yield s}}n.length&&(yield n.subarray(0))}(e,{min:r,max:n,bits:i,window:t.window,polynomial:t.polynomial}))yield s},ro=async function*(e,t){let r=new Xi.H,n=0,s=!1;const i=t.maxChunkSize;for await(const t of e)for(r.append(t),n+=t.length;n>=i;)if(yield r.slice(0,i),s=!0,i===r.length)r=new Xi.H,n=0;else{const e=new Xi.H;e.append(r.sublist(i)),r=e,n-=i}s&&!n||(yield r.subarray(0,n))},no=async function*(e){for await(const t of e){if(void 0===t.length)throw j(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if("string"==typeof t||t instanceof String)yield(0,Hr.m)(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else{if(!(t instanceof Uint8Array))throw j(new Error("Content was invalid"),"ERR_INVALID_CONTENT");yield t}}};function so(e){try{if(e instanceof Uint8Array)return async function*(){yield e}();if(t=e,Symbol.iterator in t)return async function*(){yield*e}();if(function(e){return Symbol.asyncIterator in e}(e))return e}catch{throw j(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}var t;throw j(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}const io=async function*(e,t,r){for await(const n of e)if(n.path&&("./"===n.path.substring(0,2)&&(r.wrapWithDirectory=!0),n.path=n.path.split("/").filter((e=>e&&"."!==e)).join("/")),n.content){let e,s;e="function"==typeof r.chunker?r.chunker:"rabin"===r.chunker?to:ro,s="function"==typeof r.chunkValidator?r.chunkValidator:no;const i={path:n.path,mtime:n.mtime,mode:n.mode,content:e(s(so(n.content),r),r)};yield()=>Qi(i,t,r)}else{if(!n.path)throw new Error("Import candidate must have content or path or both");{const e={path:n.path,mtime:n.mtime,mode:n.mode};yield()=>Gi(e,t,r)}}},oo=class{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}},ao=class extends oo{constructor(e,t){super(e,t),this._children={}}async put(e,t){this.cid=void 0,this.size=void 0,this._children[e]=t}get(e){return Promise.resolve(this._children[e])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const e=Object.keys(this._children);for(let t=0;t<e.length;t++){const r=e[t];yield{key:r,child:this._children[r]}}}async*flush(e){const t=Object.keys(this._children),r=[];for(let n=0;n<t.length;n++){let s=this._children[t[n]];if(s instanceof oo)for await(const t of s.flush(e))s=t,yield s;null!=s.size&&s.cid&&r.push({Name:t[n],Tsize:s.size,Hash:s.cid})}const n=new ee({type:"directory",mtime:this.mtime,mode:this.mode}),s={Data:n.marshal(),Links:r},i=Ie(_e(s)),o=await Hi(i,e,this.options),a=i.length+s.Links.reduce(((e,t)=>e+(null==t.Tsize?0:t.Tsize)),0);this.cid=o,this.size=a,yield{cid:o,unixfs:n,path:this.path,size:a}}};var co=r(92891);class lo{constructor(e,t,r=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=r,this._children=new co,this.key=null}async put(e,t){const r=await this._findNewBucketAndPos(e);await r.bucket._putAt(r,e,t)}async get(e){const t=await this._findChild(e);if(null!=t)return t.value}async del(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);null!=r&&r.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce(((e,t)=>t instanceof lo?e+t.leafCount():e+1),0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof lo?yield*t.eachLeafSeries():yield t}serialize(e,t){return t(this._children.reduce(((r,n,s)=>(null!=n&&(n instanceof lo?r.push(n.serialize(e,t)):r.push(e(n,s))),r)),[]))}async asyncTransform(e,t){return await fo(this,e,t)}toJSON(){return this.serialize(uo,po)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);if(!(r instanceof lo))return null!=r&&r.key===e?r:void 0}async _findPlace(e){const t=this._options.hash("string"==typeof e?(0,Hr.m)(e):e),r=await t.take(this._options.bits),n=this._children.get(r);return n instanceof lo?await n._findPlace(t):{bucket:this,pos:r,hash:t,existingChild:n}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(null!=t.existingChild&&t.existingChild.key!==e){const e=new lo(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,e);const r=await e._findPlace(t.existingChild.hash);return r.bucket._putAt(r,t.existingChild.key,t.existingChild.value),await e._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,r){this._putObjectAt(e.pos,{key:t,value:r,hash:e.hash})}_putObjectAt(e,t){null==this._children.get(e)&&this._popCount++,this._children.set(e,t)}_delAt(e){if(-1===e)throw new Error("Invalid position");null!=this._children.get(e)&&this._popCount--,this._children.unset(e),this._level()}_level(){if(null!=this._parent&&this._popCount<=1)if(1===this._popCount){const e=this._children.find(ho);if(null!=e&&!(e instanceof lo)){const t=e.hash;t.untake(this._options.bits);const r={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(r,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function ho(e){return Boolean(e)}function uo(e,t){return e.key}function po(e){return e}async function fo(e,t,r){const n=[];for(const s of e._children.compactArray())if(s instanceof lo)await fo(s,t,r);else{const r=await t(s);n.push({bitField:e._children.bitField(),children:r})}return await r(n)}const go=[255,254,252,248,240,224,192,128],yo=[1,3,7,15,31,63,127,255];class mo{constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+8*this._currentBytePos}totalBits(){return 8*this._value.length}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const e=this._value[this._currentBytePos],n=this._currentBitPos+1,s=Math.min(n,t);r=(r<<s)+wo(e,n-s,s),t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function wo(e,t,r){const n=function(e,t){return go[e]&yo[Math.min(t+e-1,7)]}(t,r);return(e&n)>>>t}function bo(e){return function(t){return t instanceof _o?t:new _o(t,e)}}class _o{constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const e=this._buffers[this._currentBufferIndex],n=Math.min(e.availableBits(),t);r=(r<<n)+e.take(n),t-=n,this._availableBits-=n,0===e.availableBits()&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const e=this._buffers[this._currentBufferIndex],r=Math.min(e.totalBits()-e.availableBits(),t);e.untake(r),t-=r,this._availableBits+=r,this._currentBufferIndex>0&&e.totalBits()===e.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?(0,Qn.z)([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new mo(t);this._buffers.push(r),this._availableBits+=r.availableBits()}}function Eo(e){if(null==e||null==e.hashFn)throw new Error("please define an options.hashFn");const t={bits:e.bits??8,hash:bo(e.hashFn)};return new lo(t)}const vo=class extends oo{constructor(e,t){super(e,t),this._bucket=Eo({hashFn:t.hamtHashFn,bits:t.hamtBucketBits})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){for await(const t of ko(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*ko(e,t,r,n){const s=e._children,i=[];let o=0;for(let e=0;e<s.length;e++){const r=s.get(e);if(!r)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(r instanceof lo){let e;for await(const s of await ko(r,t,null,n))e=s;if(!e)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:a,Tsize:e.size,Hash:e.cid}),o+=e.size}else if("function"==typeof r.value.flush){const e=r.value;let n;for await(const r of e.flush(t))n=r,yield n;const s=a+r.key;i.push({Name:s,Tsize:n.size,Hash:n.cid}),o+=n.size}else{const e=r.value;if(!e.cid)continue;const t=a+r.key,n=e.size;i.push({Name:t,Tsize:n,Hash:e.cid}),o+=n}}const a=Uint8Array.from(s.bitField().reverse()),c=new ee({type:"hamt-sharded-directory",data:a,fanout:e.tableSize(),hashType:n.hamtHashCode,mtime:r&&r.mtime,mode:r&&r.mode}),l=Ie(_e({Data:c.marshal(),Links:i})),h=await Hi(l,t,n),d=l.length+o;yield{cid:h,unixfs:c,size:d}}const So=async function e(t,r,n,s){let i=r;r instanceof ao&&r.directChildrenCount()>=n&&(i=await async function(e,t){const r=new vo({root:e.root,dir:!0,parent:e.parent,parentKey:e.parentKey,path:e.path,dirty:e.dirty,flat:!1,mtime:e.mtime,mode:e.mode},t);for await(const{key:t,child:n}of e.eachChildSeries())await r.put(t,n);return r}(r,s));const o=i.parent;if(o){if(i!==r){if(t&&(t.parent=i),!i.parentKey)throw new Error("No parent key found");await o.put(i.parentKey,i)}return e(i,o,n,s)}return i};async function Ro(e,t,r){const n=((e="")=>(e.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean))(e.path||""),s=n.length-1;let i=t,o="";for(let a=0;a<n.length;a++){const c=n[a];o+=`${o?"/":""}${c}`;const l=a===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,l)await i.put(c,e),t=await So(null,i,r.shardSplitThreshold,r);else{let e=await i.get(c);e&&e instanceof oo||(e=new ao({root:!1,dir:!0,parent:i,parentKey:c,path:o,dirty:!0,flat:!0,mtime:e&&e.unixfs&&e.unixfs.mtime,mode:e&&e.unixfs&&e.unixfs.mode},r)),await i.put(c,e),i=e}}return t}async function*Io(e,t){e instanceof oo?yield*e.flush(t):e&&e.unixfs&&e.unixfs.isDirectory()&&(yield e)}const To=async function*(e,t,r){let n=new ao({root:!0,dir:!0,path:"",dirty:!0,flat:!0},r);for await(const t of e)t&&(n=await Ro(t,n,r),t.unixfs&&t.unixfs.isDirectory()||(yield t));if(r.wrapWithDirectory)yield*Io(n,t);else for await(const e of n.eachChildSeries())e&&(yield*Io(e.child,t))};async function*Ao(e,t,r={}){const n=((e={})=>B.Z.bind({ignoreUndefined:!0})($i,e))(r);let s,i,o;s="function"==typeof r.dagBuilder?r.dagBuilder:io,i="function"==typeof r.treeBuilder?r.treeBuilder:To,o=Symbol.asyncIterator in e||Symbol.iterator in e?e:[e];for await(const e of i(Ui(s(o,t,n),n.fileImportConcurrency),t,n))yield{cid:e.cid,path:e.path,unixfs:e.unixfs,size:e.size}}async function*Po(e,t){if("string"==typeof e||e instanceof String||Ai(e)||Pi(e)||e._readableState)throw j(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(Oi(e)&&(e=Ri(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const r=Ii(e),{value:n,done:s}=await r.peek();if(s)return void(yield*[]);if(r.push(n),Number.isInteger(n))throw j(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(n._readableState)return void(yield*(0,_i.Z)(r,(e=>Do({content:e},t))));if(Ai(n))return void(yield Do({content:r},t));if(Di(n)||n[Symbol.iterator]||n[Symbol.asyncIterator]||Oi(n)||Pi(n))return void(yield*(0,_i.Z)(r,(e=>Do(e,t))))}if(Di(e))throw j(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");throw j(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}async function Do(e,t){const{path:r,mode:n,mtime:s,content:i}=e,o={path:r||"",mode:Q(n),mtime:X(s)};return i?o.content=await t(i):r||(o.content=await t(e)),o}const Oo=e=>{if(e){if(e.startsWith("size-")){const t=e.split("-")[1],r=parseInt(t);if(isNaN(r))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:r}}if(e.startsWith("rabin"))return{chunker:"rabin",...No(e)};throw new Error(`Unrecognized chunker option: ${e}`)}return{chunker:"fixed"}},No=e=>{const t={},r=e.split("-");switch(r.length){case 1:t.avgChunkSize=262144;break;case 2:t.avgChunkSize=Co(r[1],"avg");break;case 4:t.minChunkSize=Co(r[1],"min"),t.avgChunkSize=Co(r[2],"avg"),t.maxChunkSize=Co(r[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return t},Co=(e,t)=>{const r=parseInt(e);if(isNaN(r))throw new Error(`Chunker parameter ${t} must be an integer`);return r},Mo=B.Z.bind({ignoreUndefined:!0});const Lo=async function(e){return(await Vi.encode(e)).slice(0,8).reverse()},xo=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),Bo=async(e,t,r,n,s)=>{if(!n){const e=Eo({hashFn:Lo});n={rootBucket:e,hamtDepth:1,lastBucket:e}}await((e,t,r)=>Promise.all(e.map((e=>{if(null==e.Name)throw new Error("Unexpected Link without a Name");if(2===e.Name.length){const n=parseInt(e.Name,16);return t._putObjectAt(n,new lo({hash:r._options.hash,bits:r._options.bits},t,n))}return r.put(e.Name.substring(2),!0)}))))(e.Links,n.lastBucket,n.rootBucket);const i=await n.rootBucket._findNewBucketAndPos(t);let o=xo(i.pos);const a=(e=>{let t=e.bucket;const r=[];for(;t._parent;)r.push(t),t=t._parent;return r.push(t),r.reverse()})(i);a.length>n.hamtDepth&&(n.lastBucket=a[n.hamtDepth],o=xo(n.lastBucket._posAtParent));const c=e.Links.find((e=>{if(null==e.Name)return!1;const r=e.Name.substring(0,2),n=e.Name.substring(2);return r===o&&(!n||n===t)}));return c?null!=c.Name&&c.Name.substring(2)===t?c.Hash:(n.hamtDepth++,e=Te(await r.get(c.Hash,s)),Bo(e,t,r,n,s)):null},Uo=Bo,zo=function(e,t,r,n){const s=t+e.length;return r>=s||n<t?new Uint8Array(0):(n>=t&&n<s&&(e=e.subarray(0,n-t)),r>=t&&r<s&&(e=e.subarray(r-t)),e)},jo=(e,t,r)=>{if(t||(t=0),t<0)throw j(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(t>e)throw j(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(r||0===r||(r=e-t),r<0)throw j(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return t+r>e&&(r=e-t),{offset:t,length:r}};async function Fo(e,t,r,n,s,i,o,a){if(t instanceof Uint8Array)return void r.push(zo(t,n,s,i));if(null==t.Data)throw j(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let c;try{c=ee.unmarshal(t.Data)}catch(e){throw j(e,"ERR_NOT_UNIXFS")}if(null!=c.data){const e=c.data,t=zo(e,n,s,i);r.push(t),n+=t.byteLength}const l=[];for(let e=0;e<t.Links.length;e++){const r=t.Links[e],o=n,a=o+c.blockSizes[e];if((s>=o&&s<a||i>=o&&i<=a||s<o&&i>a)&&l.push({link:r,blockStart:n}),(n=a)>i)break}await(0,vi.zG)(l,(t=>(0,_i.Z)(t,(t=>async()=>{const r=await e.get(t.link.Hash,{signal:a.signal});return{...t,block:r}}))),(e=>bi(e,{ordered:!0})),(async t=>{for await(const{link:n,block:c,blockStart:l}of t){let t;switch(n.Hash.code){case Re:t=Te(c);break;case qi.code:t=c;break;default:return void r.end(j(new Error(`Unsupported codec: ${n.Hash.code}`),"ERR_NOT_UNIXFS"))}o.add((async()=>{await Fo(e,t,r,l,s,i,o,a)}))}}))}const Vo=(e,t,r,n,s,i,o)=>async function*(e={}){const n=r.fileSize();if(void 0===n)throw new Error("File was a directory");const{offset:s,length:i}=jo(n,e.offset,e.length);if(0===i)return;const a=new Dn.Z({concurrency:1}),c=(0,Is.d)();a.add((async()=>{await Fo(o,t,c,0,s,s+i,a,e)})),a.on("error",(e=>{c.end(e)}));let l=0;for await(const e of c)null!=e&&(l+=e.byteLength,l===i&&c.end(),yield e)};async function*$o(e,t,r,n,s,i){const o=e.Links;for(const a of o){const o=null!=a.Name?a.Name.substring(2):null;if(o){const e=await r(a.Hash,o,`${t}/${o}`,[],n+1,s,i);yield e.entry}else{e=Te(await s.get(a.Hash));for await(const o of $o(e,t,r,n,s,i))yield o}}}const Ho={raw:Vo,file:Vo,directory:(e,t,r,n,s,i,o)=>async function*(e={}){const r=e.offset||0,a=e.length||t.Links.length,c=t.Links.slice(r,a);for(const t of c){const r=await s(t.Hash,t.Name||"",`${n}/${t.Name||""}`,[],i+1,o,e);r.entry&&(yield r.entry)}},"hamt-sharded-directory":(e,t,r,n,s,i,o)=>function(e={}){return $o(t,n,s,i,o,e)},metadata:(e,t,r,n,s,i,o)=>()=>[],symlink:(e,t,r,n,s,i,o)=>()=>[]},Go={[Re]:async(e,t,r,n,s,i,o,a)=>{const c=Te(await o.get(e,a));let l,h;if(t||(t=e.toString()),null==c.Data)throw j(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{l=ee.unmarshal(c.Data)}catch(e){throw j(e,"ERR_NOT_UNIXFS")}if(r||(r=t),n.length){let e;if(e=l&&"hamt-sharded-directory"===l.type?await Uo(c,n[0],o):((e,t)=>{const r=e.Links.find((e=>e.Name===t));return r&&r.Hash})(c,n[0]),!e)throw j(new Error("file does not exist"),"ERR_NOT_FOUND");const t=n.shift();h={cid:e,toResolve:n,name:t||"",path:`${r}/${t}`}}return{entry:{type:l.isDirectory()?"directory":"file",name:t,path:r,cid:e,content:Ho[l.type](e,c,l,r,s,i,o),unixfs:l,depth:i,node:c,size:l.fileSize()},next:h}},[qi.code]:async(e,t,r,n,s,i,o,a)=>{if(n.length)throw j(new Error(`No link named ${r} found in raw node ${e}`),"ERR_NOT_FOUND");const c=await o.get(e,a);return{entry:{type:"raw",name:t,path:r,cid:e,content:(l=c,async function*(e={}){const{offset:t,length:r}=jo(l.length,e.offset,e.length);yield zo(l,0,t,t+r)}),depth:i,size:c.length,node:c}};var l},[rr]:async(e,t,r,n,s,i,o,a)=>{const c=await o.get(e),l=sr(c);let h=l,d=r;for(;n.length;){const s=n[0];if(!(s in h))throw j(new Error(`No property named ${s} found in cbor node ${e}`),"ERR_NO_PROP");{n.shift(),d=`${d}/${s}`;const o=te.k.asCID(h[s]);if(o)return{entry:{type:"object",name:t,path:r,cid:e,node:c,depth:i,size:c.length,content:async function*(){yield l}},next:{cid:o,name:s,path:d,toResolve:n}};h=h[s]}}return{entry:{type:"object",name:t,path:r,cid:e,node:c,depth:i,size:c.length,content:async function*(){yield l}}}},[Lr.identity.code]:async(e,t,r,n,s,i,o,a)=>{if(n.length)throw j(new Error(`No link named ${r} found in raw node ${e}`),"ERR_NOT_FOUND");const c=await Wr.Jx(e.multihash.bytes);return{entry:{type:"identity",name:t,path:r,cid:e,content:(l=c.digest,async function*(e={}){const{offset:t,length:r}=jo(l.length,e.offset,e.length);yield zo(l,0,t,t+r)}),depth:i,size:c.digest.length,node:c.digest}};var l}},qo=function e(t,r,n,s,i,o,a){const c=Go[t.code];if(!c)throw j(new Error(`No resolver for code ${t.code}`),"ERR_NO_RESOLVER");return c(t,r,n,s,e,i,o,a)};async function*Ko(e,t,r={}){let{cid:n,toResolve:s}=(e=>{if(e instanceof Uint8Array)return{cid:te.k.decode(e),toResolve:[]};const t=te.k.asCID(e);if(t)return{cid:t,toResolve:[]};if("string"==typeof e){0===e.indexOf("/ipfs/")&&(e=e.substring(6));const t=((e="")=>(e.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean))(e);return{cid:te.k.parse(t[0]),toResolve:t.slice(1)}}throw j(new Error(`Unknown path type ${e}`),"ERR_BAD_PATH")})(e),i=n.toString(),o=i;const a=s.length;for(;;){const c=await qo(n,i,o,s,a,t,r);if(!c.entry&&!c.next)throw j(new Error(`Could not resolve ${e}`),"ERR_NOT_FOUND");if(c.entry&&(yield c.entry),!c.next)return;s=c.next.toResolve,n=c.next.cid,i=c.next.name,o=c.next.path}}async function Wo(e,t,r={}){const n=await xn(Ko(e,t,r));if(!n)throw j(new Error(`Could not resolve ${e}`),"ERR_NOT_FOUND");return n}async function*Zo(e,t,r={}){const n=await Wo(e,t,r);if(n&&(yield n,"directory"===n.type))for await(const e of async function*e(t,r){for await(const n of t.content(r))yield n,n instanceof Uint8Array||"directory"===n.type&&(yield*e(n,r))}(n,r))yield e}"0".charCodeAt(0),(0,Hr.m)("ustar\0","binary"),(0,Hr.m)("ustar ","binary"),(0,Hr.m)(" \0","binary"),r(63024);var Yo=r(78814);async function Jo(e){let t=new Uint8Array(0);for await(const r of e)t=(0,Qn.z)([t,r],t.length+r.length);return t}const Qo="0".charCodeAt(0),Xo=(0,Hr.m)("ustar\0","binary"),ea=(0,Hr.m)("00","binary"),ta=parseInt("7777",8),ra=function(e,t){const r=e.toString(8);return r.length>t?(0,Hr.m)("7777777777777777777".slice(0,t)+" "):(0,Hr.m)("0000000000000000000".slice(0,t-r.length)+r+" ")},na=function(e){const t=(0,Hr.m)(e).byteLength;let r=Math.floor(Math.log(t)/Math.log(10))+1;return t+r>=Math.pow(10,r)&&r++,`${t+r}${e}`};function sa(e){const t=new Uint8Array(512);let r=e.name,n="";if(5===e.typeflag&&"/"!==r[r.length-1]&&(r+="/"),(0,Hr.m)(r).byteLength!==r.length)return null;for(;(0,Hr.m)(r).byteLength>100;){const e=r.indexOf("/");if(-1===e)return null;n+=""!==n?"/"+r.slice(0,e):r.slice(0,e),r=r.slice(e+1)}return(0,Hr.m)(r).byteLength>100||(0,Hr.m)(n).byteLength>155||null!=e.linkname&&(0,Hr.m)(e.linkname).byteLength>100?null:(t.set((0,Hr.m)(r),0),t.set(ra(e.mode&ta,6),100),t.set(ra(e.uid,6),108),t.set(ra(e.gid,6),116),t.set(ra(e.size,11),124),t.set(ra(e.mtime.getTime()/1e3|0,11),136),t[156]=Qo+function(e){switch(e){case"file":default:return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}}(e.type),null!=e.linkname&&t.set((0,Hr.m)(e.linkname),157),t.set(Xo,257),t.set(ea,263),null!=e.uname&&t.set((0,Hr.m)(e.uname),265),null!=e.gname&&t.set((0,Hr.m)(e.gname),297),t.set(ra(e.devmajor??0,6),329),t.set(ra(e.devminor??0,6),337),null!=n&&t.set((0,Hr.m)(n),345),t.set(ra(function(e){let t=256;for(let r=0;r<148;r++)t+=e[r];for(let r=156;r<512;r++)t+=e[r];return t}(t),6),148),t)}const{S_IFMT:ia,S_IFBLK:oa,S_IFCHR:aa,S_IFDIR:ca,S_IFIFO:la,S_IFLNK:ha}=Yo,da=parseInt("755",8),ua=parseInt("644",8),pa=new Uint8Array(1024);function fa(e=0){switch(e&ia){case oa:return"block-device";case aa:return"character-device";case ca:return"directory";case la:return"fifo";case ha:return"symlink";default:return"file"}}function ga(e){return 0!=(e&=511)?pa.subarray(0,512-e):new Uint8Array(0)}function ya(e){if(null==e.pax){const t=sa(e);if(null!=t)return t}return function(e){const t=function(e){let t="";null!=e.name&&(t+=na(" path="+e.name+"\n")),null!=e.linkname&&(t+=na(" linkpath="+e.linkname+"\n"));const r=e.pax;if(null!=r)for(const e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t+=na(" "+e+"="+r[e]+"\n"));return(0,Hr.m)(t)}(e),r={name:"PaxHeader",mode:e.mode,uid:e.uid,gid:e.gid,size:t.length,mtime:e.mtime,type:"pax-header",linkname:e.linkname,uname:e.uname,gname:e.gname,devmajor:e.devmajor,devminor:e.devminor};return new Xi.H(sa(r)??new Uint8Array(0),t,ga(t.length),sa({...r,size:e.size,type:e.type})??new Uint8Array(0)).subarray()}(e)}function ma(){return async function*(e){for await(let{header:t,body:r}of e){const e={...t,size:"symlink"===t.type?0:t.size??0,type:t.type??fa(t.mode),mode:t.mode??("directory"===t.type?da:ua),uid:t.uid??0,gid:t.gid??0,mtime:t.mtime??new Date};if("string"==typeof r&&(r=(0,Hr.m)(r)),r instanceof Uint8Array||(0,Xi.Z)(r)){e.size=r.length,yield ya(e),yield(0,Xi.Z)(r)?r.subarray():r,yield ga(e.size);continue}if("symlink"===e.type&&null==e.linkname){if(null==r)throw new Error("type was symlink but no linkname or body specified");e.linkname=(0,Qr.B)(await Jo(r)),yield ya(e);continue}if(yield ya(e),"file"!==e.type&&"contiguous-file"!==e.type)continue;let n=0;for await(const e of r??[])n+=e.length,yield(0,Xi.Z)(e)?e.subarray():e;if(n!==e.size)throw new Error(`size mismatch, wrote ${n} of ${e.size} bytes`);yield ga(e.size)}yield pa}}function wa(e){let t=e.length;for(;--t>=0;)e[t]=0}const ba=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),_a=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Ea=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),va=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ka=new Array(576);wa(ka);const Sa=new Array(60);wa(Sa);const Ra=new Array(512);wa(Ra);const Ia=new Array(256);wa(Ia);const Ta=new Array(29);wa(Ta);const Aa=new Array(30);function Pa(e,t,r,n,s){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=n,this.max_length=s,this.has_stree=e&&e.length}let Da,Oa,Na;function Ca(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}wa(Aa);const Ma=e=>e<256?Ra[e]:Ra[256+(e>>>7)],La=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},xa=(e,t,r)=>{e.bi_valid>16-r?(e.bi_buf|=t<<e.bi_valid&65535,La(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=r-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)},Ba=(e,t,r)=>{xa(e,r[2*t],r[2*t+1])},Ua=(e,t)=>{let r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1},za=(e,t,r)=>{const n=new Array(16);let s,i,o=0;for(s=1;s<=15;s++)o=o+r[s-1]<<1,n[s]=o;for(i=0;i<=t;i++){let t=e[2*i+1];0!==t&&(e[2*i]=Ua(n[t]++,t))}},ja=e=>{let t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Fa=e=>{e.bi_valid>8?La(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},Va=(e,t,r,n)=>{const s=2*t,i=2*r;return e[s]<e[i]||e[s]===e[i]&&n[t]<=n[r]},$a=(e,t,r)=>{const n=e.heap[r];let s=r<<1;for(;s<=e.heap_len&&(s<e.heap_len&&Va(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!Va(t,n,e.heap[s],e.depth));)e.heap[r]=e.heap[s],r=s,s<<=1;e.heap[r]=n},Ha=(e,t,r)=>{let n,s,i,o,a=0;if(0!==e.sym_next)do{n=255&e.pending_buf[e.sym_buf+a++],n+=(255&e.pending_buf[e.sym_buf+a++])<<8,s=e.pending_buf[e.sym_buf+a++],0===n?Ba(e,s,t):(i=Ia[s],Ba(e,i+256+1,t),o=ba[i],0!==o&&(s-=Ta[i],xa(e,s,o)),n--,i=Ma(n),Ba(e,i,r),o=_a[i],0!==o&&(n-=Aa[i],xa(e,n,o)))}while(a<e.sym_next);Ba(e,256,t)},Ga=(e,t)=>{const r=t.dyn_tree,n=t.stat_desc.static_tree,s=t.stat_desc.has_stree,i=t.stat_desc.elems;let o,a,c,l=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<i;o++)0!==r[2*o]?(e.heap[++e.heap_len]=l=o,e.depth[o]=0):r[2*o+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=l<2?++l:0,r[2*c]=1,e.depth[c]=0,e.opt_len--,s&&(e.static_len-=n[2*c+1]);for(t.max_code=l,o=e.heap_len>>1;o>=1;o--)$a(e,r,o);c=i;do{o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],$a(e,r,1),a=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=a,r[2*c]=r[2*o]+r[2*a],e.depth[c]=(e.depth[o]>=e.depth[a]?e.depth[o]:e.depth[a])+1,r[2*o+1]=r[2*a+1]=c,e.heap[1]=c++,$a(e,r,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const r=t.dyn_tree,n=t.max_code,s=t.stat_desc.static_tree,i=t.stat_desc.has_stree,o=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,c=t.stat_desc.max_length;let l,h,d,u,p,f,g=0;for(u=0;u<=15;u++)e.bl_count[u]=0;for(r[2*e.heap[e.heap_max]+1]=0,l=e.heap_max+1;l<573;l++)h=e.heap[l],u=r[2*r[2*h+1]+1]+1,u>c&&(u=c,g++),r[2*h+1]=u,h>n||(e.bl_count[u]++,p=0,h>=a&&(p=o[h-a]),f=r[2*h],e.opt_len+=f*(u+p),i&&(e.static_len+=f*(s[2*h+1]+p)));if(0!==g){do{for(u=c-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[c]--,g-=2}while(g>0);for(u=c;0!==u;u--)for(h=e.bl_count[u];0!==h;)d=e.heap[--l],d>n||(r[2*d+1]!==u&&(e.opt_len+=(u-r[2*d+1])*r[2*d],r[2*d+1]=u),h--)}})(e,t),za(r,l,e.bl_count)},qa=(e,t,r)=>{let n,s,i=-1,o=t[1],a=0,c=7,l=4;for(0===o&&(c=138,l=3),t[2*(r+1)+1]=65535,n=0;n<=r;n++)s=o,o=t[2*(n+1)+1],++a<c&&s===o||(a<l?e.bl_tree[2*s]+=a:0!==s?(s!==i&&e.bl_tree[2*s]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,i=s,0===o?(c=138,l=3):s===o?(c=6,l=3):(c=7,l=4))},Ka=(e,t,r)=>{let n,s,i=-1,o=t[1],a=0,c=7,l=4;for(0===o&&(c=138,l=3),n=0;n<=r;n++)if(s=o,o=t[2*(n+1)+1],!(++a<c&&s===o)){if(a<l)do{Ba(e,s,e.bl_tree)}while(0!=--a);else 0!==s?(s!==i&&(Ba(e,s,e.bl_tree),a--),Ba(e,16,e.bl_tree),xa(e,a-3,2)):a<=10?(Ba(e,17,e.bl_tree),xa(e,a-3,3)):(Ba(e,18,e.bl_tree),xa(e,a-11,7));a=0,i=s,0===o?(c=138,l=3):s===o?(c=6,l=3):(c=7,l=4)}};let Wa=!1;const Za=(e,t,r,n)=>{xa(e,0+(n?1:0),3),Fa(e),La(e,r),La(e,~r),r&&e.pending_buf.set(e.window.subarray(t,t+r),e.pending),e.pending+=r};var Ya={_tr_init:e=>{Wa||((()=>{let e,t,r,n,s;const i=new Array(16);for(r=0,n=0;n<28;n++)for(Ta[n]=r,e=0;e<1<<ba[n];e++)Ia[r++]=n;for(Ia[r-1]=n,s=0,n=0;n<16;n++)for(Aa[n]=s,e=0;e<1<<_a[n];e++)Ra[s++]=n;for(s>>=7;n<30;n++)for(Aa[n]=s<<7,e=0;e<1<<_a[n]-7;e++)Ra[256+s++]=n;for(t=0;t<=15;t++)i[t]=0;for(e=0;e<=143;)ka[2*e+1]=8,e++,i[8]++;for(;e<=255;)ka[2*e+1]=9,e++,i[9]++;for(;e<=279;)ka[2*e+1]=7,e++,i[7]++;for(;e<=287;)ka[2*e+1]=8,e++,i[8]++;for(za(ka,287,i),e=0;e<30;e++)Sa[2*e+1]=5,Sa[2*e]=Ua(e,5);Da=new Pa(ka,ba,257,286,15),Oa=new Pa(Sa,_a,0,30,15),Na=new Pa(new Array(0),Ea,0,19,7)})(),Wa=!0),e.l_desc=new Ca(e.dyn_ltree,Da),e.d_desc=new Ca(e.dyn_dtree,Oa),e.bl_desc=new Ca(e.bl_tree,Na),e.bi_buf=0,e.bi_valid=0,ja(e)},_tr_stored_block:Za,_tr_flush_block:(e,t,r,n)=>{let s,i,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),Ga(e,e.l_desc),Ga(e,e.d_desc),o=(e=>{let t;for(qa(e,e.dyn_ltree,e.l_desc.max_code),qa(e,e.dyn_dtree,e.d_desc.max_code),Ga(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*va[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),s=e.opt_len+3+7>>>3,i=e.static_len+3+7>>>3,i<=s&&(s=i)):s=i=r+5,r+4<=s&&-1!==t?Za(e,t,r,n):4===e.strategy||i===s?(xa(e,2+(n?1:0),3),Ha(e,ka,Sa)):(xa(e,4+(n?1:0),3),((e,t,r,n)=>{let s;for(xa(e,t-257,5),xa(e,r-1,5),xa(e,n-4,4),s=0;s<n;s++)xa(e,e.bl_tree[2*va[s]+1],3);Ka(e,e.dyn_ltree,t-1),Ka(e,e.dyn_dtree,r-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),Ha(e,e.dyn_ltree,e.dyn_dtree)),ja(e),n&&Fa(e)},_tr_tally:(e,t,r)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=r,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(Ia[r]+256+1)]++,e.dyn_dtree[2*Ma(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{xa(e,2,3),Ba(e,256,ka),(e=>{16===e.bi_valid?(La(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}},Ja=(e,t,r,n)=>{let s=65535&e|0,i=e>>>16&65535|0,o=0;for(;0!==r;){o=r>2e3?2e3:r,r-=o;do{s=s+t[n++]|0,i=i+s|0}while(--o);s%=65521,i%=65521}return s|i<<16|0};const Qa=new Uint32Array((()=>{let e,t=[];for(var r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t})());var Xa=(e,t,r,n)=>{const s=Qa,i=n+r;e^=-1;for(let r=n;r<i;r++)e=e>>>8^s[255&(e^t[r])];return-1^e},ec={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},tc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:rc,_tr_stored_block:nc,_tr_flush_block:sc,_tr_tally:ic,_tr_align:oc}=Ya,{Z_NO_FLUSH:ac,Z_PARTIAL_FLUSH:cc,Z_FULL_FLUSH:lc,Z_FINISH:hc,Z_BLOCK:dc,Z_OK:uc,Z_STREAM_END:pc,Z_STREAM_ERROR:fc,Z_DATA_ERROR:gc,Z_BUF_ERROR:yc,Z_DEFAULT_COMPRESSION:mc,Z_FILTERED:wc,Z_HUFFMAN_ONLY:bc,Z_RLE:_c,Z_FIXED:Ec,Z_DEFAULT_STRATEGY:vc,Z_UNKNOWN:kc,Z_DEFLATED:Sc}=tc,Rc=258,Ic=262,Tc=42,Ac=113,Pc=666,Dc=(e,t)=>(e.msg=ec[t],t),Oc=e=>2*e-(e>4?9:0),Nc=e=>{let t=e.length;for(;--t>=0;)e[t]=0},Cc=e=>{let t,r,n,s=e.w_size;t=e.hash_size,n=t;do{r=e.head[--n],e.head[n]=r>=s?r-s:0}while(--t);t=s,n=t;do{r=e.prev[--n],e.prev[n]=r>=s?r-s:0}while(--t)};let Mc=(e,t,r)=>(t<<e.hash_shift^r)&e.hash_mask;const Lc=e=>{const t=e.state;let r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+r),e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))},xc=(e,t)=>{sc(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Lc(e.strm)},Bc=(e,t)=>{e.pending_buf[e.pending++]=t},Uc=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},zc=(e,t,r,n)=>{let s=e.avail_in;return s>n&&(s=n),0===s?0:(e.avail_in-=s,t.set(e.input.subarray(e.next_in,e.next_in+s),r),1===e.state.wrap?e.adler=Ja(e.adler,t,s,r):2===e.state.wrap&&(e.adler=Xa(e.adler,t,s,r)),e.next_in+=s,e.total_in+=s,s)},jc=(e,t)=>{let r,n,s=e.max_chain_length,i=e.strstart,o=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-Ic?e.strstart-(e.w_size-Ic):0,l=e.window,h=e.w_mask,d=e.prev,u=e.strstart+Rc;let p=l[i+o-1],f=l[i+o];e.prev_length>=e.good_match&&(s>>=2),a>e.lookahead&&(a=e.lookahead);do{if(r=t,l[r+o]===f&&l[r+o-1]===p&&l[r]===l[i]&&l[++r]===l[i+1]){i+=2,r++;do{}while(l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&l[++i]===l[++r]&&i<u);if(n=Rc-(u-i),i=u-Rc,n>o){if(e.match_start=t,o=n,n>=a)break;p=l[i+o-1],f=l[i+o]}}}while((t=d[t&h])>c&&0!=--s);return o<=e.lookahead?o:e.lookahead},Fc=e=>{const t=e.w_size;let r,n,s;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Ic)&&(e.window.set(e.window.subarray(t,t+t-n),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),Cc(e),n+=t),0===e.strm.avail_in)break;if(r=zc(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=r,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=Mc(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=Mc(e,e.ins_h,e.window[s+3-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Ic&&0!==e.strm.avail_in)},Vc=(e,t)=>{let r,n,s,i=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(r=65535,s=e.bi_valid+42>>3,e.strm.avail_out<s)break;if(s=e.strm.avail_out-s,n=e.strstart-e.block_start,r>n+e.strm.avail_in&&(r=n+e.strm.avail_in),r>s&&(r=s),r<i&&(0===r&&t!==hc||t===ac||r!==n+e.strm.avail_in))break;o=t===hc&&r===n+e.strm.avail_in?1:0,nc(e,0,0,o),e.pending_buf[e.pending-4]=r,e.pending_buf[e.pending-3]=r>>8,e.pending_buf[e.pending-2]=~r,e.pending_buf[e.pending-1]=~r>>8,Lc(e.strm),n&&(n>r&&(n=r),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+n),e.strm.next_out),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n,e.block_start+=n,r-=n),r&&(zc(e.strm,e.strm.output,e.strm.next_out,r),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r)}while(0===o);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==ac&&t!==hc&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(s=e.window_size-e.strstart,e.strm.avail_in>s&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,s+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),s>e.strm.avail_in&&(s=e.strm.avail_in),s&&(zc(e.strm,e.window,e.strstart,s),e.strstart+=s,e.insert+=s>e.w_size-e.insert?e.w_size-e.insert:s),e.high_water<e.strstart&&(e.high_water=e.strstart),s=e.bi_valid+42>>3,s=e.pending_buf_size-s>65535?65535:e.pending_buf_size-s,i=s>e.w_size?e.w_size:s,n=e.strstart-e.block_start,(n>=i||(n||t===hc)&&t!==ac&&0===e.strm.avail_in&&n<=s)&&(r=n>s?s:n,o=t===hc&&0===e.strm.avail_in&&r===n?1:0,nc(e,e.block_start,r,o),e.block_start+=r,Lc(e.strm)),o?3:1)},$c=(e,t)=>{let r,n;for(;;){if(e.lookahead<Ic){if(Fc(e),e.lookahead<Ic&&t===ac)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=Mc(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-Ic&&(e.match_length=jc(e,r)),e.match_length>=3)if(n=ic(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=Mc(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Mc(e,e.ins_h,e.window[e.strstart+1]);else n=ic(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(xc(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===hc?(xc(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(xc(e,!1),0===e.strm.avail_out)?1:2},Hc=(e,t)=>{let r,n,s;for(;;){if(e.lookahead<Ic){if(Fc(e),e.lookahead<Ic&&t===ac)return 1;if(0===e.lookahead)break}if(r=0,e.lookahead>=3&&(e.ins_h=Mc(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-Ic&&(e.match_length=jc(e,r),e.match_length<=5&&(e.strategy===wc||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,n=ic(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=Mc(e,e.ins_h,e.window[e.strstart+3-1]),r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(xc(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(n=ic(e,0,e.window[e.strstart-1]),n&&xc(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=ic(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===hc?(xc(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(xc(e,!1),0===e.strm.avail_out)?1:2};function Gc(e,t,r,n,s){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=n,this.func=s}const qc=[new Gc(0,0,0,0,Vc),new Gc(4,4,8,4,$c),new Gc(4,5,16,8,$c),new Gc(4,6,32,32,$c),new Gc(4,4,16,16,Hc),new Gc(8,16,32,32,Hc),new Gc(8,16,128,128,Hc),new Gc(8,32,128,256,Hc),new Gc(32,128,258,1024,Hc),new Gc(32,258,258,4096,Hc)];function Kc(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Sc,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Nc(this.dyn_ltree),Nc(this.dyn_dtree),Nc(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Nc(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Nc(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Wc=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Tc&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==Ac&&t.status!==Pc?1:0},Zc=e=>{if(Wc(e))return Dc(e,fc);e.total_in=e.total_out=0,e.data_type=kc;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?Tc:Ac,e.adler=2===t.wrap?0:1,t.last_flush=-2,rc(t),uc},Yc=e=>{const t=Zc(e);var r;return t===uc&&((r=e.state).window_size=2*r.w_size,Nc(r.head),r.max_lazy_match=qc[r.level].max_lazy,r.good_match=qc[r.level].good_length,r.nice_match=qc[r.level].nice_length,r.max_chain_length=qc[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=2,r.match_available=0,r.ins_h=0),t},Jc=(e,t,r,n,s,i)=>{if(!e)return fc;let o=1;if(t===mc&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>9||r!==Sc||n<8||n>15||t<0||t>9||i<0||i>Ec||8===n&&1!==o)return Dc(e,fc);8===n&&(n=9);const a=new Kc;return e.state=a,a.strm=e,a.status=Tc,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=i,a.method=r,Yc(e)};var Qc=Jc,Xc=(e,t)=>Wc(e)||2!==e.state.wrap?fc:(e.state.gzhead=t,uc),el=(e,t)=>{if(Wc(e)||t>dc||t<0)return e?Dc(e,fc):fc;const r=e.state;if(!e.output||0!==e.avail_in&&!e.input||r.status===Pc&&t!==hc)return Dc(e,0===e.avail_out?yc:fc);const n=r.last_flush;if(r.last_flush=t,0!==r.pending){if(Lc(e),0===e.avail_out)return r.last_flush=-1,uc}else if(0===e.avail_in&&Oc(t)<=Oc(n)&&t!==hc)return Dc(e,yc);if(r.status===Pc&&0!==e.avail_in)return Dc(e,yc);if(r.status===Tc&&0===r.wrap&&(r.status=Ac),r.status===Tc){let t=Sc+(r.w_bits-8<<4)<<8,n=-1;if(n=r.strategy>=bc||r.level<2?0:r.level<6?1:6===r.level?2:3,t|=n<<6,0!==r.strstart&&(t|=32),t+=31-t%31,Uc(r,t),0!==r.strstart&&(Uc(r,e.adler>>>16),Uc(r,65535&e.adler)),e.adler=1,r.status=Ac,Lc(e),0!==r.pending)return r.last_flush=-1,uc}if(57===r.status)if(e.adler=0,Bc(r,31),Bc(r,139),Bc(r,8),r.gzhead)Bc(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),Bc(r,255&r.gzhead.time),Bc(r,r.gzhead.time>>8&255),Bc(r,r.gzhead.time>>16&255),Bc(r,r.gzhead.time>>24&255),Bc(r,9===r.level?2:r.strategy>=bc||r.level<2?4:0),Bc(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(Bc(r,255&r.gzhead.extra.length),Bc(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=Xa(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69;else if(Bc(r,0),Bc(r,0),Bc(r,0),Bc(r,0),Bc(r,0),Bc(r,9===r.level?2:r.strategy>=bc||r.level<2?4:0),Bc(r,3),r.status=Ac,Lc(e),0!==r.pending)return r.last_flush=-1,uc;if(69===r.status){if(r.gzhead.extra){let t=r.pending,n=(65535&r.gzhead.extra.length)-r.gzindex;for(;r.pending+n>r.pending_buf_size;){let s=r.pending_buf_size-r.pending;if(r.pending_buf.set(r.gzhead.extra.subarray(r.gzindex,r.gzindex+s),r.pending),r.pending=r.pending_buf_size,r.gzhead.hcrc&&r.pending>t&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex+=s,Lc(e),0!==r.pending)return r.last_flush=-1,uc;t=0,n-=s}let s=new Uint8Array(r.gzhead.extra);r.pending_buf.set(s.subarray(r.gzindex,r.gzindex+n),r.pending),r.pending+=n,r.gzhead.hcrc&&r.pending>t&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-t,t)),r.gzindex=0}r.status=73}if(73===r.status){if(r.gzhead.name){let t,n=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>n&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-n,n)),Lc(e),0!==r.pending)return r.last_flush=-1,uc;n=0}t=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,Bc(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>n&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-n,n)),r.gzindex=0}r.status=91}if(91===r.status){if(r.gzhead.comment){let t,n=r.pending;do{if(r.pending===r.pending_buf_size){if(r.gzhead.hcrc&&r.pending>n&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-n,n)),Lc(e),0!==r.pending)return r.last_flush=-1,uc;n=0}t=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,Bc(r,t)}while(0!==t);r.gzhead.hcrc&&r.pending>n&&(e.adler=Xa(e.adler,r.pending_buf,r.pending-n,n))}r.status=103}if(103===r.status){if(r.gzhead.hcrc){if(r.pending+2>r.pending_buf_size&&(Lc(e),0!==r.pending))return r.last_flush=-1,uc;Bc(r,255&e.adler),Bc(r,e.adler>>8&255),e.adler=0}if(r.status=Ac,Lc(e),0!==r.pending)return r.last_flush=-1,uc}if(0!==e.avail_in||0!==r.lookahead||t!==ac&&r.status!==Pc){let n=0===r.level?Vc(r,t):r.strategy===bc?((e,t)=>{let r;for(;;){if(0===e.lookahead&&(Fc(e),0===e.lookahead)){if(t===ac)return 1;break}if(e.match_length=0,r=ic(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(xc(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===hc?(xc(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(xc(e,!1),0===e.strm.avail_out)?1:2})(r,t):r.strategy===_c?((e,t)=>{let r,n,s,i;const o=e.window;for(;;){if(e.lookahead<=Rc){if(Fc(e),e.lookahead<=Rc&&t===ac)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(s=e.strstart-1,n=o[s],n===o[++s]&&n===o[++s]&&n===o[++s])){i=e.strstart+Rc;do{}while(n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&s<i);e.match_length=Rc-(i-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(r=ic(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=ic(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(xc(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===hc?(xc(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(xc(e,!1),0===e.strm.avail_out)?1:2})(r,t):qc[r.level].func(r,t);if(3!==n&&4!==n||(r.status=Pc),1===n||3===n)return 0===e.avail_out&&(r.last_flush=-1),uc;if(2===n&&(t===cc?oc(r):t!==dc&&(nc(r,0,0,!1),t===lc&&(Nc(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),Lc(e),0===e.avail_out))return r.last_flush=-1,uc}return t!==hc?uc:r.wrap<=0?pc:(2===r.wrap?(Bc(r,255&e.adler),Bc(r,e.adler>>8&255),Bc(r,e.adler>>16&255),Bc(r,e.adler>>24&255),Bc(r,255&e.total_in),Bc(r,e.total_in>>8&255),Bc(r,e.total_in>>16&255),Bc(r,e.total_in>>24&255)):(Uc(r,e.adler>>>16),Uc(r,65535&e.adler)),Lc(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?uc:pc)},tl=e=>{if(Wc(e))return fc;const t=e.state.status;return e.state=null,t===Ac?Dc(e,gc):uc},rl=(e,t)=>{let r=t.length;if(Wc(e))return fc;const n=e.state,s=n.wrap;if(2===s||1===s&&n.status!==Tc||n.lookahead)return fc;if(1===s&&(e.adler=Ja(e.adler,t,r,0)),n.wrap=0,r>=n.w_size){0===s&&(Nc(n.head),n.strstart=0,n.block_start=0,n.insert=0);let e=new Uint8Array(n.w_size);e.set(t.subarray(r-n.w_size,r),0),t=e,r=n.w_size}const i=e.avail_in,o=e.next_in,a=e.input;for(e.avail_in=r,e.next_in=0,e.input=t,Fc(n);n.lookahead>=3;){let e=n.strstart,t=n.lookahead-2;do{n.ins_h=Mc(n,n.ins_h,n.window[e+3-1]),n.prev[e&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=e,e++}while(--t);n.strstart=e,n.lookahead=2,Fc(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=o,e.input=a,e.avail_in=i,n.wrap=s,uc};const nl=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var sl=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(const t in r)nl(r,t)&&(e[t]=r[t])}}return e},il=e=>{let t=0;for(let r=0,n=e.length;r<n;r++)t+=e[r].length;const r=new Uint8Array(t);for(let t=0,n=0,s=e.length;t<s;t++){let s=e[t];r.set(s,n),n+=s.length}return r};let ol=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){ol=!1}const al=new Uint8Array(256);for(let e=0;e<256;e++)al[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;al[254]=al[254]=1;var cl=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,r,n,s,i,o=e.length,a=0;for(s=0;s<o;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<o&&(n=e.charCodeAt(s+1),56320==(64512&n)&&(r=65536+(r-55296<<10)+(n-56320),s++)),a+=r<128?1:r<2048?2:r<65536?3:4;for(t=new Uint8Array(a),i=0,s=0;i<a;s++)r=e.charCodeAt(s),55296==(64512&r)&&s+1<o&&(n=e.charCodeAt(s+1),56320==(64512&n)&&(r=65536+(r-55296<<10)+(n-56320),s++)),r<128?t[i++]=r:r<2048?(t[i++]=192|r>>>6,t[i++]=128|63&r):r<65536?(t[i++]=224|r>>>12,t[i++]=128|r>>>6&63,t[i++]=128|63&r):(t[i++]=240|r>>>18,t[i++]=128|r>>>12&63,t[i++]=128|r>>>6&63,t[i++]=128|63&r);return t},ll=(e,t)=>{const r=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let n,s;const i=new Array(2*r);for(s=0,n=0;n<r;){let t=e[n++];if(t<128){i[s++]=t;continue}let o=al[t];if(o>4)i[s++]=65533,n+=o-1;else{for(t&=2===o?31:3===o?15:7;o>1&&n<r;)t=t<<6|63&e[n++],o--;o>1?i[s++]=65533:t<65536?i[s++]=t:(t-=65536,i[s++]=55296|t>>10&1023,i[s++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&ol)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let r="";for(let n=0;n<t;n++)r+=String.fromCharCode(e[n]);return r})(i,s)},hl=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let r=t-1;for(;r>=0&&128==(192&e[r]);)r--;return r<0||0===r?t:r+al[e[r]]>t?r:t},dl=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const ul=Object.prototype.toString,{Z_NO_FLUSH:pl,Z_SYNC_FLUSH:fl,Z_FULL_FLUSH:gl,Z_FINISH:yl,Z_OK:ml,Z_STREAM_END:wl,Z_DEFAULT_COMPRESSION:bl,Z_DEFAULT_STRATEGY:_l,Z_DEFLATED:El}=tc;function vl(e){this.options=sl({level:bl,method:El,chunkSize:16384,windowBits:15,memLevel:8,strategy:_l},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new dl,this.strm.avail_out=0;let r=Qc(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==ml)throw new Error(ec[r]);if(t.header&&Xc(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?cl(t.dictionary):"[object ArrayBuffer]"===ul.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,r=rl(this.strm,e),r!==ml)throw new Error(ec[r]);this._dict_set=!0}}function kl(e,t){const r=new vl(t);if(r.push(e,!0),r.err)throw r.msg||ec[r.err];return r.result}vl.prototype.push=function(e,t){const r=this.strm,n=this.options.chunkSize;let s,i;if(this.ended)return!1;for(i=t===~~t?t:!0===t?yl:pl,"string"==typeof e?r.input=cl(e):"[object ArrayBuffer]"===ul.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;)if(0===r.avail_out&&(r.output=new Uint8Array(n),r.next_out=0,r.avail_out=n),(i===fl||i===gl)&&r.avail_out<=6)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else{if(s=el(r,i),s===wl)return r.next_out>0&&this.onData(r.output.subarray(0,r.next_out)),s=tl(this.strm),this.onEnd(s),this.ended=!0,s===ml;if(0!==r.avail_out){if(i>0&&r.next_out>0)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else if(0===r.avail_in)break}else this.onData(r.output)}return!0},vl.prototype.onData=function(e){this.chunks.push(e)},vl.prototype.onEnd=function(e){e===ml&&(this.result=il(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Sl={Deflate:vl,deflate:kl,deflateRaw:function(e,t){return(t=t||{}).raw=!0,kl(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,kl(e,t)},constants:tc};const Rl=16209;var Il=function(e,t){let r,n,s,i,o,a,c,l,h,d,u,p,f,g,y,m,w,b,_,E,v,k,S,R;const I=e.state;r=e.next_in,S=e.input,n=r+(e.avail_in-5),s=e.next_out,R=e.output,i=s-(t-e.avail_out),o=s+(e.avail_out-257),a=I.dmax,c=I.wsize,l=I.whave,h=I.wnext,d=I.window,u=I.hold,p=I.bits,f=I.lencode,g=I.distcode,y=(1<<I.lenbits)-1,m=(1<<I.distbits)-1;e:do{p<15&&(u+=S[r++]<<p,p+=8,u+=S[r++]<<p,p+=8),w=f[u&y];t:for(;;){if(b=w>>>24,u>>>=b,p-=b,b=w>>>16&255,0===b)R[s++]=65535&w;else{if(!(16&b)){if(0==(64&b)){w=f[(65535&w)+(u&(1<<b)-1)];continue t}if(32&b){I.mode=16191;break e}e.msg="invalid literal/length code",I.mode=Rl;break e}_=65535&w,b&=15,b&&(p<b&&(u+=S[r++]<<p,p+=8),_+=u&(1<<b)-1,u>>>=b,p-=b),p<15&&(u+=S[r++]<<p,p+=8,u+=S[r++]<<p,p+=8),w=g[u&m];r:for(;;){if(b=w>>>24,u>>>=b,p-=b,b=w>>>16&255,!(16&b)){if(0==(64&b)){w=g[(65535&w)+(u&(1<<b)-1)];continue r}e.msg="invalid distance code",I.mode=Rl;break e}if(E=65535&w,b&=15,p<b&&(u+=S[r++]<<p,p+=8,p<b&&(u+=S[r++]<<p,p+=8)),E+=u&(1<<b)-1,E>a){e.msg="invalid distance too far back",I.mode=Rl;break e}if(u>>>=b,p-=b,b=s-i,E>b){if(b=E-b,b>l&&I.sane){e.msg="invalid distance too far back",I.mode=Rl;break e}if(v=0,k=d,0===h){if(v+=c-b,b<_){_-=b;do{R[s++]=d[v++]}while(--b);v=s-E,k=R}}else if(h<b){if(v+=c+h-b,b-=h,b<_){_-=b;do{R[s++]=d[v++]}while(--b);if(v=0,h<_){b=h,_-=b;do{R[s++]=d[v++]}while(--b);v=s-E,k=R}}}else if(v+=h-b,b<_){_-=b;do{R[s++]=d[v++]}while(--b);v=s-E,k=R}for(;_>2;)R[s++]=k[v++],R[s++]=k[v++],R[s++]=k[v++],_-=3;_&&(R[s++]=k[v++],_>1&&(R[s++]=k[v++]))}else{v=s-E;do{R[s++]=R[v++],R[s++]=R[v++],R[s++]=R[v++],_-=3}while(_>2);_&&(R[s++]=R[v++],_>1&&(R[s++]=R[v++]))}break}}break}}while(r<n&&s<o);_=p>>3,r-=_,p-=_<<3,u&=(1<<p)-1,e.next_in=r,e.next_out=s,e.avail_in=r<n?n-r+5:5-(r-n),e.avail_out=s<o?o-s+257:257-(s-o),I.hold=u,I.bits=p};const Tl=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Al=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Pl=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Dl=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Ol=(e,t,r,n,s,i,o,a)=>{const c=a.bits;let l,h,d,u,p,f,g=0,y=0,m=0,w=0,b=0,_=0,E=0,v=0,k=0,S=0,R=null;const I=new Uint16Array(16),T=new Uint16Array(16);let A,P,D,O=null;for(g=0;g<=15;g++)I[g]=0;for(y=0;y<n;y++)I[t[r+y]]++;for(b=c,w=15;w>=1&&0===I[w];w--);if(b>w&&(b=w),0===w)return s[i++]=20971520,s[i++]=20971520,a.bits=1,0;for(m=1;m<w&&0===I[m];m++);for(b<m&&(b=m),v=1,g=1;g<=15;g++)if(v<<=1,v-=I[g],v<0)return-1;if(v>0&&(0===e||1!==w))return-1;for(T[1]=0,g=1;g<15;g++)T[g+1]=T[g]+I[g];for(y=0;y<n;y++)0!==t[r+y]&&(o[T[t[r+y]]++]=y);if(0===e?(R=O=o,f=20):1===e?(R=Tl,O=Al,f=257):(R=Pl,O=Dl,f=0),S=0,y=0,g=m,p=i,_=b,E=0,d=-1,k=1<<b,u=k-1,1===e&&k>852||2===e&&k>592)return 1;for(;;){A=g-E,o[y]+1<f?(P=0,D=o[y]):o[y]>=f?(P=O[o[y]-f],D=R[o[y]-f]):(P=96,D=0),l=1<<g-E,h=1<<_,m=h;do{h-=l,s[p+(S>>E)+h]=A<<24|P<<16|D|0}while(0!==h);for(l=1<<g-1;S&l;)l>>=1;if(0!==l?(S&=l-1,S+=l):S=0,y++,0==--I[g]){if(g===w)break;g=t[r+o[y]]}if(g>b&&(S&u)!==d){for(0===E&&(E=b),p+=m,_=g-E,v=1<<_;_+E<w&&(v-=I[_+E],!(v<=0));)_++,v<<=1;if(k+=1<<_,1===e&&k>852||2===e&&k>592)return 1;d=S&u,s[d]=b<<24|_<<16|p-i|0}}return 0!==S&&(s[p+S]=g-E<<24|64<<16|0),a.bits=b,0};const{Z_FINISH:Nl,Z_BLOCK:Cl,Z_TREES:Ml,Z_OK:Ll,Z_STREAM_END:xl,Z_NEED_DICT:Bl,Z_STREAM_ERROR:Ul,Z_DATA_ERROR:zl,Z_MEM_ERROR:jl,Z_BUF_ERROR:Fl,Z_DEFLATED:Vl}=tc,$l=16180,Hl=16190,Gl=16191,ql=16192,Kl=16194,Wl=16199,Zl=16200,Yl=16206,Jl=16209,Ql=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Xl(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const eh=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<$l||t.mode>16211?1:0},th=e=>{if(eh(e))return Ul;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=$l,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Ll},rh=e=>{if(eh(e))return Ul;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,th(e)},nh=(e,t)=>{let r;if(eh(e))return Ul;const n=e.state;return t<0?(r=0,t=-t):(r=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Ul:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,rh(e))},sh=(e,t)=>{if(!e)return Ul;const r=new Xl;e.state=r,r.strm=e,r.window=null,r.mode=$l;const n=nh(e,t);return n!==Ll&&(e.state=null),n};let ih,oh,ah=!0;const ch=e=>{if(ah){ih=new Int32Array(512),oh=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Ol(1,e.lens,0,288,ih,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Ol(2,e.lens,0,32,oh,0,e.work,{bits:5}),ah=!1}e.lencode=ih,e.lenbits=9,e.distcode=oh,e.distbits=5},lh=(e,t,r,n)=>{let s;const i=e.state;return null===i.window&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),n>=i.wsize?(i.window.set(t.subarray(r-i.wsize,r),0),i.wnext=0,i.whave=i.wsize):(s=i.wsize-i.wnext,s>n&&(s=n),i.window.set(t.subarray(r-n,r-n+s),i.wnext),(n-=s)?(i.window.set(t.subarray(r-n,r),0),i.wnext=n,i.whave=i.wsize):(i.wnext+=s,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=s))),0};var hh=rh,dh=sh,uh=(e,t)=>{let r,n,s,i,o,a,c,l,h,d,u,p,f,g,y,m,w,b,_,E,v,k,S=0;const R=new Uint8Array(4);let I,T;const A=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(eh(e)||!e.output||!e.input&&0!==e.avail_in)return Ul;r=e.state,r.mode===Gl&&(r.mode=ql),o=e.next_out,s=e.output,c=e.avail_out,i=e.next_in,n=e.input,a=e.avail_in,l=r.hold,h=r.bits,d=a,u=c,k=Ll;e:for(;;)switch(r.mode){case $l:if(0===r.wrap){r.mode=ql;break}for(;h<16;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(2&r.wrap&&35615===l){0===r.wbits&&(r.wbits=15),r.check=0,R[0]=255&l,R[1]=l>>>8&255,r.check=Xa(r.check,R,2,0),l=0,h=0,r.mode=16181;break}if(r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",r.mode=Jl;break}if((15&l)!==Vl){e.msg="unknown compression method",r.mode=Jl;break}if(l>>>=4,h-=4,v=8+(15&l),0===r.wbits&&(r.wbits=v),v>15||v>r.wbits){e.msg="invalid window size",r.mode=Jl;break}r.dmax=1<<r.wbits,r.flags=0,e.adler=r.check=1,r.mode=512&l?16189:Gl,l=0,h=0;break;case 16181:for(;h<16;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(r.flags=l,(255&r.flags)!==Vl){e.msg="unknown compression method",r.mode=Jl;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=Jl;break}r.head&&(r.head.text=l>>8&1),512&r.flags&&4&r.wrap&&(R[0]=255&l,R[1]=l>>>8&255,r.check=Xa(r.check,R,2,0)),l=0,h=0,r.mode=16182;case 16182:for(;h<32;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.head&&(r.head.time=l),512&r.flags&&4&r.wrap&&(R[0]=255&l,R[1]=l>>>8&255,R[2]=l>>>16&255,R[3]=l>>>24&255,r.check=Xa(r.check,R,4,0)),l=0,h=0,r.mode=16183;case 16183:for(;h<16;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.head&&(r.head.xflags=255&l,r.head.os=l>>8),512&r.flags&&4&r.wrap&&(R[0]=255&l,R[1]=l>>>8&255,r.check=Xa(r.check,R,2,0)),l=0,h=0,r.mode=16184;case 16184:if(1024&r.flags){for(;h<16;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.length=l,r.head&&(r.head.extra_len=l),512&r.flags&&4&r.wrap&&(R[0]=255&l,R[1]=l>>>8&255,r.check=Xa(r.check,R,2,0)),l=0,h=0}else r.head&&(r.head.extra=null);r.mode=16185;case 16185:if(1024&r.flags&&(p=r.length,p>a&&(p=a),p&&(r.head&&(v=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(n.subarray(i,i+p),v)),512&r.flags&&4&r.wrap&&(r.check=Xa(r.check,n,p,i)),a-=p,i+=p,r.length-=p),r.length))break e;r.length=0,r.mode=16186;case 16186:if(2048&r.flags){if(0===a)break e;p=0;do{v=n[i+p++],r.head&&v&&r.length<65536&&(r.head.name+=String.fromCharCode(v))}while(v&&p<a);if(512&r.flags&&4&r.wrap&&(r.check=Xa(r.check,n,p,i)),a-=p,i+=p,v)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=16187;case 16187:if(4096&r.flags){if(0===a)break e;p=0;do{v=n[i+p++],r.head&&v&&r.length<65536&&(r.head.comment+=String.fromCharCode(v))}while(v&&p<a);if(512&r.flags&&4&r.wrap&&(r.check=Xa(r.check,n,p,i)),a-=p,i+=p,v)break e}else r.head&&(r.head.comment=null);r.mode=16188;case 16188:if(512&r.flags){for(;h<16;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(4&r.wrap&&l!==(65535&r.check)){e.msg="header crc mismatch",r.mode=Jl;break}l=0,h=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=Gl;break;case 16189:for(;h<32;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}e.adler=r.check=Ql(l),l=0,h=0,r.mode=Hl;case Hl:if(0===r.havedict)return e.next_out=o,e.avail_out=c,e.next_in=i,e.avail_in=a,r.hold=l,r.bits=h,Bl;e.adler=r.check=1,r.mode=Gl;case Gl:if(t===Cl||t===Ml)break e;case ql:if(r.last){l>>>=7&h,h-=7&h,r.mode=Yl;break}for(;h<3;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}switch(r.last=1&l,l>>>=1,h-=1,3&l){case 0:r.mode=16193;break;case 1:if(ch(r),r.mode=Wl,t===Ml){l>>>=2,h-=2;break e}break;case 2:r.mode=16196;break;case 3:e.msg="invalid block type",r.mode=Jl}l>>>=2,h-=2;break;case 16193:for(l>>>=7&h,h-=7&h;h<32;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",r.mode=Jl;break}if(r.length=65535&l,l=0,h=0,r.mode=Kl,t===Ml)break e;case Kl:r.mode=16195;case 16195:if(p=r.length,p){if(p>a&&(p=a),p>c&&(p=c),0===p)break e;s.set(n.subarray(i,i+p),o),a-=p,i+=p,c-=p,o+=p,r.length-=p;break}r.mode=Gl;break;case 16196:for(;h<14;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(r.nlen=257+(31&l),l>>>=5,h-=5,r.ndist=1+(31&l),l>>>=5,h-=5,r.ncode=4+(15&l),l>>>=4,h-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=Jl;break}r.have=0,r.mode=16197;case 16197:for(;r.have<r.ncode;){for(;h<3;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.lens[A[r.have++]]=7&l,l>>>=3,h-=3}for(;r.have<19;)r.lens[A[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,I={bits:r.lenbits},k=Ol(0,r.lens,0,19,r.lencode,0,r.work,I),r.lenbits=I.bits,k){e.msg="invalid code lengths set",r.mode=Jl;break}r.have=0,r.mode=16198;case 16198:for(;r.have<r.nlen+r.ndist;){for(;S=r.lencode[l&(1<<r.lenbits)-1],y=S>>>24,m=S>>>16&255,w=65535&S,!(y<=h);){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(w<16)l>>>=y,h-=y,r.lens[r.have++]=w;else{if(16===w){for(T=y+2;h<T;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(l>>>=y,h-=y,0===r.have){e.msg="invalid bit length repeat",r.mode=Jl;break}v=r.lens[r.have-1],p=3+(3&l),l>>>=2,h-=2}else if(17===w){for(T=y+3;h<T;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}l>>>=y,h-=y,v=0,p=3+(7&l),l>>>=3,h-=3}else{for(T=y+7;h<T;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}l>>>=y,h-=y,v=0,p=11+(127&l),l>>>=7,h-=7}if(r.have+p>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=Jl;break}for(;p--;)r.lens[r.have++]=v}}if(r.mode===Jl)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=Jl;break}if(r.lenbits=9,I={bits:r.lenbits},k=Ol(1,r.lens,0,r.nlen,r.lencode,0,r.work,I),r.lenbits=I.bits,k){e.msg="invalid literal/lengths set",r.mode=Jl;break}if(r.distbits=6,r.distcode=r.distdyn,I={bits:r.distbits},k=Ol(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,I),r.distbits=I.bits,k){e.msg="invalid distances set",r.mode=Jl;break}if(r.mode=Wl,t===Ml)break e;case Wl:r.mode=Zl;case Zl:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=i,e.avail_in=a,r.hold=l,r.bits=h,Il(e,u),o=e.next_out,s=e.output,c=e.avail_out,i=e.next_in,n=e.input,a=e.avail_in,l=r.hold,h=r.bits,r.mode===Gl&&(r.back=-1);break}for(r.back=0;S=r.lencode[l&(1<<r.lenbits)-1],y=S>>>24,m=S>>>16&255,w=65535&S,!(y<=h);){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(m&&0==(240&m)){for(b=y,_=m,E=w;S=r.lencode[E+((l&(1<<b+_)-1)>>b)],y=S>>>24,m=S>>>16&255,w=65535&S,!(b+y<=h);){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}l>>>=b,h-=b,r.back+=b}if(l>>>=y,h-=y,r.back+=y,r.length=w,0===m){r.mode=16205;break}if(32&m){r.back=-1,r.mode=Gl;break}if(64&m){e.msg="invalid literal/length code",r.mode=Jl;break}r.extra=15&m,r.mode=16201;case 16201:if(r.extra){for(T=r.extra;h<T;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.length+=l&(1<<r.extra)-1,l>>>=r.extra,h-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=16202;case 16202:for(;S=r.distcode[l&(1<<r.distbits)-1],y=S>>>24,m=S>>>16&255,w=65535&S,!(y<=h);){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(0==(240&m)){for(b=y,_=m,E=w;S=r.distcode[E+((l&(1<<b+_)-1)>>b)],y=S>>>24,m=S>>>16&255,w=65535&S,!(b+y<=h);){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}l>>>=b,h-=b,r.back+=b}if(l>>>=y,h-=y,r.back+=y,64&m){e.msg="invalid distance code",r.mode=Jl;break}r.offset=w,r.extra=15&m,r.mode=16203;case 16203:if(r.extra){for(T=r.extra;h<T;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}r.offset+=l&(1<<r.extra)-1,l>>>=r.extra,h-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=Jl;break}r.mode=16204;case 16204:if(0===c)break e;if(p=u-c,r.offset>p){if(p=r.offset-p,p>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=Jl;break}p>r.wnext?(p-=r.wnext,f=r.wsize-p):f=r.wnext-p,p>r.length&&(p=r.length),g=r.window}else g=s,f=o-r.offset,p=r.length;p>c&&(p=c),c-=p,r.length-=p;do{s[o++]=g[f++]}while(--p);0===r.length&&(r.mode=Zl);break;case 16205:if(0===c)break e;s[o++]=r.length,c--,r.mode=Zl;break;case Yl:if(r.wrap){for(;h<32;){if(0===a)break e;a--,l|=n[i++]<<h,h+=8}if(u-=c,e.total_out+=u,r.total+=u,4&r.wrap&&u&&(e.adler=r.check=r.flags?Xa(r.check,s,u,o-u):Ja(r.check,s,u,o-u)),u=c,4&r.wrap&&(r.flags?l:Ql(l))!==r.check){e.msg="incorrect data check",r.mode=Jl;break}l=0,h=0}r.mode=16207;case 16207:if(r.wrap&&r.flags){for(;h<32;){if(0===a)break e;a--,l+=n[i++]<<h,h+=8}if(4&r.wrap&&l!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=Jl;break}l=0,h=0}r.mode=16208;case 16208:k=xl;break e;case Jl:k=zl;break e;case 16210:return jl;default:return Ul}return e.next_out=o,e.avail_out=c,e.next_in=i,e.avail_in=a,r.hold=l,r.bits=h,(r.wsize||u!==e.avail_out&&r.mode<Jl&&(r.mode<Yl||t!==Nl))&&lh(e,e.output,e.next_out,u-e.avail_out),d-=e.avail_in,u-=e.avail_out,e.total_in+=d,e.total_out+=u,r.total+=u,4&r.wrap&&u&&(e.adler=r.check=r.flags?Xa(r.check,s,u,e.next_out-u):Ja(r.check,s,u,e.next_out-u)),e.data_type=r.bits+(r.last?64:0)+(r.mode===Gl?128:0)+(r.mode===Wl||r.mode===Kl?256:0),(0===d&&0===u||t===Nl)&&k===Ll&&(k=Fl),k},ph=e=>{if(eh(e))return Ul;let t=e.state;return t.window&&(t.window=null),e.state=null,Ll},fh=(e,t)=>{if(eh(e))return Ul;const r=e.state;return 0==(2&r.wrap)?Ul:(r.head=t,t.done=!1,Ll)},gh=(e,t)=>{const r=t.length;let n,s,i;return eh(e)?Ul:(n=e.state,0!==n.wrap&&n.mode!==Hl?Ul:n.mode===Hl&&(s=1,s=Ja(s,t,r,0),s!==n.check)?zl:(i=lh(e,t,r,r),i?(n.mode=16210,jl):(n.havedict=1,Ll)))},yh=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const mh=Object.prototype.toString,{Z_NO_FLUSH:wh,Z_FINISH:bh,Z_OK:_h,Z_STREAM_END:Eh,Z_NEED_DICT:vh,Z_STREAM_ERROR:kh,Z_DATA_ERROR:Sh,Z_MEM_ERROR:Rh}=tc;function Ih(e){this.options=sl({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new dl,this.strm.avail_out=0;let r=dh(this.strm,t.windowBits);if(r!==_h)throw new Error(ec[r]);if(this.header=new yh,fh(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=cl(t.dictionary):"[object ArrayBuffer]"===mh.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(r=gh(this.strm,t.dictionary),r!==_h)))throw new Error(ec[r])}function Th(e,t){const r=new Ih(t);if(r.push(e),r.err)throw r.msg||ec[r.err];return r.result}Ih.prototype.push=function(e,t){const r=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let i,o,a;if(this.ended)return!1;for(o=t===~~t?t:!0===t?bh:wh,"[object ArrayBuffer]"===mh.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;;){for(0===r.avail_out&&(r.output=new Uint8Array(n),r.next_out=0,r.avail_out=n),i=uh(r,o),i===vh&&s&&(i=gh(r,s),i===_h?i=uh(r,o):i===Sh&&(i=vh));r.avail_in>0&&i===Eh&&r.state.wrap>0&&0!==e[r.next_in];)hh(r),i=uh(r,o);switch(i){case kh:case Sh:case vh:case Rh:return this.onEnd(i),this.ended=!0,!1}if(a=r.avail_out,r.next_out&&(0===r.avail_out||i===Eh))if("string"===this.options.to){let e=hl(r.output,r.next_out),t=r.next_out-e,s=ll(r.output,e);r.next_out=t,r.avail_out=n-t,t&&r.output.set(r.output.subarray(e,e+t),0),this.onData(s)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(i!==_h||0!==a){if(i===Eh)return i=ph(this.strm),this.onEnd(i),this.ended=!0,!0;if(0===r.avail_in)break}}return!0},Ih.prototype.onData=function(e){this.chunks.push(e)},Ih.prototype.onEnd=function(e){e===_h&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=il(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Ah={Inflate:Ih,inflate:Th,inflateRaw:function(e,t){return(t=t||{}).raw=!0,Th(e,t)},ungzip:Th,constants:tc};const{Deflate:Ph,deflate:Dh,deflateRaw:Oh,gzip:Nh}=Sl,{Inflate:Ch,inflate:Mh,inflateRaw:Lh,ungzip:xh}=Ah;var Bh={Deflate:Ph,deflate:Dh,deflateRaw:Oh,gzip:Nh,Inflate:Ch,inflate:Mh,inflateRaw:Lh,ungzip:xh,constants:tc};class Uh{constructor({preload:e,repo:t,hashers:r,options:n}){const s=function({repo:e,preload:t,hashers:r,options:n}){const s=n&&n.sharding;return mn((async function*(n,i={}){const o=Mo({shardSplitThreshold:s?1e3:1/0,strategy:"balanced"},i,{...Oo(i.chunker)});o.hashAlg&&"sha2-256"!==o.hashAlg&&1!==o.cidVersion&&(o.cidVersion=1),o.trickle&&(o.strategy="trickle"),"trickle"===o.strategy&&(o.leafType="raw",o.reduceSingleLeafToSelf=!1),o.cidVersion>0&&void 0===o.rawLeaves&&(o.rawLeaves=!0),void 0!==o.hashAlg&&void 0===o.rawLeaves&&(o.rawLeaves=!0),delete o.trickle;const a={};if(o.progress){const e=o.progress;o.progress=(t,r)=>{a[r]||(a[r]=0),a[r]+=t,e(a[r],r)}}let c;null!=o.hashAlg&&(c=await r.getHasher(o.hashAlg));const l=(0,vi.zG)(Po(n,Ci),(t=>Ao(t,e.blocks,{...o,hasher:c,pin:!1})),function(e){return async function*(t){for await(const r of t){let t=r.cid;1===e.cidVersion&&(t=t.toV1());let n=r.path?r.path:t.toString();e.wrapWithDirectory&&!r.path&&(n=""),yield{path:n,cid:t,size:r.size,mode:r.unixfs&&r.unixfs.mode,mtime:r.unixfs&&r.unixfs.mtime}}}}(o),function(e,t){return async function*(r){for await(const n of r)(!n.path||t.wrapWithDirectory?""===n.path:!n.path.includes("/"))&&!t.onlyHash&&!1!==t.preload&&e(n.cid),yield n}}(t,o),function(e,t){return async function*(r){for await(const n of r){const r=!(n.path&&n.path.includes("/"));(null==t.pin||t.pin)&&r&&!t.onlyHash&&await e.pins.pinRecursively(n.cid),yield n}}}(e,o)),h=await e.gcLock.readLock();try{for await(const e of l){const t=e.path??e.cid.toString();delete a[t],yield{...e,path:t}}}finally{h()}}))}({preload:e,repo:t,options:n,hashers:r});this.addAll=s,this.add=function({addAll:e}){return async function(t,r={}){const n=await xn(e(xi(t),r));if(null==n)throw Error("Failed to add a file, if you see this please report a bug");return n}}({addAll:s}),this.cat=function({repo:e,preload:t}){return mn((async function*(r,n={}){if(r=kn(r),!1!==n.preload){const e=r.split("/");t(te.k.parse(e[0]))}const s=await Wo(r,e.blocks,n);if("directory"===s.type)throw new Error("this dag node is a directory");if(!s.content)throw new Error("this dag node has no content");yield*s.content(n)}))}({repo:t,preload:e}),this.get=function({repo:e,preload:t}){return mn((async function*(r,n={}){if(null!=n.compressionLevel&&(n.compressionLevel<-1||n.compressionLevel>9))throw j(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(!1!==n.preload){let e;try{e=kn(r).split("/")}catch(e){throw j(e,"ERR_INVALID_PATH")}t(te.k.parse(e[0]))}const s=te.k.asCID(r)||r,i=await Wo(s,e.blocks,n);if("file"===i.type||"raw"===i.type){const e=[];return n.compress&&!0!==n.archive?e.push(i.content):e.push([{header:{name:i.path,mode:"file"===i.type&&i.unixfs.mode,mtime:"file"===i.type&&i.unixfs.mtime?new Date(1e3*i.unixfs.mtime.secs):void 0,size:i.size,type:"file"},body:i.content()}],ma()),n.compress&&e.push((async function*(e){const t=await Jo(e);yield Bh.gzip(t,{level:n.compressionLevel||6})})),void(yield*(0,vi.zG)(...e))}if("directory"!==i.type)throw j(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");{const t=[Zo(s,e.blocks,n),async function*(e){for await(const t of e){const e={header:{name:t.path,size:t.size}};if("file"===t.type)e.header.type="file",e.header.mode=null!=t.unixfs.mode?t.unixfs.mode:void 0,e.header.mtime=t.unixfs.mtime?new Date(1e3*t.unixfs.mtime.secs):void 0,e.body=t.content();else if("raw"===t.type)e.header.type="file",e.body=t.content();else{if("directory"!==t.type)throw j(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");e.header.type="directory",e.header.mode=null!=t.unixfs.mode?t.unixfs.mode:void 0,e.header.mtime=t.unixfs.mtime?new Date(1e3*t.unixfs.mtime.secs):void 0}yield e}},ma()];if(n.compress){if(!n.archive)throw j(new Error("file is not regular"),"ERR_INVALID_PATH");n.compress&&t.push((async function*(e){const t=await Jo(e);yield Bh.gzip(t,{level:n.compressionLevel||6})}))}yield*(0,vi.zG)(...t)}}))}({repo:t,preload:e}),this.ls=function({repo:e,preload:t}){return mn((async function*(r,n={}){const s=kn(r),i=s.split("/");!1!==n.preload&&t(te.k.parse(i[0]));const o=te.k.asCID(s)||s,a=await Wo(o,e.blocks,n);if("file"!==a.type){if("directory"!==a.type)throw j(new Error(`Unknown UnixFS type ${a.type}`),"ERR_UNKNOWN_UNIXFS_TYPE");for await(const e of a.content())yield Rn(e)}else yield Rn(a)}))}({repo:t,preload:e})}}const zh="0.17.0",jh=(0,z.kg)("ipfs:components:id");var Fh=function(e,t,r){var n,s,i;if(Array.isArray(t)&&(n=t.slice(0)),"string"==typeof t&&(n=t.split(".")),"symbol"==typeof t&&(n=[t]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");if(!(s=n.pop()))return!1;for(Vh(s);i=n.shift();)if(Vh(i),void 0===e[i]&&(e[i]={}),!(e=e[i])||"object"!=typeof e)return!1;return e[s]=r,!0};function Vh(e){if("__proto__"==e||"constructor"==e||"prototype"==e)throw new Error("setting of prototype values not supported")}const $h={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:e=>(Fh(e,"Discovery.MDNS.Enabled",!1),Fh(e,"Discovery.webRTCStar.Enabled",!1),e.Swarm={...e.Swarm||{},DisableNatPortMap:!0},e)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:e=>(Fh(e,"Discovery.MDNS.Enabled",!0),Fh(e,"Discovery.webRTCStar.Enabled",!0),Fh(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!1}),e)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:e=>{const t={Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]};return Fh(e,"Addresses.API",t.API?"/ip4/127.0.0.1/tcp/0":""),Fh(e,"Addresses.Gateway",t.Gateway?"/ip4/127.0.0.1/tcp/0":""),Fh(e,"Addresses.Swarm",t.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),Fh(e,"Addresses.Delegates",[]),Fh(e,"Bootstrap",[]),Fh(e,"Discovery.MDNS.Enabled",!1),Fh(e,"Discovery.webRTCStar.Enabled",!1),Fh(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!0}),e}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:e=>{const t={Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},r={MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},n=["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"];return Fh(e,"Addresses.API",t.API),Fh(e,"Addresses.Gateway",t.Gateway),Fh(e,"Addresses.Swarm",t.Swarm),Fh(e,"Addresses.Delegates",t.Delegates),Fh(e,"Bootstrap",n),Fh(e,"Discovery.MDNS.Enabled",r.MDNS.Enabled),Fh(e,"Discovery.webRTCStar.Enabled",r.webRTCStar.Enabled),Fh(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!1}),e}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:e=>{const t=e.Swarm||{},r=t.ConnMgr||{};return r.LowWater=20,r.HighWater=40,t.ConnMgr=r,e.Swarm=t,e}},"default-power":{description:'Inverse of "lowpower" profile.',transform:e=>(e.Swarm={ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},e)}},Hh=(0,z.kg)("ipfs:core:config");async function Gh(e){return Object.keys($h).map((e=>({name:e,description:$h[e].description})))}function qh({enumerable:e=!0,configurable:t=!1}={}){return{enumerable:e,configurable:t,writable:!1}}function*Kh(e,t){if(null!=t&&"object"==typeof t)if(Array.isArray(t))for(const[r,n]of t.entries()){const t=[...e,r],s=ir.k0.asCID(n);s?yield[t.join("/"),s]:"object"==typeof n&&(yield*Wh(n,t))}else{const r=ir.k0.asCID(t);r?yield[e.join("/"),r]:yield*Wh(t,e)}}function*Wh(e,t){if(!(null==e||e instanceof Uint8Array))for(const[r,n]of Object.entries(e)){const e=[...t,r];yield*Kh(e,n)}}function*Zh(e,t){if(Array.isArray(t))for(const[r,n]of t.entries()){const t=[...e,r];yield t.join("/"),"object"!=typeof n||ir.k0.asCID(n)||(yield*Yh(n,t))}else yield*Yh(t,e)}function*Yh(e,t){if(null!=e&&"object"==typeof e)for(const[r,n]of Object.entries(e)){const e=[...t,r];yield e.join("/"),null==n||n instanceof Uint8Array||"object"!=typeof n||ir.k0.asCID(n)||(yield*Zh(e,n))}}class Jh{constructor({cid:e,bytes:t,value:r}){if(!e||!t||void 0===r)throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=r,this.asBlock=this,Object.defineProperties(this,{cid:qh(),bytes:qh(),value:qh(),asBlock:qh()})}links(){return Wh(this.value,[])}tree(){return Yh(this.value,[])}get(e="/"){return function(e,t){let r=e;for(const[e,n]of t.entries()){if(r=r[n],null==r)throw new Error(`Object has no property at ${t.slice(0,e+1).map((e=>`[${JSON.stringify(e)}]`)).join("")}`);const s=ir.k0.asCID(r);if(s)return{value:s,remaining:t.slice(e+1).join("/")}}return{value:r}}(this.value,e.split("/").filter(Boolean))}}function Qh({bytes:e,cid:t,value:r,codec:n}){const s=void 0!==r?r:n&&n.decode(e);if(void 0===s)throw new Error('Missing required argument, must either provide "value" or "codec"');return new Jh({cid:t,bytes:e,value:s})}var Xh=r(44324);function ed(e){const t=nr({version:1,roots:e}),r=Xh.encode(t.length),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n}function td(){}const rd={Null:e=>null===e,Int:e=>Number.isInteger(e),Float:e=>"number"==typeof e&&Number.isFinite(e),String:e=>"string"==typeof e,Bool:e=>"boolean"==typeof e,Bytes:e=>e instanceof Uint8Array,Link:e=>!rd.Null(e)&&"object"==typeof e&&e.asCID===e,List:e=>Array.isArray(e),Map:e=>!rd.Null(e)&&"object"==typeof e&&e.asCID!==e&&!rd.List(e)&&!rd.Bytes(e)},nd={Int:rd.Int,"CarHeader > version":e=>nd.Int(e),"CarHeader > roots (anon) > valueType (anon)":rd.Link,"CarHeader > roots (anon)":e=>rd.List(e)&&Array.prototype.every.call(e,nd["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":e=>nd["CarHeader > roots (anon)"](e),CarHeader:e=>{const t=e&&Object.keys(e);return rd.Map(e)&&["version"].every((e=>t.includes(e)))&&Object.entries(e).every((([e,t])=>nd["CarHeader > "+e]&&nd["CarHeader > "+e](t)))}},sd=nd.CarHeader;async function id(e){const t=await e.upTo(8);if(!t.length)throw new Error("Unexpected end of data");const r=Xh.decode(t);return e.seek(Xh.decode.bytes),r}async function od(e,t){const r=await id(e);if(0===r)throw new Error("Invalid CAR header (zero length)");const n=await e.exactly(r);e.seek(r);const s=sr(n);if(!sd(s))throw new Error("Invalid CAR header format");if(1!==s.version&&2!==s.version||void 0!==t&&s.version!==t)throw new Error(`Invalid CAR version: ${s.version}${void 0!==t?` (expected ${t})`:""}`);const i=Array.isArray(s.roots);if(1===s.version&&!i||2===s.version&&i)throw new Error("Invalid CAR header format");if(1===s.version)return s;const o=await async function(e){const t=await e.exactly(40),r=new DataView(t.buffer,t.byteOffset,t.byteLength);let n=0;const s={version:2,characteristics:[r.getBigUint64(n,!0),r.getBigUint64(n+=8,!0)],dataOffset:Number(r.getBigUint64(n+=8,!0)),dataSize:Number(r.getBigUint64(n+=8,!0)),indexOffset:Number(r.getBigUint64(n+=8,!0))};return e.seek(40),s}(e);e.seek(o.dataOffset-e.pos);const a=await od(e,1);return Object.assign(a,o)}async function ad(e){const t=await e.exactly(2);if(18===t[0]&&32===t[1]){const t=await e.exactly(34);e.seek(34);const r=Wr.Jx(t);return te.k.create(0,112,r)}const r=await id(e);if(1!==r)throw new Error(`Unexpected CID version (${r})`);const n=await id(e),s=await async function(e){const t=await e.upTo(8);Xh.decode(t);const r=Xh.decode.bytes,n=Xh.decode(t.subarray(Xh.decode.bytes)),s=r+Xh.decode.bytes+n,i=await e.exactly(s);return e.seek(s),i}(e),i=Wr.Jx(s);return te.k.create(r,n,i)}async function cd(e){const t=e.pos;let r=await id(e);if(0===r)throw new Error("Invalid CAR section (zero length)");return r+=e.pos-t,{cid:await ad(e),length:r,blockLength:r-Number(e.pos-t)}}async function ld(e){const{cid:t,blockLength:r}=await cd(e),n=await e.exactly(r);return e.seek(r),{bytes:n,cid:t}}async function hd(e){const t=e.pos,{cid:r,length:n,blockLength:s}=await cd(e),i={cid:r,length:n,blockLength:s,offset:t,blockOffset:e.pos};return e.seek(i.blockLength),i}function dd(e){let t=0;return{upTo:async r=>e.subarray(t,t+Math.min(r,e.length-t)),async exactly(r){if(r>e.length-t)throw new Error("Unexpected end of data");return e.subarray(t,t+r)},seek(e){t+=e},get pos(){return t}}}class ud{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array&&e.cid))throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=te.k.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then((()=>this._encoder.writeBlock({cid:t,bytes:e.bytes}))),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(e){e=function(e){if(void 0===e)return[];if(!Array.isArray(e)){const t=te.k.asCID(e);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const t=[];for(const r of e){const e=te.k.asCID(r);if(!e)throw new TypeError("roots must be a single CID or an array of CIDs");t.push(e)}return t}(e);const{encoder:t,iterator:r}=fd();return{writer:new ud(e,t),out:new pd(r)}}static createAppender(){const{encoder:e,iterator:t}=fd();return e.setRoots=()=>Promise.resolve(),{writer:new ud([],e),out:new pd(t)}}static async updateRootsInBytes(e,t){const r=dd(e);await od(r);const n=ed(t);if(Number(r.pos)!==n.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${r.pos} bytes, new header is ${n.length} bytes)`);return e.set(n,0),e}}class pd{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function fd(){const e=function(){const e=[];let t=null,r=td,n=!1,s=null,i=td;const o=()=>(t||(t=new Promise((e=>{r=()=>{t=null,r=td,e()}}))),t),a={write(t){e.push(t);const r=o();return i(),r},async end(){n=!0;const e=o();i(),await e}},c={async next(){const t=e.shift();return t?(0===e.length&&r(),{done:!1,value:t}):n?(r(),{done:!0,value:void 0}):(s||(s=new Promise((e=>{i=()=>(s=null,i=td,e(c.next()))}))),s)}};return{writer:a,iterator:c}}(),{writer:t,iterator:r}=e,n=function(e){return{async setRoots(t){const r=ed(t);await e.write(r)},async writeBlock(t){const{cid:r,bytes:n}=t;await e.write(new Uint8Array(Xh.encode(r.bytes.length+n.length))),await e.write(r.bytes),n.length&&await e.write(n)},async close(){await e.end()}}}(t);return{encoder:n,iterator:r}}var gd=r(94319);const yd=async({cid:e,load:t,seen:r})=>{r=r||new Set;const n=e.toString(qr.base58btc);if(r.has(n))return;const s=await t(e);if(r.add(n),null!==s)for(const[,e]of s.links())await yd({cid:e,load:t,seen:r})},md=(0,z.kg)("ipfs:components:dag:import"),wd=[qi.code,gd.code];var bd=r(69649);class _d{constructor(e,t,r){this._version=e,this._roots=t,this._iterable=r,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class Ed extends _d{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(e){const{version:t,roots:r,iterator:n}=await kd(e);return new Ed(t,r,n)}static async fromIterable(e){const{version:t,roots:r,iterator:n}=await Sd(e);return new Ed(t,r,n)}}class vd extends(null){[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");this._decoded=!0;const e=this._iterable[Symbol.asyncIterator]();return{async next(){const t=await e.next();return t.done?t:{done:!1,value:t.value.cid}}}}static async fromBytes(e){const{version:t,roots:r,iterator:n}=await kd(e);return new vd(t,r,n)}static async fromIterable(e){const{version:t,roots:r,iterator:n}=await Sd(e);return new vd(t,r,n)}}async function kd(e){if(!(e instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return Rd(dd(e))}async function Sd(e){if(!e||"function"!=typeof e[Symbol.asyncIterator])throw new TypeError("fromIterable() requires an async iterable");return Rd(function(e){const t=e[Symbol.asyncIterator]();return function(e){let t=0,r=0,n=0,s=new Uint8Array(0);const i=async t=>{r=s.length-n;const i=[s.subarray(n)];for(;r<t;){const t=await e();if(null==t)break;r<0?t.length>r&&i.push(t.subarray(-r)):i.push(t),r+=t.length}s=new Uint8Array(i.reduce(((e,t)=>e+t.length),0));let o=0;for(const e of i)s.set(e,o),o+=e.length;n=0};return{upTo:async e=>(s.length-n<e&&await i(e),s.subarray(n,n+Math.min(s.length-n,e))),async exactly(e){if(s.length-n<e&&await i(e),s.length-n<e)throw new Error("Unexpected end of data");return s.subarray(n,n+e)},seek(e){t+=e,n+=e},get pos(){return t}}}((async function(){const e=await t.next();return e.done?null:e.value}))}(e))}async function Rd(e){const t=function(e){const t=(async()=>{const t=await od(e);if(2===t.version){const r=e.pos-t.dataOffset;e=function(e,t){let r=0;return{async upTo(n){let s=await e.upTo(n);return s.length+r>t&&(s=s.subarray(0,t-r)),s},async exactly(n){const s=await e.exactly(n);if(s.length+r>t)throw new Error("Unexpected end of data");return s},seek(t){r+=t,e.seek(t)},get pos(){return e.pos}}}(e,t.dataSize-r)}return t})();return{header:()=>t,async*blocks(){for(await t;(await e.upTo(8)).length>0;)yield await ld(e)},async*blocksIndex(){for(await t;(await e.upTo(8)).length>0;)yield await hd(e)}}}(e),{version:r,roots:n}=await t.header();return{version:r,roots:n,iterator:t.blocks()}}const Id=(0,z.kg)("ipfs:components:dag:import");async function Td(e,t,r){const n=await Ed.fromIterable(r),s=await n.getRoots();return await(0,qs.Z)(e.blocks.putMany((0,_i.Z)(n,(({cid:e,bytes:t})=>(Id(`Import block ${e}`),{key:e,value:t}))),{signal:t.signal})),s}class Ad{constructor({repo:e,codecs:t,hashers:r,preload:n}){this.export=function({repo:e,preload:t,codecs:r}){return mn((async function*(n,s={}){!1!==s.preload&&t(n);const i=te.k.asCID(n);if(!i)throw new Error(`Unexpected error converting CID type: ${n}`);md(`Exporting ${i} as car`);const{writer:o,out:a}=await ud.create([i]);let c=null;(async()=>{try{const t=function(e,t,r,n){return async s=>{const i=await n.getCodec(s.code);if(!i)throw new Error(`Can't decode links in block with codec 0x${s.code.toString(16)} to form complete DAG`);const o=await e.blocks.get(s,r);return md(`Adding block ${s} to car`),await t.put({cid:s,bytes:o}),wd.includes(s.code)?null:Qh({bytes:o,cid:s,codec:i})}}(e,o,{signal:s.signal,timeout:s.timeout},r);await yd({cid:i,load:t})}catch(e){c=e}finally{o.close()}})();for await(const e of a){if(c)break;yield e}if(c)throw c}))}({repo:e,preload:n,codecs:t}),this.get=function({codecs:e,repo:t,preload:r}){return mn((async function(n,s={}){if(!1!==s.preload&&r(n),s.path){const r=s.localResolve?await(0,bd.Z)(Tn(n,s.path,e,t,s)):await xn(Tn(n,s.path,e,t,s));if(!r)throw j(new Error("Not found"),"ERR_NOT_FOUND");return r}const i=await e.getCodec(n.code),o=await t.blocks.get(n,s);return{value:i.decode(o),remainderPath:""}}))}({codecs:t,repo:e,preload:n}),this.import=function({repo:e}){return mn((async function*(t,r={}){const n=await e.gcLock.readLock();try{const s={signal:r.signal,timeout:r.timeout},i=Ii(t),{value:o,done:a}=await i.peek();if(a)return;let c;o&&i.push(o),c=o instanceof Uint8Array?[i]:i;for await(const t of c){const n=await Td(e,s,t);if(!1!==r.pinRoots)for(const t of n){let r="";try{await e.blocks.has(t)?(Id(`Pinning root ${t}`),await e.pins.pinRecursively(t)):r="blockstore: block not found"}catch(e){r=e.message}yield{root:{cid:t,pinErrorMsg:r}}}}}finally{n()}}))}({repo:e}),this.resolve=function({repo:e,codecs:t,preload:r}){return mn((async function(n,s={}){const{cid:i}=bn(n);return!1!==s.preload&&r(i),Sn(e,t,n,s)}))}({repo:e,codecs:t,preload:n}),this.put=function({repo:e,codecs:t,hashers:r,preload:n}){return mn((async function(s,i={}){const o=i.pin?await e.gcLock.readLock():null;try{const a=await t.getCodec(i.storeCodec||"dag-cbor");if(!a)throw new Error(`Unknown storeCodec ${i.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(i.inputCodec){if(!(s instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const e=await t.getCodec(i.inputCodec);if(!e)throw new Error(`Unknown inputCodec ${i.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);s=e.decode(s)}const c=null!=i.version?i.version:1,l=await r.getHasher(i.hashAlg||"sha2-256");if(!l)throw new Error(`Unknown hash algorithm ${i.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const h=a.encode(s),d=await l.digest(h),u=te.k.create(c,a.code,d);return await e.blocks.put(u,h,{signal:i.signal}),i.pin&&await e.pins.pinRecursively(u),!1!==i.preload&&n(u),u}finally{o&&o()}}))}({repo:e,codecs:t,hashers:r,preload:n})}}var Pd=r(95120);const Dd=(0,z.kg)("ipfs:preload"),Od=new(Dn.Z.default?Dn.Z.default:Dn.Z)({concurrency:4});function Nd(e,t={}){return Dd(e),Od.add((async()=>{const r=(await On.post(e,{signal:t.signal})).body.getReader();try{for(;;){const{done:e}=await r.read();if(e)return}}finally{r.releaseLock()}}))}const Cd=(0,z.kg)("ipfs:preload");function Md(e={}){if(e.enabled=Boolean(e.enabled),e.addresses=e.addresses||[],e.cache=e.cache||1e3,!e.enabled||!e.addresses.length){Cd("preload disabled");const e=()=>{};return Object.assign(e,{start:()=>{},stop:()=>{}})}let t=!0,r=[];const n=e.addresses.map((e=>(0,Pd.k)(e))),s=Pn(e.cache),i=async e=>{try{if(t)throw new Error(`preload ${e} but preloader is not started`);const i=e.toString();if(s.has(i))return;s.set(i,!0);const o=function(e){if(!Array.isArray(e))throw new TypeError("Expected an array, got "+typeof e);for(let t=(e=[...e]).length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}(n);let a=!1;const c=Date.now();for(const e of o){if(t)throw new Error(`preload aborted for ${i}`);let n;try{n=new AbortController,r=r.concat(n),await Nd(`${e}/api/v0/refs?r=true&arg=${encodeURIComponent(i)}`,{signal:n.signal}),a=!0}catch(e){"aborted"!==e.type&&Cd.error(e)}finally{r=r.filter((e=>e!==n))}if(a)break}Cd(`${a?"":"un"}successfully preloaded ${i} in ${Date.now()-c}ms`)}catch(e){Cd.error(e)}};return i.start=()=>{t=!1},i.stop=()=>{t=!0,Cd(`aborting ${r.length} pending preload request(s)`),r.forEach((e=>e.abort())),r=[]},i}const Ld=(0,z.kg)("ipfs:mfs-preload");var xd=r(63155);let Bd;function Ud(e=!1){if(Bd)return Bd;const t=(0,xd.Z)({singleProcess:e});return Bd={readLock:e=>async(...r)=>{const n=await t.readLock();try{return await e.apply(null,r)}finally{n()}},writeLock:e=>async(...r)=>{const n=await t.writeLock();try{return await e.apply(null,r)}finally{n()}}},Bd}const zd=(0,z.kg)("ipfs:mfs:utils:with-mfs-root");async function jd(e,t){if(t&&t.signal&&t.signal.aborted)throw j(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});let r;await e.repo.datastore.open();try{const t=await e.repo.datastore.get(En);r=te.k.decode(t)}catch(n){if("ERR_NOT_FOUND"!==n.code)throw n;zd("Creating new MFS root");const s=Ie({Data:new ee({type:"directory"}).marshal(),Links:[]}),i=await zi.sha256.digest(s);if(r=te.k.createV0(i),await e.repo.blocks.put(r,s),t&&t.signal&&t.signal.aborted)throw j(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await e.repo.datastore.put(En,r.bytes)}return zd(`Loaded MFS root /ipfs/${r}`),r}function Fd(e=""){return(e.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const Vd="ipfs",$d=async(e,t,r)=>{const n=await jd(e,r);let s={entryType:"file"},i="";if(i=te.k.asCID(t)?`/ipfs/${t}`:t.toString(),i=i.trim(),i=i.replace(/(\/\/+)/g,"/"),i.endsWith("/")&&i.length>1&&(i=i.substring(0,i.length-1)),!i)throw j(new Error("paths must not be empty"),"ERR_NO_PATH");if("/"!==i.substring(0,1))throw j(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");"/"===i.substring(i.length-1)&&(i=i.substring(0,i.length-1));const o=Fd(i);if(o[0]===Vd){let e;e=2===o.length?`/${o.join("/")}`:`/${o.slice(0,o.length-1).join("/")}`,s={type:"ipfs",depth:o.length-2,entryType:"file",mfsPath:`/${o.join("/")}`,mfsDirectory:e,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}else{const e=`/${Vd}/${n}${o.length?"/"+o.join("/"):""}`,t=`/${Vd}/${n}/${o.slice(0,o.length-1).join("/")}`;s={type:"mfs",depth:o.length,entryType:"file",mfsDirectory:t,mfsPath:e,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}const a="mfs"===s.type?s.mfsPath:s.path;try{const t=await Wo(a,e.repo.blocks,r);s.cid=t.cid,s.mfsPath=`/ipfs/${t.path}`,s.entryType=t.type,s.content=t.content,"file"!==s.entryType&&"directory"!==s.entryType||"file"!==t.type&&"directory"!==t.type||(s.unixfs=t.unixfs)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return s.exists=Boolean(s.cid),s},Hd=B.Z.bind({ignoreUndefined:!0}),Gd=(0,z.kg)("ipfs:mfs:stat"),qd={withLocal:!1};function Kd(e){return mn((async function(t,r={}){r=Hd(qd,r),Gd(`Fetching stats for ${t}`);const{type:n,cid:s,mfsPath:i}=await $d(e,t,r),o="ipfs"===n&&s?s:i;let a;try{a=await Wo(o,e.repo.blocks)}catch(e){if("ERR_NOT_FOUND"===e.code)throw j(new Error(`${t} does not exist`),"ERR_NOT_FOUND");throw e}if(!Wd[a.type])throw new Error(`Cannot stat codec ${a.cid.code}`);return Wd[a.type](a)}))}const Wd={raw:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:e=>{const t={cid:e.cid,type:"file",size:e.unixfs.fileSize(),cumulativeSize:Ie(e.node).length+(e.node.Links||[]).reduce(((e,t)=>e+(t.Tsize||0)),0),blocks:e.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:e.unixfs.mode};return e.unixfs.mtime&&(t.mtime=e.unixfs.mtime),t},directory:e=>{const t={cid:e.cid,type:"directory",size:0,cumulativeSize:Ie(e.node).length+(e.node.Links||[]).reduce(((e,t)=>e+(t.Tsize||0)),0),blocks:e.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:e.unixfs.mode};return e.unixfs.mtime&&(t.mtime=e.unixfs.mtime),t},object:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},Zd=(0,z.kg)("ipfs:mfs:utils:to-trail");async function Yd(e,t){Zd(`Creating trail for path ${t}`);const r=[];for await(const n of Ko(t,e.repo.blocks))r.push({name:n.name,cid:n.cid,size:n.size,type:n.type});return r}const Jd=async(e,t,r)=>{r.codec||(r.codec=n),r.hasher||(r.hasher=zi.sha256),void 0===r.cidVersion&&(r.cidVersion=1),r.codec===n&&r.hasher!==zi.sha256&&(r.cidVersion=1);const s=await r.hasher.digest(e),i=te.k.create(r.cidVersion,r.codec.code,s);return r.onlyHash||await t.put(i,e,{signal:r.signal}),i},Qd=Vi.code;async function Xd(e){return(await Vi.encode(e)).subarray(0,8).reverse()}class eu{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}}class tu extends eu{constructor(e,t){super(e,t),this._bucket=Eo({hashFn:Xd,bits:8})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){yield*ru(this._bucket,e,this,this.options)}}async function*ru(e,t,r,n){const s=e._children,i=[];let o=0;for(let e=0;e<s.length;e++){const r=s.get(e);if(!r)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(r instanceof lo){let e;for await(const s of await ru(r,t,null,n))e=s;if(!e)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:a,Tsize:e.size,Hash:e.cid}),o+=e.size}else if("function"==typeof r.value.flush){const e=r.value;let n;for await(const r of e.flush(t))n=r,yield n;const s=a+r.key;i.push({Name:s,Tsize:n.size,Hash:n.cid}),o+=n.size}else{const e=r.value;if(!e.cid)continue;const t=a+r.key,n=e.size;i.push({Name:t,Tsize:n,Hash:e.cid}),o+=n}}const a=Uint8Array.from(s.bitField().reverse()),c={Data:new ee({type:"hamt-sharded-directory",data:a,fanout:e.tableSize(),hashType:Qd,mtime:r&&r.mtime,mode:r&&r.mode}).marshal(),Links:i},l=Ie(_e(c)),h=await Jd(l,t,n),d=l.length+o;yield{cid:h,node:c,size:d}}const nu=(0,z.kg)("ipfs:mfs:core:utils:hamt-utils"),su=async(e,t,r,n)=>{if(!n.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const s=Uint8Array.from(r._children.bitField().reverse()),i=ee.unmarshal(n.parent.Data),o=new ee({type:"hamt-sharded-directory",data:s,fanout:r.tableSize(),hashType:Qd,mode:i.mode,mtime:i.mtime}),a=await e.hashers.getHasher(n.hashAlg),c={Data:o.marshal(),Links:t.sort(((e,t)=>(e.Name||"").localeCompare(t.Name||"")))},l=Ie(c),h=await a.digest(l),d=te.k.create(n.cidVersion,Re,h);return n.flush&&await e.repo.blocks.put(d,l),{node:c,cid:d,size:t.reduce(((e,t)=>e+(t.Tsize||0)),l.length)}},iu=async(e,t,r,n,s)=>{const i=new lo({hash:r._options.hash,bits:r._options.bits},n,s);return n._putObjectAt(s,i),await au(e,t,i,r),i},ou=async e=>{const t=Eo({hashFn:Xd,bits:8});return await Promise.all(e.map((async e=>{const r=e.Name||"";if(2===r.length){const e=parseInt(r,16),n=new lo({hash:t._options.hash,bits:t._options.bits},t,e);return t._putObjectAt(e,n),Promise.resolve()}return t.put(r.substring(2),{size:e.Tsize,cid:e.Hash})}))),t},au=async(e,t,r,n)=>{await Promise.all(t.map((async t=>{const s=t.Name||"";if(2===s.length){nu("Populating sub bucket",s);const i=parseInt(s,16),o=Te(await e.repo.blocks.get(t.Hash)),a=new lo({hash:n._options.hash,bits:n._options.bits},r,i);return r._putObjectAt(i,a),await au(e,o.Links,a,n),Promise.resolve()}return n.put(s.substring(2),{size:t.Tsize,cid:t.Hash})})))},cu=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),lu=(0,z.kg)("ipfs:mfs:core:utils:add-link");async function hu(e,t){let r=t.parent;if(t.parentCid){const n=te.k.asCID(t.parentCid);if(null===n)throw j(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(n.code!==Re)throw j(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");lu(`Loading parent node ${n}`),r=Te(await e.repo.blocks.get(n))}if(!r)throw j(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!t.cid)throw j(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!t.name)throw j(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!t.size&&0!==t.size)throw j(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!r.Data)throw j(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const n=ee.unmarshal(r.Data);return"hamt-sharded-directory"===n.type?(lu("Adding link to sharded directory"),pu(e,{...t,parent:r})):r.Links.length>=t.shardSplitThreshold?(lu("Converting directory to sharded directory"),du(e,{...t,parent:r,mtime:n.mtime,mode:n.mode})):(lu(`Adding ${t.name} (${t.cid}) to regular directory`),uu(e,{...t,parent:r}))}const du=async(e,t)=>{const r=await(async(e,t,r={})=>{const n=new tu({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:r.mtime,mode:r.mode},r);for(let e=0;e<t.length;e++)await n._bucket.put(t[e].name,{size:t[e].size,cid:t[e].cid});const s=await xn(n.flush(e.repo.blocks));if(!s)throw new Error("Flushing shard yielded no result");return s})(e,t.parent.Links.map((e=>({name:e.Name||"",size:e.Tsize||0,cid:e.Hash}))).concat({name:t.name,size:t.size,cid:t.cid}),t);return lu(`Converted directory to sharded directory ${r.cid}`),r},uu=async(e,t)=>{const r=t.parent.Links.filter((e=>e.Name!==t.name));if(r.push({Name:t.name,Tsize:t.size,Hash:t.cid}),!t.parent.Data)throw j(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const n=ee.unmarshal(t.parent.Data);let s;if(n.mtime){const e=Date.now(),t=Math.floor(e/1e3);n.mtime={secs:t,nsecs:1e3*(e-1e3*t)},s=n.marshal()}else s=t.parent.Data;t.parent=_e({Data:s,Links:r});const i=await e.hashers.getHasher(t.hashAlg),o=Ie(t.parent),a=await i.digest(o),c=te.k.create(t.cidVersion,Re,a);return t.flush&&await e.repo.blocks.put(c,o),{node:t.parent,cid:c,size:o.length}},pu=async(e,t)=>{const{shard:r,path:n}=await fu(e,t),s=await xn(r.flush(e.repo.blocks));if(!s)throw new Error("No result from flushing shard");const i=Te(await e.repo.blocks.get(s.cid)),o=t.parent.Links.filter((e=>(e.Name||"").substring(0,2)!==n[0].prefix)),a=i.Links.find((e=>(e.Name||"").substring(0,2)===n[0].prefix));if(!a)throw new Error(`No link found with prefix ${n[0].prefix}`);return o.push(a),su(e,o,n[0].bucket,t)},fu=async(e,t)=>{const r={name:t.name,cid:t.cid,size:t.size};if(!t.parent.Data)throw j(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const n=await ou(t.parent.Links),s=ee.unmarshal(t.parent.Data),i=new tu({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:s.mode},t);i._bucket=n,s.mtime&&(i.mtime={secs:Math.round(Date.now()/1e3)});const o=await n._findNewBucketAndPos(r.name),a=gu(o);a[0].node=t.parent;let c=0;for(;c<a.length;){const t=a[c];c++;const s=t.node;if(!s)throw new Error("Segment had no node");const i=s.Links.find((e=>(e.Name||"").substring(0,2)===t.prefix));if(!i){lu(`Link ${t.prefix}${r.name} will be added`),c=a.length;break}if(i.Name===`${t.prefix}${r.name}`){lu(`Link ${t.prefix}${r.name} will be replaced`),c=a.length;break}if((i.Name||"").length>2){lu(`Link ${i.Name} ${i.Hash} will be replaced with a subshard`),c=a.length;break}lu(`Found subshard ${t.prefix}`);const o=Te(await e.repo.blocks.get(i.Hash));if(!a[c]){lu(`Loaded new subshard ${t.prefix}`),await iu(e,o.Links,n,t.bucket,parseInt(t.prefix,16));const s=await n._findNewBucketAndPos(r.name);a.push({bucket:s.bucket,prefix:cu(s.pos),node:o});break}const l=a[c];await au(e,o.Links,l.bucket,n),l.node=o}return await i._bucket.put(r.name,{size:r.size,cid:r.cid}),{shard:i,path:a}},gu=e=>{const t=[{bucket:e.bucket,prefix:cu(e.pos)}];let r=e.bucket._parent,n=e.bucket._posAtParent;for(;r;)t.push({bucket:r,prefix:cu(n)}),n=r._posAtParent,r=r._parent;return t.reverse(),t},yu=(0,z.kg)("ipfs:mfs:utils:update-tree"),mu={shardSplitThreshold:1e3};async function wu(e,t,r){r=Object.assign({},mu,r),yu("Trail",t),t=t.slice().reverse();let n,s=0;for await(const i of e.repo.blocks.getMany(t.map((e=>e.cid)))){const o=Te(i),a=t[s].cid,c=t[s].name;if(s++,!n){n={cid:a,name:c,size:i.length};continue}const l=await hu(e,{parent:o,name:n.name,cid:n.cid,size:n.size,flush:r.flush,shardSplitThreshold:r.shardSplitThreshold,hashAlg:r.hashAlg,cidVersion:r.cidVersion});n={cid:l.cid,name:c,size:l.size}}const{cid:i}=n;return yu(`Final CID ${i}`),i}const bu=(0,z.kg)("ipfs:mfs:utils:update-mfs-root");async function _u(e,t,r){if(r&&r.signal&&r.signal.aborted)throw j(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return bu(`New MFS root will be ${t}`),await e.repo.datastore.put(En,t.bytes),t}const Eu=B.Z.bind({ignoreUndefined:!0}),vu=(0,z.kg)("ipfs:mfs:mkdir"),ku={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function Su(e){return mn((async function(t,r={}){const n=Eu(ku,r);if(!t)throw new Error("no path given to Mkdir");if("/"===(t=t.trim())){if(n.parents)return;throw j(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if("/"!==t.substring(0,1))throw j(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");vu(`Creating ${t}`);const s=Fd(t);if("ipfs"===s[0])throw j(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const i=await jd(e,n);let o;const a=[],c=await async function(e,t,r){const n=new ee({type:"directory",mode:r.mode,mtime:r.mtime}),s=await e.hashers.getHasher(r.hashAlg),i={Data:n.marshal(),Links:[]},o=Ie(i),a=await s.digest(o),c=te.k.create(r.cidVersion,Re,a);return r.flush&&await e.repo.blocks.put(c,o),{cid:c,node:i}}(e,0,n);for(let r=0;r<=s.length;r++){const l=s.slice(0,r),h=`/ipfs/${i}/${l.join("/")}`;try{if(o=await Wo(h,e.repo.blocks),"file"!==o.type&&"directory"!==o.type)throw j(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(r===s.length){if(n.parents)return;throw j(new Error("file already exists"),"ERR_ALREADY_EXISTS")}a.push({name:o.name,cid:o.cid})}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t;if(r<s.length&&!n.parents)throw j(new Error(`Intermediate directory path ${h} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await Ru(e,l[l.length-1],c,a[a.length-1],a,n)}}const l=await wu(e,a,n);await _u(e,l,n)}))}const Ru=async(e,t,r,n,s,i)=>{vu(`Adding empty dir called ${t} to ${n.cid}`);const o=await hu(e,{parent:n.node,parentCid:n.cid,size:0,cid:r.cid,name:t,hashAlg:i.hashAlg,cidVersion:i.cidVersion,flush:i.flush,shardSplitThreshold:i.shardSplitThreshold});s[s.length-1].cid=o.cid,s.push({name:t,cid:r.cid})},Iu=B.Z.bind({ignoreUndefined:!0}),Tu=(0,z.kg)("ipfs:mfs:cp"),Au={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function Pu(e){return mn((async function(t,r,n={}){const s=Iu(Au,n);Array.isArray(t)||(t=[t]);const i=await Promise.all(t.map((t=>$d(e,t,s))));let o=await $d(e,r,s);if(!i.length||!o)throw j(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const a=i.find((e=>!e.exists));if(a)throw j(new Error(`${a.path} does not exist`),"ERR_INVALID_PARAMS");const c=Du(o);if(o.exists){if(Tu("Destination exists"),1===i.length&&!c)throw j(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(Tu("Destination does not exist"),i.length>1){if(!s.parents)throw j(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Su(e)(o.path,s),o=await $d(e,o.path,s)}else if(o.parts.length>1){const t=`/${o.parts.slice(0,-1).join("/")}`;try{await Kd(e)(t,s)}catch(r){if("ERR_NOT_FOUND"!==r.code)throw r;if(!s.parents)throw j(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Su(e)(t,s),o=await $d(e,o.path,s)}}const l=Du(o)?o.mfsPath:o.mfsDirectory,h=await Yd(e,l);if(1===i.length){const t=i.pop();if(!t)throw j(new Error("could not find source"),"ERR_INVALID_PARAMS");const r=c?t.name:o.name;return Tu(`Only one source, copying to destination ${c?"directory":"file"} ${r}`),Ou(e,t,r,h,s)}return Tu("Multiple sources, wrapping in a directory"),Nu(e,i,o,h,s)}))}const Du=e=>e.unixfs&&e.unixfs.type&&e.unixfs.type.includes("directory"),Ou=async(e,t,r,n,s)=>{let i=n.pop();if(!i)throw j(new Error("destination had no parent"),"ERR_INVALID_PARAMS");i=await Cu(e,t,r,i,s),n.push(i);const o=await wu(e,n,s);await _u(e,o,s)},Nu=async(e,t,r,n,s)=>{for(let n=0;n<t.length;n++){const i=t[n];r=await Cu(e,i,i.name,r,s)}n[n.length-1]=r;const i=await wu(e,n,s);await _u(e,i,s)},Cu=async(e,t,r,n,s)=>{const i=await e.repo.blocks.get(t.cid),{node:o,cid:a,size:c}=await hu(e,{parentCid:n.cid,size:i.length,cid:t.cid,name:r,hashAlg:s.hashAlg,cidVersion:s.cidVersion,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold});return n.node=o,n.cid=a,n.size=c,n},Mu=(0,z.kg)("ipfs:mfs:core:utils:remove-link"),Lu=async(e,t,r,n)=>{const s=t.pop();if(!s)throw j(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:i,prefix:o,node:a}=s;if(!a)throw j(new Error("Could not find parent"),"EINVALIDPARENT");const c=a.Links.find((e=>(e.Name||"").substring(0,2)===o));if(!c)throw j(new Error(`No link found with prefix ${o} for file ${r}`),"ERR_NOT_FOUND");if(c.Name===`${o}${r}`){Mu(`Removing existing link ${c.Name}`);const t=a.Links.filter((e=>e.Name!==c.Name));return await i.del(r),su(e,t,i,n)}Mu(`Descending into sub-shard ${c.Name} for ${o}${r}`);const l=await Lu(e,t,r,n);let h=l.cid,d=l.size,u=o;if(1===l.node.Links.length){Mu(`Removing subshard for ${o}`);const e=l.node.Links[0];u=`${o}${(e.Name||"").substring(2)}`,h=e.Hash,d=e.Tsize||0}return Mu(`Updating shard ${o} with name ${u}`),xu(e,i,a,o,u,d,h,n)},xu=(e,t,r,n,s,i,o,a)=>{const c=r.Links.filter((e=>e.Name!==n));return c.push({Name:s,Tsize:i,Hash:o}),su(e,c,t,a)},Bu=B.Z.bind({ignoreUndefined:!0}),Uu={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function zu(e){return mn((async function(t,r={}){const n=Bu(Uu,r);Array.isArray(t)||(t=[t]);const s=await Promise.all(t.map((t=>$d(e,t,n))));if(!s.length)throw j(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");s.forEach((e=>{if("/"===e.path)throw j(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")}));for(const t of s)await ju(e,t.path,n)}))}const ju=async(e,t,r)=>{const n=await $d(e,t,r),s=await Yd(e,n.mfsPath),i=s[s.length-1];s.pop();const o=s[s.length-1];if(!o)throw j(new Error(`${t} does not exist`),"ERR_NOT_FOUND");if("directory"===i.type&&!r.recursive)throw j(new Error(`${t} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:a}=await async function(e,t){let r=t.parent;if(t.parentCid){const n=te.k.asCID(t.parentCid);if(null===n)throw j(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");Mu(`Loading parent node ${n}`),r=Te(await e.repo.blocks.get(n))}if(!r)throw j(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!t.name)throw j(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!r.Data)throw j(new Error("Parent node had no data"),"ERR_INVALID_NODE");return"hamt-sharded-directory"===ee.unmarshal(r.Data).type?(Mu(`Removing ${t.name} from sharded directory`),(async(e,t)=>{const{rootBucket:r,path:n}=await(async(e,t,r)=>{const n=await ou(r.Links),s=await n._findNewBucketAndPos(t),i=[{bucket:s.bucket,prefix:cu(s.pos)}];let o=s.bucket;for(;o!==n;)i.push({bucket:o,prefix:cu(o._posAtParent)}),o=o._parent;i.reverse(),i[0].node=r;for(let r=0;r<i.length;r++){const s=i[r];if(!s.node)throw new Error("Could not generate HAMT path");const o=s.node.Links.filter((e=>(e.Name||"").substring(0,2)===s.prefix)).pop();if(!o){nu(`Link ${s.prefix}${t} will be added`);continue}if(o.Name===`${s.prefix}${t}`){nu(`Link ${s.prefix}${t} will be replaced`);continue}nu(`Found subshard ${s.prefix}`);const a=Te(await e.repo.blocks.get(o.Hash));if(!i[r+1]){nu(`Loaded new subshard ${s.prefix}`),await iu(e,a.Links,n,s.bucket,parseInt(s.prefix,16));const r=await n._findNewBucketAndPos(t);i.push({bucket:r.bucket,prefix:cu(r.pos),node:a});continue}const c=i[r+1];await au(e,a.Links,c.bucket,n),c.node=a}return await n.put(t,!0),i.reverse(),{rootBucket:n,path:i}})(e,t.name,t.parent);await r.del(t.name);const{node:s}=await Lu(e,n,t.name,t);return su(e,s.Links,r,t)})(e,{...t,parent:r})):(Mu(`Removing link ${t.name} regular directory`),(async(e,t)=>{t.parent.Links=t.parent.Links.filter((e=>e.Name!==t.name));const r=await Ie(t.parent),n=await e.hashers.getHasher(t.hashAlg),s=await n.digest(r),i=te.k.create(t.cidVersion,Re,s);return await e.repo.blocks.put(i,r),Mu(`Updated regular directory ${i}`),{node:t.parent,cid:i}})(e,{...t,parent:r}))}(e,{parentCid:o.cid,name:i.name,hashAlg:r.hashAlg,cidVersion:r.cidVersion,flush:r.flush,shardSplitThreshold:r.shardSplitThreshold});o.cid=a;const c=await wu(e,s,r);await _u(e,c,r)},Fu=B.Z.bind({ignoreUndefined:!0}),Vu=(0,z.kg)("ipfs:mfs:touch"),$u={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function Hu(e,t){if(e instanceof String||"string"==typeof e){const r=`${e}`;e=r.match(/^\d+$/g)?parseInt(r,8):0+r.split(",").reduce(((e,r)=>function(e,t,r){t||(t=0);const n=e.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!n)throw new Error(`Invalid file mode: ${e}`);let[,s,i,o]=n;"a"!==s&&s||(s="ugo");let a=function(e,t,r){let n=0;return(e.includes("x")||e.includes("X")&&(r||1&t||8&t||64&t))&&(n+=1),e.includes("w")&&(n+=2),e.includes("r")&&(n+=4),n}(o,t,r);return a=function(e,t){let r=0;return e.includes("u")&&(r+=t<<6),e.includes("g")&&(r+=t<<3),e.includes("o")&&(r+=t),r}(s,a),a=function(e,t,r){return t.includes("t")&&(r+=parseInt("1000",8)),t.includes("s")&&(e.includes("u")&&(r+=parseInt("4000",8)),e.includes("g")&&(r+=parseInt("2000",8))),r}(s,o,a),"="===i?(s.includes("u")&&(t&=parseInt("7077",8),t|=a),s.includes("g")&&(t&=parseInt("7707",8),t|=a),s.includes("o")&&(t&=parseInt("7770",8),t|=a),t):"+"===i?a|t:"-"===i?a^t:t}(r,e,t.isDirectory())),t.mode||0)}return e}const Gu=B.Z.bind({ignoreUndefined:!0}),qu={},Ku=B.Z.bind({ignoreUndefined:!0}),Wu={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3},Zu=B.Z.bind({ignoreUndefined:!0}),Yu=(0,z.kg)("ipfs:mfs:touch"),Ju={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"},Qu=B.Z.bind({ignoreUndefined:!0}),Xu={offset:0,length:1/0},ep=(0,z.kg)("ipfs:mfs:utils:to-async-iterator"),tp=B.Z.bind({ignoreUndefined:!0}),rp=(0,z.kg)("ipfs:mfs:write"),np={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(e,t)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3},sp=async(e,t,r,n)=>{r.exists?rp(`Overwriting file ${r.cid} offset ${n.offset} length ${n.length}`):rp(`Writing file offset ${n.offset} length ${n.length}`);const s=[];if(n.offset>0)if(r.unixfs){if(rp(`Writing first ${n.offset} bytes of original file`),s.push((()=>r.content({offset:0,length:n.offset}))),r.unixfs.fileSize()<n.offset){const e=n.offset-r.unixfs.fileSize();rp(`Writing zeros for extra ${e} bytes`),s.push(op(e))}}else rp(`Writing zeros for first ${n.offset} bytes`),s.push(op(n.offset));s.push(ip(t,n.length));const i=cp(ap(s),(e=>{if(r.unixfs&&!n.truncate){const t=r.unixfs.fileSize();if(t>e)return rp(`Writing last ${t-e} of ${t} bytes from original file starting at offset ${e}`),r.content({offset:e});rp("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}}));let o,a;void 0!==n.mode&&null!==n.mode?o=Q(n.mode):r&&r.unixfs&&(o=r.unixfs.mode),null!=n.mtime?a=X(n.mtime):r&&r.unixfs&&(a=r.unixfs.mtime);const c=await e.hashers.getHasher(n.hashAlg),l=await xn(Ao([{content:i,mode:o,mtime:a}],e.repo.blocks,{progress:n.progress,hasher:c,cidVersion:n.cidVersion,strategy:n.strategy,rawLeaves:n.rawLeaves,reduceSingleLeafToSelf:n.reduceSingleLeafToSelf,leafType:n.leafType}));if(!l)throw j(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return rp(`Wrote ${l.cid}`),{cid:l.cid,size:l.size}},ip=(e,t)=>async function*(){let r=0;for await(const n of e){if(r+=n.length,r>t)return void(yield n.subarray(0,t-r));yield n}},op=(e,t=262144)=>{const r=new Uint8Array(t);return ip(async function*(){for(;;)yield r}(),e)},ap=async function*(e){for(let t=0;t<e.length;t++)yield*e[t]()},cp=async function*(e,t){let r=0;for await(const t of e)r+=t.length,yield t;for await(const e of t(r))r+=e.length,yield e},lp=e=>{const t={cid:e.cid,name:e.name,type:"directory"===e.type?"directory":"file",size:e.size};return"file"!==e.type&&"directory"!==e.type||(t.mode=e.unixfs.mode,t.mtime=e.unixfs.mtime),t},hp={stat:Kd},dp={chmod:function(e){return mn((async function(t,r,n={}){const s=Fu($u,n);Vu(`Fetching stats for ${t}`);const{cid:i,mfsDirectory:o,name:a}=await $d(e,t,s);if(i.code!==Re)throw j(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(s.recursive){const n=await(0,vi.zG)((async function*(){for await(const n of Zo(i,e.repo.blocks)){if("file"!==n.type&&"directory"!==n.type)throw j(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");n.unixfs.mode=Hu(r,n.unixfs);const e=_e({Data:n.unixfs.marshal(),Links:n.node.Links});yield{path:n.path,content:e}}}),(t=>Ao(t,e.repo.blocks,{...s,pin:!1,dagBuilder:async function*(e,t,r){for await(const n of e)yield async function(){const e=n.content,s=Ie(e),i=await Jd(s,t,r);if(!e.Data)throw j(new Error(`${i} had no data`),"ERR_INVALID_NODE");const o=ee.unmarshal(e.Data);return{cid:i,size:s.length,path:n.path,unixfs:o}}}})),(e=>xn(e)));if(!n)throw j(new Error(`Could not chmod ${t}`),"ERR_COULD_NOT_CHMOD");return await zu(e)(t,s),void await Pu(e)(`/ipfs/${n.cid}`,t,s)}const c=Te(await e.repo.blocks.get(i));if(!c.Data)throw j(new Error(`${i} had no data`),"ERR_INVALID_NODE");const l=ee.unmarshal(c.Data);l.mode=Hu(r,l);const h=Ie({Data:l.marshal(),Links:c.Links}),d=s.hashAlg||$u.hashAlg,u=await e.hashers.getHasher(d),p=await u.digest(h),f=te.k.create(s.cidVersion,Re,p);s.flush&&await e.repo.blocks.put(f,h);const g=await Yd(e,o),y=g[g.length-1],m=te.k.decode(y.cid.bytes),w=Te(await e.repo.blocks.get(m)),b=await hu(e,{parent:w,name:a,cid:f,size:h.length,flush:s.flush,hashAlg:d,cidVersion:i.version,shardSplitThreshold:1/0});y.cid=b.cid;const _=await wu(e,g,s);await _u(e,_,s)}))},cp:Pu,flush:function(e){return mn((async function(t,r={}){r=Gu(qu,r);const{cid:n}=await Kd(e)(t,r);return n}))},mkdir:Su,mv:function(e){return mn((async function(t,r,n={}){const s=Ku(Wu,n);await Pu(e)(t,r,s),await zu(e)(t,{...s,recursive:!0})}))},rm:zu,touch:function(e){return mn((async function(t,r={}){const n=Zu(Ju,r);n.mtime=n.mtime||new Date,Yu(`Touching ${t} mtime: ${n.mtime}`);const{cid:s,mfsDirectory:i,name:o,exists:a}=await $d(e,t,n),c=r.hashAlg||Ju.hashAlg,l=await e.hashers.getHasher(c);let h,d,u=n.cidVersion;if(a){if(s.code!==Re)throw j(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");u=s.version;const r=Te(await e.repo.blocks.get(s));if(!r.Data)throw j(new Error(`${t} had no data`),"ERR_INVALID_NODE");const i=ee.unmarshal(r.Data);i.mtime=n.mtime,h=Ie({Data:i.marshal(),Links:r.Links});const o=await l.digest(h);d=te.k.create(n.cidVersion,Re,o),n.flush&&await e.repo.blocks.put(d,h)}else{h=Ie({Data:new ee({type:"file",mtime:n.mtime}).marshal(),Links:[]});const t=await l.digest(h);d=te.k.create(n.cidVersion,Re,t),n.flush&&await e.repo.blocks.put(d,h)}const p=await Yd(e,i),f=p[p.length-1],g=f.cid,y=Te(await e.repo.blocks.get(g)),m=await hu(e,{parent:y,name:o,cid:d,size:h.length,flush:n.flush,shardSplitThreshold:n.shardSplitThreshold,hashAlg:n.hashAlg,cidVersion:u});f.cid=m.cid;const w=await wu(e,p,n);await _u(e,w,n)}))}},up={write:function(e){return mn((async function(t,r,n={}){const s=tp(np,n);let i,o,a;if(rp("Reading source, destination and parent"),await Ud().readLock((async()=>{i=await function(e){if(!e)throw j(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if(("string"==typeof e||e instanceof String)&&(ep("Content was a string"),e=(0,Hr.m)(e.toString())),e.length)return ep("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield e}};if(e[Symbol.asyncIterator])return ep("Content was an async iterator"),e;if(e[Symbol.iterator])return ep("Content was an iterator"),e;if(global.Blob&&e instanceof global.Blob){ep("Content was an HTML5 Blob");let t=0;const r={next:()=>t>e.size?{done:!0}:new Promise(((r,n)=>{const s=e.slice(t,vn);t+=vn;const i=new global.FileReader,o=e=>{if(i.removeEventListener("loadend",o,!1),e.error)return n(e.error);r({done:!1,value:new Uint8Array(i.result)})};i.addEventListener("loadend",o),i.readAsArrayBuffer(s)}))};return{[Symbol.asyncIterator]:()=>r}}throw j(new Error(`Don't know how to convert ${e} into an async iterator`),"ERR_INVALID_PARAMS")}(r),o=await $d(e,t,s),a=await $d(e,o.mfsDirectory,s)}))(),rp("Read source, destination and parent"),!s.parents&&!a.exists)throw j(new Error("directory does not exist"),"ERR_NO_EXIST");if(null==i)throw j(new Error("could not create source"),"ERR_NO_SOURCE");if(null==o)throw j(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!s.create&&!o.exists)throw j(new Error("file does not exist"),"ERR_NO_EXIST");if("file"!==o.entryType)throw j(new Error("not a file"),"ERR_NOT_A_FILE");return(async(e,t,r,n,s)=>{const i=await sp(e,r,n,s);await Ud().writeLock((async()=>{const r=Fd(t),n=r.pop();if(null==n)throw j(new Error("source does not exist"),"ERR_NO_EXIST");let o=!1;try{await Kd(e)(`/${r.join("/")}`,s),o=!0}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}o||await Su(e)(`/${r.join("/")}`,s);const a=await $d(e,t,s),c=await Yd(e,a.mfsDirectory),l=c[c.length-1];if(!l)throw j(new Error("directory does not exist"),"ERR_NO_EXIST");if(!l.type||!l.type.includes("directory"))throw j(new Error(`cannot write to ${l.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const h=Te(await e.repo.blocks.get(l.cid)),d=await hu(e,{parent:h,name:n,cid:i.cid,size:i.size,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:s.cidVersion});l.cid=d.cid;const u=await wu(e,c,s);await _u(e,u,s)}))()})(e,t,i,o,s)}))},read:function(e){return mn((function(t,r={}){return r=Qu(Xu,r),{[Symbol.asyncIterator]:async function*(){const n=await $d(e,t,r),s=await Wo(n.mfsPath,e.repo.blocks);if("file"!==s.type)throw j(new Error(`${t} was not a file`),"ERR_NOT_FILE");if(!s.content)throw j(new Error(`Could not load content stream from ${t}`),"ERR_NO_CONTENT");for await(const e of s.content({offset:r.offset,length:r.length}))yield e}}}))},ls:function(e){return mn((async function*(t,r={}){const n=await $d(e,t,r),s=await Wo(n.mfsPath,e.repo.blocks);"directory"!==s.type?yield lp(s):yield*(0,_i.Z)(s.content(r),lp)}))}},pp=({options:e,mfs:t,operations:r,lock:n})=>{Object.keys(r).forEach((s=>{t[s]=n(r[s](e))}))},fp={repoOwner:!0,repo:null};const gp="Ed25519";class yp{constructor({keychain:e}){this.gen=function({keychain:e}){return mn(((t,r={type:gp,size:2048})=>e.createKey(t,r.type||gp,r.size||2048)))}({keychain:e}),this.list=function({keychain:e}){return mn((()=>e.listKeys()))}({keychain:e}),this.rm=function({keychain:e}){return mn((t=>e.removeKey(t)))}({keychain:e}),this.rename=function({keychain:e}){return mn((async(t,r)=>{const n=await e.renameKey(t,r);return{was:t,now:n.name,id:n.id,overwrite:!1}}))}({keychain:e}),this.export=function({keychain:e}){return mn(((t,r)=>e.exportKey(t,r)))}({keychain:e}),this.import=function({keychain:e}){return mn(((t,r,n)=>e.importKey(t,r,n)))}({keychain:e}),this.info=function({keychain:e}){return mn((t=>e.findKeyByName(t)))}({keychain:e})}}function mp({repo:e,preload:t}){return mn((async function(r,n={}){return!1!==n.preload&&t(r),Te(await e.blocks.get(r,n))}))}function wp(e,t=[]){for(const r in e){const n=e[r];if("/"===r&&1===Object.keys(e).length)try{t.push({Name:"",Tsize:0,Hash:te.k.parse(n)});continue}catch(e){}const s=te.k.asCID(n);s?t.push({Name:"",Tsize:0,Hash:s}):(Array.isArray(n)&&wp(n,t),n&&"object"==typeof n&&wp(n,t))}return t}function bp({repo:e,codecs:t}){return mn((async function(r,n={}){const s=await t.getCodec(r.code),i=await e.blocks.get(r,n),o=s.decode(i);switch(r.code){case qi.code:return[];case Re:return o.Links;case rr:case gr:return wp(o);default:throw new Error(`Cannot resolve links from codec ${r.code}`)}}))}function _p({repo:e,preload:t}){return mn((async function(r,n={}){const s=await e.gcLock.readLock();try{const i=Ie(r),o=await zi.sha256.digest(i),a=te.k.createV1(Re,o);return await e.blocks.put(a,i,{signal:n.signal}),!1!==n.preload&&t(a),n.pin&&await e.pins.pinRecursively(a,{signal:n.signal}),a}finally{s()}}))}class Ep{constructor({repo:e,preload:t}){this.addLink=function({repo:e,preload:t}){const r=mp({repo:e,preload:t}),n=_p({repo:e,preload:t});return mn((async function(e,t,s={}){const i=await r(e,s);return n({...i,Links:i.Links.concat([t])},s)}))}({repo:e,preload:t}),this.appendData=function({repo:e,preload:t}){const r=mp({repo:e,preload:t}),n=_p({repo:e,preload:t});return mn((async function(e,t,s={}){const i=await r(e,s),o=(0,Qn.z)([i.Data||[],t]);return n({...i,Data:o},s)}))}({repo:e,preload:t}),this.rmLink=function({repo:e,preload:t}){const r=mp({repo:e,preload:t}),n=_p({repo:e,preload:t});return mn((async function(e,t,s={}){const i=await r(e,s),o=("string"==typeof t?t:t.Name)||"";return i.Links=i.Links.filter((e=>e.Name!==o)),n(i,s)}))}({repo:e,preload:t}),this.setData=function({repo:e,preload:t}){const r=mp({repo:e,preload:t}),n=_p({repo:e,preload:t});return mn((async function(e,t,s={}){const i=await r(e,s);return n({...i,Data:t},s)}))}({repo:e,preload:t})}}class vp{constructor({repo:e,codecs:t,preload:r}){this.data=function({repo:e,preload:t}){const r=mp({repo:e,preload:t});return mn((async function(e,t={}){return(await r(e,t)).Data||new Uint8Array(0)}))}({repo:e,preload:r}),this.get=mp({repo:e,preload:r}),this.links=bp({repo:e,codecs:t}),this.new=function({repo:e,preload:t}){return mn((async function(r={}){let n;if(r.template){if("unixfs-dir"!==r.template)throw new Error("unknown template");n=new ee({type:"directory"}).marshal()}const s=Ie({Data:n,Links:[]}),i=await zi.sha256.digest(s),o=te.k.createV0(i);return await e.blocks.put(o,s,{signal:r.signal}),!1!==r.preload&&t(o),o}))}({repo:e,preload:r}),this.put=_p({repo:e,preload:r}),this.stat=function({repo:e,preload:t}){const r=mp({repo:e,preload:t});return mn((async function(e,t={}){const n=await r(e,t),s=Ie(n).length,i=n.Links.reduce(((e,t)=>e+(t.Tsize||0)),0);return{Hash:e,NumLinks:n.Links.length,BlockSize:s,LinksSize:s-(n.Data||[]).length,DataSize:(n.Data||[]).length,CumulativeSize:s+i}}))}({repo:e,preload:r}),this.patch=new Ep({repo:e,preload:r})}}const kp=(0,z.kg)("ipfs:repo:gc");function Sp({repo:e}){return mn((async function(t={}){const r=await e.stat();return{numObjects:BigInt(r.numObjects.toString()),repoSize:BigInt(r.repoSize.toString()),repoPath:r.repoPath,version:`${r.version}`,storageMax:BigInt(r.storageMax.toString())}}))}class Rp{constructor({repo:e,hashers:t}){this.gc=function({repo:e,hashers:t}){return mn((async function*(r={}){const n=Date.now();let s;try{s=await jd({repo:e,hashers:t},r),await e.pins.pinRecursively(s),yield*e.gc()}finally{s&&await e.pins.unpin(s)}kp(`Complete (${Date.now()-n}ms)`)}))}({repo:e,hashers:t}),this.stat=Sp({repo:e}),this.version=function({repo:e}){return mn((async function(t={}){try{await e._checkInitialized(t)}catch(e){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some((t=>t.test(e.message))))return 12;throw e}return e.version.get()}))}({repo:e}),this.setApiAddr=t=>e.apiAddr.set(t)}}function Ip(e,t){let r;if(r=e.metrics?t.peer?e.metrics.forPeer(t.peer):t.proto?e.metrics.forProtocol(t.proto):e.metrics.getGlobal():void 0,!r)return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0};const n=r.getMovingAverages(),s=r.getSnapshot();return{totalIn:s.dataReceived,totalOut:s.dataSent,rateIn:n.dataReceived[6e4].movingAverage/60,rateOut:n.dataSent[6e4].movingAverage/60}}class Tp{constructor({repo:e,network:t}){this.repo=Sp({repo:e}),this.bw=function({network:e}){return mn((async function*(t={}){const{libp2p:r}=await e.use(t);if(!t.poll)return void(yield Ip(r,t));const n=t.interval||1e3;let s,i=-1;try{if(i="string"==typeof n?gn(n)||-1:n,!i||i<0)throw new Error("invalid duration")}catch(e){throw j(e,"ERR_INVALID_POLL_INTERVAL")}try{for(;;)yield Ip(r,t),await new Promise((e=>{s=setTimeout(e,i)}))}finally{clearTimeout(s)}}))}({network:t}),this.bitswap=pi({network:t})}}var Ap=function(e,t,r){if(!e)return r;var n,s;if(Array.isArray(t)&&(n=t.slice(0)),"string"==typeof t&&(n=t.split(".")),"symbol"==typeof t&&(n=[t]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");for(;n.length;){if(s=n.shift(),!e)return r;if(void 0===(e=e[s]))return r}return e},Pp=r(2402);async function Dp(e){let t=0;for await(const r of e)t++;return t}const Op=Pp("ipfs:repo:migrator:migration-8");function Np(e){return e.child?Np(e.child):e}function Cp(e){try{const t=Kr.base32.decode(`b${e.toString().toLowerCase().slice(1)}`),r=te.k.decode(t).multihash.bytes,n=Kr.base32.encode(r).slice(1).toUpperCase();return new hn.s(`/${n}`,!1)}catch(t){return e}}function Mp(e){try{const t=Kr.base32.decode(`b${e.toString().toLowerCase().slice(1)}`),r=Wr.Jx(t),n=Kr.base32.encode(te.k.createV1(qi.code,r).bytes).slice(1);return new hn.s(`/${n.toUpperCase()}`,!1)}catch{return e}}async function Lp(e,t,r){const n=e.blocks;await n.open();const s=Np(n),i=await Dp(s.queryKeys({filters:[e=>r(e).toString()!==e.toString()]}));try{let e=0;for await(const n of s.query({})){const o=r(n.key);o.toString()!==n.key.toString()&&(e+=1,Op(`Migrating Block from ${n.key} to ${o}`,await s.has(n.key)),await s.delete(n.key),await s.put(o,n.value),t(e/i*100,`Migrated Block from ${n.key} to ${o}`))}}finally{await n.close()}}const xp={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(e,t=(()=>{}))=>Lp(e,t,Cp),revert:(e,t=(()=>{}))=>Lp(e,t,Mp)},Bp=F.Reader,Up=F.Writer,zp=(F.util,F.roots.default||(F.roots.default={})),jp=zp.ipfs=(()=>{const e={};return e.pin=function(){const e={};return e.Set=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.version=0,e.prototype.fanout=0,e.prototype.seed=0,e.encode=function(e,t){return t||(t=Up.create()),null!=e.version&&Object.hasOwnProperty.call(e,"version")&&t.uint32(8).uint32(e.version),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(16).uint32(e.fanout),null!=e.seed&&Object.hasOwnProperty.call(e,"seed")&&t.uint32(29).fixed32(e.seed),t},e.decode=function(e,t){e instanceof Bp||(e=Bp.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new zp.ipfs.pin.Set;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.version=e.uint32();break;case 2:n.fanout=e.uint32();break;case 3:n.seed=e.fixed32();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof zp.ipfs.pin.Set)return e;var t=new zp.ipfs.pin.Set;return null!=e.version&&(t.version=e.version>>>0),null!=e.fanout&&(t.fanout=e.fanout>>>0),null!=e.seed&&(t.seed=e.seed>>>0),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(r.version=0,r.fanout=0,r.seed=0),null!=e.version&&e.hasOwnProperty("version")&&(r.version=e.version),null!=e.fanout&&e.hasOwnProperty("fanout")&&(r.fanout=e.fanout),null!=e.seed&&e.hasOwnProperty("seed")&&(r.seed=e.seed),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e}(),e}(),e})();var Fp=r(122);const Vp=new hn.s("/local/pins"),$p=te.k.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),Hp="direct",Gp="recursive";function qp(e){return new hn.s(`/${Kr.base32.encode(e.multihash.bytes).toUpperCase().substring(1)}`)}function Kp(e,t){for(let r=0;r<e.byteLength;r++){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0}const Wp=jp.pin.Set;async function*Zp(e,t){const r=function(e){const t=e.Data;if(!t)throw new Error("No data present");const r=Xh.decode(t),n=Xh.decode.bytes;if(n<=0)throw new Error("Invalid Set header length");if(n+r>t.length)throw new Error("Impossibly large set header length");const s=t.slice(n,r+n),i=Wp.toObject(Wp.decode(s),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(1!==i.version)throw new Error(`Unsupported Set version: ${i.version}`);if(i.fanout>e.Links.length)throw new Error("Impossibly large fanout");return{header:i,data:t.slice(r+n)}}(t);let n=0;for(const s of t.Links){if(n<r.header.fanout){const t=s.Hash;if(!$p.equals(t)){const r=Te(await e.get(t));yield*Zp(e,r)}}else yield s.Hash;n++}}async function*Yp(e,t,r){const n=t.Links.find((e=>e.Name===r));if(!n)throw new Error("No link found with name "+r);const s=Te(await e.get(n.Hash));yield*Zp(e,s)}async function Jp(e,t,r){const n=await function(e,t){return async function t(r,n){const s=Wp.encode({version:1,fanout:256,seed:n}).finish(),i=Xh.encode(s.length),o=(0,Qn.z)([i,s]),a=[];for(let e=0;e<256;e++)a.push({Name:"",Tsize:1,Hash:$p});if(r.length<=8192){const e=r.map((e=>({link:{Name:"",Tsize:1,Hash:e.key},data:e.data||new Uint8Array}))).sort(((e,t)=>Kp(e.link.Hash.bytes,t.link.Hash.bytes))),t=a.concat(e.map((e=>e.link)));return{Data:(0,Qn.z)([o,...e.map((e=>e.data))]),Links:t}}{const e=r.reduce(((e,t)=>{const r=function(e,t){const r=new Uint8Array(4);new DataView(r.buffer).setUint32(0,e,!0);const n=(0,Hr.m)(t.toString()),s=(0,Qn.z)([r,n],r.byteLength+n.byteLength);return Fp((0,Qr.B)(s))}(n,t.key)%256;return e[r]=r in e?e[r].concat([t]):[t],e}),[]);let s=0;for(const r of e){const e=await t(r,n+1);await c(e,s),s++}return{Data:o,Links:a}}async function c(t,r){const n=Ie(t),s=await zi.sha256.digest(n),i=te.k.createV0(s);await e.put(i,n);const o=t.Links.reduce(((e,t)=>e+(t.Tsize||0)),0)+n.length;a[r]={Name:"",Tsize:o,Hash:i}}}(t,0)}(e,r.map((e=>({key:e})))),s=Ie(n),i=await zi.sha256.digest(s),o=te.k.createV0(i);return await e.put(o,s),{Name:t,Tsize:n.Links.reduce(((e,t)=>e+t.Tsize),0)+s.length,Hash:o}}async function Qp(e,t,r,n){if(!await t.has(Vp))return;const s=await t.get(Vp),i=te.k.decode(s),o=Te(await e.get(i));let a=0;const c=await Dp(Yp(e,o,Gp))+await Dp(Yp(e,o,Hp));for await(const t of Yp(e,o,Gp)){a++;const e={depth:1/0};0!==t.version&&(e.version=t.version),t.code!==Re&&(e.codec=t.code),await r.put(qp(t),qt(e)),n(a/c*100,`Migrated recursive pin ${t}`)}for await(const t of Yp(e,o,Hp)){a++;const e={depth:0};0!==t.version&&(e.version=t.version),t.code!==Re&&(e.codec=t.code),await r.put(qp(t),qt(e)),n(a/c*100,`Migrated direct pin ${t}`)}await e.delete(i),await t.delete(Vp)}async function Xp(e,t,r,n){const s=[],i=[];let o=0;const a=await Dp(r.queryKeys({}));for await(const{key:e,value:t}of r.query({})){o++;const r=Qt(t),c=te.k.create(r.version||0,r.codec||Re,Wr.Jx(Kr.base32.decode("b"+e.toString().toLowerCase().split("/").pop())));0===r.depth?(n(o/a*100,`Reverted direct pin ${c}`),i.push(c)):(n(o/a*100,`Reverted recursive pin ${c}`),s.push(c))}n(100,"Updating pin root");const c=Ie({Links:[await Jp(e,Hp,i),await Jp(e,Gp,s)]}),l=await zi.sha256.digest(c),h=te.k.createV0(l);await e.put(h,c),await t.put(Vp,h.bytes)}async function ef(e,t,r){const n=e.blocks,s=e.datastore,i=e.pins;await n.open(),await s.open(),await i.open();try{await r(n,s,i,t)}finally{await i.close(),await s.close(),await n.close()}}const tf={version:9,description:"Migrates pins to datastore",migrate:(e,t=(()=>{}))=>ef(e,t,Qp),revert:(e,t=(()=>{}))=>ef(e,t,Xp)},rf=new hn.s("/config"),nf=new hn.s("/version");function sf(e){let t=e;for(;t.db||t.child;)if(t=t.db||t.child,"level-js"===t.type||"Level"===t.constructor.name)return t}function of(e){const t=e.get.bind(e),r=e.has.bind(e);return e.get=n=>async function(e,t,r,n){if(await r(e))return t(e);const s=sf(n);if(!s)throw(0,$n.notFoundError)();return new Promise(((t,r)=>{const n=s.store("readonly").get(e.toString());n.transaction.onabort=()=>{r(n.transaction.error)},n.transaction.oncomplete=()=>{if(n.result)return t(n.result);r((0,$n.notFoundError)())}}))}(n,t,r,e),e.has=t=>async function(e,t,r){const n=await t(e);if(n)return n;const s=sf(r);return!!s&&new Promise(((t,r)=>{const n=s.store("readonly").get(e.toString());n.transaction.onabort=()=>{r(n.transaction.error)},n.transaction.oncomplete=()=>{t(Boolean(n.result))}}))}(t,r,e),e}function af(e){return{...e,root:of(e.root),datastore:of(e.datastore),pins:of(e.pins),keys:of(e.keys)}}async function cf(e,t,r=(()=>{})){const n=sf(t);n?(r(`Upgrading ${e}`),await pf(n,((e,t)=>[{type:"del",key:e},{type:"put",key:(0,Hr.m)(e),value:t}]))):r(`${e} did not need an upgrade`)}async function lf(e,t,r=(()=>{})){const n=sf(t);n?(r(`Downgrading ${e}`),await pf(n,((e,t)=>[{type:"del",key:e},{type:"put",key:(0,Qr.B)(e),value:t}]))):r(`${e} did not need a downgrade`)}function hf(e){return e.child?hf(e.child):e}async function df(e,t,r){const n=Object.entries(e).map((([e,t])=>({key:e,backend:hf(t)}))).filter((({key:e,backend:t})=>"LevelDatastore"===t.constructor.name)).map((({key:e,backend:t})=>({name:e,store:t})));t(0,`Migrating ${n.length} dbs`);let s=0;const i=e=>{t(Math.round(s/n.length*100),e)};for(const{name:e,store:t}of n){await t.open();try{await r(e,t,i)}finally{s++,await t.close()}}t(100,`Migrated ${n.length} dbs`)}const uf={version:10,description:"Migrates datastore-level keys to binary",migrate:(e,t=(()=>{}))=>df(e,t,cf),revert:(e,t=(()=>{}))=>df(e,t,lf)};function pf(e,t){return new Promise(((r,n)=>{const s=e.iterator();s._deserializeKey=s._deserializeValue=e=>e,function i(){s.next(((o,a,c)=>{if(o||void 0===a){const e=e=>{e?n(e):r()};s.end(e)}else!function(t,r){const n=e.store("readwrite"),s=n.transaction;let i,o=0;s.onabort=()=>r(i||s.error||new Error("aborted by user")),s.oncomplete=()=>r(),function e(){const r=t[o++],a=r.key;let c;try{c="del"===r.type?n.delete(a):n.put(r.value,a)}catch(e){return i=e,void s.abort()}o<t.length&&(c.onsuccess=e)}()}(t(a,c),i)}))}()}))}const ff=new hn.s("/local/filesroot"),gf={version:11,description:"Store mfs root in the datastore",migrate:async function(e,t=(()=>{})){if(t(100,"Migrating MFS root to repo datastore"),await e.root.open(),await e.datastore.open(),await e.root.has(ff)){const t=await e.root.get(ff);await e.datastore.put(ff,t),await e.root.delete(ff)}await e.datastore.close(),await e.root.close(),t(100,"Stored MFS root in repo datastore")},revert:async function(e,t=(()=>{})){if(t(100,"Migrating MFS root to repo root datastore"),await e.root.open(),await e.datastore.open(),await e.datastore.has(ff)){const t=await e.datastore.get(ff);await e.root.put(ff,t),await e.datastore.delete(ff)}await e.datastore.close(),await e.root.close(),t(100,"Stored MFS root in repo root datastore")}},yf=F.Reader,mf=F.Writer,wf=F.util,bf=F.roots.default||(F.roots.default={}),_f=bf.Protocols=(()=>{function e(e){if(this.protocols=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.protocols=wf.emptyArray,e.encode=function(e,t){if(t||(t=mf.create()),null!=e.protocols&&e.protocols.length)for(var r=0;r<e.protocols.length;++r)t.uint32(10).string(e.protocols[r]);return t},e.decode=function(e,t){e instanceof yf||(e=yf.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new bf.Protocols;e.pos<r;){var s=e.uint32();s>>>3==1?(n.protocols&&n.protocols.length||(n.protocols=[]),n.protocols.push(e.string())):e.skipType(7&s)}return n},e.fromObject=function(e){if(e instanceof bf.Protocols)return e;var t=new bf.Protocols;if(e.protocols){if(!Array.isArray(e.protocols))throw TypeError(".Protocols.protocols: array expected");t.protocols=[];for(var r=0;r<e.protocols.length;++r)t.protocols[r]=String(e.protocols[r])}return t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.protocols=[]),e.protocols&&e.protocols.length){r.protocols=[];for(var n=0;n<e.protocols.length;++n)r.protocols[n]=e.protocols[n]}return r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),Ef=F.Reader,vf=F.Writer,kf=F.util,Sf=F.roots.default||(F.roots.default={}),Rf=Sf.Addresses=(()=>{function e(e){if(this.addrs=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.addrs=kf.emptyArray,e.prototype.certifiedRecord=null,e.encode=function(e,t){if(t||(t=vf.create()),null!=e.addrs&&e.addrs.length)for(var r=0;r<e.addrs.length;++r)Sf.Addresses.Address.encode(e.addrs[r],t.uint32(10).fork()).ldelim();return null!=e.certifiedRecord&&Object.hasOwnProperty.call(e,"certifiedRecord")&&Sf.Addresses.CertifiedRecord.encode(e.certifiedRecord,t.uint32(18).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Ef||(e=Ef.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Sf.Addresses;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.addrs&&n.addrs.length||(n.addrs=[]),n.addrs.push(Sf.Addresses.Address.decode(e,e.uint32()));break;case 2:n.certifiedRecord=Sf.Addresses.CertifiedRecord.decode(e,e.uint32());break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Sf.Addresses)return e;var t=new Sf.Addresses;if(e.addrs){if(!Array.isArray(e.addrs))throw TypeError(".Addresses.addrs: array expected");t.addrs=[];for(var r=0;r<e.addrs.length;++r){if("object"!=typeof e.addrs[r])throw TypeError(".Addresses.addrs: object expected");t.addrs[r]=Sf.Addresses.Address.fromObject(e.addrs[r])}}if(null!=e.certifiedRecord){if("object"!=typeof e.certifiedRecord)throw TypeError(".Addresses.certifiedRecord: object expected");t.certifiedRecord=Sf.Addresses.CertifiedRecord.fromObject(e.certifiedRecord)}return t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.addrs=[]),t.defaults&&(r.certifiedRecord=null),e.addrs&&e.addrs.length){r.addrs=[];for(var n=0;n<e.addrs.length;++n)r.addrs[n]=Sf.Addresses.Address.toObject(e.addrs[n],t)}return null!=e.certifiedRecord&&e.hasOwnProperty("certifiedRecord")&&(r.certifiedRecord=Sf.Addresses.CertifiedRecord.toObject(e.certifiedRecord,t)),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.Address=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}let t;return e.prototype.multiaddr=kf.newBuffer([]),e.prototype.isCertified=null,Object.defineProperty(e.prototype,"_isCertified",{get:kf.oneOfGetter(t=["isCertified"]),set:kf.oneOfSetter(t)}),e.encode=function(e,t){return t||(t=vf.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),null!=e.isCertified&&Object.hasOwnProperty.call(e,"isCertified")&&t.uint32(16).bool(e.isCertified),t},e.decode=function(e,t){e instanceof Ef||(e=Ef.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Sf.Addresses.Address;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Sf.Addresses.Address)return e;var t=new Sf.Addresses.Address;return null!=e.multiaddr&&("string"==typeof e.multiaddr?kf.base64.decode(e.multiaddr,t.multiaddr=kf.newBuffer(kf.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),null!=e.isCertified&&(t.isCertified=Boolean(e.isCertified)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.multiaddr="":(r.multiaddr=[],t.bytes!==Array&&(r.multiaddr=kf.newBuffer(r.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(r.multiaddr=t.bytes===String?kf.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),null!=e.isCertified&&e.hasOwnProperty("isCertified")&&(r.isCertified=e.isCertified,t.oneofs&&(r._isCertified="isCertified")),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e}(),e.CertifiedRecord=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.seq=kf.Long?kf.Long.fromBits(0,0,!0):0,e.prototype.raw=kf.newBuffer([]),e.encode=function(e,t){return t||(t=vf.create()),null!=e.seq&&Object.hasOwnProperty.call(e,"seq")&&t.uint32(8).uint64(e.seq),null!=e.raw&&Object.hasOwnProperty.call(e,"raw")&&t.uint32(18).bytes(e.raw),t},e.decode=function(e,t){e instanceof Ef||(e=Ef.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Sf.Addresses.CertifiedRecord;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.seq=e.uint64();break;case 2:n.raw=e.bytes();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Sf.Addresses.CertifiedRecord)return e;var t=new Sf.Addresses.CertifiedRecord;return null!=e.seq&&(kf.Long?(t.seq=kf.Long.fromValue(e.seq)).unsigned=!0:"string"==typeof e.seq?t.seq=parseInt(e.seq,10):"number"==typeof e.seq?t.seq=e.seq:"object"==typeof e.seq&&(t.seq=new kf.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0))),null!=e.raw&&("string"==typeof e.raw?kf.base64.decode(e.raw,t.raw=kf.newBuffer(kf.base64.length(e.raw)),0):e.raw.length&&(t.raw=e.raw)),t},e.toObject=function(e,t){t||(t={});var r={};if(t.defaults){if(kf.Long){var n=new kf.Long(0,0,!0);r.seq=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else r.seq=t.longs===String?"0":0;t.bytes===String?r.raw="":(r.raw=[],t.bytes!==Array&&(r.raw=kf.newBuffer(r.raw)))}return null!=e.seq&&e.hasOwnProperty("seq")&&("number"==typeof e.seq?r.seq=t.longs===String?String(e.seq):e.seq:r.seq=t.longs===String?kf.Long.prototype.toString.call(e.seq):t.longs===Number?new kf.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0):e.seq),null!=e.raw&&e.hasOwnProperty("raw")&&(r.raw=t.bytes===String?kf.base64.encode(e.raw,0,e.raw.length):t.bytes===Array?Array.prototype.slice.call(e.raw):e.raw),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e}(),e})(),If=F.Reader,Tf=F.Writer,Af=F.util,Pf=F.roots.default||(F.roots.default={}),Df=Pf.Peer=(()=>{function e(e){if(this.addresses=[],this.protocols=[],this.metadata=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}let t;return e.prototype.addresses=Af.emptyArray,e.prototype.protocols=Af.emptyArray,e.prototype.metadata=Af.emptyArray,e.prototype.pubKey=null,e.prototype.peerRecordEnvelope=null,Object.defineProperty(e.prototype,"_pubKey",{get:Af.oneOfGetter(t=["pubKey"]),set:Af.oneOfSetter(t)}),Object.defineProperty(e.prototype,"_peerRecordEnvelope",{get:Af.oneOfGetter(t=["peerRecordEnvelope"]),set:Af.oneOfSetter(t)}),e.encode=function(e,t){if(t||(t=Tf.create()),null!=e.addresses&&e.addresses.length)for(var r=0;r<e.addresses.length;++r)Pf.Address.encode(e.addresses[r],t.uint32(10).fork()).ldelim();if(null!=e.protocols&&e.protocols.length)for(r=0;r<e.protocols.length;++r)t.uint32(18).string(e.protocols[r]);if(null!=e.metadata&&e.metadata.length)for(r=0;r<e.metadata.length;++r)Pf.Metadata.encode(e.metadata[r],t.uint32(26).fork()).ldelim();return null!=e.pubKey&&Object.hasOwnProperty.call(e,"pubKey")&&t.uint32(34).bytes(e.pubKey),null!=e.peerRecordEnvelope&&Object.hasOwnProperty.call(e,"peerRecordEnvelope")&&t.uint32(42).bytes(e.peerRecordEnvelope),t},e.decode=function(e,t){e instanceof If||(e=If.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Pf.Peer;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.addresses&&n.addresses.length||(n.addresses=[]),n.addresses.push(Pf.Address.decode(e,e.uint32()));break;case 2:n.protocols&&n.protocols.length||(n.protocols=[]),n.protocols.push(e.string());break;case 3:n.metadata&&n.metadata.length||(n.metadata=[]),n.metadata.push(Pf.Metadata.decode(e,e.uint32()));break;case 4:n.pubKey=e.bytes();break;case 5:n.peerRecordEnvelope=e.bytes();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Pf.Peer)return e;var t=new Pf.Peer;if(e.addresses){if(!Array.isArray(e.addresses))throw TypeError(".Peer.addresses: array expected");t.addresses=[];for(var r=0;r<e.addresses.length;++r){if("object"!=typeof e.addresses[r])throw TypeError(".Peer.addresses: object expected");t.addresses[r]=Pf.Address.fromObject(e.addresses[r])}}if(e.protocols){if(!Array.isArray(e.protocols))throw TypeError(".Peer.protocols: array expected");for(t.protocols=[],r=0;r<e.protocols.length;++r)t.protocols[r]=String(e.protocols[r])}if(e.metadata){if(!Array.isArray(e.metadata))throw TypeError(".Peer.metadata: array expected");for(t.metadata=[],r=0;r<e.metadata.length;++r){if("object"!=typeof e.metadata[r])throw TypeError(".Peer.metadata: object expected");t.metadata[r]=Pf.Metadata.fromObject(e.metadata[r])}}return null!=e.pubKey&&("string"==typeof e.pubKey?Af.base64.decode(e.pubKey,t.pubKey=Af.newBuffer(Af.base64.length(e.pubKey)),0):e.pubKey.length&&(t.pubKey=e.pubKey)),null!=e.peerRecordEnvelope&&("string"==typeof e.peerRecordEnvelope?Af.base64.decode(e.peerRecordEnvelope,t.peerRecordEnvelope=Af.newBuffer(Af.base64.length(e.peerRecordEnvelope)),0):e.peerRecordEnvelope.length&&(t.peerRecordEnvelope=e.peerRecordEnvelope)),t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.addresses=[],r.protocols=[],r.metadata=[]),e.addresses&&e.addresses.length){r.addresses=[];for(var n=0;n<e.addresses.length;++n)r.addresses[n]=Pf.Address.toObject(e.addresses[n],t)}if(e.protocols&&e.protocols.length)for(r.protocols=[],n=0;n<e.protocols.length;++n)r.protocols[n]=e.protocols[n];if(e.metadata&&e.metadata.length)for(r.metadata=[],n=0;n<e.metadata.length;++n)r.metadata[n]=Pf.Metadata.toObject(e.metadata[n],t);return null!=e.pubKey&&e.hasOwnProperty("pubKey")&&(r.pubKey=t.bytes===String?Af.base64.encode(e.pubKey,0,e.pubKey.length):t.bytes===Array?Array.prototype.slice.call(e.pubKey):e.pubKey,t.oneofs&&(r._pubKey="pubKey")),null!=e.peerRecordEnvelope&&e.hasOwnProperty("peerRecordEnvelope")&&(r.peerRecordEnvelope=t.bytes===String?Af.base64.encode(e.peerRecordEnvelope,0,e.peerRecordEnvelope.length):t.bytes===Array?Array.prototype.slice.call(e.peerRecordEnvelope):e.peerRecordEnvelope,t.oneofs&&(r._peerRecordEnvelope="peerRecordEnvelope")),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),Of=(Pf.Address=(()=>{function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}let t;return e.prototype.multiaddr=Af.newBuffer([]),e.prototype.isCertified=null,Object.defineProperty(e.prototype,"_isCertified",{get:Af.oneOfGetter(t=["isCertified"]),set:Af.oneOfSetter(t)}),e.encode=function(e,t){return t||(t=Tf.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),null!=e.isCertified&&Object.hasOwnProperty.call(e,"isCertified")&&t.uint32(16).bool(e.isCertified),t},e.decode=function(e,t){e instanceof If||(e=If.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Pf.Address;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Pf.Address)return e;var t=new Pf.Address;return null!=e.multiaddr&&("string"==typeof e.multiaddr?Af.base64.decode(e.multiaddr,t.multiaddr=Af.newBuffer(Af.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),null!=e.isCertified&&(t.isCertified=Boolean(e.isCertified)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.multiaddr="":(r.multiaddr=[],t.bytes!==Array&&(r.multiaddr=Af.newBuffer(r.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(r.multiaddr=t.bytes===String?Af.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),null!=e.isCertified&&e.hasOwnProperty("isCertified")&&(r.isCertified=e.isCertified,t.oneofs&&(r._isCertified="isCertified")),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),Pf.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.key="",e.prototype.value=Af.newBuffer([]),e.encode=function(e,t){return t||(t=Tf.create()),null!=e.key&&Object.hasOwnProperty.call(e,"key")&&t.uint32(10).string(e.key),null!=e.value&&Object.hasOwnProperty.call(e,"value")&&t.uint32(18).bytes(e.value),t},e.decode=function(e,t){e instanceof If||(e=If.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Pf.Metadata;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Pf.Metadata)return e;var t=new Pf.Metadata;return null!=e.key&&(t.key=String(e.key)),null!=e.value&&("string"==typeof e.value?Af.base64.decode(e.value,t.value=Af.newBuffer(Af.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(r.key="",t.bytes===String?r.value="":(r.value=[],t.bytes!==Array&&(r.value=Af.newBuffer(r.value)))),null!=e.key&&e.hasOwnProperty("key")&&(r.key=e.key),null!=e.value&&e.hasOwnProperty("value")&&(r.value=t.bytes===String?Af.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),F.Reader),Nf=F.Writer,Cf=F.util,Mf=F.roots.default||(F.roots.default={}),Lf=Mf.Envelope=(()=>{function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.publicKey=Cf.newBuffer([]),e.prototype.payloadType=Cf.newBuffer([]),e.prototype.payload=Cf.newBuffer([]),e.prototype.signature=Cf.newBuffer([]),e.encode=function(e,t){return t||(t=Nf.create()),null!=e.publicKey&&Object.hasOwnProperty.call(e,"publicKey")&&t.uint32(10).bytes(e.publicKey),null!=e.payloadType&&Object.hasOwnProperty.call(e,"payloadType")&&t.uint32(18).bytes(e.payloadType),null!=e.payload&&Object.hasOwnProperty.call(e,"payload")&&t.uint32(26).bytes(e.payload),null!=e.signature&&Object.hasOwnProperty.call(e,"signature")&&t.uint32(42).bytes(e.signature),t},e.decode=function(e,t){e instanceof Of||(e=Of.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new Mf.Envelope;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof Mf.Envelope)return e;var t=new Mf.Envelope;return null!=e.publicKey&&("string"==typeof e.publicKey?Cf.base64.decode(e.publicKey,t.publicKey=Cf.newBuffer(Cf.base64.length(e.publicKey)),0):e.publicKey.length&&(t.publicKey=e.publicKey)),null!=e.payloadType&&("string"==typeof e.payloadType?Cf.base64.decode(e.payloadType,t.payloadType=Cf.newBuffer(Cf.base64.length(e.payloadType)),0):e.payloadType.length&&(t.payloadType=e.payloadType)),null!=e.payload&&("string"==typeof e.payload?Cf.base64.decode(e.payload,t.payload=Cf.newBuffer(Cf.base64.length(e.payload)),0):e.payload.length&&(t.payload=e.payload)),null!=e.signature&&("string"==typeof e.signature?Cf.base64.decode(e.signature,t.signature=Cf.newBuffer(Cf.base64.length(e.signature)),0):e.signature.length&&(t.signature=e.signature)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.publicKey="":(r.publicKey=[],t.bytes!==Array&&(r.publicKey=Cf.newBuffer(r.publicKey))),t.bytes===String?r.payloadType="":(r.payloadType=[],t.bytes!==Array&&(r.payloadType=Cf.newBuffer(r.payloadType))),t.bytes===String?r.payload="":(r.payload=[],t.bytes!==Array&&(r.payload=Cf.newBuffer(r.payload))),t.bytes===String?r.signature="":(r.signature=[],t.bytes!==Array&&(r.signature=Cf.newBuffer(r.signature)))),null!=e.publicKey&&e.hasOwnProperty("publicKey")&&(r.publicKey=t.bytes===String?Cf.base64.encode(e.publicKey,0,e.publicKey.length):t.bytes===Array?Array.prototype.slice.call(e.publicKey):e.publicKey),null!=e.payloadType&&e.hasOwnProperty("payloadType")&&(r.payloadType=t.bytes===String?Cf.base64.encode(e.payloadType,0,e.payloadType.length):t.bytes===Array?Array.prototype.slice.call(e.payloadType):e.payloadType),null!=e.payload&&e.hasOwnProperty("payload")&&(r.payload=t.bytes===String?Cf.base64.encode(e.payload,0,e.payload.length):t.bytes===Array?Array.prototype.slice.call(e.payload):e.payload),null!=e.signature&&e.hasOwnProperty("signature")&&(r.signature=t.bytes===String?Cf.base64.encode(e.signature,0,e.signature.length):t.bytes===Array?Array.prototype.slice.call(e.signature):e.signature),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e})(),xf=F.Reader,Bf=F.Writer,Uf=F.util,zf=F.roots.default||(F.roots.default={}),jf=zf.PeerRecord=(()=>{function e(e){if(this.addresses=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.peerId=Uf.newBuffer([]),e.prototype.seq=Uf.Long?Uf.Long.fromBits(0,0,!0):0,e.prototype.addresses=Uf.emptyArray,e.encode=function(e,t){if(t||(t=Bf.create()),null!=e.peerId&&Object.hasOwnProperty.call(e,"peerId")&&t.uint32(10).bytes(e.peerId),null!=e.seq&&Object.hasOwnProperty.call(e,"seq")&&t.uint32(16).uint64(e.seq),null!=e.addresses&&e.addresses.length)for(var r=0;r<e.addresses.length;++r)zf.PeerRecord.AddressInfo.encode(e.addresses[r],t.uint32(26).fork()).ldelim();return t},e.decode=function(e,t){e instanceof xf||(e=xf.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new zf.PeerRecord;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.peerId=e.bytes();break;case 2:n.seq=e.uint64();break;case 3:n.addresses&&n.addresses.length||(n.addresses=[]),n.addresses.push(zf.PeerRecord.AddressInfo.decode(e,e.uint32()));break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof zf.PeerRecord)return e;var t=new zf.PeerRecord;if(null!=e.peerId&&("string"==typeof e.peerId?Uf.base64.decode(e.peerId,t.peerId=Uf.newBuffer(Uf.base64.length(e.peerId)),0):e.peerId.length&&(t.peerId=e.peerId)),null!=e.seq&&(Uf.Long?(t.seq=Uf.Long.fromValue(e.seq)).unsigned=!0:"string"==typeof e.seq?t.seq=parseInt(e.seq,10):"number"==typeof e.seq?t.seq=e.seq:"object"==typeof e.seq&&(t.seq=new Uf.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0))),e.addresses){if(!Array.isArray(e.addresses))throw TypeError(".PeerRecord.addresses: array expected");t.addresses=[];for(var r=0;r<e.addresses.length;++r){if("object"!=typeof e.addresses[r])throw TypeError(".PeerRecord.addresses: object expected");t.addresses[r]=zf.PeerRecord.AddressInfo.fromObject(e.addresses[r])}}return t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.addresses=[]),t.defaults)if(t.bytes===String?r.peerId="":(r.peerId=[],t.bytes!==Array&&(r.peerId=Uf.newBuffer(r.peerId))),Uf.Long){var n=new Uf.Long(0,0,!0);r.seq=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else r.seq=t.longs===String?"0":0;if(null!=e.peerId&&e.hasOwnProperty("peerId")&&(r.peerId=t.bytes===String?Uf.base64.encode(e.peerId,0,e.peerId.length):t.bytes===Array?Array.prototype.slice.call(e.peerId):e.peerId),null!=e.seq&&e.hasOwnProperty("seq")&&("number"==typeof e.seq?r.seq=t.longs===String?String(e.seq):e.seq:r.seq=t.longs===String?Uf.Long.prototype.toString.call(e.seq):t.longs===Number?new Uf.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0):e.seq),e.addresses&&e.addresses.length){r.addresses=[];for(var s=0;s<e.addresses.length;++s)r.addresses[s]=zf.PeerRecord.AddressInfo.toObject(e.addresses[s],t)}return r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.AddressInfo=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.multiaddr=Uf.newBuffer([]),e.encode=function(e,t){return t||(t=Bf.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),t},e.decode=function(e,t){e instanceof xf||(e=xf.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new zf.PeerRecord.AddressInfo;e.pos<r;){var s=e.uint32();s>>>3==1?n.multiaddr=e.bytes():e.skipType(7&s)}return n},e.fromObject=function(e){if(e instanceof zf.PeerRecord.AddressInfo)return e;var t=new zf.PeerRecord.AddressInfo;return null!=e.multiaddr&&("string"==typeof e.multiaddr?Uf.base64.decode(e.multiaddr,t.multiaddr=Uf.newBuffer(Uf.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.multiaddr="":(r.multiaddr=[],t.bytes!==Array&&(r.multiaddr=Uf.newBuffer(r.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(r.multiaddr=t.bytes===String?Uf.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e}(),e})();F.util.Long=void 0,F.configure();const Ff={version:12,description:"Store each peerstore peer under a single datastore key",migrate:async function(e,t=(()=>{})){t(0,"Storing each peerstore key under a single datastore key"),await e.datastore.open();const r={},n=[];for await(const{key:t,value:s}of e.datastore.query({prefix:"/peers"})){n.push(t);const e=t.toString(),[,i,o,a,c]=e.split("/");if("peers"===i&&["protos","addrs","metadata","keys"].includes(o)&&a)if(r[a]=r[a]||{addresses:[],protocols:[],metadata:[]},"protos"===o){const e=_f.decode(s);r[a].protocols=e.protocols.sort()}else if("addrs"===o){const e=Rf.decode(s);r[a].addresses=e.addrs.sort(((e,t)=>(0,Zr.HM)(e.multiaddr).toString().localeCompare((0,Zr.HM)(t.multiaddr).toString()))),e.certifiedRecord&&e.certifiedRecord.raw&&(r[a].peerRecordEnvelope=e.certifiedRecord.raw)}else"metadata"===o?r[a].metadata.push({key:c,value:s}):"keys"===o&&(r[a].pubKey=s)}t(33,"Read peer data from store");for(const t of n)await e.datastore.delete(t);t(66,"Removed existing peer data from store");for(const t of Object.keys(r)){const n=r[t];n.metadata=n.metadata.sort(((e,t)=>e.key.localeCompare(t.key)));const s=Df.encode(n).finish();await e.datastore.put(new hn.s(`/peers/${t}`),s)}await e.datastore.close(),t(100,"Stored each peerstore key under a single datastore key")},revert:async function(e,t=(()=>{})){t(0,"Storing each peerstore key under a multiple datastore keys"),await e.datastore.open();const r={},n=[];for await(const{key:t,value:s}of e.datastore.query({prefix:"/peers"})){n.push(t);const e=t.toString(),[,,i]=e.split("/");r[i]=Df.decode(s)}t(33,"Read peer data from store");for(const t of n)await e.datastore.delete(t);t(66,"Removed existing peer data from store");for(const[t,n]of Object.entries(r)){if(n.protocols&&n.protocols.length>0&&await e.datastore.put(new hn.s(`/peers/protos/${t}`),_f.encode({protocols:n.protocols}).finish()),n.addresses&&n.addresses.length>0){const r=n.peerRecordEnvelope;let s;if(r){const e=Lf.decode(r);s={raw:r,seq:jf.decode(e.payload).seq}}await e.datastore.put(new hn.s(`/peers/addrs/${t}`),Rf.encode({addrs:n.addresses,certifiedRecord:s}).finish())}if(n.metadata&&n.metadata.length>0)for(const{key:r,value:s}of n.metadata)await e.datastore.put(new hn.s(`/peers/metadata/${t}/${r}`),s);n.pubKey&&await e.datastore.put(new hn.s(`/peers/keys/${t}`),n.pubKey)}await e.datastore.close(),t(100,"Stored each peerstore key under multiple datastore keys")}},Vf={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0},$f=[Object.assign({version:1},Vf),Object.assign({version:2},Vf),Object.assign({version:3},Vf),Object.assign({version:4},Vf),Object.assign({version:5},Vf),Object.assign({version:6},Vf),Object.assign({version:7},Vf),xp,tf,uf,gf,Ff];class Hf extends Error{constructor(e){super(e),this.name="NonReversibleMigrationError",this.code=Hf.code,this.message=e}}Hf.code="ERR_NON_REVERSIBLE_MIGRATION";class Gf extends Error{constructor(e){super(e),this.name="NotInitializedRepoError",this.code=Gf.code,this.message=e}}Gf.code="ERR_NOT_INITIALIZED_REPO";class qf extends Error{constructor(e){super(e),this.name="RequiredParameterError",this.code=qf.code,this.message=e}}qf.code="ERR_REQUIRED_PARAMETER";class Kf extends Error{constructor(e){super(e),this.name="InvalidValueError",this.code=Kf.code,this.message=e}}Kf.code="ERR_INVALID_VALUE";class Wf extends Error{constructor(e){super(e),this.name="MissingRepoOptionsError",this.code=Wf.code,this.message=e}}Wf.code="ERR_MISSING_REPO_OPTIONS";const Zf=Pp("ipfs:repo:migrator:repo:init");async function Yf(e){if(!await async function(e){if(!e)throw new Wf("Please pass repo options when trying to open a repo");const t=e.root;try{await t.open();const e=await t.has(nf),r=await t.has(rf);return!(!e||!r)||(Zf(`Version entry present: ${e}`),Zf(`Config entry present: ${r}`),!1)}catch(e){return Zf("While checking if repo is initialized error was thrown: "+e.message),!1}finally{if(void 0!==t)try{await t.close()}catch{}}}(e))throw new Gf("Repo is not initialized!");const t=e.root;await t.open();try{return parseInt((0,Qr.B)(await t.get(nf)))}finally{await t.close()}}async function Jf(e,t){if(!t)throw new Wf("Please pass repo options when trying to open a repo");const r=t.root;await r.open(),await r.put(nf,(0,Hr.m)(String(e))),await r.close()}const Qf=Pp("ipfs:repo:migrator");function Xf(e,t,r,n=!1){let s=0;for(const i of e){if(i.version>r)break;if(i.version>t){if(n&&!i.revert)throw new eg.NonReversibleMigrationError(`It is not possible to revert to version ${t} because migration version ${i.version} is not reversible. Cancelling reversion.`);s++}}if(s!==r-t)throw new eg.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${t} to ${r}`)}const eg=a;var tg=r(13434);class rg extends Error{constructor(e){super(e),this.name="LockExistsError",this.code=rg.code}}rg.code="ERR_LOCK_EXISTS";class ng extends Error{constructor(e){super(e),this.name="NotFoundError",this.code=ng.code}}ng.code="ERR_NOT_FOUND";class sg extends Error{constructor(e){super(e),this.name="InvalidRepoVersionError",this.code=sg.code}}sg.code="ERR_INVALID_REPO_VERSION";const ig="ERR_REPO_NOT_INITIALIZED";async function og(e,t,r){const n=await t(e);if(n)return n;const s=cg(r);return!!s&&new Promise(((t,r)=>{const n=s.store("readonly").get(e.toString());n.transaction.onabort=()=>{r(n.transaction.error)},n.transaction.oncomplete=()=>{t(Boolean(n.result))}}))}async function ag(e,t,r,n){if(await r(e))return t(e);const s=cg(n);if(!s)throw new ng;return new Promise(((t,r)=>{const n=s.store("readonly").get(e.toString());n.transaction.onabort=()=>{r(n.transaction.error)},n.transaction.oncomplete=()=>{if(n.result)return t(n.result);r(new ng)}}))}function cg(e){let t=e;for(;t.db||t.child;)if(t=t.db||t.child,"level-js"===t.type||"Level"===t.constructor.name)return t}const lg=Pp("ipfs:repo:version"),hg=new hn.s("version"),dg=Dn.Z.default?Dn.Z.default:Dn.Z,ug=new hn.s("config");function pg(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}const fg=new hn.s("datastore_spec");const gg=new hn.s("api");function yg(e){const t=te.k.asCID(e);if(null==t)throw j(new Error("Not a valid cid"),"ERR_INVALID_CID");return t.multihash.code!==Lr.identity.code?{isIdentity:!1}:{isIdentity:!0,digest:t.multihash.digest}}const mg=Pp("ipfs:repo:lock:memory"),wg="repo.lock",bg={},_g={lock:async function(e){const t=e+"/"+wg;if(mg("locking %s",t),!0===bg[t])throw new rg(`Lock already being held for file: ${t}`);return bg[t]=!0,{async close(){bg[t]&&delete bg[t]}}},locked:async function(e){const t=e+"/"+wg;return mg(`checking lock: ${t}`),Boolean(bg[t])}},Eg={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:_g},vg={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}};function kg(e){const t=ir.k0.asCID(e);if(null==t)throw j(new Error("Not a valid cid"),"ERR_INVALID_CID");const r=Kr.base32.encode(t.multihash.bytes);return new hn.s("/"+r.slice(1).toUpperCase(),!1)}function Sg(e){return Wr.Jx(Kr.base32.decode(`b${e.toString().toLowerCase().substring(1)}`))}const Rg=Pp("ipfs:repo:utils:walk-dag");async function*Ig(e,t,r,n){try{const s=Qh({bytes:await t.get(e,n),cid:e,codec:await r(e.code)});for(const[,e]of s.links())yield e,yield*Ig(e,t,r,n)}catch(t){throw Rg("Could not walk DAG for CID",e.toString(),t),t}}class Tg extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof e.maxAge&&0===e.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if("function"==typeof this.onEviction)for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return"number"==typeof t.expiry&&t.expiry<=Date.now()&&("function"==typeof this.onEviction&&this.onEviction(e,t.value),this.delete(e))}_getOrDeleteIfExpired(e,t){if(!1===this._deleteIfExpired(e,t))return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||!1===this._deleteIfExpired(t,r)&&(yield e)}for(const e of this.cache){const[t,r]=e;!1===this._deleteIfExpired(t,r)&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(!1===this._deleteIfExpired(e,t))return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n="number"==typeof r&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):!!this.oldCache.has(e)&&!this._deleteIfExpired(e,this.oldCache.get(e))}peek(e){return this.cache.has(e)?this._peek(e,this.cache):this.oldCache.has(e)?this._peek(e,this.oldCache):void 0}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;!1===this._deleteIfExpired(t,r)&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||!1===this._deleteIfExpired(t,r)&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;!1===this._deleteIfExpired(n,s)&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this.cache.has(n)||!1===this._deleteIfExpired(n,s)&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}class Ag{constructor({pinstore:e,blockstore:t,loadCodec:r}){this.pinstore=e,this.blockstore=t,this.loadCodec=r,this.log=Pp("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(e,t={}){await this.blockstore.get(e,t);const r={depth:0};return 0!==e.version&&(r.version=e.version),e.code!==Re&&(r.codec=e.code),t.metadata&&(r.metadata=t.metadata),this.pinstore.put(kg(e),qt(r))}unpin(e,t){return this.pinstore.delete(kg(e),t)}async pinRecursively(e,t={}){await this.fetchCompleteDag(e,t);const r={depth:1/0};0!==e.version&&(r.version=e.version),e.code!==Re&&(r.codec=e.code),t.metadata&&(r.metadata=t.metadata),await this.pinstore.put(kg(e),qt(r))}async*directKeys(e){for await(const e of this.pinstore.query({filters:[e=>0===Qt(e.value).depth]})){const t=Qt(e.value),r=t.version||0,n=null!=t.codec?t.codec:Re,s=Sg(e.key);yield{cid:te.k.create(r,n,s),metadata:t.metadata}}}async*recursiveKeys(e){for await(const e of this.pinstore.query({filters:[e=>Qt(e.value).depth===1/0]})){const t=Qt(e.value),r=t.version||0,n=null!=t.codec?t.codec:Re,s=Sg(e.key);yield{cid:te.k.create(r,n,s),metadata:t.metadata}}}async*indirectKeys(e){for await(const{cid:t}of this.recursiveKeys())for await(const r of Ig(t,this.blockstore,this.loadCodec,e)){const e=[zn.recursive];(await this.isPinnedWithType(r,e)).pinned||(yield r)}}async isPinnedWithType(e,t,r){Array.isArray(t)||(t=[t]);const n=t.includes(zn.all),s=t.includes(zn.direct),i=t.includes(zn.recursive),o=t.includes(zn.indirect);if(i||s||n){const r=await(0,bd.Z)(this.pinstore.query({prefix:kg(e).toString(),filters:[e=>{if(n)return!0;const r=Qt(e.value);return t.includes(0===r.depth?zn.direct:zn.recursive)}],limit:1}));if(r){const t=Qt(r.value);return{cid:e,pinned:!0,reason:0===t.depth?zn.direct:zn.recursive,metadata:t.metadata}}}const a=this;if(n||o){const t=await(0,bd.Z)(async function*(e,t){for await(const{cid:r}of t)for await(const t of Ig(r,a.blockstore,a.loadCodec))if(t.equals(e))return void(yield r)}(e,this.recursiveKeys()));if(t)return{cid:e,pinned:!0,reason:zn.indirect,parent:t}}return{cid:e,pinned:!1}}async fetchCompleteDag(e,t={}){const r=new Tg({maxSize:t.cidCacheMaxSize??2048}),n=async(e,t)=>{if(r.has(e.toString()))return;r.set(e.toString(),!0);const s=Qh({bytes:await this.blockstore.get(e,t),cid:e,codec:await this.loadCodec(e.code)});await Promise.all([...s.links()].map((([,e])=>n(e,t))))};await n(e,t)}static checkPinType(e){if("string"!=typeof e||!Object.keys(zn).includes(e))throw function(e){return j(new Error(`Invalid type '${e}', must be one of {direct, indirect, recursive, all}`),"ERR_INVALID_PIN_TYPE")}(e);return!0}}async function Pg(e,t){const{pinned:r,reason:n}=await t.isPinnedWithType(e,zn.all);if(r)throw j(new Error(`pinned: ${n}`),"ERR_BLOCK_PINNED")}var Dg=r(11583);const Og=Pp("ipfs:repo:gc"),Ng=(0,$n.notFoundError)().code,Cg=new hn.s("/local/filesroot");const Mg=Pp("ipfs:repo"),Lg=Number.MAX_SAFE_INTEGER;class xg{constructor(e,t,r,n){if("string"!=typeof e)throw new Error("missing repo path");if("function"!=typeof t)throw new Error("missing codec loader");this.options=(0,B.Z)(Eg,n),this.closed=!0,this.path=e,this.root=r.root,this.datastore=r.datastore,this.keys=r.keys;const s=r.blocks,i=r.pins;this.pins=new Ag({pinstore:i,blockstore:s,loadCodec:t});const o=(a=this.pins,c=s,{open:()=>c.open(),close:()=>c.close(),query:(e,t)=>c.query(e,t),queryKeys:(e,t)=>c.queryKeys(e,t),get:async(e,t)=>c.get(e,t),async*getMany(e,t){yield*c.getMany(e,t)},async put(e,t,r){await c.put(e,t,r)},async*putMany(e,t){yield*c.putMany(e,t)},has:(e,t)=>c.has(e,t),delete:async(e,t)=>(await Pg(e,a),c.delete(e,t)),deleteMany:(e,t)=>c.deleteMany((0,_i.Z)(e,(async e=>(await Pg(e,a),e))),t),batch:()=>c.batch()});var a,c;this.blocks=function(e){return{open:()=>e.open(),close:()=>e.close(),query:(t,r)=>e.query(t,r),queryKeys:(t,r)=>e.queryKeys(t,r),async get(t,r){const n=yg(t);return n.isIdentity?Promise.resolve(n.digest):e.get(t,r)},async*getMany(e,t){for await(const r of e)yield this.get(r,t)},async put(t,r,n){const{isIdentity:s}=yg(t);s||await e.put(t,r,n)},async*putMany(t,r){const n=(0,Is.d)({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)((async()=>{try{await(0,qs.Z)(e.putMany(async function*(){for await(const{key:e,value:r}of t)yg(e).isIdentity||(yield{key:e,value:r}),n.push({key:e,value:r})}())),n.end()}catch(e){n.end(e)}})),yield*n},has(t,r){const{isIdentity:n}=yg(t);return n?Promise.resolve(!0):e.has(t,r)},delete(t,r){const{isIdentity:n}=yg(t);return n?Promise.resolve():e.delete(t,r)},deleteMany:(t,r)=>e.deleteMany((0,Ei.Z)(t,(e=>!yg(e).isIdentity)),r),batch(){const t=e.batch();return{put(e,r){const{isIdentity:n}=yg(e);n||t.put(e,r)},delete(e){const{isIdentity:r}=yg(e);r||t.delete(e)},commit:e=>t.commit(e)}}}}(o),this.version=function(e){return{exists:async()=>og(hg,e.has.bind(e),e),async get(){const t=await ag(hg,e.get.bind(e),e.has.bind(e),e);return parseInt((0,Qr.B)(t),10)},set:t=>e.put(hg,(0,Hr.m)(String(t))),async check(e){const t=await this.get();return lg("comparing version: %s and %s",t,e),t===e||6===t&&7===e||6===e&&7===t}}}(this.root),this.config=function(e){const t=new dg({concurrency:1}),r={async getAll(t={}){const r=await ag(ug,e.get.bind(e),e.has.bind(e),e);return JSON.parse((0,Qr.B)(r))},async get(e,t={}){if(null==e)throw new ng(`Key ${e} does not exist in config`);const r=await this.getAll(t),n=Ap(r,e);if(void 0===n)throw new ng(`Key ${e} does not exist in config`);return n},set(e,r,s={}){if("string"!=typeof e&&!(e instanceof String))throw j(new Error("Invalid key type: "+typeof e),"ERR_INVALID_KEY");if(void 0===r||r instanceof Uint8Array)throw j(new Error("Invalid value type: "+typeof r),"ERR_INVALID_VALUE");return t.add((()=>n({key:e,value:r},s.signal)))},replace(e,r={}){if(!e||e instanceof Uint8Array)throw j(new Error("Invalid value type: "+typeof e),"ERR_INVALID_VALUE");return t.add((()=>n({key:void 0,value:e},r.signal)))},exists:async()=>og(ug,e.has.bind(e),e)};return r;async function n(e,t){if(t&&t.aborted)return;const n=e.key,i=e.value;if(n){const e=await r.getAll();return"object"==typeof e&&null!==e&&Fh(e,n,i),s(e)}return s(i)}function s(t){const r=(0,Hr.m)(JSON.stringify(t,null,2));return e.put(ug,r)}}(this.root),this.spec=function(e){return{exists:()=>e.has(fg),async get(){const t=await e.get(fg);return JSON.parse((0,Qr.B)(t))},set:async t=>e.put(fg,(0,Hr.m)(JSON.stringify(function(e,t={}){if(!pg(e)&&!Array.isArray(e))throw new TypeError("Expected a plain object or array");const{deep:r,compare:n}=t,s=[],i=[],o=e=>{const t=s.indexOf(e);if(-1!==t)return i[t];const r=[];return s.push(e),i.push(r),r.push(...e.map((e=>Array.isArray(e)?o(e):pg(e)?a(e):e))),r},a=e=>{const t=s.indexOf(e);if(-1!==t)return i[t];const c={},l=Object.keys(e).sort(n);s.push(e),i.push(c);for(const t of l){const n=e[t];let s;s=r&&Array.isArray(n)?o(n):r&&pg(n)?a(n):n,Object.defineProperty(c,t,{...Object.getOwnPropertyDescriptor(e,t),value:s})}return c};return Array.isArray(e)?r?o(e):e.slice():a(e)}(t,{deep:!0}))))}}(this.root),this.apiAddr=function(e){return{async get(){const t=await e.get(gg);return t&&t.toString()},set:t=>e.put(gg,(0,Hr.m)(t.toString())),delete:()=>e.delete(gg)}}(this.root),this.gcLock=(0,xd.Z)({name:e,singleProcess:!1!==this.options.repoOwner}),this.gc=function({gcLock:e,pins:t,blockstore:r,root:n,loadCodec:s}){return async function*(){const i=Date.now();Og("Creating set of marked blocks");const o=await e.writeLock();try{const e=await async function({pins:e,blockstore:t,loadCodec:r,root:n}){const s=async function*(){let e;try{e=await n.get(Cg)}catch(e){if(e.code===Ng)return void Og("No blocks in MFS");throw e}const s=te.k.decode(e);yield s,yield*Ig(s,t,r)}(),i=(0,Dg.Z)((0,_i.Z)(e.recursiveKeys(),(({cid:e})=>e)),e.indirectKeys(),(0,_i.Z)(e.directKeys(),(({cid:e})=>e)),s),o=new Set;for await(const e of(0,Dg.Z)(i,s))o.add(Kr.base32.encode(e.multihash.bytes));return o}({pins:t,blockstore:r,root:n,loadCodec:s}),a=r.queryKeys({});yield*async function*({blockstore:e},t,r){let n=0,s=0;yield*(0,vi.zG)(Ui((0,_i.Z)(r,(async r=>async function(){n++;try{const n=Kr.base32.encode(r.multihash.bytes);if(t.has(n))return null;try{await e.delete(r),s++}catch(e){return{err:new Error(`Could not delete block with CID ${r}: ${e.message}`)}}return{cid:r}}catch(e){const t=`Could delete block with CID ${r}`;return Og(t,e),{err:new Error(t+`: ${e.message}`)}}})),256),(e=>(0,Ei.Z)(e,Boolean))),Og(`Marked set has ${t.size} unique blocks. Blockstore has ${n} blocks. Deleted ${s} blocks.`)}({blockstore:r},e,a),Og(`Complete (${Date.now()-i}ms)`)}finally{o()}}}({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:t})}async init(e){var t;Mg("initializing at: %s",this.path),await this._openRoot(),await this.config.replace((t=e,t.Datastore=Object.assign({},vg,Ap(t,"datastore")),t)),await this.spec.set(function(e){const t={...vg.Spec,...Ap(e,"Datastore.Spec")};return{type:t.type,mounts:t.mounts.map((e=>({mountpoint:e.mountpoint,type:e.child.type,path:e.child.path,shardFunc:e.child.shardFunc})))}}(e)),await this.version.set(12)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch(e){return!1}}async open(){if(!this.closed)throw j(new Error("repo is already open"),"ERR_REPO_ALREADY_OPEN");Mg("opening at: %s",this.path);try{if(await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),Mg("acquired repo.lock"),!await this.version.check(12)){if(!await this._isAutoMigrationEnabled())throw new sg("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");await this._migrate(12,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys})}Mg("creating datastore"),await this.datastore.open(),Mg("creating blocks"),await this.blocks.open(),Mg("creating keystore"),await this.keys.open(),Mg("creating pins"),await this.pins.pinstore.open(),this.closed=!1,Mg("all opened")}catch(e){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(e){Mg("error removing lock",e)}throw e}}async _openRoot(){try{await this.root.open()}catch(e){if("Already open"!==e.message)throw e}}async _openLock(){const e=await this.options.repoLock.lock(this.path);if("function"!=typeof e.close)throw j(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return e}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){let e;Mg("init check");try{[e]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(e){if("ERR_NOT_FOUND"===e.code)throw j(new Error("repo is not initialized yet"),ig,{path:this.path});throw e}if(!e)throw j(new Error("repo is not initialized yet"),ig,{path:this.path})}async close(){if(this.closed)throw j(new Error("repo is already closed"),"ERR_REPO_ALREADY_CLOSED");Mg("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(e){if(e.code!==ig&&!e.message.startsWith("ENOENT"))throw e}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map((e=>e&&e.close()))),Mg("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[e,t,r,n,s]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),Bg(this.datastore),Bg(this.keys)]),i=t.size+n+s;return{repoPath:this.path,storageMax:e,version:r,numObjects:t.count,repoSize:i}}throw j(new Error("repo is not initialized yet"),ig,{path:this.path})}async _isAutoMigrationEnabled(){if(void 0!==this.options.autoMigrate)return this.options.autoMigrate;let e;try{e=await this.config.get("repoAutoMigrate")}catch(t){if(t.code!==ng.code)throw t;e=!0}return e}async _migrate(e,t){return await this.version.get()>e?(Mg(`reverting to version ${e}`),async function(e,t,r,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??$f;if(!e)throw new eg.RequiredParameterError("Path argument is required!");if(!r)throw new eg.RequiredParameterError("repoOptions argument is required!");if(!n)throw new eg.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(n)||n<=0)throw new eg.InvalidValueError("Version has to be positive integer!");t=af(t);const l=await Yf(t);if(l===n)return void Qf("Nothing to revert.");if(l<n)throw new eg.InvalidValueError(`Current repo's version (${l}) is lower then toVersion (${n}), you probably wanted to migrate it?`);let h;Xf(c,n,l,!0),a||i||(h=await r.repoLock.lock(e)),Qf(`Reverting from version ${l} to ${n}`);try{const e=c.slice().reverse();for(const r of e){if(r.version<=n)break;if(!(r.version>l)){Qf(`Reverting migration version ${r.version}`);try{if(!a){let e=()=>{};o&&(e=(e,t)=>o(r.version,e.toFixed(2),t)),await r.revert(t,e)}}catch(e){const n=r.version;throw Qf(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${n}`),await Jf(n,t),e.message=`During reversion to version ${r.version} exception was raised: ${e.message}`,e}Qf(`Reverting to version ${r.version} finished`)}}a||await Jf(n,t),Qf(`All migrations successfully reverted to version ${n}!`)}finally{a||i||!h||await h.close()}}(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(Mg(`migrating to version ${e}`),async function(e,t,r,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??$f;if(!e)throw new eg.RequiredParameterError("Path argument is required!");if(!r)throw new eg.RequiredParameterError("repoOptions argument is required!");if(!n)throw new eg.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(n)||n<=0)throw new eg.InvalidValueError("Version has to be positive integer!");t=af(t);const l=await Yf(t);if(l===n)return void Qf("Nothing to migrate.");if(l>n)throw new eg.InvalidValueError(`Current repo's version (${l}) is higher then toVersion (${n}), you probably wanted to revert it?`);let h;Xf(c,l,n),a||i||(h=await r.repoLock.lock(e));try{for(const e of c){if(void 0!==n&&e.version>n)break;if(!(e.version<=l)){Qf(`Migrating version ${e.version}`);try{if(!a){let r=()=>{};o&&(r=(t,r)=>o(e.version,t.toFixed(2),r)),await e.migrate(t,r)}}catch(r){const n=e.version-1;throw Qf(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${n}`),await Jf(n,t),new Error(`During migration to version ${e.version} exception was raised: ${r.stack||r.message||r}`)}Qf(`Migrating to version ${e.version} finished`)}}a||await Jf(n||function(e){return e=e||$f,Array.isArray(e)&&0!==e.length?e[e.length-1].version:0}(c),t),Qf("Repo successfully migrated",void 0!==n?`to version ${n}!`:"to latest version!")}finally{a||i||!h||await h.close()}}(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const e=await this.config.get("Datastore.StorageMax");return BigInt(tg(e))}catch(e){return BigInt(Lg)}}async _blockStat(){let e=BigInt(0),t=BigInt(0);if(this.blocks)for await(const{key:r,value:n}of this.blocks.query({}))e+=BigInt(1),t+=BigInt(n.byteLength),t+=BigInt(r.bytes.byteLength);return{count:e,size:t}}}async function Bg(e){let t=BigInt(0);for await(const r of e.query({}))t+=BigInt(r.value.byteLength),t+=BigInt(r.key.uint8Array().byteLength);return t}async function*Ug(e,t){let r=0;if(!(t<1))for await(const n of e)if(yield n,r++,r===t)return}var zg=r(28505),jg=r(35562);class Fg extends Rs.e{constructor(e,t={}){super(),this.db="string"==typeof e?new jg.Level(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t}}async open(){try{await this.db.open(this.opts)}catch(e){throw $n.dbOpenFailedError(e)}}async put(e,t){try{await this.db.put(e.toString(),t)}catch(e){throw $n.dbWriteFailedError(e)}}async get(e){let t;try{t=await this.db.get(e.toString())}catch(e){if(e.notFound)throw $n.notFoundError(e);throw $n.dbWriteFailedError(e)}return t}async has(e){try{await this.db.get(e.toString())}catch(e){if(e.notFound)return!1;throw e}return!0}async delete(e){try{await this.db.del(e.toString())}catch(e){throw $n.dbDeleteFailedError(e)}}close(){return this.db&&this.db.close()}batch(){const e=[];return{put:(t,r)=>{e.push({type:"put",key:t.toString(),value:r})},delete:t=>{e.push({type:"del",key:t.toString()})},commit:()=>this.db.batch(e)}}query(e){let t=this._query({values:!0,prefix:e.prefix});Array.isArray(e.filters)&&(t=e.filters.reduce(((e,t)=>(0,Ei.Z)(e,t)),t)),Array.isArray(e.orders)&&(t=e.orders.reduce(((e,t)=>(0,zg.Z)(e,t)),t));const{offset:r,limit:n}=e;if(r){let e=0;t=(0,Ei.Z)(t,(()=>e++>=r))}return n&&(t=Ug(t,n)),t}queryKeys(e){let t=(0,_i.Z)(this._query({values:!1,prefix:e.prefix}),(({key:e})=>e));Array.isArray(e.filters)&&(t=e.filters.reduce(((e,t)=>(0,Ei.Z)(e,t)),t)),Array.isArray(e.orders)&&(t=e.orders.reduce(((e,t)=>(0,zg.Z)(e,t)),t));const{offset:r,limit:n}=e;if(r){let e=0;t=(0,Ei.Z)(t,(()=>e++>=r))}return n&&(t=Ug(t,n)),t}_query(e){const t={keys:!0,keyEncoding:"buffer",values:e.values};if(null!=e.prefix){const r=e.prefix.toString();t.gte=r,t.lt=r+""}const r=this.db.iterator(t);if(r[Symbol.asyncIterator])return async function*(e){for await(const[t,r]of e)yield{key:new hn.s(t,!1),value:r};await e.close()}(r);if(null!=r.next&&null!=r.end)return n=r,{[Symbol.asyncIterator]:()=>({next:()=>new Promise(((e,t)=>{n.next(((r,s,i)=>r?t(r):null==s?n.end((r=>{if(r)return t(r);e({done:!0,value:void 0})})):void e({done:!1,value:{key:new hn.s(s,!1),value:i}})))})),return:()=>new Promise(((e,t)=>{n.end((r=>{if(r)return t(r);e({done:!0,value:void 0})}))}))})};var n;throw new Error("Level returned incompatible iterator")}}var Vg=r(80630),$g=r(19418),Hg=r(16276);const Gg=(e,t)=>async function*(){const r=await Hg(e);yield*r.sort(t)}();class qg{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:n}of e)await this.put(r,n,t),yield{key:r,value:n}}async*getMany(e,t={}){for await(const r of e)yield this.get(r,t)}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(t,r){e.push({key:t,value:r})},delete(e){t.push(e)},commit:async r=>{await Vg(this.putMany(e,r)),e=[],await Vg(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(null!=e.prefix&&(r=$g(r,(t=>t.key.toString().startsWith(e.prefix||"")))),Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>$g(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>Gg(e,t)),r)),null!=e.offset){let t=0;r=$g(r,(()=>t++>=(e.offset||0)))}return null!=e.limit&&(r=Cs(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(null!=e.prefix&&(r=$g(r,(t=>t.toString().startsWith(e.prefix||"")))),Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>$g(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>Gg(e,t)),r)),null!=e.offset){let t=0;r=$g(r,(()=>t++>=e.offset))}return null!=e.limit&&(r=Cs(r,e.limit)),r}}function Kg(e){const t=te.k.asCID(e);if(!t)throw j(new Error("Not a valid cid"),"ERR_INVALID_CID");return new hn.s("/"+Kr.base32.encode(t.multihash.bytes).slice(1).toUpperCase(),!1)}function Wg(e){return te.k.createV1(qi.code,Wr.Jx(Kr.base32.decode("b"+e.toString().slice(1).toLowerCase())))}function Zg(e){const t=e.substring(0,1);if("/"===t)return Zg(e.substring(1));let r,n;r="b"===t.toLowerCase()?e=>Kr.base32.decode(e.toLowerCase()).subarray(2):"c"===t.toLowerCase()?e=>Kr.base32pad.decode(e.toLowerCase()).subarray(2):"z"===t?e=>qr.base58btc.decode(e).subarray(2):"Q"===t?e=>qr.base58btc.decode("z"+e):e=>Kr.base32.decode("b"+e.toLowerCase()).subarray(2);for(let t=1;t<e.length;t++)try{n=r(e.substring(0,t))}catch(e){if("Unexpected end of data"!==e.message)throw e}let s="/C";return n&&(s=`/${Kr.base32.encode(n).slice(1,-1).toUpperCase()||"C"}`),s}class Yg extends qg{constructor(e){super(),this.child=e}open(){return this.child.open()}close(){return this.child.close()}async*query(e,t){for await(const{key:r,value:n}of this.child.query(function(e){return{...e,prefix:e.prefix?Zg(e.prefix):void 0,filters:e.filters?e.filters.map((e=>t=>e({key:Wg(t.key),value:t.value}))):void 0,orders:e.orders?e.orders.map((e=>(t,r)=>e({key:Wg(t.key),value:t.value},{key:Wg(r.key),value:r.value}))):void 0}}(e),t))yield{key:Wg(r),value:n}}async*queryKeys(e,t){for await(const r of this.child.queryKeys(function(e){return{...e,prefix:e.prefix?Zg(e.prefix):void 0,filters:e.filters?e.filters.map((e=>t=>e(Wg(t)))):void 0,orders:e.orders?e.orders.map((e=>(t,r)=>e(Wg(t),Wg(r)))):void 0}}(e),t))yield Wg(r)}async get(e,t){return this.child.get(Kg(e),t)}async*getMany(e,t){for await(const r of e)yield this.get(r,t)}async put(e,t,r){await this.child.put(Kg(e),t,r)}async*putMany(e,t){const r=(0,Is.d)({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)((async()=>{try{const n=this.child;await(0,qs.Z)(this.child.putMany(async function*(){for await(const s of e){const e=Kg(s.key);await n.has(e,t)||(yield{key:e,value:s.value}),r.push(s)}}())),r.end()}catch(e){r.end(e)}})),yield*r}has(e,t){return this.child.has(Kg(e),t)}delete(e,t){return this.child.delete(Kg(e),t)}deleteMany(e,t){const r=(0,Is.d)({objectMode:!0});return(0,qs.Z)(this.child.deleteMany(async function*(){for await(const t of e)yield Kg(t),r.push(t);r.end()}(),t)).catch((e=>{r.end(e)})),r}}function Jg(e,t,r){const n=r.path||"ipfs";return function(e,r,n,s){return new xg(e,(e=>t.getCodec(e)),n,s)}(n,0,{root:new Fg(n,{prefix:"",version:2}),blocks:new Yg(new Fg(`${n}/blocks`,{prefix:"",version:2})),datastore:new Fg(`${n}/datastore`,{prefix:"",version:2}),keys:new Fg(`${n}/keys`,{prefix:"",version:2}),pins:new Fg(`${n}/pins`,{prefix:"",version:2})},{autoMigrate:r.autoMigrate,onMigrationProgress:r.onMigrationProgress||e,repoLock:_g})}var Qg=r(56179),Xg=r(60164);const ey=()=>{};class ty{constructor(e){this.min=e.min??0,this.max=e.max??1/0,this.peers=new Set,this.onConnect=e.onConnect??ey,this.onDisconnect=e.onDisconnect??ey}get[Symbol.toStringTag](){return Xg.d.toString()}get[Xg.d](){return!0}async setRegistrar(e){this.registrar=e}disconnect(e){this.onDisconnect(e)}}function ry(e){return new ty(e)}var ny=r(23250);class sy{constructor(e,t,r){this.gossip=e,this.msgs=new Map,this.history=[],this.msgIdToStrFn=r;for(let e=0;e<t;e++)this.history[e]=[]}get size(){return this.msgs.size}put(e,t,r=!1){const{msgIdStr:n}=e;return!this.msgs.has(n)&&(this.msgs.set(n,{message:t,validated:r,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),!0)}observeDuplicate(e,t){const r=this.msgs.get(e);r&&!r.validated&&r.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const r=this.msgs.get(e);if(!r)return null;const n=(r.iwantCounts.get(t)??0)+1;return r.iwantCounts.set(t,n),{msg:r.message,count:n}}getGossipIDs(e){const t=new Map;for(let r=0;r<this.gossip;r++)this.history[r].forEach((r=>{const n=this.msgs.get(r.msgIdStr);if(n&&n.validated&&e.has(r.topic)){let e=t.get(r.topic);e||(e=[],t.set(r.topic,e)),e.push(r.msgId)}}));return t}validate(e){const t=this.msgs.get(e);if(!t)return null;const{message:r,originatingPeers:n}=t;return t.validated=!0,t.originatingPeers=new Set,{message:r,originatingPeers:n}}shift(){this.history[this.history.length-1].forEach((e=>{this.msgs.delete(e.msgIdStr)})),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}var iy=r(64482);const{RPC:oy}=iy,ay="/floodsub/1.0.0",cy="/meshsub/1.0.0",ly="/meshsub/1.1.0",hy=5e3;function dy(e=[],t){return{subscriptions:[],messages:e,control:t?{graft:t.graft||[],prune:t.prune||[],ihave:t.ihave||[],iwant:t.iwant||[]}:void 0}}function uy(e){if(e.length<=1)return e;for(let t=0;t<e.length;t++){const r=Math.floor(Math.random()*Math.floor(e.length)),n=e[t];e[t]=e[r],e[r]=n}return e}const py=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var s=0;s<e.length;s++){var i=e.charAt(s),o=i.charCodeAt(0);if(255!==r[o])throw new TypeError(i+" is ambiguous");r[o]=s}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var n=0,s=0;e[t]===c;)n++,t++;for(var i=(e.length-t)*l+1>>>0,o=new Uint8Array(i);e[t];){var h=r[e.charCodeAt(t)];if(255===h)return;for(var d=0,u=i-1;(0!==h||d<s)&&-1!==u;u--,d++)h+=a*o[u]>>>0,o[u]=h%256>>>0,h=h/256>>>0;if(0!==h)throw new Error("Non-zero carry");s=d,t++}if(" "!==e[t]){for(var p=i-s;p!==i&&0===o[p];)p++;for(var f=new Uint8Array(n+(i-p)),g=n;p!==i;)f[g++]=o[p++];return f}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,s=0,i=t.length;s!==i&&0===t[s];)s++,r++;for(var o=(i-s)*h+1>>>0,l=new Uint8Array(o);s!==i;){for(var d=t[s],u=0,p=o-1;(0!==d||u<n)&&-1!==p;p--,u++)d+=256*l[p]>>>0,l[p]=d%a>>>0,d=d/a>>>0;if(0!==d)throw new Error("Non-zero carry");n=u,s++}for(var f=o-n;f!==o&&0===l[f];)f++;for(var g=c.repeat(r);f<o;++f)g+=e.charAt(l[f]);return g},decodeUnsafe:d,decode:function(e){var r=d(e);if(r)return r;throw new Error(`Non-${t} character`)}}},fy=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class gy{constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class yy{constructor(e,t,r){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=r}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return wy(this,e)}}class my{constructor(e){this.decoders=e}or(e){return wy(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const wy=(e,t)=>new my({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class by{constructor(e,t,r,n){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=n,this.encoder=new gy(e,t,r),this.decoder=new yy(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const _y=({name:e,prefix:t,encode:r,decode:n})=>new by(e,t,r,n),Ey=({prefix:e,name:t,alphabet:r})=>{const{encode:n,decode:s}=py(r,t);return _y({prefix:e,name:t,encode:n,decode:e=>fy(s(e))})},vy=({name:e,prefix:t,bitsPerChar:r,alphabet:n})=>_y({prefix:t,name:e,encode:e=>((e,t,r)=>{const n="="===t[t.length-1],s=(1<<r)-1;let i="",o=0,a=0;for(let n=0;n<e.length;++n)for(a=a<<8|e[n],o+=8;o>r;)o-=r,i+=t[s&a>>o];if(o&&(i+=t[s&a<<r-o]),n)for(;i.length*r&7;)i+="=";return i})(e,n,r),decode:t=>((e,t,r,n)=>{const s={};for(let e=0;e<t.length;++e)s[t[e]]=e;let i=e.length;for(;"="===e[i-1];)--i;const o=new Uint8Array(i*r/8|0);let a=0,c=0,l=0;for(let t=0;t<i;++t){const i=s[e[t]];if(void 0===i)throw new SyntaxError(`Non-${n} character`);c=c<<r|i,a+=r,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=r||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o})(t,n,r,e)}),ky=_y({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),Sy=vy({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Ry=vy({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Iy=Ey({prefix:"9",name:"base10",alphabet:"0123456789"}),Ty=vy({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Ay=vy({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Py=vy({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Dy=vy({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Oy=vy({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ny=vy({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Cy=vy({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),My=vy({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ly=vy({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),xy=vy({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),By=vy({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Uy=Ey({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),zy=Ey({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),jy=Ey({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Fy=Ey({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Vy=vy({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),$y=vy({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Hy=vy({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Gy=vy({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),qy=Array.from(""),Ky=qy.reduce(((e,t,r)=>(e[r]=t,e)),[]),Wy=qy.reduce(((e,t,r)=>(e[t.codePointAt(0)]=r,e)),[]),Zy=_y({prefix:"",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+Ky[t]),"")},decode:function(e){const t=[];for(const r of e){const e=Wy[r.codePointAt(0)];if(void 0===e)throw new Error(`Non-base256emoji character: ${r}`);t.push(e)}return new Uint8Array(t)}});var Yy=Math.pow(2,31),Jy=Math.pow(2,7),Qy=Math.pow(2,14),Xy=Math.pow(2,21),em=Math.pow(2,28),tm=Math.pow(2,35),rm=Math.pow(2,42),nm=Math.pow(2,49),sm=Math.pow(2,56),im=Math.pow(2,63);const om=function e(t,r,n){r=r||[];for(var s=n=n||0;t>=Yy;)r[n++]=255&t|128,t/=128;for(;-128&t;)r[n++]=255&t|128,t>>>=7;return r[n]=0|t,e.bytes=n-s+1,r},am=function(e){return e<Jy?1:e<Qy?2:e<Xy?3:e<em?4:e<tm?5:e<rm?6:e<nm?7:e<sm?8:e<im?9:10},cm=(e,t,r=0)=>(om(e,t,r),t),lm=e=>am(e),hm=(e,t)=>{const r=t.byteLength,n=lm(e),s=n+lm(r),i=new Uint8Array(s+r);return cm(e,i,0),cm(r,i,n),i.set(t,s),new dm(e,r,t,i)};class dm{constructor(e,t,r,n){this.code=e,this.size=t,this.digest=r,this.bytes=n}}const um=({name:e,code:t,encode:r})=>new pm(e,t,r);class pm{constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?hm(this.code,t):t.then((e=>hm(this.code,e)))}throw Error("Unknown type, must be binary type")}}const fm=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),gm=um({name:"sha2-256",code:18,encode:fm("SHA-256")}),ym=um({name:"sha2-512",code:19,encode:fm("SHA-512")}),mm=fy,wm={code:0,name:"identity",encode:mm,digest:e=>hm(0,mm(e))},bm="raw",_m=85,Em=e=>fy(e),vm=e=>fy(e),km=new TextEncoder,Sm=new TextDecoder,Rm="json",Im=512,Tm=e=>km.encode(JSON.stringify(e)),Am=e=>JSON.parse(Sm.decode(e));r(82784);class Pm{constructor(e,t,r,n){this.code=t,this.version=e,this.multihash=r,this.bytes=n,this.byteOffset=n.byteOffset,this.byteLength=n.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:cid_hidden,byteLength:cid_hidden,code:cid_readonly,version:cid_readonly,multihash:cid_readonly,bytes:cid_readonly,_baseCache:cid_hidden,asCID:cid_hidden})}toV0(){if(0===this.version)return this;{const{code:e,multihash:t}=this;if(e!==DAG_PB_CODE)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==SHA_256_CODE)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Pm.createV0(t)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=Digest.create(e,t);return Pm.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&Digest.equals(this.multihash,e.multihash)}toString(e){const{bytes:t,version:r,_baseCache:n}=this;return 0===r?toStringV0(t,n,e||base58btc.encoder):toStringV1(t,n,e||base32.encoder)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return deprecate(/^0\.0/,IS_CID_DEPRECATION),!(!e||!e[cidSymbol]&&e.asCID!==e)}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof Pm)return e;if(null!=e&&e.asCID===e){const{version:t,code:r,multihash:n,bytes:s}=e;return new Pm(t,r,n,s||encodeCID(t,r,n.bytes))}if(null!=e&&!0===e[cidSymbol]){const{version:t,multihash:r,code:n}=e,s=Digest.decode(r);return Pm.create(t,n,s)}return null}static create(e,t,r){if("number"!=typeof t)throw new Error("String codecs are no longer supported");switch(e){case 0:if(t!==DAG_PB_CODE)throw new Error(`Version 0 CID must use dag-pb (code: ${DAG_PB_CODE}) block encoding`);return new Pm(e,t,r,r.bytes);case 1:{const n=encodeCID(e,t,r.bytes);return new Pm(e,t,r,n)}default:throw new Error("Invalid version")}}static createV0(e){return Pm.create(0,DAG_PB_CODE,e)}static createV1(e,t){return Pm.create(1,e,t)}static decode(e){const[t,r]=Pm.decodeFirst(e);if(r.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Pm.inspectBytes(e),r=t.size-t.multihashSize,n=coerce(e.subarray(r,r+t.multihashSize));if(n.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=n.subarray(t.multihashSize-t.digestSize),i=new Digest.Digest(t.multihashCode,t.digestSize,s,n);return[0===t.version?Pm.createV0(i):Pm.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){const t=()=>{const[t,r]=varint.decode(e.subarray(0));return t};let r=t(),n=DAG_PB_CODE;if(18===r||1===r&&t(),0!==r&&1!==r)throw new RangeError(`Invalid CID version ${r}`);const s=t(),i=t(),o=0+i;return{version:r,codec:n,multihashCode:s,digestSize:i,multihashSize:o-0,size:o}}static parse(e,t){const[r,n]=parseCIDtoBytes(e,t),s=Pm.decode(n);return s._baseCache.set(r,e),s}}Symbol.for("@ipld/js-cid/CID");const Dm={...c,...l,...h,...d,...u,...p,...f,...g,...y,...m};function Om(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function Nm(e=0){return null!=globalThis.Buffer&&null!=globalThis.Buffer.allocUnsafe?Om(globalThis.Buffer.allocUnsafe(e)):new Uint8Array(e)}function Cm(e,t,r,n){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:r},decoder:{decode:n}}}const Mm=Cm("utf8","u",(e=>"u"+new TextDecoder("utf8").decode(e)),(e=>(new TextEncoder).encode(e.substring(1)))),Lm=Cm("ascii","a",(e=>{let t="a";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}),(e=>{const t=Nm((e=e.substring(1)).length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t})),xm={utf8:Mm,"utf-8":Mm,hex:Dm.base16,latin1:Lm,ascii:Lm,binary:Lm,...Dm};function Bm(e,t="utf8"){const r=xm[t];if(!r)throw new Error(`Unsupported encoding "${t}"`);return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?r.encoder.encode(e).substring(1):globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("utf8")}function Um(e){return Bm(e,"base64")}const zm="StrictSign",jm="StrictNoSign";var Fm,Vm,$m,Hm,Gm,qm;function Km(e){switch(e){case $m.Ignore:return Hm.Ignore;case $m.Reject:return Hm.Reject}}!function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(Fm||(Fm={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(Vm||(Vm={})),function(e){e.Accept="accept",e.Ignore="ignore",e.Reject="reject"}($m||($m={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(Hm||(Hm={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(Gm||(Gm={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(qm||(qm={}));const Wm="ERR_INVALID_PEER_SCORE_PARAMS",Zm={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},Ym={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Jm(e={}){return{...Zm,...e,topics:e.topics?Object.entries(e.topics).reduce(((e,[t,r])=>(e[t]=function(e={}){return{...Ym,...e}}(r),e)),{}):{}}}function Qm(e){if(e.topicWeight<0)throw j(new Error("invalid topic weight; must be >= 0"),Wm);if(0===e.timeInMeshQuantum)throw j(new Error("invalid TimeInMeshQuantum; must be non zero"),Wm);if(e.timeInMeshWeight<0)throw j(new Error("invalid TimeInMeshWeight; must be positive (or 0 to disable)"),Wm);if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw j(new Error("invalid TimeInMeshQuantum; must be positive"),Wm);if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw j(new Error("invalid TimeInMeshCap; must be positive"),Wm);if(e.firstMessageDeliveriesWeight<0)throw j(new Error("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)"),Wm);if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw j(new Error("invalid FirstMessageDeliveriesDecay; must be between 0 and 1"),Wm);if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw j(new Error("invalid FirstMessageDeliveriesCap; must be positive"),Wm);if(e.meshMessageDeliveriesWeight>0)throw j(new Error("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)"),Wm);if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw j(new Error("invalid MeshMessageDeliveriesDecay; must be between 0 and 1"),Wm);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw j(new Error("invalid MeshMessageDeliveriesCap; must be positive"),Wm);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw j(new Error("invalid MeshMessageDeliveriesThreshold; must be positive"),Wm);if(e.meshMessageDeliveriesWindow<0)throw j(new Error("invalid MeshMessageDeliveriesWindow; must be non-negative"),Wm);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw j(new Error("invalid MeshMessageDeliveriesActivation; must be at least 1s"),Wm);if(e.meshFailurePenaltyWeight>0)throw j(new Error("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)"),Wm);if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw j(new Error("invalid MeshFailurePenaltyDecay; must be between 0 and 1"),Wm);if(e.invalidMessageDeliveriesWeight>0)throw j(new Error("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)"),Wm);if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw j(new Error("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1"),Wm)}const Xm={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function ew(e={}){return{...Xm,...e}}function tw(e,t,r,n){let s=0;Object.entries(t.topics).forEach((([e,t])=>{const n=r.topics[e];if(void 0===n)return;let i=0;if(t.inMesh){let e=t.meshTime/n.timeInMeshQuantum;e>n.timeInMeshCap&&(e=n.timeInMeshCap),i+=e*n.timeInMeshWeight}let o=t.firstMessageDeliveries;if(o>n.firstMessageDeliveriesCap&&(o=n.firstMessageDeliveriesCap),i+=o*n.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<n.meshMessageDeliveriesThreshold){const e=n.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;i+=e*e*n.meshMessageDeliveriesWeight}i+=t.meshFailurePenalty*n.meshFailurePenaltyWeight,i+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*n.invalidMessageDeliveriesWeight,s+=i*n.topicWeight})),r.topicScoreCap>0&&s>r.topicScoreCap&&(s=r.topicScoreCap);const i=r.appSpecificScore(e);if(s+=i*r.appSpecificWeight,t.ips.forEach((e=>{if(r.IPColocationFactorWhitelist.has(e))return;const t=n.get(e),i=t?t.size:0;if(i>r.IPColocationFactorThreshold){const e=i-r.IPColocationFactorThreshold;s+=e*e*r.IPColocationFactorWeight}})),t.behaviourPenalty>r.behaviourPenaltyThreshold){const e=t.behaviourPenalty-r.behaviourPenaltyThreshold;s+=e*e*r.behaviourPenaltyWeight}return s}var rw,nw=r(19301);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(rw||(rw={}));class sw{constructor(){this.records=new Map,this.queue=new nw}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:rw.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const r={msgId:e,expire:Date.now()+12e4};return this.queue.push(r),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}var iw=r(40841);function ow(e){return null!=e&&"function"==typeof e.init}class aw{constructor(e={}){this.started=!1,null!=e.peerId&&this.setPeerId(e.peerId),null!=e.addressManager&&this.setAddressManager(e.addressManager),null!=e.peerStore&&this.setPeerStore(e.peerStore),null!=e.upgrader&&this.setUpgrader(e.upgrader),null!=e.metrics&&this.setMetrics(e.metrics),null!=e.registrar&&this.setRegistrar(e.registrar),null!=e.connectionManager&&this.setConnectionManager(e.connectionManager),null!=e.transportManager&&this.setTransportManager(e.transportManager),null!=e.connectionGater&&this.setConnectionGater(e.connectionGater),null!=e.contentRouting&&this.setContentRouting(e.contentRouting),null!=e.peerRouting&&this.setPeerRouting(e.peerRouting),null!=e.datastore&&this.setDatastore(e.datastore),null!=e.connectionProtector&&this.setConnectionProtector(e.connectionProtector),null!=e.dht&&this.setDHT(e.dht),null!=e.pubsub&&this.setPubSub(e.pubsub),null!=e.dialer&&this.setDialer(e.dialer)}isStarted(){return this.started}async beforeStart(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.beforeStart&&await e.beforeStart()})))}async start(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{await e.start()}))),this.started=!0}async afterStart(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.afterStart&&await e.afterStart()})))}async beforeStop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.beforeStop&&await e.beforeStop()})))}async stop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{await e.stop()}))),this.started=!1}async afterStop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.afterStop&&await e.afterStop()})))}setPeerId(e){return this.peerId=e,e}getPeerId(){if(null==this.peerId)throw j(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this.peerId}setMetrics(e){return this.metrics=e,ow(e)&&e.init(this),e}getMetrics(){return this.metrics}setAddressManager(e){return this.addressManager=e,ow(e)&&e.init(this),e}getAddressManager(){if(null==this.addressManager)throw j(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this.addressManager}setPeerStore(e){return this.peerStore=e,ow(e)&&e.init(this),e}getPeerStore(){if(null==this.peerStore)throw j(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this.peerStore}setUpgrader(e){return this.upgrader=e,ow(e)&&e.init(this),e}getUpgrader(){if(null==this.upgrader)throw j(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this.upgrader}setRegistrar(e){return this.registrar=e,ow(e)&&e.init(this),e}getRegistrar(){if(null==this.registrar)throw j(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this.registrar}setConnectionManager(e){return this.connectionManager=e,ow(e)&&e.init(this),e}getConnectionManager(){if(null==this.connectionManager)throw j(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this.connectionManager}setTransportManager(e){return this.transportManager=e,ow(e)&&e.init(this),e}getTransportManager(){if(null==this.transportManager)throw j(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this.transportManager}setConnectionGater(e){return this.connectionGater=e,ow(e)&&e.init(this),e}getConnectionGater(){if(null==this.connectionGater)throw j(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this.connectionGater}setContentRouting(e){return this.contentRouting=e,ow(e)&&e.init(this),e}getContentRouting(){if(null==this.contentRouting)throw j(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this.contentRouting}setPeerRouting(e){return this.peerRouting=e,ow(e)&&e.init(this),e}getPeerRouting(){if(null==this.peerRouting)throw j(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this.peerRouting}setDatastore(e){return this.datastore=e,ow(e)&&e.init(this),e}getDatastore(){if(null==this.datastore)throw j(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this.datastore}setConnectionProtector(e){return this.connectionProtector=e,ow(e)&&e.init(this),e}getConnectionProtector(){return this.connectionProtector}setDHT(e){return this.dht=e,ow(e)&&e.init(this),e}getDHT(){if(null==this.dht)throw j(new Error("dht not set"),"ERR_SERVICE_MISSING");return this.dht}setPubSub(e){return this.pubsub=e,ow(e)&&e.init(this),e}getPubSub(){if(null==this.pubsub)throw j(new Error("pubsub not set"),"ERR_SERVICE_MISSING");return this.pubsub}setDialer(e){return this.dialer=e,ow(e)&&e.init(this),e}getDialer(){if(null==this.dialer)throw j(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this.dialer}}const cw=(0,z.kg)("libp2p:gossipsub:score");class lw{constructor(e,t,r){this.params=e,this.metrics=t,this.peerStats=new Map,this.peerIPs=new Map,this.scoreCache=new Map,this.deliveryRecords=new sw,this.components=new aw,function(e){for(const[t,r]of Object.entries(e.topics))try{Qm(r)}catch(e){throw j(new Error(`invalid score parameters for topic ${t}: ${e.message}`),Wm)}if(e.topicScoreCap<0)throw j(new Error("invalid topic score cap; must be positive (or 0 for no cap)"),Wm);if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw j(new Error("missing application specific score function"),Wm);if(e.IPColocationFactorWeight>0)throw j(new Error("invalid IPColocationFactorWeight; must be negative (or 0 to disable)"),Wm);if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw j(new Error("invalid IPColocationFactorThreshold; must be at least 1"),Wm);if(e.behaviourPenaltyWeight>0)throw j(new Error("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)"),Wm);if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw j(new Error("invalid BehaviourPenaltyDecay; must be between 0 and 1"),Wm);if(e.decayInterval<1e3)throw j(new Error("invalid DecayInterval; must be at least 1s"),Wm);if(e.decayToZero<=0||e.decayToZero>=1)throw j(new Error("invalid DecayToZero; must be between 0 and 1"),Wm)}(e),this.scoreCacheValidityMs=r.scoreCacheValidityMs,this.computeScore=r.computeScore??tw}init(e){this.components=e}get size(){return this.peerStats.size}start(){this._backgroundInterval?cw("Peer score already running"):(this._backgroundInterval=setInterval((()=>this.background()),this.params.decayInterval),cw("started"))}stop(){this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),cw("stopped")):cw("Peer score already stopped")}background(){this.refreshScores(),this.updateIPs(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map((([e,t])=>[e,t])))}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach(((r,n)=>{r.connected?(Object.entries(r.topics).forEach((([r,n])=>{const s=this.params.topics[r];void 0!==s&&(n.firstMessageDeliveries*=s.firstMessageDeliveriesDecay,n.firstMessageDeliveries<t&&(n.firstMessageDeliveries=0),n.meshMessageDeliveries*=s.meshMessageDeliveriesDecay,n.meshMessageDeliveries<t&&(n.meshMessageDeliveries=0),n.meshFailurePenalty*=s.meshFailurePenaltyDecay,n.meshFailurePenalty<t&&(n.meshFailurePenalty=0),n.invalidMessageDeliveries*=s.invalidMessageDeliveriesDecay,n.invalidMessageDeliveries<t&&(n.invalidMessageDeliveries=0),n.inMesh&&(n.meshTime=e-n.graftTime,n.meshTime>s.meshMessageDeliveriesActivation&&(n.meshMessageDeliveriesActive=!0)))})),r.behaviourPenalty*=this.params.behaviourPenaltyDecay,r.behaviourPenalty<t&&(r.behaviourPenalty=0)):e>r.expire&&(this.removeIPs(n,r.ips),this.peerStats.delete(n),this.scoreCache.delete(n))}))}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(!t)return 0;const r=Date.now(),n=this.scoreCache.get(e);if(n&&n.cacheUntil>r)return n.score;this.metrics?.scoreFnRuns.inc();const s=this.computeScore(e,t,this.params,this.peerIPs),i=r+this.scoreCacheValidityMs;return n?(this.metrics?.scoreCachedDelta.observe(Math.abs(s-n.score)),n.score=s,n.cacheUntil=i):this.scoreCache.set(e,{score:s,cacheUntil:i}),s}addPenalty(e,t,r){const n=this.peerStats.get(e);n&&(n.behaviourPenalty+=t,this.metrics?.onScorePenalty(r))}addPeer(e){const t={connected:!0,expire:0,topics:{},ips:[],behaviourPenalty:0};this.peerStats.set(e,t);const r=this.getIPs(e);this.setIPs(e,r,t.ips),t.ips=r}removePeer(e){const t=this.peerStats.get(e);if(t){if(this.score(e)>0)return this.removeIPs(e,t.ips),void this.peerStats.delete(e);Object.entries(t.topics).forEach((([e,t])=>{t.firstMessageDeliveries=0;const r=this.params.topics[e].meshMessageDeliveriesThreshold;if(t.inMesh&&t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<r){const e=r-t.meshMessageDeliveries;t.meshFailurePenalty+=e*e}t.inMesh=!1,t.meshMessageDeliveriesActive=!1})),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const r=this.peerStats.get(e);if(r){const e=this.getPtopicStats(r,t);e&&(e.inMesh=!0,e.graftTime=Date.now(),e.meshTime=0,e.meshMessageDeliveriesActive=!1)}}prune(e,t){const r=this.peerStats.get(e);if(r){const e=this.getPtopicStats(r,t);if(e){const r=this.params.topics[t].meshMessageDeliveriesThreshold;if(e.meshMessageDeliveriesActive&&e.meshMessageDeliveries<r){const t=r-e.meshMessageDeliveries;e.meshFailurePenalty+=t*t}e.meshMessageDeliveriesActive=!1,e.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,r){this.markFirstMessageDelivery(e,r);const n=this.deliveryRecords.ensureRecord(t),s=Date.now();n.status===rw.unknown?(n.status=rw.valid,n.validated=s,n.peers.forEach((t=>{t!==e.toString()&&this.markDuplicateMessageDelivery(t,r)}))):cw("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,s-n.firstSeen,rw[n.status])}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,r,n){switch(n){case Hm.Error:return void this.markInvalidMessageDelivery(e,r);case Hm.Blacklisted:return}const s=this.deliveryRecords.ensureRecord(t);if(s.status===rw.unknown){if(n===Hm.Ignore)return s.status=rw.ignored,void s.peers.clear();s.status=rw.invalid,this.markInvalidMessageDelivery(e,r),s.peers.forEach((e=>{this.markInvalidMessageDelivery(e,r)})),s.peers.clear()}else cw("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-s.firstSeen,rw[s.status])}duplicateMessage(e,t,r){const n=this.deliveryRecords.ensureRecord(t);if(!n.peers.has(e))switch(n.status){case rw.unknown:n.peers.add(e);break;case rw.valid:n.peers.add(e),this.markDuplicateMessageDelivery(e,r,n.validated);break;case rw.invalid:this.markInvalidMessageDelivery(e,r);case rw.ignored:}}markInvalidMessageDelivery(e,t){const r=this.peerStats.get(e);if(r){const e=this.getPtopicStats(r,t);e&&(e.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const r=this.peerStats.get(e);if(r){const e=this.getPtopicStats(r,t);if(e){let r=this.params.topics[t].firstMessageDeliveriesCap;e.firstMessageDeliveries=Math.min(r,e.firstMessageDeliveries+1),e.inMesh&&(r=this.params.topics[t].meshMessageDeliveriesCap,e.meshMessageDeliveries=Math.min(r,e.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,r){const n=this.peerStats.get(e);if(n){const e=void 0!==r?Date.now():0,s=this.getPtopicStats(n,t);if(s&&s.inMesh){const n=this.params.topics[t];if(void 0!==r){const s=e-r,i=s>n.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,s,i),i)return}const i=n.meshMessageDeliveriesCap;s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1)}}}getIPs(e){return this.components.getConnectionManager().getConnections((0,Ln.jE)(e)).map((e=>e.remoteAddr.toOptions().host))}setIPs(e,t,r){e:for(const n of t){for(const e of r)if(n===e)continue e;let t=this.peerIPs.get(n);t||(t=new Set,this.peerIPs.set(n,t)),t.add(e)}e:for(const n of r){for(const e of t)if(n===e)continue e;const r=this.peerIPs.get(n);r&&(r.delete(e),r.size||this.peerIPs.delete(n))}}removeIPs(e,t){t.forEach((t=>{const r=this.peerIPs.get(t);r&&(r.delete(e),r.size||this.peerIPs.delete(t))}))}updateIPs(){this.peerStats.forEach(((e,t)=>{const r=this.getIPs(t);this.setIPs(t,r,e.ips),e.ips=r}))}getPtopicStats(e,t){let r=e.topics[t];return void 0!==r?r:void 0!==this.params.topics[t]?(r={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=r,r):null}}class hw{constructor(e,t,r){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=r,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const r=t[Math.floor(Math.random()*t.length)],n=this.msgIdToStrFn(r);let s=this.promises.get(n);s||(s=new Map,this.promises.set(n,s));const i=Date.now();s.has(e)||(s.set(e,i+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(n)||this.requestMsByMsg.set(n,i)))}getBrokenPromises(){const e=Date.now(),t=new Map;let r=0;return this.promises.forEach(((n,s)=>{n.forEach(((s,i)=>{s<e&&(t.set(i,(t.get(i)??0)+1),n.delete(i),r++)})),n.size||this.promises.delete(s)})),this.metrics?.iwantPromiseBroken.inc(r),t}deliverMessage(e){this.trackMessage(e);const t=this.promises.get(e);t&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(t.size)))}rejectMessage(e,t){this.trackMessage(e),t!==Hm.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;for(const[t,r]of this.requestMsByMsg.entries()){if(!(r<e))break;this.requestMsByMsg.delete(t)}}trackMessage(e){if(this.metrics){const t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}class dw{constructor(e){this.entries=new Map,this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs})}prune(){const e=Date.now();for(const[t,r]of this.entries.entries()){if(!(r.validUntilMs<e))break;this.entries.delete(t)}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var uw,pw,fw,gw,yw,mw;function ww(e,t){t||(t=e.reduce(((e,t)=>e+t.length),0));const r=Nm(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return Om(r)}!function(e){e.forward="forward",e.publish="publish"}(uw||(uw={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(pw||(pw={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Unsub="unsubscribed",e.Excess="excess"}(fw||(fw={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(gw||(gw={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(yw||(yw={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(mw||(mw={}));var bw=r(31490);const _w=function(e,t="utf8"){const r=xm[t];if(!r)throw new Error(`Unsupported encoding "${t}"`);return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?r.decoder.decode(`${r.prefix}${e}`):Om(globalThis.Buffer.from(e,"utf-8"))}("libp2p-pubsub:");const Ew=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var s=0;s<e.length;s++){var i=e.charAt(s),o=i.charCodeAt(0);if(255!==r[o])throw new TypeError(i+" is ambiguous");r[o]=s}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var n=0,s=0;e[t]===c;)n++,t++;for(var i=(e.length-t)*l+1>>>0,o=new Uint8Array(i);e[t];){var h=r[e.charCodeAt(t)];if(255===h)return;for(var d=0,u=i-1;(0!==h||d<s)&&-1!==u;u--,d++)h+=a*o[u]>>>0,o[u]=h%256>>>0,h=h/256>>>0;if(0!==h)throw new Error("Non-zero carry");s=d,t++}if(" "!==e[t]){for(var p=i-s;p!==i&&0===o[p];)p++;for(var f=new Uint8Array(n+(i-p)),g=n;p!==i;)f[g++]=o[p++];return f}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,s=0,i=t.length;s!==i&&0===t[s];)s++,r++;for(var o=(i-s)*h+1>>>0,l=new Uint8Array(o);s!==i;){for(var d=t[s],u=0,p=o-1;(0!==d||u<n)&&-1!==p;p--,u++)d+=256*l[p]>>>0,l[p]=d%a>>>0,d=d/a>>>0;if(0!==d)throw new Error("Non-zero carry");n=u,s++}for(var f=o-n;f!==o&&0===l[f];)f++;for(var g=c.repeat(r);f<o;++f)g+=e.charAt(l[f]);return g},decodeUnsafe:d,decode:function(e){var r=d(e);if(r)return r;throw new Error(`Non-${t} character`)}}},vw=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class kw{constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Sw{constructor(e,t,r){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=r}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return Iw(this,e)}}class Rw{constructor(e){this.decoders=e}or(e){return Iw(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const Iw=(e,t)=>new Rw({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class Tw{constructor(e,t,r,n){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=n,this.encoder=new kw(e,t,r),this.decoder=new Sw(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Aw=({name:e,prefix:t,encode:r,decode:n})=>new Tw(e,t,r,n),Pw=({prefix:e,name:t,alphabet:r})=>{const{encode:n,decode:s}=Ew(r,t);return Aw({prefix:e,name:t,encode:n,decode:e=>vw(s(e))})},Dw=({name:e,prefix:t,bitsPerChar:r,alphabet:n})=>Aw({prefix:t,name:e,encode:e=>((e,t,r)=>{const n="="===t[t.length-1],s=(1<<r)-1;let i="",o=0,a=0;for(let n=0;n<e.length;++n)for(a=a<<8|e[n],o+=8;o>r;)o-=r,i+=t[s&a>>o];if(o&&(i+=t[s&a<<r-o]),n)for(;i.length*r&7;)i+="=";return i})(e,n,r),decode:t=>((e,t,r,n)=>{const s={};for(let e=0;e<t.length;++e)s[t[e]]=e;let i=e.length;for(;"="===e[i-1];)--i;const o=new Uint8Array(i*r/8|0);let a=0,c=0,l=0;for(let t=0;t<i;++t){const i=s[e[t]];if(void 0===i)throw new SyntaxError(`Non-${n} character`);c=c<<r|i,a+=r,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=r||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o})(t,n,r,e)}),Ow=Aw({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),Nw=Dw({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Cw=Dw({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Mw=Pw({prefix:"9",name:"base10",alphabet:"0123456789"}),Lw=Dw({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),xw=Dw({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Bw=Dw({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Uw=Dw({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),zw=Dw({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),jw=Dw({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Fw=Dw({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Vw=Dw({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),$w=Dw({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Hw=Dw({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Gw=Dw({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),qw=Pw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Kw=Pw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Ww=Pw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Zw=Pw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Yw=Dw({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Jw=Dw({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Qw=Dw({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Xw=Dw({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),eb=Array.from(""),tb=eb.reduce(((e,t,r)=>(e[r]=t,e)),[]),rb=eb.reduce(((e,t,r)=>(e[t.codePointAt(0)]=r,e)),[]),nb=Aw({prefix:"",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+tb[t]),"")},decode:function(e){const t=[];for(const r of e){const e=rb[r.codePointAt(0)];if(void 0===e)throw new Error(`Non-base256emoji character: ${r}`);t.push(e)}return new Uint8Array(t)}});var sb=Math.pow(2,31),ib=Math.pow(2,7),ob=Math.pow(2,14),ab=Math.pow(2,21),cb=Math.pow(2,28),lb=Math.pow(2,35),hb=Math.pow(2,42),db=Math.pow(2,49),ub=Math.pow(2,56),pb=Math.pow(2,63);const fb=function e(t,r,n){r=r||[];for(var s=n=n||0;t>=sb;)r[n++]=255&t|128,t/=128;for(;-128&t;)r[n++]=255&t|128,t>>>=7;return r[n]=0|t,e.bytes=n-s+1,r},gb=function(e){return e<ib?1:e<ob?2:e<ab?3:e<cb?4:e<lb?5:e<hb?6:e<db?7:e<ub?8:e<pb?9:10},yb=(e,t,r=0)=>(fb(e,t,r),t),mb=e=>gb(e),wb=(e,t)=>{const r=t.byteLength,n=mb(e),s=n+mb(r),i=new Uint8Array(s+r);return yb(e,i,0),yb(r,i,n),i.set(t,s),new bb(e,r,t,i)};class bb{constructor(e,t,r,n){this.code=e,this.size=t,this.digest=r,this.bytes=n}}const _b=({name:e,code:t,encode:r})=>new Eb(e,t,r);class Eb{constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?wb(this.code,t):t.then((e=>wb(this.code,e)))}throw Error("Unknown type, must be binary type")}}const vb=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),kb=_b({name:"sha2-256",code:18,encode:vb("SHA-256")}),Sb=_b({name:"sha2-512",code:19,encode:vb("SHA-512")}),Rb=vw,Ib={code:0,name:"identity",encode:Rb,digest:e=>wb(0,Rb(e))},Tb="raw",Ab=85,Pb=e=>vw(e),Db=e=>vw(e),Ob=new TextEncoder,Nb=new TextDecoder,Cb="json",Mb=512,Lb=e=>Ob.encode(JSON.stringify(e)),xb=e=>JSON.parse(Nb.decode(e));r(82784);class Bb{constructor(e,t,r,n){this.code=t,this.version=e,this.multihash=r,this.bytes=n,this.byteOffset=n.byteOffset,this.byteLength=n.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:src_cid_hidden,byteLength:src_cid_hidden,code:src_cid_readonly,version:src_cid_readonly,multihash:src_cid_readonly,bytes:src_cid_readonly,_baseCache:src_cid_hidden,asCID:src_cid_hidden})}toV0(){if(0===this.version)return this;{const{code:e,multihash:t}=this;if(e!==cid_DAG_PB_CODE)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==cid_SHA_256_CODE)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Bb.createV0(t)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=Digest.create(e,t);return Bb.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&Digest.equals(this.multihash,e.multihash)}toString(e){const{bytes:t,version:r,_baseCache:n}=this;return 0===r?cid_toStringV0(t,n,e||base58btc.encoder):cid_toStringV1(t,n,e||base32.encoder)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return cid_deprecate(/^0\.0/,cid_IS_CID_DEPRECATION),!(!e||!e[cid_cidSymbol]&&e.asCID!==e)}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof Bb)return e;if(null!=e&&e.asCID===e){const{version:t,code:r,multihash:n,bytes:s}=e;return new Bb(t,r,n,s||cid_encodeCID(t,r,n.bytes))}if(null!=e&&!0===e[cid_cidSymbol]){const{version:t,multihash:r,code:n}=e,s=Digest.decode(r);return Bb.create(t,n,s)}return null}static create(e,t,r){if("number"!=typeof t)throw new Error("String codecs are no longer supported");switch(e){case 0:if(t!==cid_DAG_PB_CODE)throw new Error(`Version 0 CID must use dag-pb (code: ${cid_DAG_PB_CODE}) block encoding`);return new Bb(e,t,r,r.bytes);case 1:{const n=cid_encodeCID(e,t,r.bytes);return new Bb(e,t,r,n)}default:throw new Error("Invalid version")}}static createV0(e){return Bb.create(0,cid_DAG_PB_CODE,e)}static createV1(e,t){return Bb.create(1,e,t)}static decode(e){const[t,r]=Bb.decodeFirst(e);if(r.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Bb.inspectBytes(e),r=t.size-t.multihashSize,n=coerce(e.subarray(r,r+t.multihashSize));if(n.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=n.subarray(t.multihashSize-t.digestSize),i=new Digest.Digest(t.multihashCode,t.digestSize,s,n);return[0===t.version?Bb.createV0(i):Bb.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){const t=()=>{const[t,r]=varint.decode(e.subarray(0));return t};let r=t(),n=cid_DAG_PB_CODE;if(18===r||1===r&&t(),0!==r&&1!==r)throw new RangeError(`Invalid CID version ${r}`);const s=t(),i=t(),o=0+i;return{version:r,codec:n,multihashCode:s,digestSize:i,multihashSize:o-0,size:o}}static parse(e,t){const[r,n]=cid_parseCIDtoBytes(e,t),s=Bb.decode(n);return s._baseCache.set(r,e),s}}Symbol.for("@ipld/js-cid/CID");const Ub={...v,...k,...S,...R,...I,...T,...A,...P,...D,...O};function zb(e){return null!=globalThis.Buffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e}function jb(e,t,r,n){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:r},decoder:{decode:n}}}const Fb=jb("utf8","u",(e=>"u"+new TextDecoder("utf8").decode(e)),(e=>(new TextEncoder).encode(e.substring(1)))),Vb=jb("ascii","a",(e=>{let t="a";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}),(e=>{const t=function(e=0){return null!=globalThis.Buffer&&null!=globalThis.Buffer.allocUnsafe?zb(globalThis.Buffer.allocUnsafe(e)):new Uint8Array(e)}((e=e.substring(1)).length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t})),$b={utf8:Fb,"utf-8":Fb,hex:Ub.base16,latin1:Vb,ascii:Vb,binary:Vb,...Ub};function Hb(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return((e,t)=>{const r=function(e,t="utf8"){const r=$b[t];if(!r)throw new Error(`Unsupported encoding "${t}"`);return"utf8"!==t&&"utf-8"!==t||null==globalThis.Buffer||null==globalThis.Buffer.from?r.decoder.decode(`${r.prefix}${e}`):zb(globalThis.Buffer.from(e,"utf-8"))}(t.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(e.length+r.length);return n.set(e,0),n.set(r,e.length),n})(e.from.toBytes(),e.sequenceNumber)}async function Gb(e){return await gm.encode(e.data)}function qb(e,t,r,n,s){let i=0;const o=new Map;if(Object.entries(t.topics).forEach((([e,t])=>{const n=s.get(e)??"unknown",a=r.topics[e];if(void 0===a)return;let c=o.get(n);c||(c={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(n,c));let l=0,h=0,d=0,u=0,p=0;t.inMesh&&(l+=Math.max(t.meshTime/a.timeInMeshQuantum,a.timeInMeshCap)*a.timeInMeshWeight);let f=t.firstMessageDeliveries;if(f>a.firstMessageDeliveriesCap&&(f=a.firstMessageDeliveriesCap),h+=f*a.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<a.meshMessageDeliveriesThreshold){const e=a.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;d+=e*e*a.meshMessageDeliveriesWeight}u+=t.meshFailurePenalty*a.meshFailurePenaltyWeight,p+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*a.invalidMessageDeliveriesWeight,i+=(l+h+d+u+p)*a.topicWeight,c.p1w+=l,c.p2w+=h,c.p3w+=d,c.p3bw+=u,c.p4w+=p})),r.topicScoreCap>0&&i>r.topicScoreCap){i=r.topicScoreCap;const e=r.topicScoreCap/i;for(const t of o.values())t.p1w*=e,t.p2w*=e,t.p3w*=e,t.p3bw*=e,t.p4w*=e}let a=0,c=0,l=0;return a+=r.appSpecificScore(e)*r.appSpecificWeight,t.ips.forEach((e=>{if(r.IPColocationFactorWhitelist.has(e))return;const t=n.get(e),s=t?t.size:0;if(s>r.IPColocationFactorThreshold){const e=s-r.IPColocationFactorThreshold;c+=e*e*r.IPColocationFactorWeight}})),l+=t.behaviourPenalty*t.behaviourPenalty*r.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function Kb(e,t,r=(()=>!0)){const n=new Set;if(t<=0)return n;for(const s of e){if(n.size>=t)break;r(s)&&(n.add(s),e.delete(s))}return n}var Wb,Zb=r(50351),Yb=r(97177);class Jb{constructor(e,t,r){this.rawStream=e,this.pushable=(0,Is.d)({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=r.maxBufferSize??1/0,(0,vi.zG)((0,Zb.wJ)(this.pushable,this.closeController.signal,{returnOnAbort:!0}),(0,Yb.c)(),this.rawStream).catch(t)}get protocol(){return this.rawStream.stat.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}class Qb{constructor(e){this.rawStream=e,this.closeController=new AbortController,this.source=(0,Zb.wJ)((0,vi.zG)(this.rawStream,(0,Yb.J)()),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}}!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(Wb||(Wb={}));class Xb extends ny.v{constructor(e={}){super(),this.multicodecs=[ly,cy],this.peers=new Set,this.streamsInbound=new Map,this.streamsOutbound=new Map,this.outboundInflightQueue=(0,Is.d)({objectMode:!0}),this.direct=new Set,this.floodsubPeers=new Set,this.acceptFromWhitelist=new Map,this.topics=new Map,this.subscriptions=new Set,this.mesh=new Map,this.fanout=new Map,this.fanoutLastpub=new Map,this.gossip=new Map,this.control=new Map,this.peerhave=new Map,this.iasked=new Map,this.backoff=new Map,this.outbound=new Map,this.topicValidators=new Map,this.heartbeatTicks=0,this.components=new aw,this.directPeerInitial=null,this.status={code:Wb.stopped},this.heartbeatTimer=null,this.runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch((e=>{this.log("Error running heartbeat",e)})).finally((()=>{if(null!=e&&e(),this.status.code===Wb.started){clearTimeout(this.status.heartbeatTimeout);let e=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;e<.25*this.opts.heartbeatInterval&&(e+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,e)}}))};const t={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...e,scoreParams:Jm(e.scoreParams),scoreThresholds:ew(e.scoreThresholds)};if(this.globalSignaturePolicy=t.globalSignaturePolicy??zm,t.fallbackToFloodsub&&this.multicodecs.push(ay),this.log=(0,z.kg)(t.debugName??"libp2p:gossipsub"),this.opts=t,this.direct=new Set(t.directPeers.map((e=>e.id.toString()))),this.seenCache=new dw({validityMs:t.seenTTL}),this.publishedMessageIds=new dw({validityMs:t.seenTTL}),e.msgIdFn)this.msgIdFn=e.msgIdFn;else switch(this.globalSignaturePolicy){case zm:this.msgIdFn=Hb;break;case jm:this.msgIdFn=Gb}if(e.fastMsgIdFn&&(this.fastMsgIdFn=e.fastMsgIdFn,this.fastMsgIdCache=new dw({validityMs:t.seenTTL})),this.msgIdToStrFn=e.msgIdToStrFn??Um,this.mcache=e.messageCache||new sy(t.mcacheGossip,t.mcacheLength,this.msgIdToStrFn),e.dataTransform&&(this.dataTransform=e.dataTransform),e.metricsRegister){if(!e.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const r=Math.max(...Object.values(t.scoreParams.topics).map((e=>e.meshMessageDeliveriesWindow)),1e3),n=function(e,t,r){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:e.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:e.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:e.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedStatus:e.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*r.maxMeshMessageDeliveriesWindowSec,.5*r.maxMeshMessageDeliveriesWindowSec,1*r.maxMeshMessageDeliveriesWindowSec,2*r.maxMeshMessageDeliveriesWindowSec,4*r.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*r.behaviourPenaltyThreshold,.5*r.behaviourPenaltyThreshold,1*r.behaviourPenaltyThreshold,2*r.behaviourPenaltyThreshold,4*r.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*r.gossipPromiseExpireSec,1*r.gossipPromiseExpireSec,2*r.gossipPromiseExpireSec,4*r.gossipPromiseExpireSec]}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),topicStrToLabel:t,toTopic(e){return this.topicStrToLabel.get(e)??e},onJoin(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh(e,t,r){const n=this.toTopic(e);this.meshPeerInclusionEvents.inc({topic:n,reason:t},r)},onRemoveFromMesh(e,t,r){const n=this.toTopic(e);this.meshPeerChurnEvents.inc({topic:n,reason:t},r)},onReportValidationMcacheHit(e){this.asyncValidationMcacheHit.inc({hit:e?"hit":"miss"})},onReportValidation(e,t){const r=this.toTopic(e);this.asyncValidationResult.inc({topic:r,acceptance:t})},onScorePenalty(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv(e,t,r){const n=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:n},t),this.ihaveRcvNotSeenMsgids.inc({topic:n},r)},onIwantRcv(e,t){for(const[t,r]of e){const e=this.toTopic(t);this.iwantRcvMsgids.inc({topic:e},r)}this.iwantRcvDonthaveMsgids.inc(t)},onForwardMsg(e,t){const r=this.toTopic(e);this.msgForwardCount.inc({topic:r},1),this.msgForwardPeers.inc({topic:r},t)},onPublishMsg(e,t,r,n){const s=this.toTopic(e);this.msgPublishCount.inc({topic:s},1),this.msgPublishBytes.inc({topic:s},r*n),this.msgPublishPeers.inc({topic:s},r),this.msgPublishPeersByGroup.inc({topic:s,peerGroup:"direct"},t.direct),this.msgPublishPeersByGroup.inc({topic:s,peerGroup:"floodsub"},t.floodsub),this.msgPublishPeersByGroup.inc({topic:s,peerGroup:"mesh"},t.mesh),this.msgPublishPeersByGroup.inc({topic:s,peerGroup:"fanout"},t.fanout)},onMsgRecvPreValidation(e){const t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvResult(e,t){const r=this.toTopic(e);this.msgReceivedStatus.inc({topic:r,status:t})},onMsgRecvInvalid(e,t){const r=this.toTopic(e),n=t.reason===Hm.Error?t.error:t.reason;this.msgReceivedInvalid.inc({topic:r,error:n},1)},onDuplicateMsgDelivery(e,t,r){if(this.duplicateMsgDeliveryDelay.observe(t/1e3),r){const t=this.toTopic(e);this.duplicateMsgLateDelivery.inc({topic:t},1)}},onRpcRecv(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),e.messages&&this.rpcRecvMessage.inc(e.messages.length),e.control&&(this.rpcRecvControl.inc(1),e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),e.messages&&this.rpcSentMessage.inc(e.messages.length),e.control){const t=e.control.ihave?.length??0,r=e.control.iwant?.length??0,n=e.control.graft?.length??0,s=e.control.prune?.length??0;t>0&&this.rpcSentIHave.inc(t),r>0&&this.rpcSentIWant.inc(r),n>0&&this.rpcSentGraft.inc(n),s>0&&this.rpcSentPrune.inc(s),(t>0||r>0||n>0||s>0)&&this.rpcSentControl.inc(1)}},registerScores(e,t){let r=0,n=0,s=0,i=0;for(const o of e)o>=t.graylistThreshold&&r++,o>=t.publishThreshold&&n++,o>=t.gossipThreshold&&s++,o>=0&&i++;this.peersByScoreThreshold.set({threshold:mw.graylist},r),this.peersByScoreThreshold.set({threshold:mw.publish},n),this.peersByScoreThreshold.set({threshold:mw.gossip},s),this.peersByScoreThreshold.set({threshold:mw.mesh},i),this.score.set(e)},registerScoreWeights(e){for(const[t,r]of e.byTopic)this.scoreWeights.set({topic:t,p:"p1"},r.p1w),this.scoreWeights.set({topic:t,p:"p2"},r.p2w),this.scoreWeights.set({topic:t,p:"p3"},r.p3w),this.scoreWeights.set({topic:t,p:"p3b"},r.p3bw),this.scoreWeights.set({topic:t,p:"p4"},r.p4w);this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh(e,t){const r=new Map;e.forEach(((e,t)=>{const n=this.topicStrToLabel.get(t)??"unknown";let s=r.get(n);s||(s=new Set,r.set(n,s)),e.forEach((e=>s?.add(e)))}));for(const[e,n]of r){const r=[];n.forEach((e=>{r.push(t.get(e)??0)})),this.scorePerMesh.set({topic:e},r)}}}}(e.metricsRegister,e.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:t.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:r/1e3});n.mcacheSize.addCollect((()=>this.onScrapeMetrics(n)));for(const e of this.multicodecs)n.protocolsEnabled.set({protocol:e},1);this.metrics=n}else this.metrics=null;this.gossipTracer=new hw(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new lw(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:t.heartbeatInterval}),this.maxInboundStreams=e.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams}getPeers(){return[...this.peers.keys()].map((e=>(0,Ln.jE)(e)))}isStarted(){return this.status.code===Wb.started}async init(e){this.components=e,this.score.init(e)}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await async function(e,t){switch(e){case zm:{if(!t)throw Error("Must provide PeerId");if(null==t.privateKey)throw Error("Cannot sign message, no private key present");if(null==t.publicKey)throw Error("Cannot sign message, no public key present");const e=await(0,qn.unmarshalPrivateKey)(t.privateKey);return{type:Vm.Signing,author:t,key:t.publicKey,privateKey:e}}case jm:return{type:Vm.Anonymous};default:throw new Error(`Unknown signature policy "${e}"`)}}(this.globalSignaturePolicy,this.components.getPeerId()),this.outboundInflightQueue=(0,Is.d)({objectMode:!0}),(0,vi.zG)(this.outboundInflightQueue,(async e=>{for await(const{peerId:t,connection:r}of e)await this.createOutboundStream(t,r)})).catch((e=>this.log.error("outbound inflight queue error",e))),await Promise.all(this.opts.directPeers.map((async e=>{await this.components.getPeerStore().addressBook.add(e.id,e.addrs)})));const e=this.components.getRegistrar();await Promise.all(this.multicodecs.map((t=>e.handle(t,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))));const t=ry({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),r=await Promise.all(this.multicodecs.map((r=>e.register(r,t)))),n=setTimeout(this.runHeartbeat,100);this.status={code:Wb.started,registrarTopologyIds:r,heartbeatTimeout:n,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout((()=>{Promise.resolve().then((async()=>{await Promise.all(Array.from(this.direct).map((async e=>await this.connect(e))))})).catch((e=>{this.log(e)}))}),1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Wb.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:Wb.stopped};const t=this.components.getRegistrar();e.forEach((e=>t.unregister(e))),this.outboundInflightQueue.end();for(const e of this.streamsOutbound.values())e.close();this.streamsOutbound.clear();for(const e of this.streamsInbound.values())e.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const r=t.remotePeer;this.addPeer(r,t.stat.direction),this.createInboundStream(r,e),this.outboundInflightQueue.push({peerId:r,connection:t})}onPeerConnected(e,t){this.isStarted()&&(this.addPeer(e,t.stat.direction),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const r=e.toString();if(this.peers.has(r)&&!this.streamsOutbound.has(r))try{const n=new Jb(await t.newStream(this.multicodecs),(e=>this.log.error("outbound pipe error",e)),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(r,n);const s=n.protocol;s===ay&&this.floodsubPeers.add(r),this.metrics?.peersPerProtocol.inc({protocol:s},1),this.subscriptions.size>0&&(this.log("send subscriptions to",r),this.sendSubscriptions(r,Array.from(this.subscriptions),!0))}catch(e){this.log.error("createOutboundStream error",e)}}async createInboundStream(e,t){if(!this.isStarted())return;const r=e.toString();if(!this.peers.has(r))return;const n=this.streamsInbound.get(r);void 0!==n&&(this.log("replacing existing inbound steam %s",r),n.close()),this.log("create inbound stream %s",r);const s=new Qb(t);this.streamsInbound.set(r,s),this.pipePeerReadStream(e,s.source).catch((e=>this.log(e)))}addPeer(e,t){const r=e.toString();this.peers.has(r)||(this.log("new peer %p",e),this.peers.add(r),this.score.addPeer(r),this.outbound.has(r)||this.outbound.set(r,"outbound"===t))}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const r=this.streamsOutbound.get(t),n=this.streamsInbound.get(t);r&&this.metrics?.peersPerProtocol.inc({protocol:r.protocol},-1),r?.close(),n?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const e of this.topics.values())e.delete(t);for(const[e,r]of this.mesh)!0===r.delete(t)&&this.metrics?.onRemoveFromMesh(e,fw.Dc,1);for(const e of this.fanout.values())e.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===Wb.started}getMeshPeers(e){const t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t?Array.from(t):[]).map((e=>(0,Ln.jE)(e)))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await(0,vi.zG)(t,(async t=>{for await(const r of t)try{const t=r.subarray(),n=oy.decode(t);this.metrics?.onRpcRecv(n,t.length),this.opts.awaitRpcHandler?await this.handleReceivedRpc(e,n):this.handleReceivedRpc(e,n).catch((e=>this.log(e)))}catch(e){this.log(e)}}))}catch(t){this.log.error(t),this.onPeerDisconnected(e)}}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString()))return this.log("received message from unacceptable peer %p",e),void this.metrics?.rpcRecvNotAccepted.inc();if(this.log("rpc from %p",e),t.subscriptions&&t.subscriptions.length>0&&(t.subscriptions.forEach((t=>{this.handleReceivedSubscription(e,t)})),this.dispatchEvent(new ny.A("subscription-change",{detail:{peerId:e,subscriptions:t.subscriptions.filter((e=>null!==e.topic)).map((e=>({topic:e.topic??"",subscribe:Boolean(e.subscribe)})))}}))),t.messages)for(const r of t.messages){const t=this.handleReceivedMessage(e,r).catch((e=>this.log(e)));this.opts.awaitRpcMessageHandler&&await t}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t){if(null==t.topic)return;this.log("subscription update from %p topic %s",e,t.topic);let r=this.topics.get(t.topic);null==r&&(r=new Set,this.topics.set(t.topic,r)),t.subscribe?r.add(e.toString()):r.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const r=await this.validateReceivedMessage(e,t);switch(this.metrics?.onMsgRecvResult(t.topic,r.code),r.code){case qm.duplicate:return this.score.duplicateMessage(e.toString(),r.msgIdStr,t.topic),void this.mcache.observeDuplicate(r.msgIdStr,e.toString());case qm.invalid:if(r.msgIdStr){const n=r.msgIdStr;this.score.rejectMessage(e.toString(),n,t.topic,r.reason),this.gossipTracer.rejectMessage(n,r.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);return void this.metrics?.onMsgRecvInvalid(t.topic,r);case qm.valid:this.score.validateMessage(r.messageId.msgIdStr),this.gossipTracer.deliverMessage(r.messageId.msgIdStr),this.mcache.put(r.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(this.components.getPeerId().equals(e)&&!this.opts.emitSelf||(super.dispatchEvent(new ny.A("gossipsub:message",{detail:{propagationSource:e,msgId:r.messageId.msgIdStr,msg:r.msg}})),super.dispatchEvent(new ny.A("message",{detail:r.msg})))),this.opts.asyncValidation||this.forwardMessage(r.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){const r=this.fastMsgIdFn?.(t),n=r?this.fastMsgIdCache?.get(r):void 0;if(n)return{code:qm.duplicate,msgIdStr:n};const s=await async function(e,t){switch(e){case jm:return null!=t.signature?{valid:!1,error:Gm.SignaturePresent}:null!=t.seqno?{valid:!1,error:Gm.SeqnoPresent}:null!=t.key?{valid:!1,error:Gm.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case zm:{if(null==t.seqno)return{valid:!1,error:Gm.InvalidSeqno};if(8!==t.seqno.length)return{valid:!1,error:Gm.InvalidSeqno};if(null==t.signature)return{valid:!1,error:Gm.InvalidSignature};if(null==t.from)return{valid:!1,error:Gm.InvalidPeerId};let e,r;try{e=(0,Ln.cv)(t.from)}catch(e){return{valid:!1,error:Gm.InvalidPeerId}}if(t.key){if(r=(0,qn.unmarshalPublicKey)(t.key),void 0!==e.publicKey&&!function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}(r.bytes,e.publicKey))return{valid:!1,error:Gm.InvalidPeerId}}else{if(null==e.publicKey)return{valid:!1,error:Gm.InvalidPeerId};r=(0,qn.unmarshalPublicKey)(e.publicKey)}const n={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},s=ww([_w,oy.Message.encode(n).finish()]);return await r.verify(s,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${Bm(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:t.key??(0,qn.marshalPublicKey)(r)}}:{valid:!1,error:Gm.InvalidSignature}}}}(this.globalSignaturePolicy,t);if(!s.valid)return{code:qm.invalid,reason:Hm.Error,error:s.error};const i=s.message;try{this.dataTransform&&(i.data=this.dataTransform.inboundTransform(t.topic,i.data))}catch(e){return this.log("Invalid message, transform failed",e),{code:qm.invalid,reason:Hm.Error,error:Gm.TransformFailed}}const o=await this.msgIdFn(i),a=this.msgIdToStrFn(o),c={msgId:o,msgIdStr:a};if(r&&this.fastMsgIdCache?.put(r,a),this.seenCache.has(a))return{code:qm.duplicate,msgIdStr:a};this.seenCache.put(a);const l=this.topicValidators.get(t.topic);if(null!=l){let t;try{t=await l(i.topic,i,e)}catch(e){const r=e.code;"ERR_TOPIC_VALIDATOR_IGNORE"===r&&(t=$m.Ignore),t="ERR_TOPIC_VALIDATOR_REJECT"===r?$m.Reject:$m.Ignore}if(t!==$m.Accept)return{code:qm.invalid,reason:Km(t),msgIdStr:a}}return{code:qm.valid,messageId:c,msg:i}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,r){this.sendRpc(e,{subscriptions:t.map((e=>({topic:e,subscribe:r}))),messages:[]})}async handleControlMessage(e,t){if(void 0===t)return;const r=t.ihave?this.handleIHave(e,t.ihave):[],n=t.iwant?this.handleIWant(e,t.iwant):[],s=t.graft?await this.handleGraft(e,t.graft):[];t.prune&&await this.handlePrune(e,t.prune),(r.length||n.length||s.length)&&this.sendRpc(e,dy(n,{iwant:r,prune:s}))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),r=this.acceptFromWhitelist.get(e);if(r&&r.messagesAccepted<128&&r.acceptUntil>=t)return r.messagesAccepted+=1,!0;const n=this.score.score(e);return n>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),n>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];const r=this.score.score(e);if(r<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,r),this.metrics?.ihaveRcvIgnored.inc({reason:yw.LowScore}),[];const n=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,n),n>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:yw.MaxIhave}),[];const s=this.iasked.get(e)??0;if(s>=hy)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:yw.MaxIasked}),[];const i=new Map;if(t.forEach((({topicID:e,messageIDs:t})=>{if(!e||!t||!this.mesh.has(e))return;let r=0;t.forEach((e=>{const t=this.msgIdToStrFn(e);this.seenCache.has(t)||(i.set(t,e),r++)})),this.metrics?.onIhaveRcv(e,t.length,r)})),!i.size)return[];let o=i.size;o+s>hy&&(o=hy-s),this.log("IHAVE: Asking for %d out of %d messages from %s",o,i.size,e);let a=Array.from(i.values());return uy(a),a=a.slice(0,o),this.iasked.set(e,s+o),this.gossipTracer.addPromise(e,a),[{messageIDs:a}]}handleIWant(e,t){if(!t.length)return[];const r=this.score.score(e);if(r<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,r),[];const n=new Map,s=new Map;let i=0;return t.forEach((({messageIDs:t})=>{t&&t.forEach((t=>{const r=this.msgIdToStrFn(t),o=this.mcache.getWithIWantCount(r,e);null!=o?(s.set(o.msg.topic,1+(s.get(o.msg.topic)??0)),o.count>3?this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):n.set(r,o.msg)):i++}))})),this.metrics?.onIwantRcv(s,i),n.size?(this.log("IWANT: Sending %d messages to %s",n.size,e),Array.from(n.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){const r=[],n=this.score.score(e),s=Date.now();let i=this.opts.doPX;return t.forEach((({topicID:t})=>{if(!t)return;const o=this.mesh.get(t);if(!o)return void(i=!1);if(o.has(e))return;if(this.direct.has(e))return this.log("GRAFT: ignoring request from direct peer %s",e),r.push(t),void(i=!1);const a=this.backoff.get(t)?.get(e);if("number"==typeof a&&s<a){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,gw.GraftBackoff),i=!1;const n=a+this.opts.graftFloodThreshold-this.opts.pruneBackoff;return s<n&&this.score.addPenalty(e,1,gw.GraftBackoff),this.addBackoff(e,t),void r.push(t)}return n<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,n,t),r.push(t),i=!1,void this.addBackoff(e,t)):o.size>=this.opts.Dhi&&!this.outbound.get(e)?(r.push(t),void this.addBackoff(e,t)):(this.log("GRAFT: Add mesh link from %s in %s",e,t),this.score.graft(e,t),o.add(e),void this.metrics?.onAddToMesh(t,pw.Subscribed,1))})),r.length?await Promise.all(r.map((t=>this.makePrune(e,t,i)))):[]}async handlePrune(e,t){const r=this.score.score(e);for(const{topicID:n,backoff:s,peers:i}of t){if(null==n)continue;const t=this.mesh.get(n);if(!t)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,n),this.score.prune(e,n),t.has(e)&&(t.delete(e),this.metrics?.onRemoveFromMesh(n,fw.Unsub,1)),"number"==typeof s&&s>0?this.doAddBackoff(e,n,1e3*s):this.addBackoff(e,n),i&&i.length){if(r<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,r,n);continue}await this.pxConnect(i)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,r){let n=this.backoff.get(t);n||(n=new Map,this.backoff.set(t,n));const s=Date.now()+r;(n.get(e)??0)<s&&n.set(e,s)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach(((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,gw.BrokenPromise)}))}clearBackoff(){if(this.heartbeatTicks%15!=0)return;const e=Date.now();this.backoff.forEach(((t,r)=>{t.forEach(((r,n)=>{r<e&&t.delete(n)})),0===t.size&&this.backoff.delete(r)}))}async directConnect(){const e=[];this.direct.forEach((t=>{this.streamsOutbound.has(t)||e.push(t)})),await Promise.all(e.map((async e=>await this.connect(e))))}async pxConnect(e){e.length>this.opts.prunePeers&&(uy(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map((async e=>{if(!e.peerID)return;const r=(0,Ln.cv)(e.peerID).toString();if(!this.peers.has(r))if(e.signedPeerRecord)try{const n=await Qg.X.openAndCertify(e.signedPeerRecord,"libp2p-peer-record"),s=n.peerId;if(!n.peerId.equals(r))return void this.log("bogus peer record obtained through px: peer ID %p doesn't match expected peer %p",s,r);if(!await this.components.getPeerStore().addressBook.consumePeerRecord(n))return void this.log("bogus peer record obtained through px: could not add peer record to address book");t.push(r)}catch(e){this.log("bogus peer record obtained through px: invalid signature or not a peer record")}else t.push(r)}))),t.length&&await Promise.all(t.map((async e=>await this.connect(e))))}async connect(e){this.log("Initiating connection with %s",e);const t=(0,Ln.jE)(e),r=await this.components.getConnectionManager().openConnection(t);for(const e of this.multicodecs)for(const n of this.components.getRegistrar().getTopologies(e))n.onConnect(t,r)}subscribe(e){if(this.status.code!==Wb.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==Wb.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!1);this.leave(e).catch((e=>{this.log(e)}))}join(e){if(this.status.code!==Wb.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,r=this.fanout.get(e);if(r&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),r.forEach((e=>{!this.direct.has(e)&&this.score.score(e)>=0&&t.add(e)})),this.metrics?.onAddToMesh(e,pw.Fanout,t.size)),t.size<this.opts.D){const r=t.size;this.getRandomGossipPeers(e,this.opts.D,(e=>!t.has(e)&&!this.direct.has(e)&&this.score.score(e)>=0)).forEach((e=>{t.add(e)})),this.metrics?.onAddToMesh(e,pw.Random,t.size-r)}this.mesh.set(e,t),t.forEach((t=>{this.log("JOIN: Add mesh link to %s in %s",t,e),this.sendGraft(t,e)}))}async leave(e){if(this.status.code!==Wb.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t&&(await Promise.all(Array.from(t).map((async t=>(this.log("LEAVE: Remove mesh link to %s in %s",t,e),await this.sendPrune(t,e))))),this.mesh.delete(e))}selectPeersToForward(e,t,r){const n=new Set,s=this.topics.get(e);s&&(this.direct.forEach((e=>{s.has(e)&&t!==e&&!r?.has(e)&&n.add(e)})),this.floodsubPeers.forEach((e=>{s.has(e)&&t!==e&&!r?.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&n.add(e)})));const i=this.mesh.get(e);return i&&i.size>0&&i.forEach((e=>{t===e||r?.has(e)||n.add(e)})),n}selectPeersToPublish(e){const t=new Set,r={direct:0,floodsub:0,mesh:0,fanout:0},n=this.topics.get(e);if(n)if(this.opts.floodPublish)n.forEach((e=>{this.direct.has(e)?(t.add(e),r.direct++):this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),r.floodsub++)}));else{this.direct.forEach((e=>{n.has(e)&&(t.add(e),r.direct++)})),this.floodsubPeers.forEach((e=>{n.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),r.floodsub++)}));const s=this.mesh.get(e);if(s&&s.size>0)s.forEach((e=>{t.add(e),r.mesh++}));else{const n=this.fanout.get(e);if(n&&n.size>0)n.forEach((e=>{t.add(e),r.fanout++}));else{const n=this.getRandomGossipPeers(e,this.opts.D,(e=>this.score.score(e)>=this.opts.scoreThresholds.publishThreshold));n.size>0&&(this.fanout.set(e,n),n.forEach((e=>{t.add(e),r.fanout++})))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:r}}forwardMessage(e,t,r,n){r&&this.score.deliverMessage(r,e,t.topic);const s=this.selectPeersToForward(t.topic,r,n),i=dy([t]);s.forEach((e=>{this.sendRpc(e,i)})),this.metrics?.onForwardMsg(t.topic,s.size)}async publish(e,t){const r=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(null==this.publishConfig)throw Error("PublishError.Uninitialized");const{raw:n,msg:s}=await async function(e,t,r,n){switch(e.type){case Vm.Signing:{const s={from:e.author.toBytes(),data:n,seqno:(0,bw.O6)(8),topic:t,signature:void 0,key:void 0},i=ww([_w,oy.Message.encode(s).finish()]);return s.signature=await e.privateKey.sign(i),s.key=e.key,{raw:s,msg:{type:"signed",from:e.author,data:r,sequenceNumber:BigInt(`0x${Bm(s.seqno,"base16")}`),topic:t,signature:s.signature,key:s.key}}}case Vm.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:r,topic:t}}}}(this.publishConfig,e,t,r),i=await this.msgIdFn(s),o=this.msgIdToStrFn(i);if(this.seenCache.has(o))throw Error("PublishError.Duplicate");const{tosend:a,tosendCount:c}=this.selectPeersToPublish(e),l=!0===this.opts.emitSelf&&this.subscriptions.has(e);if(0===a.size&&!this.opts.allowPublishToZeroPeers&&!l)throw Error("PublishError.InsufficientPeers");this.seenCache.put(o),this.mcache.put({msgId:i,msgIdStr:o},n,!0),this.publishedMessageIds.put(o);const h=dy([n]);for(const e of a)this.sendRpc(e,h)||a.delete(e);return this.metrics?.onPublishMsg(e,c,a.size,null!=n.data?n.data.length:0),l&&(a.add(this.components.getPeerId().toString()),super.dispatchEvent(new ny.A("gossipsub:message",{detail:{propagationSource:this.components.getPeerId(),msgId:o,msg:s}})),super.dispatchEvent(new ny.A("message",{detail:s}))),{recipients:Array.from(a.values()).map((e=>(0,Ln.jE)(e)))}}reportMessageValidationResult(e,t,r){if(r===$m.Accept){const n=this.mcache.validate(e);if(this.metrics?.onReportValidationMcacheHit(null!==n),null!=n){const{message:s,originatingPeers:i}=n;this.score.deliverMessage(t.toString(),e,s.topic),this.forwardMessage(e,n.message,t.toString(),i),this.metrics?.onReportValidation(s.topic,r)}}else{const n=this.mcache.remove(e);if(this.metrics?.onReportValidationMcacheHit(null!==n),n){const s=Km(r),{message:i,originatingPeers:o}=n;this.score.rejectMessage(t.toString(),e,i.topic,s);for(const t of o)this.score.rejectMessage(t,e,i.topic,s);this.metrics?.onReportValidation(i.topic,r)}}}sendGraft(e,t){const r=dy([],{graft:[{topicID:t}]});this.sendRpc(e,r)}async sendPrune(e,t){const r=dy([],{prune:[await this.makePrune(e,t,this.opts.doPX)]});this.sendRpc(e,r)}sendRpc(e,t){const r=this.streamsOutbound.get(e);if(!r)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const n=this.control.get(e);n&&(this.piggybackControl(e,t,n),this.control.delete(e));const s=this.gossip.get(e);s&&(this.piggybackGossip(e,t,s),this.gossip.delete(e));const i=oy.encode(t).finish();try{r.push(i)}catch(t){return this.log.error(`Cannot send rpc to ${e}`,t),n&&this.control.set(e,n),s&&this.gossip.set(e,s),!1}return this.metrics?.onRpcSent(t,i.length),!0}piggybackControl(e,t,r){const n=(r.graft||[]).filter((({topicID:t})=>(t&&this.mesh.get(t)||new Set).has(e))),s=(r.prune||[]).filter((({topicID:t})=>!(t&&this.mesh.get(t)||new Set).has(e)));(n.length||s.length)&&(t.control?(t.control.graft=t.control.graft&&t.control.graft.concat(n),t.control.prune=t.control.prune&&t.control.prune.concat(s)):t.control={graft:n,prune:s,ihave:[],iwant:[]})}piggybackGossip(e,t,r){t.control||(t.control={ihave:[],iwant:[],graft:[],prune:[]}),t.control.ihave=r}async sendGraftPrune(e,t,r){const n=this.opts.doPX;for(const[s,i]of e){const e=i.map((e=>({topicID:e})));let o=[];const a=t.get(s);a&&(o=await Promise.all(a.map((async e=>await this.makePrune(s,e,n&&!r.get(s))))),t.delete(s));const c=dy([],{graft:e,prune:o});this.sendRpc(s,c)}for(const[e,s]of t){const t=dy([],{prune:await Promise.all(s.map((async t=>await this.makePrune(e,t,n&&!r.get(e)))))});this.sendRpc(e,t)}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[r,n]of e)this.doEmitGossip(r,n,t.get(r)??[])}doEmitGossip(e,t,r){if(!r.length)return;if(uy(r),r.length>hy&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",r.length),!t.size)return;let n=this.opts.Dlazy;const s=.25*t.size;let i=t;s>n&&(n=s),n>i.size?n=i.size:i=uy(Array.from(i)).slice(0,n),i.forEach((t=>{let n=r;r.length>hy&&(n=uy(n.slice()).slice(0,hy)),this.pushGossip(t,{topicID:e,messageIDs:n})}))}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,dy([],{ihave:t}));for(const[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,dy([],{graft:t.graft,prune:t.prune}))}pushGossip(e,t){this.log("Add gossip to %s",e);const r=this.gossip.get(e)||[];this.gossip.set(e,r.concat(t))}async makePrune(e,t,r){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===cy)return{topicID:t,peers:[]};const n=this.opts.pruneBackoff/1e3;if(!r)return{topicID:t,peers:[],backoff:n};const s=this.getRandomGossipPeers(t,this.opts.prunePeers,(t=>t!==e&&this.score.score(t)>=0)),i=await Promise.all(Array.from(s).map((async e=>{const t=(0,Ln.jE)(e);return{peerID:t.toBytes(),signedPeerRecord:await this.components.getPeerStore().addressBook.getRawEnvelope(t)}})));return{topicID:t,peers:i,backoff:n}}async heartbeat(){const{D:e,Dlo:t,Dhi:r,Dscore:n,Dout:s,fanoutTTL:i}=this.opts;this.heartbeatTicks++;const o=new Map,a=e=>{let t=o.get(e);return void 0===t&&(t=this.score.score(e),o.set(e,t)),t},c=new Map,l=new Map,h=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks==0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const d=new Map;this.mesh.forEach(((i,o)=>{const u=this.topics.get(o),p=new Set,f=new Set;if(d.set(o,f),u){const e=uy(Array.from(u)),t=this.backoff.get(o);for(const r of e){const e=this.streamsOutbound.get(r);if(e&&this.multicodecs.includes(e.protocol)&&!i.has(r)&&!this.direct.has(r)){const e=a(r);t&&t.has(r)||!(e>=0)||p.add(r),e>=this.opts.scoreThresholds.gossipThreshold&&f.add(r)}}}const g=(e,t)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",e,o),this.addBackoff(e,o),i.delete(e),a(e)>=this.opts.scoreThresholds.gossipThreshold&&f.add(e),this.metrics?.onRemoveFromMesh(o,t,1);const r=l.get(e);r?r.push(o):l.set(e,[o])},y=(e,t)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",e,o),this.score.graft(e,o),i.add(e),f.delete(e),this.metrics?.onAddToMesh(o,t,1);const r=c.get(e);r?r.push(o):c.set(e,[o])};if(i.forEach((e=>{const t=a(e);t<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",e,t,o),g(e,fw.BadScore),h.set(e,!0))})),i.size<t){(m=p,w=e-i.size,Kb(m,w,(()=>!0))).forEach((e=>{y(e,pw.NotEnough)}))}var m,w;if(i.size>r){let t=Array.from(i);t.sort(((e,t)=>a(t)-a(e))),t=t.slice(0,n).concat(uy(t.slice(n)));let r=0;if(t.slice(0,e).forEach((e=>{this.outbound.get(e)&&r++})),r<s){const n=e=>{const r=t[e];for(let r=e;r>0;r--)t[r]=t[r-1];t[0]=r};if(r>0){let s=r;for(let r=1;r<e&&s>0;r++)this.outbound.get(t[r])&&(n(r),s--)}let s=e-r;for(let r=e;r<t.length&&s>0;r++)this.outbound.get(t[r])&&(n(r),s--)}t.slice(e).forEach((e=>{g(e,fw.Excess)}))}if(i.size>=t){let e=0;i.forEach((t=>{this.outbound.get(t)&&e++})),e<s&&Kb(p,s-e,(e=>!0===this.outbound.get(e))).forEach((e=>{y(e,pw.Outbound)}))}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks==0&&i.size>1){const e=Array.from(i).sort(((e,t)=>a(e)-a(t))),t=Math.floor(i.size/2),r=a(e[t]);if(r<this.opts.scoreThresholds.opportunisticGraftThreshold){const e=Kb(p,this.opts.opportunisticGraftPeers,(e=>a(e)>r));for(const t of e)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",t,o),y(t,pw.Opportunistic)}}}));const u=Date.now();this.fanoutLastpub.forEach(((e,t)=>{e+i<u&&(this.fanout.delete(t),this.fanoutLastpub.delete(t))})),this.fanout.forEach(((t,r)=>{const n=this.topics.get(r);t.forEach((e=>{(!n.has(e)||a(e)<this.opts.scoreThresholds.publishThreshold)&&t.delete(e)}));const s=this.topics.get(r),i=[],o=new Set;if(d.set(r,o),s){const e=uy(Array.from(s));for(const r of e){const e=this.streamsOutbound.get(r);if(e&&this.multicodecs.includes(e.protocol)&&!t.has(r)&&!this.direct.has(r)){const e=a(r);e>=this.opts.scoreThresholds.publishThreshold&&i.push(r),e>=this.opts.scoreThresholds.gossipThreshold&&o.add(r)}}}if(t.size<e){const r=e-t.size;i.slice(0,r).forEach((e=>{t.add(e),o?.delete(e)}))}})),this.emitGossip(d),await this.sendGraftPrune(c,l,h),this.flush(),this.mcache.shift(),this.dispatchEvent(new ny.A("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,r=(()=>!0)){const n=this.topics.get(e);if(!n)return new Set;let s=[];return n.forEach((e=>{const t=this.streamsOutbound.get(e);t&&this.multicodecs.includes(t.protocol)&&r(e)&&s.push(e)})),s=uy(s),t>0&&s.length>t&&(s=s.slice(0,t)),new Set(s)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;for(const e of this.backoff.values())t+=e.size;e.cacheSize.set({cache:"backoff"},t);for(const[t,r]of this.topics)e.topicPeersCount.set({topicStr:t},r.size);for(const[t,r]of this.mesh)e.meshPeerCounts.set({topicStr:t},r.size);const r=[],n=new Map;e.behaviourPenalty.reset();for(const t of this.peers.keys()){const s=this.score.score(t);r.push(s),n.set(t,s),e.behaviourPenalty.observe(this.score.peerStats.get(t)?.behaviourPenalty??0)}e.registerScores(r,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,n);const s=function(e,t,r,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of e){const e=t.get(o);if(e){const t=qb(o,e,r,n,s);for(const[e,r]of t.byTopic){let t=i.byTopic.get(e);t||(t={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(e,t)),t.p1w.push(r.p1w),t.p2w.push(r.p2w),t.p3w.push(r.p3w),t.p3bw.push(r.p3bw),t.p4w.push(r.p4w)}i.p5w.push(t.p5w),i.p6w.push(t.p6w),i.p7w.push(t.p7w),i.score.push(t.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(s)}}Xb.multicodec=ly;const e_=(0,z.kg)("libp2p-delegated-peer-routing");var t_,r_;!function(e){e[e.SENDING_QUERY=0]="SENDING_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADDING_PEER=6]="ADDING_PEER",e[e.DIALING_PEER=7]="DIALING_PEER"}(t_||(t_={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(r_||(r_={}));class n_{constructor(e){if(null==e)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new Dn.Z({concurrency:4});const{protocol:t,host:r,port:n}=e.getEndpointConfig();e_(`enabled DelegatedPeerRouting via ${t}://${r}:${n}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async findPeer(e,t={}){e_("findPeer starts: %p",e),t.timeout=t.timeout??3e4,t.signal=dn([this.abortController.signal].concat(null!=t.signal?[t.signal]:[]));const r=(0,mi.Z)(),n=(0,mi.Z)();this.httpQueue.add((async()=>(r.resolve(),await n.promise)));try{await r.promise;for await(const r of this.client.dht.findPeer(e,t))if("FINAL_PEER"===r.name)return{id:r.peer.id,multiaddrs:r.peer.multiaddrs,protocols:[]}}catch(e){throw e_.error("findPeer errored: %o",e),e}finally{n.resolve(),e_("findPeer finished: %p",e)}throw j(new Error("Not found"),"ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){let r;const n=te.k.asCID(e);r=null!=n?n:(0,Ln.cv)(e),e_("getClosestPeers starts: %s",r),t.timeout=t.timeout??3e4,t.signal=dn([this.abortController.signal].concat(null!=t.signal?[t.signal]:[]));const s=(0,mi.Z)(),i=(0,mi.Z)();this.httpQueue.add((async()=>(s.resolve(),await i.promise)));try{await s.promise;for await(const e of this.client.dht.query(r,t))"PEER_RESPONSE"===e.name&&(yield*e.closer.map((e=>({id:e.id,multiaddrs:e.multiaddrs,protocols:[]}))))}catch(e){throw e_.error("getClosestPeers errored:",e),e}finally{i.resolve(),e_("getClosestPeers finished: %b",e)}}}const s_=(0,z.kg)("libp2p:delegated-content-routing"),i_=3e4;var o_,a_;!function(e){e[e.SENDING_QUERY=0]="SENDING_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADDING_PEER=6]="ADDING_PEER",e[e.DIALING_PEER=7]="DIALING_PEER"}(o_||(o_={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(a_||(a_={}));class c_{constructor(e){if(null==e)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new Dn.Z({concurrency:4}),this.httpQueueRefs=new Dn.Z({concurrency:2});const{protocol:t,host:r,port:n}=e.getEndpointConfig();s_(`enabled DelegatedContentRouting via ${t}://${r}:${n}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async*findProviders(e,t={}){s_("findProviders starts: %c",e),t.timeout=t.timeout??i_,t.signal=dn([this.abortController.signal].concat(null!=t.signal?[t.signal]:[]));const r=(0,mi.Z)(),n=(0,mi.Z)();this.httpQueue.add((async()=>(r.resolve(),await n.promise)));try{await r.promise;for await(const r of this.client.dht.findProvs(e,t))"PROVIDER"===r.name&&(yield*r.providers.map((e=>({id:e.id,protocols:[],multiaddrs:e.multiaddrs}))))}catch(e){throw s_.error("findProviders errored:",e),e}finally{n.resolve(),s_("findProviders finished: %c",e)}}async provide(e,t={}){s_("provide starts: %c",e),t.timeout=t.timeout??i_,t.signal=dn([this.abortController.signal].concat(null!=t.signal?[t.signal]:[])),await this.httpQueueRefs.add((async()=>{await this.client.block.stat(e,t),await(0,qs.Z)(this.client.dht.provide(e,t))})),s_("provide finished: %c",e)}async put(e,t,r={}){s_("put value start: %b",e),r.timeout=r.timeout??i_,r.signal=dn([this.abortController.signal].concat(null!=r.signal?[r.signal]:[])),await this.httpQueue.add((async()=>{await(0,qs.Z)(this.client.dht.put(e,t,r))})),s_("put value finished: %b",e)}async get(e,t={}){return s_("get value start: %b",e),t.timeout=t.timeout??i_,t.signal=dn([this.abortController.signal].concat(null!=t.signal?[t.signal]:[])),await this.httpQueue.add((async()=>{for await(const r of this.client.dht.get(e,t))if("VALUE"===r.name)return s_("get value finished: %b",e),r.value;throw j(new Error("Not found"),"ERR_NOT_FOUND")}))}}const l_=e=>Promise.reject(new Error(`No base found for "${e}"`));class h_{constructor(e){this._basesByName={},this._basesByPrefix={},this._loadBase=e.loadBase||l_;for(const t of e.bases)this.addBase(t)}addBase(e){if(this._basesByName[e.name]||this._basesByPrefix[e.prefix])throw new Error(`Codec already exists for codec "${e.name}"`);this._basesByName[e.name]=e,this._basesByPrefix[e.prefix]=e}removeBase(e){delete this._basesByName[e.name],delete this._basesByPrefix[e.prefix]}async getBase(e){if(this._basesByName[e])return this._basesByName[e];if(this._basesByPrefix[e])return this._basesByPrefix[e];const t=await this._loadBase(e);return null==this._basesByName[t.name]&&null==this._basesByPrefix[t.prefix]&&this.addBase(t),t}listBases(){return Object.values(this._basesByName)}}const d_=e=>Promise.reject(new Error(`No codec found for "${e}"`));class u_{constructor(e){this._codecsByName={},this._codecsByCode={},this._loadCodec=e.loadCodec||d_;for(const t of e.codecs)this.addCodec(t)}addCodec(e){if(this._codecsByName[e.name]||this._codecsByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._codecsByName[e.name]=e,this._codecsByCode[e.code]=e}removeCodec(e){delete this._codecsByName[e.name],delete this._codecsByCode[e.code]}async getCodec(e){const t="string"==typeof e?this._codecsByName:this._codecsByCode;if(t[e])return t[e];const r=await this._loadCodec(e);return null==t[e]&&this.addCodec(r),r}listCodecs(){return Object.values(this._codecsByName)}}const p_=e=>Promise.reject(new Error(`No hasher found for "${e}"`));class f_{constructor(e){this._hashersByName={},this._hashersByCode={},this._loadHasher=e.loadHasher||p_;for(const t of e.hashers)this.addHasher(t)}addHasher(e){if(this._hashersByName[e.name]||this._hashersByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._hashersByName[e.name]=e,this._hashersByCode[e.code]=e}removeHasher(e){delete this._hashersByName[e.name],delete this._hashersByCode[e.code]}async getHasher(e){const t="string"==typeof e?this._hashersByName:this._hashersByCode;if(t[e])return t[e];const r=await this._loadHasher(e);return null==t[e]&&this.addHasher(r),r}listHashers(){return Object.values(this._hashersByName)}}function g_(e){try{e=(0,Pd.k)((0,Zr.HM)(e))}catch(e){}return e.toString()}const y_=(0,z.kg)("ipfs-http-client:lib:error-handler"),m_=B.Z.bind({ignoreUndefined:!0}),w_=U.isBrowser||U.isWebWorker?location.protocol:"http",b_=U.isBrowser||U.isWebWorker?location.hostname:"localhost",__=U.isBrowser||U.isWebWorker?location.port:"5001",E_=async e=>{let t;try{if((e.headers.get("Content-Type")||"").startsWith("application/json")){const r=await e.json();y_(r),t=r.Message||r.message}else t=await e.text()}catch(e){y_("Failed to parse error response",e),t=e.message}let r=new On.HTTPError(e);throw t&&(t.includes("deadline has elapsed")&&(r=new On.TimeoutError),t&&t.includes("context deadline exceeded")&&(r=new On.TimeoutError)),t&&t.includes("request timed out")&&(r=new On.TimeoutError),t&&(r.message=t),r},v_=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,k_=e=>e.replace(v_,(function(e){return"-"+e.toLowerCase()}));class S_ extends On{constructor(e={}){const t=((e={})=>{let t,r,n={};if("string"==typeof e||(0,Zr.h2)(e))t=new URL(g_(e));else if(e instanceof URL)t=e;else if("string"==typeof e.url||(0,Zr.h2)(e.url))t=new URL(g_(e.url)),n=e;else if(e.url instanceof URL)t=e.url,n=e;else{n=e||{};const r=(n.protocol||w_).replace(":",""),s=(n.host||b_).split(":")[0],i=n.port||__;t=new URL(`${r}://${s}:${i}`)}if(n.apiPath?t.pathname=n.apiPath:"/"!==t.pathname&&void 0!==t.pathname||(t.pathname="api/v0"),U.isNode){const e=void 0;r=n.agent||new e({keepAlive:!0,maxSockets:6})}return{...n,host:t.host,protocol:t.protocol.replace(":",""),port:Number(t.port),apiPath:t.pathname,url:t,agent:r}})(e);var r;super({timeout:(r=t.timeout||0,("string"==typeof r?gn(r):r)||void 0),headers:t.headers,base:`${t.url}`,handleError:E_,transformSearchParams:e=>{const t=new URLSearchParams;for(const[r,n]of e)"undefined"!==n&&"null"!==n&&"signal"!==r&&t.append(k_(r),n),"timeout"!==r||isNaN(n)||t.append(k_(r),n);return t},agent:t.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const n=this.fetch;this.fetch=(e,r={})=>("string"!=typeof e||e.startsWith("/")||(e=`${t.url}/${e}`),n.call(this,e,m_(r,{method:"POST"})))}}On.HTTPError;const R_=e=>t=>e(new S_(t),t);function I_(e){if(null!=e)return"string"==typeof e?e:e.toString(8).padStart(4,"0")}function T_(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const r=e.getTime(),n=Math.floor(r/1e3);t={secs:n,nsecs:1e3*(r-1e3*n)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw j(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}function A_({arg:e,searchParams:t,hashAlg:r,mtime:n,mode:s,...i}={}){t&&(i={...i,...t}),r&&(i.hash=r),null!=n&&(n=T_(n),i.mtime=n.secs,i.mtimeNsecs=n.nsecs),null!=s&&(i.mode=I_(s)),i.timeout&&!isNaN(i.timeout)&&(i.timeout=`${i.timeout}ms`),null==e?e=[]:Array.isArray(e)||(e=[e]);const o=new URLSearchParams(i);return e.forEach((e=>o.append("arg",e))),o}const P_=R_((e=>async function(t={}){return((await(await e.post("bitswap/wantlist",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json()).Keys||[]).map((e=>te.k.parse(e["/"])))})),D_=R_((e=>async function(t,r={}){return((await(await e.post("bitswap/wantlist",{signal:r.signal,searchParams:A_({...r,peer:t.toString()}),headers:r.headers})).json()).Keys||[]).map((e=>te.k.parse(e["/"])))})),O_=R_((e=>async function(t={}){const r=await e.post("bitswap/stat",{searchParams:A_(t),signal:t.signal,headers:t.headers});return function(e){return{provideBufLen:e.ProvideBufLen,wantlist:(e.Wantlist||[]).map((e=>te.k.parse(e["/"]))),peers:(e.Peers||[]).map((e=>(0,Ln.jE)(e))),blocksReceived:BigInt(e.BlocksReceived),dataReceived:BigInt(e.DataReceived),blocksSent:BigInt(e.BlocksSent),dataSent:BigInt(e.DataSent),dupBlksReceived:BigInt(e.DupBlksReceived),dupDataReceived:BigInt(e.DupDataReceived)}}(await r.json())})),N_=R_((e=>async function(t,r={}){return(await e.post("bitswap/unwant",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers})).json()}));function C_(e){return{wantlist:P_(e),wantlistForPeer:D_(e),unwant:N_(e),stat:O_(e)}}const M_=R_((e=>async function(t,r={}){const n=await e.post("block/get",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers});return new Uint8Array(await n.arrayBuffer())}));async function L_(e){if(Ai(e))return new Blob([e]);if("string"==typeof e||e instanceof String)return new Blob([e.toString()]);if(Pi(e))return e;if(Oi(e)&&(e=Ri(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const t=Ii(e),{value:r,done:n}=await t.peek();if(n)return x_(t);if(t.push(r),Number.isInteger(r))return new Blob([Uint8Array.from(await(0,Ti.Z)(t))]);if(Ai(r)||"string"==typeof r||r instanceof String)return x_(t)}throw j(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT")}async function x_(e){const t=[];for await(const r of e)t.push(r);return new Blob(t)}function B_(e){if(null!=e)return"string"==typeof e?e:e.toString(8).padStart(4,"0")}async function U_(e,t,r={}){const n=[],s=new FormData;let i=0,o=0;for await(const{content:t,path:r,mode:a,mtime:c}of Po(e,L_)){let e="";i>0&&(e=`-${i}`);let l=(t?"file":"dir")+e;const h=[];if(null!=a&&h.push(`mode=${B_(a)}`),null!=c){const{secs:e,nsecs:t}=c;h.push(`mtime=${e}`),null!=t&&h.push(`mtime-nsecs=${t}`)}if(h.length&&(l=`${l}?${h.join("&")}`),t){s.set(l,t,null!=r?encodeURIComponent(r):void 0);const e=o+t.size;n.push({name:r,start:o,end:e}),o=e}else{if(null==r)throw new Error("path or content or both must be set");s.set(l,new File([""],encodeURIComponent(r),{type:"application/x-directory"}))}i++}return{total:o,parts:n,headers:r,body:s}}function z_(...e){return(0,dn.anySignal)(function(e){return e.filter(Boolean)}(e))}const j_=R_((e=>async function t(r,n={}){const s=z_((new AbortController).signal,n.signal);let i;try{const t=await e.post("block/put",{signal:s,searchParams:A_(n),...await U_([r],0,n.headers)});i=await t.json()}catch(e){if("dag-pb"===n.format)return t(r,{...n,format:"protobuf"});if("dag-cbor"===n.format)return t(r,{...n,format:"cbor"});throw e}return te.k.parse(i.Key)})),F_=R_((e=>async function*(t,r={}){Array.isArray(t)||(t=[t]);const n=await e.post("block/rm",{signal:r.signal,searchParams:A_({arg:t.map((e=>e.toString())),"stream-channels":!0,...r}),headers:r.headers});for await(const e of n.ndjson())yield V_(e)}));function V_(e){const t={cid:te.k.parse(e.Hash)};return e.Error&&(t.error=new Error(e.Error)),t}const $_=R_((e=>async function(t,r={}){const n=await e.post("block/stat",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers}),s=await n.json();return{cid:te.k.parse(s.Key),size:s.Size}}));function H_(e){return{get:M_(e),put:j_(e),rm:F_(e),stat:$_(e)}}const G_=R_((e=>async function(t,r={}){const n=await e.post("bootstrap/add",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),{Peers:s}=await n.json();return{Peers:s.map((e=>(0,Zr.HM)(e)))}})),q_=R_((e=>async function(t={}){const r=await e.post("bootstrap/rm",{signal:t.signal,searchParams:A_({...t,all:!0}),headers:t.headers}),{Peers:n}=await r.json();return{Peers:n.map((e=>(0,Zr.HM)(e)))}})),K_=R_((e=>async function(t={}){const r=await e.post("bootstrap/list",{signal:t.signal,searchParams:A_(t),headers:t.headers}),{Peers:n}=await r.json();return{Peers:n.map((e=>(0,Zr.HM)(e)))}})),W_=R_((e=>async function(t={}){const r=await e.post("bootstrap/add",{signal:t.signal,searchParams:A_({...t,default:!0}),headers:t.headers}),{Peers:n}=await r.json();return{Peers:n.map((e=>(0,Zr.HM)(e)))}})),Z_=R_((e=>async function(t,r={}){const n=await e.post("bootstrap/rm",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),{Peers:s}=await n.json();return{Peers:s.map((e=>(0,Zr.HM)(e)))}}));function Y_(e){return{add:G_(e),clear:q_(e),list:K_(e),reset:W_(e),rm:Z_(e)}}const J_=R_((e=>async function(t,r={}){const n=await e.post("config/profile/apply",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),s=await n.json();return{original:s.OldCfg,updated:s.NewCfg}}));function Q_(e){if(null==e)return e;const t=/^[A-Z]+$/;return Object.keys(e).reduce(((r,n)=>(t.test(n)?r[n.toLowerCase()]=e[n]:t.test(n[0])?r[n[0].toLowerCase()+n.slice(1)]=e[n]:r[n]=e[n],r)),{})}const X_=R_((e=>async function(t={}){const r=await e.post("config/profile/list",{signal:t.signal,searchParams:A_(t),headers:t.headers});return(await r.json()).map((e=>Q_(e)))}));function eE(e){return{apply:J_(e),list:X_(e)}}const tE=R_((e=>async(t,r={})=>{if(!t)throw new Error("key argument is required");const n=await e.post("config",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});return(await n.json()).Value})),rE=R_((e=>async(t={})=>{const r=await e.post("config/show",{signal:t.signal,searchParams:A_({...t}),headers:t.headers});return await r.json()})),nE=R_((e=>async(t,r={})=>{const n=z_((new AbortController).signal,r.signal),s=await e.post("config/replace",{signal:n,searchParams:A_(r),...await U_([(0,Hr.m)(JSON.stringify(t))],0,r.headers)});await s.text()})),sE=R_((e=>async(t,r,n={})=>{if("string"!=typeof t)throw new Error("Invalid key type");const s={...n,...iE(t,r)},i=await e.post("config",{signal:n.signal,searchParams:A_(s),headers:n.headers});await i.text()})),iE=(e,t)=>{switch(typeof t){case"boolean":return{arg:[e,t.toString()],bool:!0};case"string":return{arg:[e,t]};default:return{arg:[e,JSON.stringify(t)],json:!0}}};function oE(e){return{getAll:rE(e),get:tE(e),set:sE(e),replace:nE(e),profiles:eE(e)}}const aE=R_((e=>async function*(t,r={}){const n=await e.post("dag/export",{signal:r.signal,searchParams:A_({arg:t.toString()}),headers:r.headers});yield*n.iterator()}));async function*cE(e,t,r,n,s){const i=async e=>{const t=await r.getCodec(e.code),i=await n(e,s);return t.decode(i)},o=t.split("/").filter(Boolean);let a=await i(e),c=e;for(;o.length;){const e=o.shift();if(!e)throw j(new Error(`Could not resolve path "${t}"`),"ERR_INVALID_PATH");if(!Object.prototype.hasOwnProperty.call(a,e))throw j(new Error(`no link named "${e}" under ${c}`),"ERR_NO_LINK");a=a[e],yield{value:a,remainderPath:o.join("/")};const r=te.k.asCID(a);r&&(c=r,a=await i(a))}yield{value:a,remainderPath:""}}const lE=(e,t)=>{const r=R_(((t,r)=>{const n=M_(r);return async(t,r={})=>{if(r.path){const s=r.localResolve?await(0,bd.Z)(cE(t,r.path,e,n,r)):await xn(cE(t,r.path,e,n,r));if(!s)throw j(new Error("Not found"),"ERR_NOT_FOUND");return s}const s=await e.getCodec(t.code),i=await n(t,r);return{value:s.decode(i),remainderPath:""}}}));return r(t)},hE=R_((e=>async function*(t,r={}){const n=z_((new AbortController).signal,r.signal),{headers:s,body:i}=await U_(t,0,r.headers),o=await e.post("dag/import",{signal:n,headers:s,body:i,searchParams:A_({"pin-roots":r.pinRoots})});for await(const{Root:e}of o.ndjson())if(void 0!==e){const{Cid:{"/":t},PinErrorMsg:r}=e;yield{root:{cid:te.k.parse(t),pinErrorMsg:r}}}})),dE=(e,t)=>{const r=R_((t=>async(r,n={})=>{const s={storeCodec:"dag-cbor",hashAlg:"sha2-256",...n};let i;if(s.inputCodec){if(!(r instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");i=r}else i=(await e.getCodec(s.storeCodec)).encode(r),s.inputCodec=s.storeCodec;const o=z_((new AbortController).signal,s.signal),a=await t.post("dag/put",{timeout:s.timeout,signal:o,searchParams:A_(s),...await U_([i],0,s.headers)}),c=await a.json();return te.k.parse(c.Cid["/"])}));return r(t)},uE=R_((e=>async(t,r={})=>{const n=await e.post("dag/resolve",{signal:r.signal,searchParams:A_({arg:`${t}${r.path?`/${r.path}`.replace(/\/[/]+/g,"/"):""}`,...r}),headers:r.headers}),s=await n.json();return{cid:te.k.parse(s.Cid["/"]),remainderPath:s.RemPath}}));function pE(e,t){return{export:aE(t),get:lE(e,t),import:hE(t),put:dE(e,t),resolve:uE(t)}}const fE=e=>{if(0===e.Type)return{name:"SENDING_QUERY",type:e.Type};if(1===e.Type)return{from:(0,Ln.jE)(e.ID),name:"PEER_RESPONSE",type:e.Type,messageType:0,messageName:"PUT_VALUE",closer:(e.Responses||[]).map((({ID:e,Addrs:t})=>({id:(0,Ln.jE)(e),multiaddrs:t.map((e=>(0,Zr.HM)(e))),protocols:[]}))),providers:(e.Responses||[]).map((({ID:e,Addrs:t})=>({id:(0,Ln.jE)(e),multiaddrs:t.map((e=>(0,Zr.HM)(e))),protocols:[]})))};if(2===e.Type){let t={id:e.ID??(0,Ln.jE)(e.ID),multiaddrs:[],protocols:[]};return e.Responses&&e.Responses.length&&(t={id:(0,Ln.jE)(e.Responses[0].ID),multiaddrs:e.Responses[0].Addrs.map((e=>(0,Zr.HM)(e))),protocols:[]}),{name:"FINAL_PEER",type:e.Type,peer:t}}if(3===e.Type)return{name:"QUERY_ERROR",type:e.Type,error:new Error(e.Extra)};if(4===e.Type)return{name:"PROVIDER",type:e.Type,providers:e.Responses.map((({ID:e,Addrs:t})=>({id:(0,Ln.jE)(e),multiaddrs:t.map((e=>(0,Zr.HM)(e))),protocols:[]})))};if(5===e.Type)return{name:"VALUE",type:e.Type,value:(0,Hr.m)(e.Extra,"base64pad")};if(6===e.Type){const t=e.Responses.map((({ID:e})=>(0,Ln.jE)(e)));if(!t.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:e.Type,peer:t[0]}}if(7===e.Type)return{name:"DIALING_PEER",type:e.Type,peer:(0,Ln.jE)(e.ID)};throw new Error("Unknown DHT event type")},gE=R_((e=>async function*(t,r={}){const n=await e.post("dht/findpeer",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});for await(const e of n.ndjson())yield fE(e)})),yE=R_((e=>async function*(t,r={}){const n=await e.post("dht/findprovs",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers});for await(const e of n.ndjson())yield fE(e)})),mE=R_((e=>async function*(t,r={}){const n=await e.post("dht/get",{signal:r.signal,searchParams:A_({arg:t instanceof Uint8Array?(0,Qr.B)(t):t.toString(),...r}),headers:r.headers});for await(const e of n.ndjson())yield fE(e)})),wE=R_((e=>async function*(t,r={recursive:!1}){const n=Array.isArray(t)?t:[t],s=await e.post("dht/provide",{signal:r.signal,searchParams:A_({arg:n.map((e=>e.toString())),...r}),headers:r.headers});for await(const e of s.ndjson())yield fE(e)})),bE=R_((e=>async function*(t,r,n={}){const s=z_((new AbortController).signal,n.signal),i=await e.post("dht/put",{signal:s,searchParams:A_({arg:t instanceof Uint8Array?(0,Qr.B)(t):t.toString(),...n}),...await U_([r],0,n.headers)});for await(const e of i.ndjson())yield fE(e)})),_E=R_((e=>async function*(t,r={}){const n=await e.post("dht/query",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers});for await(const e of n.ndjson())yield fE(e)}));function EE(e){return{findPeer:gE(e),findProvs:yE(e),get:mE(e),provide:wE(e),put:bE(e),query:_E(e)}}const vE=R_((e=>async function(t={}){return(await e.post("diag/cmds",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json()})),kE=R_((e=>async function(t={}){return(await e.post("diag/net",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json()})),SE=R_((e=>async function(t={}){return(await e.post("diag/sys",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json()}));function RE(e){return{cmds:vE(e),net:kE(e),sys:SE(e)}}const IE=R_((e=>async function(t,r,n={}){const s=await e.post("files/chmod",{signal:n.signal,searchParams:A_({arg:t,mode:r,...n}),headers:n.headers});await s.text()})),TE=R_((e=>async function(t,r,n={}){const s=Array.isArray(t)?t:[t],i=await e.post("files/cp",{signal:n.signal,searchParams:A_({arg:s.concat(r).map((e=>te.k.asCID(e)?`/ipfs/${e}`:e)),...n}),headers:n.headers});await i.text()})),AE=R_((e=>async function(t,r={}){if(!t||"string"!=typeof t)throw new Error("ipfs.files.flush requires a path");const n=await e.post("files/flush",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),s=await n.json();return te.k.parse(s.Cid)}));function PE(e){const t=Q_(e);return Object.prototype.hasOwnProperty.call(t,"mode")&&(t.mode=parseInt(t.mode,8)),Object.prototype.hasOwnProperty.call(t,"mtime")&&(t.mtime={secs:t.mtime,nsecs:t.mtimeNsecs||0},delete t.mtimeNsecs),t}const DE=R_((e=>async function*(t,r={}){if(!t)throw new Error("ipfs.files.ls requires a path");const n=await e.post("files/ls",{signal:r.signal,searchParams:A_({arg:te.k.asCID(t)?`/ipfs/${t}`:t,long:!0,...r,stream:!0}),headers:r.headers});for await(const e of n.ndjson())if("Entries"in e)for(const t of e.Entries||[])yield OE(PE(t));else yield OE(PE(e))}));function OE(e){return e.hash&&(e.cid=te.k.parse(e.hash)),delete e.hash,e.type=1===e.type?"directory":"file",e}const NE=R_((e=>async function(t,r={}){const n=await e.post("files/mkdir",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});await n.text()})),CE=R_((e=>async function(t,r,n={}){Array.isArray(t)||(t=[t]);const s=await e.post("files/mv",{signal:n.signal,searchParams:A_({arg:t.concat(r),...n}),headers:n.headers});await s.text()}));var ME=r(18901);const LE=R_((e=>async function*(t,r={}){const n=await e.post("files/read",{signal:r.signal,searchParams:A_({arg:t,count:r.length,...r}),headers:r.headers});yield*ME(n.body)})),xE=R_((e=>async function(t,r={}){const n=await e.post("files/rm",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),s=await n.text();if(""!==s){const e=new On.HTTPError(n);throw e.message=s,e}})),BE=R_((e=>async function(t,r={}){const n=await e.post("files/stat",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),s=await n.json();return s.WithLocality=s.WithLocality||!1,(i=PE(s)).cid=te.k.parse(i.hash),delete i.hash,i;var i})),UE=R_((e=>async function(t,r={}){const n=await e.post("files/touch",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});await n.text()})),zE=R_((e=>async function(t,r,n={}){const s=z_((new AbortController).signal,n.signal),i=await e.post("files/write",{signal:s,searchParams:A_({arg:t,streamChannels:!0,count:n.length,...n}),...await U_([{content:r,path:"arg",mode:I_(n.mode),mtime:T_(n.mtime)}],0,n.headers)});await i.text()}));function jE(e){return{chmod:IE(e),cp:TE(e),flush:AE(e),ls:DE(e),mkdir:NE(e),mv:CE(e),read:LE(e),rm:xE(e),stat:BE(e),touch:UE(e),write:zE(e)}}const FE=R_((e=>async(e,t,r={})=>{throw j(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),VE=R_((e=>async function(t,r={type:"Ed25519"}){const n=await e.post("key/gen",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});return Q_(await n.json())})),$E=R_((e=>async function(t,r,n,s={}){const i=await e.post("key/import",{signal:s.signal,searchParams:A_({arg:t,pem:r,password:n,...s}),headers:s.headers});return Q_(await i.json())})),HE=R_((e=>async(e,t={})=>{throw j(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),GE=R_((e=>async function(t={}){const r=await e.post("key/list",{signal:t.signal,searchParams:A_(t),headers:t.headers});return((await r.json()).Keys||[]).map((e=>Q_(e)))})),qE=R_((e=>async function(t,r,n={}){const s=await e.post("key/rename",{signal:n.signal,searchParams:A_({arg:[t,r],...n}),headers:n.headers});return Q_(await s.json())})),KE=R_((e=>async function(t,r={}){const n=await e.post("key/rm",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});return Q_((await n.json()).Keys[0])}));function WE(e){return{export:FE(e),gen:VE(e),import:$E(e),info:HE(e),list:GE(e),rename:qE(e),rm:KE(e)}}const ZE=R_((e=>async function(t,r,n={}){const s=await e.post("log/level",{signal:n.signal,searchParams:A_({arg:[t,r],...n}),headers:n.headers});return Q_(await s.json())})),YE=R_((e=>async function(t={}){const r=await e.post("log/ls",{signal:t.signal,searchParams:A_(t),headers:t.headers});return(await r.json()).Strings})),JE=R_((e=>async function*(t={}){const r=await e.post("log/tail",{signal:t.signal,searchParams:A_(t),headers:t.headers});yield*r.ndjson()}));function QE(e){return{level:ZE(e),ls:YE(e),tail:JE(e)}}const XE=R_((e=>async function(t,r={}){const n=await e.post("name/publish",{signal:r.signal,searchParams:A_({arg:`${t}`,...r}),headers:r.headers});return Q_(await n.json())})),ev=R_((e=>async function*(t,r={}){const n=await e.post("name/resolve",{signal:r.signal,searchParams:A_({arg:t,stream:!0,...r}),headers:r.headers});for await(const e of n.ndjson())yield e.Path})),tv=R_((e=>async function(t,r={}){const n=await e.post("name/pubsub/cancel",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});return Q_(await n.json())})),rv=R_((e=>async function(t={}){const r=await e.post("name/pubsub/state",{signal:t.signal,searchParams:A_(t),headers:t.headers});return Q_(await r.json())})),nv=R_((e=>async function(t={}){const r=await e.post("name/pubsub/subs",{signal:t.signal,searchParams:A_(t),headers:t.headers});return(await r.json()).Strings||[]}));function sv(e){return{cancel:tv(e),state:rv(e),subs:nv(e)}}function iv(e){return{publish:XE(e),resolve:ev(e),pubsub:sv(e)}}const ov=R_((e=>async function(t,r={}){const n=await e.post("object/data",{signal:r.signal,searchParams:A_({arg:`${t instanceof Uint8Array?te.k.decode(t):t}`,...r}),headers:r.headers}),s=await n.arrayBuffer();return new Uint8Array(s,0,s.byteLength)})),av=R_((e=>async function(t,r={}){const n=await e.post("object/get",{signal:r.signal,searchParams:A_({arg:`${t instanceof Uint8Array?te.k.decode(t):t}`,dataEncoding:"base64",...r}),headers:r.headers}),s=await n.json();return{Data:(0,Hr.m)(s.Data,"base64pad"),Links:(s.Links||[]).map((e=>({Name:e.Name,Hash:te.k.parse(e.Hash),Tsize:e.Size})))}})),cv=R_((e=>async function(t,r={}){const n=await e.post("object/links",{signal:r.signal,searchParams:A_({arg:`${t instanceof Uint8Array?te.k.decode(t):t}`,...r}),headers:r.headers});return((await n.json()).Links||[]).map((e=>({Name:e.Name,Tsize:e.Size,Hash:te.k.parse(e.Hash)})))})),lv=R_((e=>async function(t={}){const r=await e.post("object/new",{signal:t.signal,searchParams:A_({arg:t.template,...t}),headers:t.headers}),{Hash:n}=await r.json();return te.k.parse(n)})),hv=(e,t)=>{const r=R_((r=>{const n=dE(e,t);return async function(e,t={}){return n(e,{...t,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}}));return r(t)},dv=R_((e=>async function(t,r={}){const n=await e.post("object/stat",{signal:r.signal,searchParams:A_({arg:`${t}`,...r}),headers:r.headers}),s=await n.json();return{...s,Hash:te.k.parse(s.Hash)}})),uv=R_((e=>async function(t,r,n={}){const s=await e.post("object/patch/add-link",{signal:n.signal,searchParams:A_({arg:[`${t}`,r.Name||r.name||"",(r.Hash||r.cid||"").toString()||null],...n}),headers:n.headers}),{Hash:i}=await s.json();return te.k.parse(i)})),pv=R_((e=>async function(t,r,n={}){const s=z_((new AbortController).signal,n.signal),i=await e.post("object/patch/append-data",{signal:s,searchParams:A_({arg:`${t}`,...n}),...await U_([r],0,n.headers)}),{Hash:o}=await i.json();return te.k.parse(o)})),fv=R_((e=>async function(t,r,n={}){const s=await e.post("object/patch/rm-link",{signal:n.signal,searchParams:A_({arg:[`${t}`,r.Name||r.name||null],...n}),headers:n.headers}),{Hash:i}=await s.json();return te.k.parse(i)})),gv=R_((e=>async function(t,r,n={}){const s=z_((new AbortController).signal,n.signal),i=await e.post("object/patch/set-data",{signal:s,searchParams:A_({arg:[`${t}`],...n}),...await U_([r],0,n.headers)}),{Hash:o}=await i.json();return te.k.parse(o)}));function yv(e){return{addLink:uv(e),appendData:pv(e),rmLink:fv(e),setData:gv(e)}}function mv(e,t){return{data:ov(t),get:av(t),links:cv(t),new:lv(t),put:hv(e,t),stat:dv(t),patch:yv(t)}}const wv=R_((e=>async function*(t,r={}){for await(const{path:n,recursive:s,metadata:i}of Bn(t)){const t=await e.post("pin/add",{signal:r.signal,searchParams:A_({...r,arg:n,recursive:s,metadata:i?JSON.stringify(i):void 0,stream:!0}),headers:r.headers});for await(const e of t.ndjson())if(e.Pins)for(const t of e.Pins)yield te.k.parse(t);else yield te.k.parse(e)}}));function bv(e){const t=wv(e);return R_((()=>async function(e,r={}){return xn(t([{path:e,...r}],r))}))(e)}function _v(e,t,r){const n={type:e,cid:te.k.parse(t)};return r&&(n.metadata=r),n}const Ev=R_((e=>async function*(t={}){let r=[];t.paths&&(r=Array.isArray(t.paths)?t.paths:[t.paths]);const n=await e.post("pin/ls",{signal:t.signal,searchParams:A_({...t,arg:r.map((e=>`${e}`)),stream:!0}),headers:t.headers});for await(const e of n.ndjson()){if(e.Keys){for(const t of Object.keys(e.Keys))yield _v(e.Keys[t].Type,t,e.Keys[t].Metadata);return}yield _v(e.Type,e.Cid,e.Metadata)}})),vv=R_((e=>async function*(t,r={}){for await(const{path:n,recursive:s}of Bn(t)){const t=new URLSearchParams(r.searchParams);t.append("arg",`${n}`),null!=s&&t.set("recursive",String(s));const i=await e.post("pin/rm",{signal:r.signal,headers:r.headers,searchParams:A_({...r,arg:`${n}`,recursive:s})});for await(const e of i.ndjson())e.Pins?yield*e.Pins.map((e=>te.k.parse(e))):yield te.k.parse(e)}})),kv=e=>{const t=vv(e);return R_((()=>async function(e,r={}){return xn(t([{path:e,...r}],r))}))(e)},Sv=({Name:e,Status:t,Cid:r})=>({cid:te.k.parse(r),name:e,status:t}),Rv=e=>{if("string"==typeof e&&""!==e)return e;throw new TypeError("service name must be passed")},Iv=e=>{if(te.k.asCID(e))return e.toString();throw new TypeError("CID instance expected instead of "+typeof e)},Tv=({service:e,cid:t,name:r,status:n,all:s})=>{const i=A_({service:Rv(e),name:r,force:!!s||void 0});if(t)for(const e of t)i.append("cid",Iv(e));if(n)for(const e of n)i.append("status",e);return i},Av=({cid:e,service:t,background:r,name:n,origins:s})=>{const i=A_({arg:Iv(e),service:Rv(t),name:n,background:!!r||void 0});if(s)for(const e of s)i.append("origin",e.toString());return i};function Pv(e){return async function(t,{timeout:r,signal:n,headers:s,...i}){const o=await e.post("pin/remote/add",{timeout:r,signal:n,headers:s,searchParams:Av({cid:t,...i})});return Sv(await o.json())}}function Dv(e){return async function*({timeout:t,signal:r,headers:n,...s}){const i=await e.post("pin/remote/ls",{timeout:t,signal:r,headers:n,searchParams:Tv(s)});for await(const e of i.ndjson())yield Sv(e)}}function Ov(e){return async function({timeout:t,signal:r,headers:n,...s}){await e.post("pin/remote/rm",{timeout:t,signal:r,headers:n,searchParams:Tv({...s,all:!1})})}}function Nv(e){return async function({timeout:t,signal:r,headers:n,...s}){await e.post("pin/remote/rm",{timeout:t,signal:r,headers:n,searchParams:Tv({...s,all:!0})})}}function Cv(e){const t=String(e);if("undefined"===t)throw Error("endpoint is required");return"/"===t[t.length-1]?t.slice(0,-1):t}function Mv(e){return{service:e.Service,endpoint:new URL(e.ApiEndpoint),...e.Stat&&{stat:Lv(e.Stat)}}}function Lv(e){switch(e.Status){case"valid":{const{Pinning:t,Pinned:r,Queued:n,Failed:s}=e.PinCount;return{status:"valid",pinCount:{queued:n,pinning:t,pinned:r,failed:s}}}case"invalid":return{status:"invalid"};default:return{status:e.Status}}}function xv(e){return async function(t,r){const{endpoint:n,key:s,headers:i,timeout:o,signal:a}=r;await e.post("pin/remote/service/add",{timeout:o,signal:a,searchParams:A_({arg:[t,Cv(n),s]}),headers:i})}}function Bv(e){return async function(t={}){const{stat:r,headers:n,timeout:s,signal:i}=t,o=await e.post("pin/remote/service/ls",{timeout:s,signal:i,headers:n,searchParams:!0===r?A_({stat:r}):void 0}),{RemoteServices:a}=await o.json();return a.map(Mv)}}function Uv(e){return async function(t,r={}){await e.post("pin/remote/service/rm",{signal:r.signal,headers:r.headers,searchParams:A_({arg:t})})}}function zv(e){const t=new S_(e);return{add:xv(t),ls:Bv(t),rm:Uv(t)}}function jv(e){const t=new S_(e);return{add:Pv(t),ls:Dv(t),rm:Ov(t),rmAll:Nv(t),service:zv(e)}}function Fv(e){return{addAll:wv(e),add:bv(e),ls:Ev(e),rmAll:vv(e),rm:kv(e),remote:jv(e)}}const Vv=e=>(0,Qr.B)($v(e)),$v=e=>or.base64url.decode(e),Hv=e=>or.base64url.encode((0,Hr.m)(e)),Gv=R_((e=>async function(t={}){const{Strings:r}=await(await e.post("pubsub/ls",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json();return n=r,(Array.isArray(n)?n.map(Vv):n)||[];var n})),qv=R_((e=>async function(t,r={}){const n=await e.post("pubsub/peers",{signal:r.signal,searchParams:A_({arg:Hv(t),...r}),headers:r.headers}),{Strings:s}=await n.json();return s||[]})),Kv=R_((e=>async function(t,r,n={}){const s=A_({arg:Hv(t),...n}),i=z_((new AbortController).signal,n.signal),o=await e.post("pubsub/pub",{signal:i,searchParams:s,...await U_([r],0,n.headers)});await o.text()})),Wv=(0,z.kg)("ipfs-http-client:pubsub:subscribe"),Zv=(e,t)=>R_((e=>async function(r,n,s={}){let i,o;s.signal=t.subscribe(r,n,s.signal);const a=new Promise(((e,t)=>{i=e,o=t})),c=setTimeout((()=>i()),1e3);return e.post("pubsub/sub",{signal:s.signal,searchParams:A_({arg:Hv(r),...s}),headers:s.headers}).catch((e=>{t.unsubscribe(r,n),o(e)})).then((e=>{clearTimeout(c),e&&(async function(e,{onMessage:t,onEnd:r,onError:n}){n=n||Wv;try{for await(const r of e.ndjson())try{if(!r.from)continue;null!=r.from&&null!=r.seqno?t({type:"signed",from:(0,Ln.jE)(r.from),data:$v(r.data),sequenceNumber:(s=r.seqno,BigInt(`0x${(0,Qr.B)(or.base64url.decode(s),"base16")}`)),topic:Vv(r.topicIDs[0]),key:$v(r.key??"u"),signature:$v(r.signature??"u")}):t({type:"unsigned",data:$v(r.data),topic:Vv(r.topicIDs[0])})}catch(e){e.message=`Failed to parse pubsub message: ${e.message}`,n(e,!1,r)}}catch(e){Yv(e)||n(e,!0)}finally{r()}var s}(e,{onMessage:e=>{n&&("function"!=typeof n?"function"==typeof n.handleEvent&&n.handleEvent(e):n(e))},onEnd:()=>t.unsubscribe(r,n),onError:s.onError}),i())})),a}))(e),Yv=e=>{switch(e.type){case"aborted":case"abort":return!0;default:return"AbortError"===e.name}};class Jv{constructor(){this._subs=new Map}subscribe(e,t,r){const n=this._subs.get(e)||[];if(n.find((e=>e.handler===t)))throw new Error(`Already subscribed to ${e} with this handler`);const s=new AbortController;return this._subs.set(e,[{handler:t,controller:s}].concat(n)),r&&r.addEventListener("abort",(()=>this.unsubscribe(e,t))),s.signal}unsubscribe(e,t){const r=this._subs.get(e)||[];let n;t?(this._subs.set(e,r.filter((e=>e.handler!==t))),n=r.filter((e=>e.handler===t))):(this._subs.set(e,[]),n=r),(this._subs.get(e)||[]).length||this._subs.delete(e),n.forEach((e=>e.controller.abort()))}}function Qv(e){const t=new Jv;return{ls:Gv(e),peers:qv(e),publish:Kv(e),subscribe:Zv(e,t),unsubscribe:(r=t,async function(e,t){r.unsubscribe(e,t)})};var r}const Xv=R_((e=>async function*(t={}){const r=await e.post("refs/local",{signal:t.signal,transform:Q_,searchParams:A_(t),headers:t.headers});yield*r.ndjson()})),ek=R_(((e,t)=>Object.assign((async function*(t,r={}){const n=Array.isArray(t)?t:[t],s=await e.post("refs",{signal:r.signal,searchParams:A_({arg:n.map((e=>`${e instanceof Uint8Array?te.k.decode(e):e}`)),...r}),headers:r.headers,transform:Q_});yield*s.ndjson()}),{local:Xv(t)}))),tk=R_((e=>async function*(t={}){const r=await e.post("repo/gc",{signal:t.signal,searchParams:A_(t),headers:t.headers,transform:e=>({err:e.Error?new Error(e.Error):null,cid:(e.Key||{})["/"]?te.k.parse(e.Key["/"]):null})});yield*r.ndjson()})),rk=R_((e=>async function(t={}){const r=await e.post("repo/stat",{signal:t.signal,searchParams:A_(t),headers:t.headers}),n=await r.json();return{numObjects:BigInt(n.NumObjects),repoSize:BigInt(n.RepoSize),repoPath:n.RepoPath,version:n.Version,storageMax:BigInt(n.StorageMax)}})),nk=R_((e=>async function(t={}){return(await(await e.post("repo/version",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json()).Version}));function sk(e){return{gc:tk(e),stat:rk(e),version:nk(e)}}const ik=R_((e=>async function*(t={}){const r=await e.post("stats/bw",{signal:t.signal,searchParams:A_(t),headers:t.headers,transform:e=>({totalIn:BigInt(e.TotalIn),totalOut:BigInt(e.TotalOut),rateIn:parseFloat(e.RateIn),rateOut:parseFloat(e.RateOut)})});yield*r.ndjson()}));function ok(e){return{bitswap:O_(e),repo:rk(e),bw:ik(e)}}const ak=R_((e=>async function(t={}){const r=await e.post("swarm/addrs",{signal:t.signal,searchParams:A_(t),headers:t.headers}),{Addrs:n}=await r.json();return Object.keys(n).map((e=>({id:(0,Ln.jE)(e),addrs:(n[e]||[]).map((e=>(0,Zr.HM)(e)))})))})),ck=R_((e=>async function(t,r={}){const n=await e.post("swarm/connect",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),{Strings:s}=await n.json();return s||[]})),lk=R_((e=>async function(t,r={}){const n=await e.post("swarm/disconnect",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),{Strings:s}=await n.json();return s||[]})),hk=R_((e=>async function(t={}){const r=await e.post("swarm/addrs/local",{signal:t.signal,searchParams:A_(t),headers:t.headers}),{Strings:n}=await r.json();return(n||[]).map((e=>(0,Zr.HM)(e)))})),dk=R_((e=>async function(t={}){const r=await e.post("swarm/peers",{signal:t.signal,searchParams:A_(t),headers:t.headers}),{Peers:n}=await r.json();return(n||[]).map((e=>({addr:(0,Zr.HM)(e.Addr),peer:(0,Ln.jE)(e.Peer),muxer:e.Muxer,latency:e.Latency,streams:e.Streams,direction:null==e.Direction?void 0:0===e.Direction?"inbound":"outbound"})))}));function uk(e){return{addrs:ak(e),connect:ck(e),disconnect:lk(e),localAddrs:hk(e),peers:dk(e)}}const pk=R_((e=>async function*(t,r={}){const n=z_((new AbortController).signal,r.signal),{headers:s,body:i,total:o,parts:a}=await U_(t,0,r.headers),[c,l]="function"==typeof r.progress?fk(o,a,r.progress):[void 0,void 0],h=await e.post("add",{searchParams:A_({"stream-channels":!0,...r,progress:Boolean(c)}),onUploadProgress:l,signal:n,headers:s,body:i});for await(let e of h.ndjson())e=Q_(e),void 0!==e.hash?yield yk(e):c&&c(e.bytes||0,e.name)})),fk=(e,t,r)=>t?[void 0,gk(e,t,r)]:[r,void 0],gk=(e,t,r)=>{let n=0;const s=t.length;return({loaded:i,total:o})=>{const a=Math.floor(i/o*e);for(;n<s;){const{start:e,end:s,name:i}=t[n];if(a<s){r(a-e,i);break}r(s-e,i),n+=1}}};function yk({name:e,hash:t,size:r,mode:n,mtime:s,mtimeNsecs:i}){const o={path:e,cid:te.k.parse(t),size:parseInt(r)};return null!=n&&(o.mode=parseInt(n,8)),null!=s&&(o.mtime={secs:s,nsecs:i||0}),o}function mk(e){const t=pk(e);return R_((()=>async function(e,r={}){return await xn(t(xi(e),r))}))(e)}const wk=R_((e=>async function*(t,r={}){const n=await e.post("cat",{signal:r.signal,searchParams:A_({arg:t.toString(),...r}),headers:r.headers});yield*n.iterator()})),bk=R_((e=>async(t={})=>(await e.post("commands",{signal:t.signal,searchParams:A_(t),headers:t.headers})).json())),_k=R_((e=>async(t,r={})=>{const n=await e.post("dns",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers});return(await n.json()).Path})),Ek=R_((e=>()=>{const t=new URL(e.opts.base||"");return{host:t.hostname,port:t.port,protocol:t.protocol,pathname:t.pathname,"api-path":t.pathname}})),vk=R_((e=>async function*(t,r={}){const n={arg:`${t instanceof Uint8Array?te.k.decode(t):t}`,...r};n.compressionLevel&&(n["compression-level"]=n.compressionLevel,delete n.compressionLevel);const s=await e.post("get",{signal:r.signal,searchParams:A_(n),headers:r.headers});yield*s.iterator()})),kk=R_((e=>async function(t={}){const r=await e.post("id",{signal:t.signal,searchParams:A_({arg:t.peerId?t.peerId.toString():void 0,...t}),headers:t.headers}),n={...Q_(await r.json())};return n.id=(0,Ln.jE)(n.id),n.addresses&&(n.addresses=n.addresses.map((e=>(0,Zr.HM)(e)))),n})),Sk=e=>{const t=kk(e);return async function(e={}){const r=await t(e);return Boolean(r&&r.addresses&&r.addresses.length)}},Rk=R_(((e,t)=>async function*(r,n={}){const s=`${r instanceof Uint8Array?te.k.decode(r):r}`;async function i(e){let r=e.Hash;if(r.includes("/")){const e=r.startsWith("/ipfs/")?r:`/ipfs/${r}`;r=(await BE(t)(e)).cid}else r=te.k.parse(r);const n={name:e.Name,path:s+(e.Name?`/${e.Name}`:""),size:e.Size,cid:r,type:Ik(e)};return e.Mode&&(n.mode=parseInt(e.Mode,8)),void 0!==e.Mtime&&null!==e.Mtime&&(n.mtime={secs:e.Mtime},void 0!==e.MtimeNsecs&&null!==e.MtimeNsecs&&(n.mtime.nsecs=e.MtimeNsecs)),n}const o=await e.post("ls",{signal:n.signal,searchParams:A_({arg:s,...n}),headers:n.headers});for await(let e of o.ndjson()){if(e=e.Objects,!e)throw new Error("expected .Objects in results");if(e=e[0],!e)throw new Error("expected one array in results.Objects");const t=e.Links;if(!Array.isArray(t))throw new Error("expected one array in results.Objects[0].Links");if(!t.length)return void(yield i(e));yield*t.map(i)}}));function Ik(e){switch(e.Type){case 1:case 5:return"dir";default:return"file"}}const Tk=R_((e=>async function(t={}){const r=await e.post("dns",{signal:t.signal,searchParams:A_(t),headers:t.headers});return Q_(await r.json())})),Ak=R_((e=>async function*(t,r={}){const n=await e.post("ping",{signal:r.signal,searchParams:A_({arg:`${t}`,...r}),headers:r.headers,transform:Q_});yield*n.ndjson()})),Pk=R_((e=>async function(t,r={}){const n=await e.post("resolve",{signal:r.signal,searchParams:A_({arg:t,...r}),headers:r.headers}),{Path:s}=await n.json();return s})),Dk=R_((e=>async(e={})=>{throw j(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),Ok=R_((e=>async function(t={}){const r=await e.post("shutdown",{signal:t.signal,searchParams:A_(t),headers:t.headers});await r.text()})),Nk=R_((e=>async function(t={}){const r=await e.post("version",{signal:t.signal,searchParams:A_(t),headers:t.headers});return{...Q_(await r.json()),"ipfs-http-client":"1.0.0"}}));r(63897),r(36074);var Ck,Mk,Lk,xk=r(79359);async function*Bk(e,t){yield*(0,_i.Z)(e,(async e=>(await t.addressBook.add(e.id,e.multiaddrs),e)))}function Uk(e){const t=new Set;return(0,Ei.Z)(e,(e=>!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)))}async function*zk(e,t=1){let r=0;for await(const t of e)r++,yield t;if(r<t)throw j(new Error("not found"),"NOT_FOUND")}!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(Ck||(Ck={})),(Lk=Mk||(Mk={})).DHT_DISABLED="ERR_DHT_DISABLED",Lk.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",Lk.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",Lk.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",Lk.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",Lk.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",Lk.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",Lk.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",Lk.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",Lk.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",Lk.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",Lk.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",Lk.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",Lk.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",Lk.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",Lk.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",Lk.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",Lk.ERR_DIALED_SELF="ERR_DIALED_SELF",Lk.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",Lk.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",Lk.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",Lk.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",Lk.ERR_INVALID_KEY="ERR_INVALID_KEY",Lk.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",Lk.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",Lk.ERR_INVALID_PEER="ERR_INVALID_PEER",Lk.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",Lk.ERR_NOT_FOUND="ERR_NOT_FOUND",Lk.ERR_TIMEOUT="ERR_TIMEOUT",Lk.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",Lk.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",Lk.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",Lk.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",Lk.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",Lk.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",Lk.ERR_FIND_SELF="ERR_FIND_SELF",Lk.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",Lk.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",Lk.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",Lk.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",Lk.ERR_INVALID_CMS="ERR_INVALID_CMS",Lk.ERR_MISSING_KEYS="ERR_MISSING_KEYS",Lk.ERR_NO_KEY="ERR_NO_KEY",Lk.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",Lk.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",Lk.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",Lk.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",Lk.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",Lk.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",Lk.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",Lk.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",Lk.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",Lk.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",Lk.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",Lk.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",Lk.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",Lk.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",Lk.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",Lk.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",Lk.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",Lk.ERR_INVALID_RECORD="ERR_INVALID_RECORD",Lk.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",Lk.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",Lk.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",Lk.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",Lk.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED";var jk=r(35609),Fk=r(3894);const Vk=(0,z.kg)("libp2p:peer-routing");class $k{constructor(e,t){this.components=e,this.routers=t.routers,this.refreshManagerInit=t.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||0===this.routers.length||null!=this.timeoutId||!1===this.refreshManagerInit.enabled||(this.timeoutId=(0,jk.setDelayedInterval)(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(null==this.abortController)try{this.abortController=new Gr.TimeoutController(this.refreshManagerInit.timeout??1e4);try{(0,Fk.setMaxListeners)?.(1/0,this.abortController.signal)}catch{}await(0,qs.Z)(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(e){Vk.error(e)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){(0,jk.clearDelayedInterval)(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(e,t){if(0===this.routers.length)throw j(new Error("No peer routers available"),Mk.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw j(new Error("Should not try to find self"),Mk.ERR_FIND_SELF);const r=await(0,vi.zG)((0,Dg.Z)(...this.routers.map((r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){Vk.error(e)}}()))),(e=>(0,Ei.Z)(e,Boolean)),(e=>Bk(e,this.components.peerStore)),(async e=>await(0,bd.Z)(e)));if(null!=r)return r;throw j(new Error(Ck.NOT_FOUND),Mk.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(0===this.routers.length)throw j(new Error("No peer routers available"),Mk.ERR_NO_ROUTERS_AVAILABLE);yield*(0,vi.zG)((0,Dg.Z)(...this.routers.map((r=>r.getClosestPeers(e,t)))),(e=>Bk(e,this.components.peerStore)),(e=>Uk(e)),(e=>zk(e)))}}class Hk{constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw j(new Error("No content this.routers available"),Mk.ERR_NO_ROUTERS_AVAILABLE);yield*(0,vi.zG)((0,Dg.Z)(...this.routers.map((r=>r.findProviders(e,t)))),(e=>Bk(e,this.components.peerStore)),(e=>Uk(e)),(e=>zk(e)))}async provide(e,t={}){if(0===this.routers.length)throw j(new Error("No content routers available"),Mk.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async r=>await r.provide(e,t))))}async put(e,t,r){if(!this.isStarted())throw j(new Error(Ck.NOT_STARTED_YET),Mk.DHT_NOT_STARTED);const n=this.components.dht;null!=n&&await(0,qs.Z)(n.put(e,t,r))}async get(e,t){if(!this.isStarted())throw j(new Error(Ck.NOT_STARTED_YET),Mk.DHT_NOT_STARTED);const r=this.components.dht;if(null!=r)for await(const n of r.get(e,t))if("VALUE"===n.name)return n.value;throw j(new Error(Ck.NOT_FOUND),Mk.ERR_NOT_FOUND)}async*getMany(e,t,r){if(!this.isStarted())throw j(new Error(Ck.NOT_STARTED_YET),Mk.DHT_NOT_STARTED);if(null==t||0===t)return;let n=0;const s=this.components.dht;if(null!=s)for await(const i of s.get(e,r))if("VALUE"===i.name&&(yield{from:i.from,val:i.value},n++,n===t))break;if(0===n)throw j(new Error(Ck.NOT_FOUND),Mk.ERR_NOT_FOUND)}}function Gk(e){if((0,Vn.I)(e))return{id:e,multiaddrs:[],protocols:[]};let t;return"string"==typeof e&&(e=(0,Zr.HM)(e)),(0,Zr.h2)(e)&&(t=e,e=function(e){const t=e.getPeerId();if(null==t)throw j(new Error(`${e.toString()} does not have a valid peer type`),Mk.ERR_INVALID_MULTIADDR);try{return(0,Ln.jE)(t)}catch(t){throw j(new Error(`${e.toString()} is not a valid peer type`),Mk.ERR_INVALID_MULTIADDR)}}(e)),{id:e,multiaddrs:null!=t?[t]:[],protocols:[]}}const qk=e=>e;class Kk extends ny.v{constructor(e,t){super();const{listen:r=[],announce:n=[]}=t;this.components=e,this.listen=new Set(r.map((e=>e.toString()))),this.announce=new Set(n.map((e=>e.toString()))),this.observed=new Set,this.announceFilter=t.announceFilter??qk}getListenAddrs(){return Array.from(this.listen).map((e=>(0,Zr.HM)(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>(0,Zr.HM)(e)))}getObservedAddrs(){return Array.from(this.observed).map((e=>(0,Zr.HM)(e)))}confirmObservedAddr(e){}removeObservedAddr(e){}addObservedAddr(e){let t=(0,Zr.HM)(e);const r=t.getPeerId();null!=r&&(0,Ln.jE)(r).equals(this.components.peerId)&&(t=t.decapsulate((0,Zr.HM)(`/p2p/${this.components.peerId.toString()}`)));const n=t.toString();this.observed.has(n)||(this.observed.add(n),this.dispatchEvent(new ny.A("change:addresses")))}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(this.getObservedAddrs().map((e=>e.toString())));const t=new Set(e);return this.announceFilter(Array.from(t).map((e=>(0,Zr.HM)(e)))).map((e=>e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate(`/p2p/${this.components.peerId.toString()}`)))}}const Wk=(0,z.kg)("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class Zk extends ny.v{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",null!=globalThis.document&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let e="hidden",t="visibilitychange";void 0!==globalThis.document.hidden?(e="hidden",t="visibilitychange"):void 0!==globalThis.document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==globalThis.document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==globalThis.document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),this.hidden=e,this.visibilityChange=t}_addVisibilityChangeListener(){void 0===globalThis.document.addEventListener||void 0===document[this.hidden]?Wk("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(void 0!==this.hidden&&void 0!==document[this.hidden])return null==document[this.hidden]}_handleVisibilityChange(){const e=!1===globalThis.document[this.hidden];Wk(e?"Page Visible":"Page Hidden"),this.dispatchEvent(new ny.A("visibilityChange",{detail:e}))}}const Yk=(0,z.kg)("libp2p:connection-manager:latency-monitor");class Jk extends ny.v{constructor(e={}){super();const{latencyCheckIntervalMs:t,dataEmitIntervalMs:r,asyncTestFn:n,latencyRandomPercentage:s}=e;this.latencyCheckIntervalMs=t??500,this.latencyRandomPercentage=s??10,this.latencyCheckMultiply=this.latencyRandomPercentage/100*2*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=null===r||0===r?void 0:r??5e3,Yk("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),null!=this.dataEmitIntervalMs?Yk("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):Yk("Not emitting summaries"),this.asyncTestFn=n,null!=globalThis.process?.hrtime?(Yk("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=e=>{const t=this.now(e);return 1e3*t[0]+t[1]/1e6}):"undefined"!=typeof window&&null!=window.performance?.now?(Yk("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=e=>Math.round(this.now()-e)):(Yk("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=e=>this.now()-e),this.latencyData=this.initLatencyData()}start(){void 0!==globalThis.window&&(this.visibilityChangeEmitter=new Zk,this.visibilityChangeEmitter.addEventListener("visibilityChange",(e=>{const{detail:t}=e;t?this._startTimers():(this._emitSummary(),this._stopTimers())}))),!0===this.visibilityChangeEmitter?.isVisible()&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){null==this.checkLatencyID&&(this.checkLatency(),null!=this.dataEmitIntervalMs&&(this.emitIntervalID=setInterval((()=>this._emitSummary()),this.dataEmitIntervalMs),"function"==typeof this.emitIntervalID.unref&&this.emitIntervalID.unref()))}_stopTimers(){null!=this.checkLatencyID&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),null!=this.emitIntervalID&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const e=this.getSummary();e.events>0&&this.dispatchEvent(new ny.A("data",{detail:e}))}getSummary(){const e={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),Yk.trace("Summary: %O",e),e}checkLatency(){const e=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,t={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+e),startTime:this.now()},r=()=>{if(null==this.checkLatencyID)return;const e=this.getDeltaMS(t.startTime)-t.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,e),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,e),this.latencyData.totalMs+=e,Yk.trace("MS: %s Data: %O",e,this.latencyData)};Yk.trace("localData: %O",t),this.checkLatencyID=setTimeout((()=>{null!=this.asyncTestFn?(t.deltaOffset=0,t.startTime=this.now(),this.asyncTestFn(r)):(t.deltaOffset-=1,r())}),t.deltaOffset),"function"==typeof this.checkLatencyID.unref&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}var Qk=r(21233),Xk=r(76260),eS=r(97724),tS=r(630),rS=r(6633);const nS=(0,z.kg)("libp2p:connection-manager"),sS={maxConnections:1/0,minConnections:0,maxData:1/0,maxSentData:1/0,maxReceivedData:1/0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,movingAverageInterval:6e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},iS="libp2p",oS="connection-manager";class aS extends ny.v{constructor(e,t){if(super(),this.opts=B.Z.call({ignoreUndefined:!0},sS,t),this.opts.maxConnections<this.opts.minConnections)throw j(new Error("Connection Manager maxConnections must be greater than minConnections"),Mk.ERR_INVALID_PARAMETERS);nS("options: %o",this.opts),this.components=e,this.connections=new Map,this.started=!1,this._checkMetrics=this._checkMetrics.bind(this),this.latencyMonitor=new Jk({latencyCheckIntervalMs:t.pollInterval,dataEmitIntervalMs:t.pollInterval});try{(0,Fk.setMaxListeners)?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=t.startupReconnectTimeout??6e4,this.dialTimeout=t.dialTimeout??3e4,this.allow=(t.allow??[]).map((e=>(0,Zr.HM)(e))),this.deny=(t.deny??[]).map((e=>(0,Zr.HM)(e))),this.inboundConnectionRateLimiter=new rS.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){null!=this.components.metrics&&(this.timer=this.timer??Qk(this._checkMetrics,this.opts.pollInterval)),this.components.metrics?.updateComponentMetric({system:iS,component:oS,metric:"connections",label:"direction",value:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const r of t)"inbound"===r.stat.direction?e.inbound++:e.outbound++;return e}}),this.components.metrics?.updateComponentMetric({system:iS,component:oS,metric:"protocol-streams-total",label:"protocol",value:()=>{const e={};for(const t of this.connections.values())for(const r of t)for(const t of r.streams){const r=`${t.stat.direction} ${t.stat.protocol??"unnegotiated"}`;e[r]=(e[r]??0)+1}return e}}),this.components.metrics?.updateComponentMetric({system:iS,component:oS,metric:"protocol-streams-per-connection-90th-percentile",label:"protocol",value:()=>{const e={};for(const t of this.connections.values())for(const r of t){const t={};for(const e of r.streams){const r=`${e.stat.direction} ${e.stat.protocol??"unnegotiated"}`;t[r]=(t[r]??0)+1}for(const[r,n]of Object.entries(t))e[r]=e[r]??[],e[r].push(n)}const t={};for(let[r,n]of Object.entries(e)){n=n.sort(((e,t)=>e-t));const e=Math.floor(.9*n.length);t[r]=n[e]}return t}}),this.latencyMonitor.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor.addEventListener("data",this._onLatencyMeasure),this.started=!0,nS("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then((async()=>{const e=[];for(const t of await this.components.peerStore.all())(await this.components.peerStore.getTags(t.id)).filter((e=>e.name===tS.$)).length>0&&e.push(t.id);this.connectOnStartupController?.clear(),this.connectOnStartupController=new Gr.TimeoutController(this.startupReconnectTimeout);try{(0,Fk.setMaxListeners)?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(e.map((async e=>{await this.openConnection(e,{signal:this.connectOnStartupController?.signal}).catch((e=>{nS.error(e)}))})))})).catch((e=>{nS.error(e)})).finally((()=>{this.connectOnStartupController?.clear()}))}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.timer?.clear(),this.latencyMonitor.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor.stop(),this.started=!1,await this._close(),nS("stopped")}async _close(){const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(e){nS.error(e)}})());nS("closing %d connections",e.length),await Promise.all(e),this.connections.clear()}async _checkMetrics(){const e=this.components.metrics;if(null!=e)try{const t=e.getGlobal().getMovingAverages(),r=t.dataReceived[this.opts.movingAverageInterval].movingAverage;await this._checkMaxLimit("maxReceivedData",r);const n=t.dataSent[this.opts.movingAverageInterval].movingAverage;await this._checkMaxLimit("maxSentData",n);const s=r+n;await this._checkMaxLimit("maxData",s),nS.trace("metrics update",s)}finally{this.timer=Qk(this._checkMetrics,this.opts.pollInterval)}}onConnect(e){this._onConnect(e).catch((e=>{nS.error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const r=t.remotePeer,n=r.toString(),s=this.connections.get(n);null!=s?s.push(t):this.connections.set(n,[t]),null!=r.publicKey&&await this.components.peerStore.keyBook.set(r,r.publicKey);const i=this.getConnections().length,o=i-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",i,o),this.dispatchEvent(new ny.A("peer:connect",{detail:t}))}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const r=t.remotePeer.toString();let n=this.connections.get(r);null!=n&&n.length>1?(n=n.filter((e=>e.id!==t.id)),this.connections.set(r,n)):null!=n&&(this.connections.delete(r),this.dispatchEvent(new ny.A("peer:disconnect",{detail:t})),this.components.metrics?.onPeerDisconnected(t.remotePeer))}getConnections(e){if(null!=e)return this.connections.get(e.toString())??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}async openConnection(e,t={}){nS("dial to %p",e);const r=this.getConnections(e);if(r.length>0)return nS("had an existing connection to %p",e),r[0];let n;if(null==t?.signal){n=new Gr.TimeoutController(this.dialTimeout),t.signal=n.signal;try{(0,Fk.setMaxListeners)?.(1/0,n.signal)}catch{}}try{const r=await this.components.dialer.dial(e,t);let s=this.connections.get(e.toString());null==s&&(s=[],this.connections.set(e.toString(),s));let i=!1;for(const e of s)e.id===r.id&&(i=!0);return i||s.push(r),r}finally{null!=n&&n.clear()}}async closeConnections(e){const t=this.connections.get(e.toString())??[];await Promise.all(t.map((async e=>await e.close())))}getAll(e){if(!(0,Vn.I)(e))throw j(new Error("peerId must be an instance of peer-id"),Mk.ERR_INVALID_PARAMETERS);const t=e.toString(),r=this.connections.get(t);return null!=r?r.filter((e=>e.stat.status===Xk.o1)):[]}_onLatencyMeasure(e){const{detail:t}=e;this._checkMaxLimit("maxEventLoopDelay",t.avgMs,1).catch((e=>{nS.error(e)}))}async _checkMaxLimit(e,t,r=1){const n=this.opts[e];nS.trace("checking limit of %s. current value: %d of %d",e,t,n),t>n&&(nS("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,e,t,n,r),await this._pruneConnections(r))}async _pruneConnections(e){const t=this.getConnections(),r=new eS.ji;for(const e of t){const t=e.remotePeer;if(r.has(t))continue;const n=await this.components.peerStore.getTags(t);r.set(t,n.reduce(((e,t)=>e+t.value),0))}const n=t.sort(((e,t)=>{const n=r.get(e.remotePeer)??0,s=r.get(t.remotePeer)??0;return n>s?1:n<s?-1:0})),s=[];for(const t of n)if(nS("too many connections open - closing a connection to %p",t.remotePeer),s.push(t),s.length===e)break;await Promise.all(s.map((async e=>{try{await e.close()}catch(e){nS.error(e)}this.onDisconnect(new ny.A("connectionEnd",{detail:e}))})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return nS("connection from %s refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return nS("connection from %s refused - incomingPendingConnections exceeded by peer %s",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return nS("connection from %s refused - inboundConnectionThreshold exceeded by host %s",t,e.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(nS("connection from %s refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}const cS=(0,z.kg)("libp2p:connection-manager:auto-dialler"),lS={enabled:!0,minConnections:0,autoDialInterval:1e4};class hS{constructor(e,t){this.components=e,this.options=B.Z.call({ignoreUndefined:!0},lS,t),this.running=!1,this._autoDial=this._autoDial.bind(this),cS("options: %j",this.options)}isStarted(){return this.running}async start(){this.options.enabled?(this.running=!0,this._autoDial().catch((e=>{cS.error("could start autodial",e)})),cS("started")):cS("not enabled")}async stop(){this.options.enabled?(this.running=!1,null!=this.autoDialTimeout&&this.autoDialTimeout.clear(),cS("stopped")):cS("not enabled")}async _autoDial(){null!=this.autoDialTimeout&&this.autoDialTimeout.clear();const e=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=e)return void(this.autoDialTimeout=Qk(this._autoDial,this.options.autoDialInterval));const t=await this.components.peerStore.all(),r=await(0,vi.zG)(t.sort((()=>Math.random()>.5?1:-1)),(e=>(0,Ei.Z)(e,(e=>!e.id.equals(this.components.peerId)))),(e=>(0,zg.Z)(e,((e,t)=>t.protocols.length>e.protocols.length||null!=t.id.publicKey&&null==e.id.publicKey?1:-1))),(async e=>await(0,Ti.Z)(e)));for(let t=0;this.running&&t<r.length&&this.components.connectionManager.getConnections().length<e;t++){if(!this.running)return;const e=r[t];if(0===this.components.connectionManager.getConnections(e.id).length){cS("connecting to a peerStore stored peer %p",e.id);try{await this.components.connectionManager.openConnection(e.id)}catch(e){cS.error("could not connect to peerStore stored peer",e)}}}this.running&&(this.autoDialTimeout=Qk(this._autoDial,this.options.autoDialInterval))}}var dS;!function(e){let t,r,n,s,i,o;!function(e){e.SUCCESS="SUCCESS",e.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",e.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",e.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",e.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",e.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",e.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",e.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",e.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",e.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",e.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",e.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",e.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",e.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",e.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE"}(t=e.Status||(e.Status={})),function(e){e[e.SUCCESS=100]="SUCCESS",e[e.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",e[e.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",e[e.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",e[e.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",e[e.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",e[e.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",e[e.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",e[e.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",e[e.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",e[e.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",e[e.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",e[e.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",e[e.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",e[e.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"}(r||(r={})),function(e){e.codec=()=>(0,Jn.Ji)(r)}(t=e.Status||(e.Status={})),function(e){e.HOP="HOP",e.STOP="STOP",e.STATUS="STATUS",e.CAN_HOP="CAN_HOP"}(n=e.Type||(e.Type={})),function(e){e[e.HOP=1]="HOP",e[e.STOP=2]="STOP",e[e.STATUS=3]="STATUS",e[e.CAN_HOP=4]="CAN_HOP"}(s||(s={})),function(e){e.codec=()=>(0,Jn.Ji)(s)}(n=e.Type||(e.Type={})),function(e){let t;e.codec=()=>(null==t&&(t=(0,Jn.yw)(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),(!0===r.writeDefaults||null!=e.id&&e.id.byteLength>0)&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const r of e.addrs)t.uint32(18),t.bytes(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={id:new Uint8Array(0),addrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:r.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(i=e.Peer||(e.Peer={})),e.codec=()=>(null==o&&(o=(0,Jn.yw)(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.Type.codec().encode(t.type,r)),null!=t.srcPeer&&(r.uint32(18),e.Peer.codec().encode(t.srcPeer,r,{writeDefaults:!1})),null!=t.dstPeer&&(r.uint32(26),e.Peer.codec().encode(t.dstPeer,r,{writeDefaults:!1})),null!=t.code&&(r.uint32(32),e.Status.codec().encode(t.code,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{const n={},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const r=t.uint32();switch(r>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.srcPeer=e.Peer.codec().decode(t,t.uint32());break;case 3:n.dstPeer=e.Peer.codec().decode(t,t.uint32());break;case 4:n.code=e.Status.codec().decode(t);break;default:t.skipType(7&r)}}return n}))),o),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(dS||(dS={}));var uS=r(49516);const pS="/libp2p/circuit/relay/0.1.0";function fS(e,t){e.write({type:dS.Type.STATUS,code:t})}function gS(e,t){try{null!=e.dstPeer?.addrs&&e.dstPeer.addrs.forEach((e=>(0,Zr.HM)(e)))}catch(r){throw fS(t,e.type===dS.Type.HOP?dS.Status.HOP_DST_MULTIADDR_INVALID:dS.Status.STOP_DST_MULTIADDR_INVALID),r}try{null!=e.srcPeer?.addrs&&e.srcPeer.addrs.forEach((e=>(0,Zr.HM)(e)))}catch(r){throw fS(t,e.type===dS.Type.HOP?dS.Status.HOP_SRC_MULTIADDR_INVALID:dS.Status.STOP_SRC_MULTIADDR_INVALID),r}}var yS=r(86063);const mS=(0,z.kg)("libp2p:circuit:stream-handler");class wS{constructor(e){const{stream:t,maxLength:r=4096}=e;this.stream=t,this.shake=(0,yS.Y)(this.stream),this.decoder=Yb.J.fromReader(this.shake.reader,{maxDataLength:r})}async read(){const e=await this.decoder.next();if(null!=e.value){const t=dS.decode(e.value);return mS("read message type",t.type),t}mS("read received no value, closing stream"),this.close()}write(e){mS("write message type %s",e.type),this.shake.write(Yb.c.single(dS.encode(e)))}rest(){return this.shake.rest(),this.shake.stream}end(e){this.write(e),this.close()}close(){mS("closing the stream"),this.rest().sink([]).catch((e=>{mS.error(e)}))}}const bS=(0,z.kg)("libp2p:circuit:stop"),_S=(0,z.kg)("libp2p:circuit:hop");var ES=r(28704);const vS=(0,z.kg)("libp2p:circuit");class kS{constructor(e,t){this._init=t,this.components=e,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(pS,(e=>{this._onProtocol(e).catch((e=>{vS.error(e)}))})).catch((e=>{vS.error(e)})))}async stop(){await this.components.registrar.unhandle(pS)}hopEnabled(){return!0}hopActive(){return!0}get[ES.NA](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(e){const{connection:t,stream:r}=e,n=new Gr.TimeoutController(this._init.hop.timeout);try{(0,Fk.setMaxListeners)?.(1/0,n.signal)}catch{}try{const e=(0,Zb.D7)(r,n.signal),s=new wS({stream:{...r,...e}}),i=await s.read();if(null==i)return vS("request was invalid, could not read from stream"),s.write({type:dS.Type.STATUS,code:dS.Status.MALFORMED_MESSAGE}),void s.close();let o;switch(i.type){case dS.Type.CAN_HOP:vS("received CAN_HOP request from %p",t.remotePeer),await function(e){const{connection:t,streamHandler:r,circuit:n}=e,s=n.hopEnabled();_S("can hop (%s) request from %p",s,t.remotePeer),r.end({type:dS.Type.STATUS,code:s?dS.Status.SUCCESS:dS.Status.HOP_CANT_SPEAK_RELAY})}({circuit:this,connection:t,streamHandler:s});break;case dS.Type.HOP:vS("received HOP request from %p",t.remotePeer),await async function(e){const{connection:t,request:r,streamHandler:n,circuit:s,connectionManager:i}=e;if(!s.hopEnabled())return _S("HOP request received but we are not acting as a relay"),n.end({type:dS.Type.STATUS,code:dS.Status.HOP_CANT_SPEAK_RELAY});try{gS(r,n)}catch(e){return void _S.error("invalid hop request via peer %p %o",t.remotePeer,e)}if(null==r.dstPeer)return void _S("HOP request received but we do not receive a dstPeer");const o=(0,Ln.cv)(r.dstPeer.id),a=i.getConnections(o);if(0===a.length&&!s.hopActive())return _S("HOP request received but we are not connected to the destination peer"),n.end({type:dS.Type.STATUS,code:dS.Status.HOP_NO_CONN_TO_DST});if(0===a.length)return _S("did not have connection to remote peer"),n.end({type:dS.Type.STATUS,code:dS.Status.HOP_NO_CONN_TO_DST});const c={type:dS.Type.STOP,dstPeer:r.dstPeer,srcPeer:r.srcPeer};let l;try{_S("performing STOP request");const e=await async function(e){const{connection:t,request:r,signal:n}=e,s=await t.newStream(pS,{signal:n});bS("starting stop request to %p",t.remotePeer);const i=new wS({stream:s});i.write(r);const o=await i.read();if(null!=o){if(o.code===dS.Status.SUCCESS)return bS("stop request to %p was successful",t.remotePeer),i.rest();bS("stop request failed with code %d",o.code),i.close()}else i.close()}({connection:a[0],request:c});if(null==e)throw new Error("Could not stop");l=e}catch(e){return void _S.error(e)}_S("hop request from %p is valid",t.remotePeer),n.write({type:dS.Type.STATUS,code:dS.Status.SUCCESS});const h=n.rest();return _S("creating related connections"),await(0,vi.zG)(h,l,h)}({connection:t,request:i,streamHandler:s,circuit:this,connectionManager:this.components.connectionManager});break;case dS.Type.STOP:vS("received STOP request from %p",t.remotePeer),o=await function(e){const{connection:t,request:r,streamHandler:n}=e;try{gS(r,n)}catch(e){return void bS.error("invalid stop request via peer %p %o",t.remotePeer,e)}return bS("stop request is valid"),n.write({type:dS.Type.STATUS,code:dS.Status.SUCCESS}),n.rest()}({connection:t,request:i,streamHandler:s});break;default:return vS("Request of type %s not supported",i.type),s.write({type:dS.Type.STATUS,code:dS.Status.MALFORMED_MESSAGE}),void s.close()}if(null!=o){const e=t.remoteAddr.encapsulate("/p2p-circuit").encapsulate((0,Zr.HM)(i.dstPeer?.addrs[0])),r=(0,Zr.HM)(i.srcPeer?.addrs[0]),n=(0,uS.j)({stream:o,remoteAddr:e,localAddr:r}),s=i.type===dS.Type.HOP?"relay":"inbound";vS("new %s connection %s",s,n.remoteAddr);const a=await this.components.upgrader.upgradeInbound(n);vS("%s connection %s upgraded",s,n.remoteAddr),null!=this.handler&&this.handler(a)}}finally{n.clear()}}async dial(e,t={}){const r=e.toString().split("/p2p-circuit"),n=(0,Zr.HM)(r[0]),s=(0,Zr.HM)(r[r.length-1]),i=n.getPeerId(),o=s.getPeerId();if(null==i||null==o){const e="Circuit relay dial failed as addresses did not have peer id";throw vS.error(e),j(new Error(e),Mk.ERR_RELAYED_DIAL)}const a=(0,Ln.jE)(i),c=(0,Ln.jE)(o);let l=!1,h=this.components.connectionManager.getConnections(a)[0];null==h&&(await this.components.peerStore.addressBook.add(a,[n]),h=await this.components.connectionManager.openConnection(a,t),l=!0);try{const r=await async function(e){const{connection:t,request:r,signal:n}=e,s=await t.newStream(pS,{signal:n}),i=new wS({stream:s});i.write(r);const o=await i.read();if(null==o)throw j(new Error("HOP request had no response"),Mk.ERR_HOP_REQUEST_FAILED);if(o.code===dS.Status.SUCCESS)return _S("hop request was successful"),i.rest();throw _S("hop request failed with code %d, closing stream",o.code),i.close(),j(new Error(`HOP request failed with code "${o.code??"unknown"}"`),Mk.ERR_HOP_REQUEST_FAILED)}({...t,connection:h,request:{type:dS.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map((e=>e.bytes))},dstPeer:{id:c.toBytes(),addrs:[(0,Zr.HM)(s).bytes]}}}),i=n.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),o=(0,uS.j)({stream:r,remoteAddr:e,localAddr:i});return vS("new outbound connection %s",o.remoteAddr),await this.components.upgrader.upgradeOutbound(o)}catch(e){throw vS.error("Circuit relay dial failed",e),l&&await h.close(),e}}createListener(e){return this.handler=e.handler,function(e){const t=new Map,r=Object.assign(new ny.v,{close:async()=>await Promise.resolve(),listen:async function(n){const s=n.toString().split("/p2p-circuit").find((e=>""!==e)),i=(0,Zr.HM)(s),o=i.getPeerId();if(null==o)throw new Error("Could not determine relay peer from multiaddr");const a=(0,Ln.jE)(o);await e.peerStore.addressBook.add(a,[i]);const c=await e.connectionManager.openConnection(a),l=c.remoteAddr.encapsulate("/p2p-circuit");t.set(c.remotePeer.toString(),l),r.dispatchEvent(new ny.A("listening"))},getAddrs:function(){const e=[];for(const r of t.values())e.push(r);return e}});return e.connectionManager.addEventListener("peer:disconnect",(e=>{const{detail:n}=e;t.delete(n.remotePeer.toString())&&r.dispatchEvent(new ny.A("close"))})),r}({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>Yr.dx.matches(e)))}}async function SS(e){const t=(new TextEncoder).encode(e),r=await zi.sha256.digest(t);return te.k.createV0(r)}const RS="hop_relay",IS="true",TS="/libp2p/relay";var AS=r(79690);const PS=(0,z.kg)("libp2p:auto-relay"),DS=()=>{};class OS{constructor(e,t){this.components=e,this.addressSorter=t.addressSorter??AS.F,this.maxListeners=t.maxListeners??1,this.listenRelays=new Set,this.onError=t.onError??DS,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",(e=>{this._onProtocolChange(e).catch((e=>{PS.error(e)}))})),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(e){const{peerId:t,protocols:r}=e.detail,n=t.toString();if(null!=r.find((e=>e===pS))){if(!this.listenRelays.has(n))try{const e=this.components.connectionManager.getConnections(t);if(0===e.length)return;const r=e[0];if(r.remoteAddr.protoCodes().includes(290))return void PS(`relayed connection to ${n} will not be used to hop on`);const s=await async function(e){const{connection:t,signal:r}=e,n=await t.newStream(pS,{signal:r}),s=new wS({stream:n});s.write({type:dS.Type.CAN_HOP});const i=await s.read();return await s.close(),null!=i&&i.code===dS.Status.SUCCESS}({connection:r});s&&(await this.components.peerStore.metadataBook.setValue(t,RS,(0,Hr.m)(IS)),await this._addListenRelay(r,n))}catch(e){this.onError(e)}}else this.listenRelays.has(n)&&await this._removeListenRelay(n)}_onPeerDisconnected(e){const t=e.detail.remotePeer.toString();this.listenRelays.has(t)&&this._removeListenRelay(t).catch((e=>{PS.error(e)}))}async _addListenRelay(e,t){try{if(this.listenRelays.size>=this.maxListeners)return;const r=await(0,vi.zG)(await this.components.peerStore.addressBook.get(e.remotePeer),(e=>(0,zg.Z)(e,this.addressSorter)),(async e=>await(0,Ti.Z)(e))),n=await Promise.all(r.map((async t=>{try{let r=t.multiaddr;return null==r.getPeerId()&&(r=r.encapsulate(`/p2p/${e.remotePeer.toString()}`)),r=r.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([r]),!0}catch(e){PS.error("error listening on circuit address",e),this.onError(e)}return!1})));n.includes(!0)&&this.listenRelays.add(t)}catch(e){this.onError(e),this.listenRelays.delete(t)}}async _removeListenRelay(e){this.listenRelays.delete(e)&&await this._listenOnAvailableHopRelays([e])}async _listenOnAvailableHopRelays(e=[]){if(this.listenRelays.size>=this.maxListeners)return;const t=[],r=await this.components.peerStore.all();for(const{id:n,metadata:s}of r){const r=n.toString();if(this.listenRelays.has(r))continue;if(e.includes(r))continue;const i=s.get(RS);if(null==i||(0,Qr.B)(i)!==IS)continue;const o=this.components.connectionManager.getConnections(n);if(0!==o.length){if(await this._addListenRelay(o[0],r),this.listenRelays.size>=this.maxListeners)return}else t.push(n)}for(const e of t)if(await this._tryToListenOnRelay(e),this.listenRelays.size>=this.maxListeners)return;try{const e=await SS(TS);for await(const t of this.components.contentRouting.findProviders(e)){if(0===t.multiaddrs.length)continue;const e=t.id;if(!e.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(e,t.multiaddrs),await this._tryToListenOnRelay(e),this.listenRelays.size>=this.maxListeners))return}}catch(e){this.onError(e)}}async _tryToListenOnRelay(e){try{const t=await this.components.connectionManager.openConnection(e);await this._addListenRelay(t,e.toString())}catch(t){PS.error("Could not use %p as relay",e,t),this.onError(t,`could not connect and listen on known hop relay ${e.toString()}`)}}}const NS=(0,z.kg)("libp2p:relay");class CS{constructor(e,t){this.components=e,this.autoRelay=!1!==t.autoRelay?.enabled?new OS(e,{addressSorter:t.addressSorter,...t.autoRelay}):void 0,this.started=!1,this.init=t,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){!1!==this.init.hop.enabled&&!1!==this.init.advertise.enabled&&(this.timeout=(0,jk.setDelayedInterval)(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){null!=this.timeout&&(0,jk.clearDelayedInterval)(this.timeout),this.started=!1}async _advertiseService(){try{const e=await SS(TS);await this.components.contentRouting.provide(e)}catch(e){e.code===Mk.ERR_NO_ROUTERS_AVAILABLE?(NS.error("a content router, such as a DHT, must be provided in order to advertise the relay service",e),await this.stop()):NS.error(e)}}}var MS=r(7314),LS=(r(29222),r(4676),r(14463));r(41486);const xS=LS.pki,BS=(0,z.kg)("libp2p:keychain:cms"),US=new WeakMap;class zS{constructor(e,t){if(null==e)throw j(new Error("keychain is required"),Mk.ERR_KEYCHAIN_REQUIRED);this.keychain=e,US.set(this,{dek:t})}async encrypt(e,t){if(!(t instanceof Uint8Array))throw j(new Error("Plain data must be a Uint8Array"),Mk.ERR_INVALID_PARAMETERS);const r=await this.keychain.findKeyByName(e),n=await this.keychain.getPrivateKey(e),s=US.get(this);if(null==s)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const i=s.dek,o=LS.pki.decryptRsaPrivateKey(n,i),a=await((e,t)=>{const r=xS.rsa.setPublicKey(t.n,t.e),n=xS.createCertificate();n.publicKey=r,n.serialNumber="01",n.validity.notBefore=new Date,n.validity.notAfter=new Date,n.validity.notAfter.setFullYear(n.validity.notBefore.getFullYear()+10);const s=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:e.id}];return n.setSubject(s),n.setIssuer(s),n.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),n.sign(t),n})(r,o),c=LS.pkcs7.createEnvelopedData();c.addRecipient(a),c.content=LS.util.createBuffer(t),c.encrypt();const l=LS.asn1.toDer(c.toAsn1()).getBytes();return(0,Hr.m)(l,"ascii")}async decrypt(e){if(!(e instanceof Uint8Array))throw j(new Error("CMS data is required"),Mk.ERR_INVALID_PARAMETERS);let t;try{const r=LS.util.createBuffer((0,Qr.B)(e,"ascii")),n=LS.asn1.fromDer(r);t=LS.pkcs7.messageFromAsn1(n)}catch(e){throw BS.error(e),j(new Error("Invalid CMS"),Mk.ERR_INVALID_CMS)}const r=t.recipients.filter((e=>e.issuer.find((e=>"O"===e.shortName&&"ipfs"===e.value)))).filter((e=>e.issuer.find((e=>"CN"===e.shortName)))).map((e=>({recipient:e,keyId:e.issuer.find((e=>"CN"===e.shortName)).value}))),n=await async function(e,t){const r=e.map(t);return e[(await Promise.all(r)).findIndex((e=>e))]}(r,(async e=>{try{if(null!=await this.keychain.findKeyById(e.keyId))return!0}catch(e){return!1}return!1}));if(null==n){const e=r.map((e=>e.keyId));throw j(new Error(`Decryption needs one of the key(s): ${e.join(", ")}`),Mk.ERR_MISSING_KEYS,{missingKeys:e})}const s=await this.keychain.findKeyById(n.keyId);if(null==s)throw j(new Error("No key available to decrypto"),Mk.ERR_NO_KEY);const i=await this.keychain.getPrivateKey(s.name),o=US.get(this);if(null==o)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const a=o.dek,c=LS.pki.decryptRsaPrivateKey(i,a);return t.decrypt(n.recipient,c),(0,Hr.m)(t.content.getBytes(),"ascii")}}const jS=(0,z.kg)("libp2p:keychain"),FS="/info/",VS=new WeakMap,$S={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function HS(e){return null!=e&&"string"==typeof e&&e===MS(e.trim())&&e.length>0}async function GS(){const e=800*Math.random()+200;await new Promise((t=>setTimeout(t,e)))}function qS(e){return new hn.s("/pkcs8/"+e)}function KS(e){return new hn.s(FS+e)}class WS{constructor(e,t){if(this.components=e,this.init=(0,B.Z)($S,t),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<14)throw new Error("dek.keyLength must be least 14 bytes");if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<16)throw new Error("dek.saltLength must be least 16 bytes");if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<1e3)throw new Error("dek.iterationCount must be least 1000");const r=null!=this.init.pass&&null!=this.init.dek?.salt?(0,bw.nk)(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";VS.set(this,{dek:r}),this.started=!1}isStarted(){return this.started}async start(){const e=KS("self");await this.components.datastore.has(e)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const e=VS.get(this);if(null==e)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const t=e.dek;return new zS(this,t)}static generateOptions(){const e=Object.assign({},$S),t=3*Math.ceil(16/3);return e.dek.salt=(0,Qr.B)((0,bw.O6)(t),"base64"),e}static get options(){return $S}async createKey(e,t,r=2048){if(!HS(e)||"self"===e)throw await GS(),j(new Error("Invalid key name"),Mk.ERR_INVALID_KEY_NAME);if("string"!=typeof t)throw await GS(),j(new Error("Invalid key type"),Mk.ERR_INVALID_KEY_TYPE);const n=qS(e);if(await this.components.datastore.has(n))throw await GS(),j(new Error("Key name already exists"),Mk.ERR_KEY_ALREADY_EXISTS);if("rsa"===t.toLowerCase()&&(!Number.isSafeInteger(r)||r<2048))throw await GS(),j(new Error("Invalid RSA key size"),Mk.ERR_INVALID_KEY_SIZE);let s;try{const i=await(0,qn.generateKeyPair)(t,r),o=await i.id(),a=VS.get(this);if(null==a)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const c=a.dek,l=await i.export(c);s={name:e,id:o};const h=this.components.datastore.batch();h.put(n,(0,Hr.m)(l)),h.put(KS(e),(0,Hr.m)(JSON.stringify(s))),await h.commit()}catch(e){throw await GS(),e}return s}async listKeys(){const e={prefix:FS},t=[];for await(const r of this.components.datastore.query(e))t.push(JSON.parse((0,Qr.B)(r.value)));return t}async findKeyById(e){try{return(await this.listKeys()).find((t=>t.id===e))}catch(e){throw await GS(),e}}async findKeyByName(e){if(!HS(e))throw await GS(),j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);const t=KS(e);try{const e=await this.components.datastore.get(t);return JSON.parse((0,Qr.B)(e))}catch(t){throw await GS(),jS.error(t),j(new Error(`Key '${e}' does not exist.`),Mk.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!HS(e)||"self"===e)throw await GS(),j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);const t=qS(e),r=await this.findKeyByName(e),n=this.components.datastore.batch();return n.delete(t),n.delete(KS(e)),await n.commit(),r}async renameKey(e,t){if(!HS(e)||"self"===e)throw await GS(),j(new Error(`Invalid old key name '${e}'`),Mk.ERR_OLD_KEY_NAME_INVALID);if(!HS(t)||"self"===t)throw await GS(),j(new Error(`Invalid new key name '${t}'`),Mk.ERR_NEW_KEY_NAME_INVALID);const r=qS(e),n=qS(t),s=KS(e),i=KS(t);if(await this.components.datastore.has(n))throw await GS(),j(new Error(`Key '${t}' already exists`),Mk.ERR_KEY_ALREADY_EXISTS);try{const e=await this.components.datastore.get(r),o=await this.components.datastore.get(s),a=JSON.parse((0,Qr.B)(o));a.name=t;const c=this.components.datastore.batch();return c.put(n,e),c.put(i,(0,Hr.m)(JSON.stringify(a))),c.delete(r),c.delete(s),await c.commit(),a}catch(e){throw await GS(),e}}async exportKey(e,t){if(!HS(e))throw await GS(),j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);if(null==t)throw await GS(),j(new Error("Password is required"),Mk.ERR_PASSWORD_REQUIRED);const r=qS(e);try{const e=await this.components.datastore.get(r),n=(0,Qr.B)(e),s=VS.get(this);if(null==s)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const i=s.dek,o=await(0,qn.importKey)(n,i);return await o.export(t)}catch(e){throw await GS(),e}}async importKey(e,t,r){if(!HS(e)||"self"===e)throw await GS(),j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);if(null==t)throw await GS(),j(new Error("PEM encoded key is required"),Mk.ERR_PEM_REQUIRED);const n=qS(e);if(await this.components.datastore.has(n))throw await GS(),j(new Error(`Key '${e}' already exists`),Mk.ERR_KEY_ALREADY_EXISTS);let s,i;try{s=await(0,qn.importKey)(t,r)}catch(e){throw await GS(),j(new Error("Cannot read the key, most likely the password is wrong"),Mk.ERR_CANNOT_READ_KEY)}try{i=await s.id();const e=VS.get(this);if(null==e)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const r=e.dek;t=await s.export(r)}catch(e){throw await GS(),e}const o={name:e,id:i},a=this.components.datastore.batch();return a.put(n,(0,Hr.m)(t)),a.put(KS(e),(0,Hr.m)(JSON.stringify(o))),await a.commit(),o}async importPeer(e,t){try{if(!HS(e))throw j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);if(null==t)throw j(new Error("PeerId is required"),Mk.ERR_MISSING_PRIVATE_KEY);if(null==t.privateKey)throw j(new Error("PeerId.privKey is required"),Mk.ERR_MISSING_PRIVATE_KEY);const r=await(0,qn.unmarshalPrivateKey)(t.privateKey),n=qS(e);if(await this.components.datastore.has(n))throw await GS(),j(new Error(`Key '${e}' already exists`),Mk.ERR_KEY_ALREADY_EXISTS);const s=VS.get(this);if(null==s)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const i=s.dek,o=await r.export(i),a={name:e,id:t.toString()},c=this.components.datastore.batch();return c.put(n,(0,Hr.m)(o)),c.put(KS(e),(0,Hr.m)(JSON.stringify(a))),await c.commit(),a}catch(e){throw await GS(),e}}async getPrivateKey(e){if(!HS(e))throw await GS(),j(new Error(`Invalid key name '${e}'`),Mk.ERR_INVALID_KEY_NAME);try{const t=qS(e),r=await this.components.datastore.get(t);return(0,Qr.B)(r)}catch(t){throw await GS(),jS.error(t),j(new Error(`Key '${e}' does not exist.`),Mk.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if("string"!=typeof e)throw await GS(),j(new Error(`Invalid old pass type '${typeof e}'`),Mk.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof t)throw await GS(),j(new Error(`Invalid new pass type '${typeof t}'`),Mk.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await GS(),j(new Error(`Invalid pass length ${t.length}`),Mk.ERR_INVALID_PASS_LENGTH);jS("recreating keychain");const r=VS.get(this);if(null==r)throw j(new Error("dek missing"),Mk.ERR_INVALID_PARAMETERS);const n=r.dek;this.init.pass=t;const s=null!=t&&null!=this.init.dek?.salt?(0,bw.nk)(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";VS.set(this,{dek:s});const i=await this.listKeys();for(const e of i){const t=await this.components.datastore.get(qS(e.name)),r=(0,Qr.B)(t),i=await(0,qn.importKey)(r,n),o=s.toString(),a=await i.export(o),c=this.components.datastore.batch(),l={name:e.name,id:e.id};c.put(qS(e.name),(0,Hr.m)(a)),c.put(KS(e.name),(0,Hr.m)(JSON.stringify(l))),await c.commit()}jS("keychain reconstructed")}}var ZS=r(18889);class YS{constructor(e){if("number"!=typeof e)throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t){if(null!=this.previousTime){const r=this.alpha(e,this.previousTime),n=t-this.movingAverage,s=r*n;this.movingAverage=r*t+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+n*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*n}else this.movingAverage=t;this.previousTime=e}}function JS(e){return new YS(e)}class QS extends ny.v{constructor(e){super(),this.enabled=e.enabled,this.queue=[],this.stats={dataReceived:0n,dataSent:0n},this.frequencyLastTime=Date.now(),this.frequencyAccumulators={},this.movingAverages={dataReceived:[],dataSent:[]},this.computeThrottleMaxQueueSize=e.computeThrottleMaxQueueSize,this.computeThrottleTimeout=e.computeThrottleTimeout,this._update=this._update.bind(this),this.movingAverageIntervals=e.movingAverageIntervals;for(let t=0;t<e.initialCounters.length;t++){const r=e.initialCounters[t];this.stats[r]=0n,this.movingAverages[r]=[];for(let e=0;e<this.movingAverageIntervals.length;e++){const t=this.movingAverageIntervals[e];(this.movingAverages[r][t]=JS(t)).push(this.frequencyLastTime,0)}}}start(){this.enabled&&this.queue.length>0&&this._resetComputeTimeout()}stop(){null!=this.timeout&&(this.timeout.clear(),this.timeout=null)}getSnapshot(){return Object.assign({},this.stats)}getMovingAverages(){return Object.assign({},this.movingAverages)}push(e,t){this.queue.push([e,t,Date.now()]),this._resetComputeTimeout()}_resetComputeTimeout(){this.timeout=Qk(this._update,this._nextTimeout())}_nextTimeout(){const e=this.queue.length/this.computeThrottleMaxQueueSize;return Math.max(this.computeThrottleTimeout*(1-e),0)}_update(){if(this.timeout=null,this.queue.length>0){let e=["",0,0];for(e of this.queue)this._applyOp(e);this.queue=[],e.length>2&&""!==e[0]&&this._updateFrequency(e[2]),this.dispatchEvent(new ny.A("update",{detail:this.stats}))}}_updateFrequency(e){const t=e-this.frequencyLastTime;this._updateFrequencyFor("dataReceived",t,e),this._updateFrequencyFor("dataSent",t,e),this.frequencyLastTime=e}_updateFrequencyFor(e,t,r){const n=this.frequencyAccumulators[e]??0;this.frequencyAccumulators[e]=0;const s=n/(t??1)*1e3;let i=this.movingAverages[e];null==i&&(i=this.movingAverages[e]=[]);const o=this.movingAverageIntervals;for(let e=0;e<o.length;e++){const t=o[e];let n=i[t];null==n&&(n=i[t]=JS(t)),n.push(r,s)}}_applyOp(e){const t=e[0],r=e[1];if("number"!=typeof r)throw new Error("invalid increment number");let n;n=Object.prototype.hasOwnProperty.call(this.stats,t)?this.stats[t]:this.stats[t]=0n,this.stats[t]=n+BigInt(r),null==this.frequencyAccumulators[t]&&(this.frequencyAccumulators[t]=0),this.frequencyAccumulators[t]+=r}}const XS=["dataReceived","dataSent"],eR={in:"dataReceived",out:"dataSent"};class tR{constructor(e){this.enabled=e.enabled,this.statsInit={...e,initialCounters:XS},this.globalStats=new QS(this.statsInit),this.peerStats=new Map,this.protocolStats=new Map,this.oldPeers=Pn(e.maxOldPeersRetention??50),this.running=!1,this._onMessage=this._onMessage.bind(this),this.systems=new Map}isStarted(){return this.running}async start(){this.enabled&&(this.running=!0)}async stop(){if(this.running){this.running=!1,this.globalStats.stop();for(const e of this.peerStats.values())e.stop();for(const e of this.protocolStats.values())e.stop()}}getGlobal(){return this.globalStats}getPeers(){return Array.from(this.peerStats.keys())}getComponentMetrics(){return this.systems}updateComponentMetric(e){const{system:t="libp2p",component:r,metric:n,value:s,label:i,help:o}=e;this.systems.has(t)||this.systems.set(t,new Map);const a=this.systems.get(t);if(null==a)throw new Error("Unknown metric system");a.has(r)||a.set(r,new Map);const c=a.get(r);if(null==c)throw new Error("Unknown metric component");c.set(n,{label:i,help:o,calculate:"function"!=typeof s?()=>s:s})}forPeer(e){const t=e.toString();return this.peerStats.get(t)??this.oldPeers.get(t)}getProtocols(){return Array.from(this.protocolStats.keys())}forProtocol(e){return this.protocolStats.get(e)}onPeerDisconnected(e){const t=e.toString(),r=this.peerStats.get(t);null!=r&&(r.stop(),this.peerStats.delete(t),this.oldPeers.set(t,r))}_onMessage(e){if(!this.running)return;const{remotePeer:t,protocol:r,direction:n,dataLength:s}=e,i=eR[n];let o=this.forPeer(t);if(null==o){const e=new QS(this.statsInit);this.peerStats.set(t.toString(),e),o=e}if(o.push(i,s),this.globalStats.push(i,s),null!=r){let e=this.forProtocol(r);if(null==e){const t=new QS(this.statsInit);this.protocolStats.set(r,t),e=t}e.push(i,s)}}updatePlaceholder(e,t){if(!this.running)return;const r=e.toString(),n=this.peerStats.get(r)??this.oldPeers.get(r),s=t.toString(),i=this.peerStats.get(s)??this.oldPeers.get(s);let o=n;var a,c;null!=i&&(c=o,(a=i).stop(),c.stop(),a.queue=[...a.queue,...c.queue],o=a,this.oldPeers.remove(s)),this.peerStats.delete(e.toString()),this.peerStats.set(s,o),o.start()}trackStream(e){const{stream:t,remotePeer:r,protocol:n}=e;if(!this.running)return;const s=t.source;t.source=(0,ZS.Z)(s,(e=>this._onMessage({remotePeer:r,protocol:n,direction:"in",dataLength:e.byteLength})));const i=t.sink;t.sink=async e=>await(0,vi.zG)(e,(e=>(0,ZS.Z)(e,(e=>{this._onMessage({remotePeer:r,protocol:n,direction:"out",dataLength:e.byteLength})}))),i)}}var rR=r(66594);class nR extends Map{constructor(e){super();const{system:t,component:r,metric:n,metrics:s}=e;this.system=t??"libp2p",this.component=r,this.metric=n,this.metrics=s,this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metrics.updateComponentMetric({system:this.system,component:this.component,metric:this.metric,value:this.size})}}function sR(e){const{system:t,component:r,metric:n,metrics:s}=e;let i;return i=null!=s?new nR({system:t,component:r,metric:n,metrics:s}):new Map,i}const iR=(0,z.kg)("libp2p:transports");class oR extends ny.v{constructor(e,t={}){super(),this.components=e,this.started=!1,this.transports=new Map,this.listeners=sR({component:"transport-manager",metric:"listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??aR.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(null==t)throw j(new Error("Transport must have a valid tag"),Mk.ERR_INVALID_KEY);if(this.transports.has(t))throw j(new Error("There is already a transport with this tag"),Mk.ERR_DUPLICATE_TRANSPORT);iR("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}async start(){const e=this.components.addressManager.getListenAddrs();await this.listen(e),this.started=!0}async stop(){const e=[];for(const[t,r]of this.listeners)for(iR("closing listeners for %s",t);r.length>0;){const t=r.pop();null!=t&&e.push(t.close())}await Promise.all(e),iR("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const r=this.transportForMultiaddr(e);if(null==r)throw j(new Error(`No transport available for address ${String(e)}`),Mk.ERR_TRANSPORT_UNAVAILABLE);try{return await r.dial(e,{...t,upgrader:this.components.upgrader})}catch(e){throw null==e.code&&(e.code=Mk.ERR_TRANSPORT_DIAL_FAILED),e}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(e){for(const t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(null==e||0===e.length)return void iR("no addresses were provided for listening, this node is dial only");const t=[];for(const[r,n]of this.transports.entries()){const s=n.filter(e),i=[];for(const e of s){iR("creating listener for %s on %s",r,e);const t=n.createListener({upgrader:this.components.upgrader});let s=this.listeners.get(r);null==s&&(s=[],this.listeners.set(r,s)),s.push(t),t.addEventListener("listening",(()=>{this.dispatchEvent(new ny.A("listener:listening",{detail:t}))})),t.addEventListener("close",(()=>{this.dispatchEvent(new ny.A("listener:close",{detail:t}))})),i.push(t.listen(e))}if(0!==i.length){if(null==(await(0,rR.Z)(i)).find((e=>e.isFulfilled))&&this.faultTolerance!==aR.NO_FATAL)throw j(new Error(`Transport (${r}) could not listen on any available address`),Mk.ERR_NO_VALID_ADDRESSES)}else t.push(r)}if(t.length===this.transports.size){const e=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===aR.FATAL_ALL)throw j(new Error(e),Mk.ERR_NO_VALID_ADDRESSES);iR(`libp2p in dial mode only: ${e}`)}}async remove(e){iR("removing %s",e);for(const t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}var aR;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(aR||(aR={}));var cR=r(53841),lR=r(97975),hR=r(3571);const dR=(0,z.kg)("libp2p:connection");class uR{constructor(e){const{remoteAddr:t,remotePeer:r,newStream:n,close:s,getStreams:i,stat:o}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.stat={...o,status:Xk.o1},this._newStream=n,this._close=s,this._getStreams=i,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[hR.N](){return!0}get streams(){return this._getStreams()}async newStream(e,t){if(this.stat.status===Xk.Z5)throw j(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===Xk.m$)throw j(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(e)||(e=[e]);const r=await this._newStream(e,t);return r.stat.direction="outbound",r}addStream(e){e.stat.direction="inbound"}removeStream(e){}async close(){if(this.stat.status!==Xk.m$&&!this._closing){this.stat.status=Xk.Z5;try{this.streams.forEach((e=>e.close()))}catch(e){dR.error(e)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=Xk.m$}}}const pR=(0,z.kg)("libp2p:registrar");class fR{constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw j(new Error(`No handler registered for protocol ${e}`),Mk.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e))throw j(new Error(`Handler already registered for protocol ${e}`),Mk.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const n=B.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},r);this.handlers.set(e,{handler:t,options:n}),await this.components.peerStore.protoBook.add(this.components.peerId,[e])}async unhandle(e){const t=Array.isArray(e)?e:[e];t.forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.protoBook.remove(this.components.peerId,t)}async register(e,t){if(!(0,Xg.w)(t))throw pR.error("topology must be an instance of interfaces/topology"),j(new Error("topology must be an instance of interfaces/topology"),Mk.ERR_INVALID_PARAMETERS);const r=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let n=this.topologies.get(e);return null==n&&(n=new Map,this.topologies.set(e,n)),n.set(r,t),await t.setRegistrar(this),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),0===r.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then((e=>{for(const r of e){const e=this.topologies.get(r);if(null!=e)for(const r of e.values())r.onDisconnect(t.remotePeer)}})).catch((e=>{pR.error(e)}))}_onProtocolChange(e){const{peerId:t,protocols:r,oldProtocols:n}=e.detail,s=n.filter((e=>!r.includes(e))),i=r.filter((e=>!n.includes(e)));for(const e of s){const r=this.topologies.get(e);if(null!=r)for(const e of r.values())e.onDisconnect(t)}for(const e of i){const r=this.topologies.get(e);if(null!=r)for(const e of r.values()){const r=this.components.connectionManager.getConnections(t)[0];null!=r&&e.onConnect(t,r)}}}}const gR=(0,z.kg)("libp2p:upgrader");function yR(e,t,r){let n=0;return r.streams.forEach((r=>{r.stat.direction===t&&r.stat.protocol===e&&n++})),n}class mR extends ny.v{constructor(e,t){super(),this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout}async upgradeInbound(e){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw j(new Error("connection denied"),Mk.ERR_CONNECTION_DENIED);let t,r,n,s,i,o,a;const c=this.components.metrics,l=new Gr.TimeoutController(this.inboundUpgradeTimeout);try{(0,Fk.setMaxListeners)?.(1/0,l.signal)}catch{}try{const h=(0,Zb.D7)(e,l.signal);if(e.source=h.source,e.sink=h.sink,await this.components.connectionGater.denyInboundConnection(e))throw j(new Error("The multiaddr connection is blocked by gater.acceptConnection"),Mk.ERR_CONNECTION_INTERCEPTED);if(null!=c){({setTarget:o,proxy:a}=lR());const t=`${(1e9*Math.random()).toString(36)}${Date.now()}`;o({toString:()=>t}),c.trackStream({stream:e,remotePeer:a})}gR("starting the inbound connection upgrade");let d=e;const u=this.components.connectionProtector;null!=u&&(gR("protecting the inbound connection"),d=await u.protect(e));try{if(({conn:t,remotePeer:r,protocol:i}=await this._encryptInbound(d)),await this.components.connectionGater.denyInboundEncryptedConnection(r,{...d,...t}))throw j(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),Mk.ERR_CONNECTION_INTERCEPTED);if(this.muxers.size>0){const e=await this._multiplexInbound({...d,...t},this.muxers);s=e.muxerFactory,n=e.stream}else n=t}catch(e){throw gR.error("Failed to upgrade inbound connection",e),e}if(await this.components.connectionGater.denyInboundUpgradedConnection(r,{...d,...t}))throw j(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),Mk.ERR_CONNECTION_INTERCEPTED);return null!=c&&(c.updatePlaceholder(a,r),o(r)),gR("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:i,direction:"inbound",maConn:e,upgradedConn:n,muxerFactory:s,remotePeer:r})}finally{this.components.connectionManager.afterUpgradeInbound(),l.clear()}}async upgradeOutbound(e,t){const r=e.remoteAddr.getPeerId();if(null==r)throw j(new Error("outbound connection must have a peer id"),Mk.ERR_INVALID_MULTIADDR);const n=(0,Ln.jE)(r);if(await this.components.connectionGater.denyOutboundConnection(n,e))throw j(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),Mk.ERR_CONNECTION_INTERCEPTED);let s,i,o,a,c,l,h;const d=this.components.metrics;if(null!=d){({setTarget:l,proxy:h}=lR());const t=`${(1e9*Math.random()).toString(36)}${Date.now()}`;l({toB58String:()=>t}),d.trackStream({stream:e,remotePeer:h})}gR("Starting the outbound connection upgrade");let u=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(u=await t.protect(e))}try{if(s=u,!0!==t?.skipEncryption){if(({conn:s,remotePeer:i,protocol:a}=await this._encryptOutbound(u,n)),await this.components.connectionGater.denyOutboundEncryptedConnection(i,{...u,...s}))throw j(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),Mk.ERR_CONNECTION_INTERCEPTED)}else a="native",i=n;if(o=s,null!=t?.muxerFactory)c=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...u,...s},this.muxers);c=e.muxerFactory,o=e.stream}}catch(t){throw gR.error("Failed to upgrade outbound connection",t),await e.close(t),t}if(await this.components.connectionGater.denyOutboundUpgradedConnection(i,{...u,...s}))throw j(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),Mk.ERR_CONNECTION_INTERCEPTED);return null!=d&&(d.updatePlaceholder(h,i),l(i)),gR("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:a,direction:"outbound",maConn:e,upgradedConn:o,muxerFactory:c,remotePeer:i})}_createConnection(e){const{cryptoProtocol:t,direction:r,maConn:n,upgradedConn:s,remotePeer:i,muxerFactory:o}=e;let a,c,l;null!=o&&(a=o.createStreamMuxer({direction:r,onIncomingStream:e=>{null!=l&&Promise.resolve().then((async()=>{const t=this.components.registrar.getProtocols(),{stream:n,protocol:s}=await cR.pr(e,t);gR("%s: incoming stream opened on %s",r,s);const o=this.components.metrics;if(null!=o&&o.trackStream({stream:n,remotePeer:i,protocol:s}),null==l)return;const a=function(e,t){try{const{options:r}=t.getHandler(e);return r.maxInboundStreams}catch(e){if(e.code!==Mk.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 32}(s,this.components.registrar);yR(s,"inbound",l)!==a?(e.source=n.source,e.sink=n.sink,e.stat.protocol=s,this.components.peerStore.protoBook.add(i,[s]).catch((e=>gR.error(e))),l.addStream(e),this._onStream({connection:l,stream:e,protocol:s})):e.abort(j(new Error(`Too many inbound protocol streams for protocol "${s}" - limit ${a}`),Mk.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS))})).catch((t=>{gR.error(t),null==e.stat.timeline.close&&e.close()}))},onStreamEnd:e=>{l?.removeStream(e.id)}}),c=async(e,t={})=>{if(null==a)throw j(new Error("Stream is not multiplexed"),Mk.ERR_MUXER_UNAVAILABLE);gR("%s: starting new stream on %s",r,e);const n=await a.newStream(),s=this.components.metrics;let o;try{if(null==t.signal){gR("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e),o=new Gr.TimeoutController(3e4),t.signal=o.signal;try{(0,Fk.setMaxListeners)?.(1/0,o.signal)}catch{}}const{stream:r,protocol:a}=await cR.Ys(n,e,t);null!=s&&s.trackStream({stream:r,remotePeer:i,protocol:a});const c=function(e,t){try{const{options:r}=t.getHandler(e);return r.maxOutboundStreams}catch(e){if(e.code!==Mk.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 64}(a,this.components.registrar);if(yR(a,"outbound",l)===c){const e=j(new Error(`Too many outbound protocol streams for protocol "${a}" - limit ${c}`),Mk.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw n.abort(e),e}return this.components.peerStore.protoBook.add(i,[a]).catch((e=>gR.error(e))),n.source=r.source,n.sink=r.sink,n.stat.protocol=a,n}catch(e){if(gR.error("could not create new stream",e),null==n.stat.timeline.close&&n.close(),null!=e.code)throw e;throw j(e,Mk.ERR_UNSUPPORTED_PROTOCOL)}finally{null!=o&&o.clear()}},(0,vi.zG)(s,a,s).catch(gR.error));const h=n.timeline;n.timeline=new Proxy(h,{set:(...e)=>(null!=l&&"close"===e[1]&&null!=e[2]&&null==h.close&&(async()=>{try{"OPEN"===l.stat.status&&await l.close()}catch(e){gR.error(e)}finally{this.dispatchEvent(new ny.A("connectionEnd",{detail:l}))}})().catch((e=>{gR.error(e)})),Reflect.set(...e))}),n.timeline.upgraded=Date.now();const d=()=>{throw j(new Error("connection is not multiplexed"),Mk.ERR_CONNECTION_NOT_MULTIPLEXED)};var u;return u={remoteAddr:n.remoteAddr,remotePeer:i,stat:{status:"OPEN",direction:r,timeline:n.timeline,multiplexer:a?.protocol,encryption:t},newStream:c??d,getStreams:()=>null!=a?a.streams:d(),close:async()=>{await n.close(),null!=a&&a.close()}},l=new uR(u),this.dispatchEvent(new ny.A("connection",{detail:l})),l}_onStream(e){const{connection:t,stream:r,protocol:n}=e,{handler:s}=this.components.registrar.getHandler(n);s({connection:t,stream:r})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());gR("handling inbound crypto protocol selection",t);try{const{stream:r,protocol:n}=await cR.pr(e,t,{writeBytes:!0}),s=this.connectionEncryption.get(n);if(null==s)throw new Error(`no crypto module found for ${n}`);return gR("encrypting inbound connection..."),{...await s.secureInbound(this.components.peerId,r),protocol:n}}catch(e){throw j(e,Mk.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncryption.keys());gR("selecting outbound crypto protocol",r);try{const{stream:n,protocol:s}=await cR.Ys(e,r,{writeBytes:!0}),i=this.connectionEncryption.get(s);if(null==i)throw new Error(`no crypto module found for ${s}`);return gR("encrypting outbound connection to %p",t),{...await i.secureOutbound(this.components.peerId,n,t),protocol:s}}catch(e){throw j(e,Mk.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const r=Array.from(t.keys());gR("outbound selecting muxer %s",r);try{const{stream:n,protocol:s}=await cR.Ys(e,r,{writeBytes:!0});return gR("%s selected as muxer protocol",s),{stream:n,muxerFactory:t.get(s)}}catch(e){throw gR.error("error multiplexing outbound stream",e),j(e,Mk.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const r=Array.from(t.keys());gR("inbound handling muxers %s",r);try{const{stream:n,protocol:s}=await cR.pr(e,r,{writeBytes:!0});return{stream:n,muxerFactory:t.get(s)}}catch(e){throw gR.error("error multiplexing inbound stream",e),j(e,Mk.ERR_MUXER_UNAVAILABLE)}}}var wR;!function(e){let t;e.codec=()=>(null==t&&(t=(0,Jn.yw)(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const r of e.listenAddrs)t.uint32(18),t.bytes(r);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const r of e.protocols)t.uint32(26),t.string(r);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={listenAddrs:[],protocols:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 5:r.protocolVersion=e.string();break;case 6:r.agentVersion=e.string();break;case 1:r.publicKey=e.bytes();break;case 2:r.listenAddrs.push(e.bytes());break;case 4:r.observedAddr=e.bytes();break;case 3:r.protocols.push(e.string());break;case 8:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(wR||(wR={}));const bR="0.0.0",_R=`js-libp2p/${bR}`,ER=(0,z.kg)("libp2p:identify");class vR{constructor(e,t){this.components=e,this.started=!1,this.init=t,this.identifyProtocolStr=`/${t.protocolPrefix}/id/1.0.0`,this.identifyPushProtocolStr=`/${t.protocolPrefix}/id/push/1.0.0`,this.host={protocolVersion:`${t.protocolPrefix}/0.1.0`,...t.host},this.components.connectionManager.addEventListener("peer:connect",(e=>{const t=e.detail;this.identify(t).catch(ER.error)})),this.components.peerStore.addEventListener("change:multiaddrs",(e=>{const{peerId:t}=e.detail;this.components.peerId.equals(t)&&this.pushToPeerStore().catch((e=>ER.error(e)))})),this.components.peerStore.addEventListener("change:protocols",(e=>{const{peerId:t}=e.detail;this.components.peerId.equals(t)&&this.pushToPeerStore().catch((e=>ER.error(e)))}))}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",(0,Hr.m)(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",(0,Hr.m)(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,(e=>{this._handleIdentify(e).catch((e=>{ER.error(e)}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,(e=>{this._handlePush(e).catch((e=>{ER.error(e)}))}),{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(e){const t=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),r=this.components.addressManager.getAddresses().map((e=>e.bytes)),n=await this.components.peerStore.protoBook.get(this.components.peerId),s=e.map((async e=>{let s;const i=new Gr.TimeoutController(this.init.timeout);try{(0,Fk.setMaxListeners)?.(1/0,i.signal)}catch{}try{s=await e.newStream([this.identifyPushProtocolStr],{signal:i.signal});const o=(0,Zb.D7)(s,i.signal);await o.sink((0,vi.zG)([wR.encode({listenAddrs:r,signedPeerRecord:t,protocols:n})],Yb.c()))}catch(e){ER.error("could not push identify update to peer",e)}finally{null!=s&&s.close(),i.clear()}}));await Promise.all(s)}async pushToPeerStore(){if(!this.isStarted())return;const e=[];for(const t of this.components.connectionManager.getConnections()){const r=t.remotePeer;(await this.components.peerStore.get(r)).protocols.includes(this.identifyPushProtocolStr)&&e.push(t)}await this.push(e)}async _identify(e,t={}){let r,n,s=t.signal;if(null==s){r=new Gr.TimeoutController(this.init.timeout),s=r.signal;try{(0,Fk.setMaxListeners)?.(1/0,r.signal)}catch{}}try{n=await e.newStream([this.identifyProtocolStr],{signal:s});const t=(0,Zb.D7)(n,s),i=await(0,vi.zG)([],t,Yb.J({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async e=>await(0,bd.Z)(e)));if(null==i)throw j(new Error("No data could be retrieved"),Mk.ERR_CONNECTION_ENDED);try{return wR.decode(i)}catch(e){throw j(e,Mk.ERR_INVALID_MESSAGE)}}finally{null!=r&&r.clear(),null!=n&&n.close()}}async identify(e,t={}){const r=await this._identify(e,t),{publicKey:n,listenAddrs:s,protocols:i,observedAddr:o,signedPeerRecord:a,agentVersion:c,protocolVersion:l}=r;if(null==n)throw j(new Error("public key was missing from identify message"),Mk.ERR_MISSING_PUBLIC_KEY);const h=await(0,Ln.y5)(n);if(!e.remotePeer.equals(h))throw j(new Error("identified peer does not match the expected peer"),Mk.ERR_INVALID_PEER);if(this.components.peerId.equals(h))throw j(new Error("identified peer is our own peer id?"),Mk.ERR_INVALID_PEER);const d=vR.getCleanMultiaddr(o);if(null!=a){ER("received signed peer record from %p",h);try{const e=await Qg.X.openAndCertify(a,Qg.K.DOMAIN);if(!e.peerId.equals(h))throw j(new Error("identified peer does not match the expected peer"),Mk.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(e))return await this.components.peerStore.protoBook.set(h,i),null!=c&&await this.components.peerStore.metadataBook.setValue(h,"AgentVersion",(0,Hr.m)(c)),null!=l&&await this.components.peerStore.metadataBook.setValue(h,"ProtocolVersion",(0,Hr.m)(l)),void ER("identify completed for peer %p and protocols %o",h,i)}catch(e){ER("received invalid envelope, discard it and fallback to listenAddrs is available",e)}}else ER("no signed peer record received from %p",h);ER("falling back to legacy addresses from %p",h);try{await this.components.peerStore.addressBook.set(h,s.map((e=>(0,Zr.HM)(e))))}catch(e){ER.error("received invalid addrs",e)}await this.components.peerStore.protoBook.set(h,i),null!=c&&await this.components.peerStore.metadataBook.setValue(h,"AgentVersion",(0,Hr.m)(c)),null!=l&&await this.components.peerStore.metadataBook.setValue(h,"ProtocolVersion",(0,Hr.m)(l)),ER("identify completed for peer %p and protocols %o",h,i),ER("received observed address of %s",d?.toString())}async _handleIdentify(e){const{connection:t,stream:r}=e,n=new Gr.TimeoutController(this.init.timeout);try{(0,Fk.setMaxListeners)?.(1/0,n.signal)}catch{}try{const e=this.components.peerId.publicKey??new Uint8Array(0),s=await this.components.peerStore.get(this.components.peerId),i=this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,Zr.a_)("p2p").code)));let o=s.peerRecordEnvelope;if(i.length>0&&null==o){const e=new Qg.K({peerId:this.components.peerId,multiaddrs:i}),t=await Qg.X.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t),o=t.marshal().subarray()}const a=wR.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:i.map((e=>e.bytes)),signedPeerRecord:o,observedAddr:t.remoteAddr.bytes,protocols:s.protocols}),c=(0,Zb.D7)(r,n.signal),l=(0,vi.zG)([a],Yb.c());await c.sink(l)}catch(e){ER.error("could not respond to identify request",e)}finally{r.close(),n.clear()}}async _handlePush(e){const{connection:t,stream:r}=e,n=new Gr.TimeoutController(this.init.timeout);try{(0,Fk.setMaxListeners)?.(1/0,n.signal)}catch{}let s;try{const e=(0,Zb.D7)(r,n.signal),t=await(0,vi.zG)([],e,Yb.J({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async e=>await(0,bd.Z)(e)));null!=t&&(s=wR.decode(t))}catch(e){return ER.error("received invalid message",e)}finally{r.close(),n.clear()}if(null==s)return ER.error("received invalid message");const i=t.remotePeer;if(this.components.peerId.equals(i))ER("received push from ourselves?");else{if(ER("received push from %p",i),null!=s.signedPeerRecord){ER("received signedPeerRecord in push");try{const e=await Qg.X.openAndCertify(s.signedPeerRecord,Qg.K.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(e))return ER("consumed signedPeerRecord sent in push"),void await this.components.peerStore.protoBook.set(i,s.protocols);ER("failed to consume signedPeerRecord sent in push")}catch(e){ER("received invalid envelope, discard it and fallback to listenAddrs is available",e)}}else ER("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(i,s.listenAddrs.map((e=>(0,Zr.HM)(e))))}catch(e){ER.error("received invalid addrs",e)}try{await this.components.peerStore.protoBook.set(i,s.protocols)}catch(e){ER.error("received invalid protocols",e)}ER("handled push from %p",i)}}static getCleanMultiaddr(e){if(null!=e&&e.length>0)try{return(0,Zr.HM)(e)}catch{}}}var kR,SR;!function(e){let t;e.codec=()=>(null==t&&(t=(0,Jn.yw)(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),!0!==r.writeDefaults&&""===e.identifier||(t.uint32(10),t.string(e.identifier)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={identifier:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();t>>>3==1?r.identifier=e.string():e.skipType(7&t)}return r}))),t),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(kR||(kR={})),function(e){let t,r,n;!function(e){e.OK="OK",e.NOT_FOUND="NOT_FOUND",e.ERROR="ERROR"}(t=e.StatusCode||(e.StatusCode={})),function(e){e[e.OK=0]="OK",e[e.NOT_FOUND=1]="NOT_FOUND",e[e.ERROR=2]="ERROR"}(r||(r={})),function(e){e.codec=()=>(0,Jn.Ji)(r)}(t=e.StatusCode||(e.StatusCode={})),e.codec=()=>(null==n&&(n=(0,Jn.yw)(((t,n,s={})=>{!1!==s.lengthDelimited&&n.fork(),(!0===s.writeDefaults||null!=t.status&&0!==r[t.status])&&(n.uint32(8),e.StatusCode.codec().encode(t.status,n)),(!0===s.writeDefaults||null!=t.data&&t.data.byteLength>0)&&(n.uint32(18),n.bytes(t.data)),!1!==s.lengthDelimited&&n.ldelim()}),((r,n)=>{const s={status:t.OK,data:new Uint8Array(0)},i=null==n?r.len:r.pos+n;for(;r.pos<i;){const t=r.uint32();switch(t>>>3){case 1:s.status=e.StatusCode.codec().decode(r);break;case 2:s.data=r.bytes();break;default:r.skipType(7&t)}}return s}))),n),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(SR||(SR={}));const RR=(0,z.kg)("libp2p:fetch");class IR{constructor(e,t){this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/fetch/0.0.1`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,(e=>{this.handleMessage(e).catch((e=>{RR.error(e)})).finally((()=>{e.stream.close()}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,r={}){RR("dialing %s to %p",this.protocol,e);const n=await this.components.connectionManager.openConnection(e,r);let s,i,o=r.signal;if(null==o){s=new Gr.TimeoutController(this.init.timeout),o=s.signal;try{(0,Fk.setMaxListeners)?.(1/0,s.signal)}catch{}}try{i=await n.newStream([this.protocol],{signal:o});const e=(0,Zb.D7)(i,o),r=await(0,vi.zG)([kR.encode({identifier:t})],Yb.c(),e,Yb.J(),(async function(e){const t=await(0,bd.Z)(e);if(null==t)throw j(new Error("No data received"),Mk.ERR_INVALID_MESSAGE);const r=SR.decode(t);switch(r.status){case SR.StatusCode.OK:return r.data;case SR.StatusCode.NOT_FOUND:return null;case SR.StatusCode.ERROR:{const e=(new TextDecoder).decode(r.data);throw j(new Error("Error in fetch protocol response: "+e),Mk.ERR_INVALID_PARAMETERS)}default:throw j(new Error("Unknown response status"),Mk.ERR_INVALID_MESSAGE)}}));return r??null}finally{null!=s&&s.clear(),null!=i&&i.close()}}async handleMessage(e){const{stream:t}=e,r=this;await(0,vi.zG)(t,Yb.J(),(async function*(e){const t=await(0,bd.Z)(e);if(null==t)throw j(new Error("No data received"),Mk.ERR_INVALID_MESSAGE);const n=kR.decode(t);let s;const i=r._getLookupFunction(n.identifier);if(null!=i){const e=await i(n.identifier);s=null!=e?{status:SR.StatusCode.OK,data:e}:{status:SR.StatusCode.NOT_FOUND,data:new Uint8Array(0)}}else{const e=(new TextEncoder).encode("No lookup function registered for key: "+n.identifier);s={status:SR.StatusCode.ERROR,data:e}}yield SR.encode(s)}),Yb.c(),t)}_getLookupFunction(e){for(const t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw j(new Error("Fetch protocol handler for key prefix '"+e+"' already registered"),Mk.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){null!=t&&this.lookupFunctions.get(e)!==t||this.lookupFunctions.delete(e)}}const TR=(0,z.kg)("libp2p:ping");class AR{constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix}/ping/1.0.0`,this.init=t}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const{stream:t}=e;(0,vi.zG)(t,t).catch((e=>{TR.error(e)}))}async ping(e,t={}){TR("dialing %s to %p",this.protocol,e);const r=Date.now(),n=(0,bw.O6)(32),s=await this.components.connectionManager.openConnection(e,t);let i,o,a=t.signal;if(null==a){i=new Gr.TimeoutController(this.init.timeout),a=i.signal;try{(0,Fk.setMaxListeners)?.(1/0,i.signal)}catch{}}try{o=await s.newStream([this.protocol],{signal:a});const e=(0,Zb.D7)(o,a),t=await(0,vi.zG)([n],e,(async e=>await(0,bd.Z)(e))),c=Date.now();if(null==t||!(0,Hn.f)(n,t.subarray()))throw j(new Error("Received wrong ping ack"),Mk.ERR_WRONG_PING_ACK);return c-r}finally{null!=i&&i.clear(),null!=o&&o.close()}}}var PR=r(22951),DR=r(9972),OR=r(99699),NR=r(90214);const CR=(0,z.kg)("libp2p:nat");function MR(e=1024,t=65535){return Math.floor(Math.random()*(t-e+1)+e)}class LR{constructor(e,t){if(this.components=e,this.started=!1,this.enabled=t.enabled,this.externalAddress=t.externalAddress,this.localAddress=t.localAddress,this.description=t.description??`libp2p@${bR} ${this.components.peerId.toString()}`,this.ttl=t.ttl??7200,this.keepAlive=t.keepAlive??!0,this.gateway=t.gateway,this.ttl<7200)throw j(new Error("NatManager ttl should be at least 7200 seconds"),Mk.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){DR.jU||!this.enabled||this.started||(this.started=!0,this._start().catch((e=>{CR.error(e)})))}async _start(){const e=this.components.transportManager.getAddrs();for(const t of e){const{family:e,host:r,port:n,transport:s}=t.toOptions();if(!t.isThinWaistAddress()||"tcp"!==s)continue;if((0,NR.Y)(t))continue;if(4!==e)continue;const i=await this._getClient(),o=this.externalAddress??await i.externalIp();if(OR(o))throw new Error(`${o} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);const a=MR();CR(`opening uPnP connection from ${o}:${a} to ${r}:${n}`),await i.map({publicPort:a,localPort:n,localAddress:this.localAddress,protocol:"TCP"===s.toUpperCase()?"TCP":"UDP"}),this.components.addressManager.addObservedAddr((0,Zr.uv)({family:4,address:o,port:a},s))}}async _getClient(){return null!=this.client||(this.client=await(0,PR.h)({description:this.description,ttl:this.ttl,keepAlive:this.keepAlive,gateway:this.gateway})),this.client}async stop(){if(!DR.jU&&null!=this.client)try{await this.client.close(),this.client=void 0}catch(e){CR.error(e)}}}const xR=(0,z.kg)("libp2p:peer-record-updater");class BR{constructor(e){this.components=e,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then((async()=>{const e=new Qg.K({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,Zr.a_)("p2p").code)))}),t=await Qg.X.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t)})).catch((e=>{xR.error("Could not update self peer record: %o",e)}))}}class UR{constructor(e){this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if("FINAL_PEER"===r.name)return r.peer;throw j(new Error(Ck.NOT_FOUND),Mk.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))"FINAL_PEER"===r.name&&(yield r.peer)}}var zR=r(87806);class jR{constructor(e){this.dht=e}async provide(e){await(0,qs.Z)(this.dht.provide(e))}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))"PROVIDER"===r.name&&(yield*r.providers)}async put(e,t,r){await(0,qs.Z)(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if("VALUE"===r.name)return r.value;throw j(new Error("Not found"),"ERR_NOT_FOUND")}}class FR{constructor(e={}){this._started=!1,this._peerId=e.peerId,this._addressManager=e.addressManager,this._peerStore=e.peerStore,this._upgrader=e.upgrader,this._metrics=e.metrics,this._registrar=e.registrar,this._connectionManager=e.connectionManager,this._transportManager=e.transportManager,this._connectionGater=e.connectionGater,this._contentRouting=e.contentRouting,this._peerRouting=e.peerRouting,this._datastore=e.datastore,this._connectionProtector=e.connectionProtector,this._dht=e.dht,this._pubsub=e.pubsub,this._dialer=e.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.beforeStart&&await e.beforeStart()})))}async start(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{await e.start()}))),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.afterStart&&await e.afterStart()})))}async beforeStop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.beforeStop&&await e.beforeStop()})))}async stop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{await e.stop()}))),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter((e=>(0,iw.qK)(e))).map((async e=>{null!=e.afterStop&&await e.afterStop()})))}get peerId(){if(null==this._peerId)throw j(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(e){this._peerId=e}get addressManager(){if(null==this._addressManager)throw j(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(e){this._addressManager=e}get peerStore(){if(null==this._peerStore)throw j(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(e){this._peerStore=e}get upgrader(){if(null==this._upgrader)throw j(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(e){this._upgrader=e}get registrar(){if(null==this._registrar)throw j(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(e){this._registrar=e}get connectionManager(){if(null==this._connectionManager)throw j(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(e){this._connectionManager=e}get transportManager(){if(null==this._transportManager)throw j(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(e){this._transportManager=e}get connectionGater(){if(null==this._connectionGater)throw j(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(e){this._connectionGater=e}get contentRouting(){if(null==this._contentRouting)throw j(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(e){this._contentRouting=e}get peerRouting(){if(null==this._peerRouting)throw j(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(e){this._peerRouting=e}get datastore(){if(null==this._datastore)throw j(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(e){this._datastore=e}get connectionProtector(){return this._connectionProtector}set connectionProtector(e){this._connectionProtector=e}get dialer(){if(null==this._dialer)throw j(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(e){this._dialer=e}get metrics(){return this._metrics}set metrics(e){this._metrics=e}get dht(){return this._dht}set dht(e){this._dht=e}get pubsub(){return this._pubsub}set pubsub(e){this._pubsub=e}}const VR={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:100,maxDialsPerPeer:4,dialTimeout:3e4,inboundUpgradeTimeout:3e4,resolvers:{dnsaddr:r(84694).I},addressSorter:AS.F},connectionGater:{},transportManager:{faultTolerance:aR.FATAL_ALL},metrics:{enabled:!1,computeThrottleMaxQueueSize:1e3,computeThrottleTimeout:2e3,movingAverageIntervals:[6e4,3e5,9e5],maxOldPeersRetention:50},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:9e5,enabled:!1,ttl:18e5},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:_R},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};var $R=r(9001),HR=r(44198);class GR extends ny.v{get[HR.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}get lan(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}get(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}findProviders(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}findPeer(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}getClosestPeers(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}provide(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}put(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}async getMode(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}async setMode(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}async refreshRoutingTable(){throw j(new Error(Ck.DHT_DISABLED),Mk.DHT_DISABLED)}}class qR extends ny.v{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}get multicodecs(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}getPeers(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}getTopics(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}subscribe(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}unsubscribe(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}getSubscribers(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}async publish(){throw j(new Error(Ck.PUBSUB_DISABLED),Mk.ERR_PUBSUB_DISABLED)}}var KR=r(16395),WR=r(5181);const ZR=(0,z.kg)("libp2p:dialer:dial-request");class YR{constructor(e){const{addrs:t,dialAction:r,dialer:n}=e;this.addrs=t,this.dialer=n,this.dialAction=r}async run(e={}){const t=this.dialer.getTokens(this.addrs.length);if(t.length<1)throw j(new Error("No dial tokens available"),Mk.ERR_NO_DIAL_TOKENS);const r=new WR;for(const e of t)r.push(e).catch((e=>{ZR.error(e)}));const n=this.addrs.map((()=>{const e=new AbortController;try{(0,Fk.setMaxListeners)?.(1/0,e.signal)}catch{}return e}));if(null!=e.signal)try{(0,Fk.setMaxListeners)?.(1/0,e.signal)}catch{}let s=0,i=!1;try{return await Promise.any(this.addrs.map((async(o,a)=>{const c=await r.shift();if(i)throw this.dialer.releaseToken(t.splice(t.indexOf(c),1)[0]),j(new Error("dialAction already succeeded"),Mk.ERR_ALREADY_SUCCEEDED);const l=n[a];if(null==l)throw j(new Error("dialAction did not come with an AbortController"),Mk.ERR_INVALID_PARAMETERS);let h;try{const i=l.signal;h=await this.dialAction(o,{...e,signal:null!=e.signal?(0,dn.anySignal)([i,e.signal]):i}),n[a]=void 0}finally{s++,this.addrs.length-s>=t.length?r.push(c).catch((e=>{ZR.error(e)})):this.dialer.releaseToken(t.splice(t.indexOf(c),1)[0])}if(null==h)throw j(new Error("dialAction led to empty object"),Mk.ERR_TRANSPORT_DIAL_FAILED);return i=!0,h})))}finally{n.forEach((e=>{void 0!==e&&e.abort()})),t.forEach((e=>this.dialer.releaseToken(e)))}}}const JR=(0,z.kg)("libp2p:dialer"),QR="dialler";class XR{constructor(e,t={}){this.started=!1,this.addressSorter=t.addressSorter??AS.F,this.maxAddrsToDial=t.maxAddrsToDial??25,this.timeout=t.dialTimeout??3e4,this.maxDialsPerPeer=t.maxDialsPerPeer??4,this.tokens=[...new Array(t.maxParallelDials??100)].map(((e,t)=>t)),this.components=e,this.pendingDials=sR({component:QR,metric:"pending-dials",metrics:t.metrics}),this.pendingDialTargets=sR({component:QR,metric:"pending-dial-targets",metrics:e.metrics});for(const[e,r]of Object.entries(t.resolvers??{}))Zr.s_.set(e,r)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const e of this.pendingDials.values())try{e.controller.abort()}catch(e){JR.error(e)}this.pendingDials.clear();for(const e of this.pendingDialTargets.values())e.reject(new KR._("Dialer was destroyed"));this.pendingDialTargets.clear()}async dial(e,t={}){const{id:r,multiaddrs:n}=Gk(e);if(this.components.peerId.equals(r))throw j(new Error("Tried to dial self"),Mk.ERR_DIALED_SELF);if(JR("check multiaddrs %p",r),null!=n&&n.length>0&&(JR("storing multiaddrs %p",r,n),await this.components.peerStore.addressBook.add(r,n)),await this.components.connectionGater.denyDialPeer(r))throw j(new Error("The dial request is blocked by gater.allowDialPeer"),Mk.ERR_PEER_DIAL_INTERCEPTED);JR("creating dial target for %p",r);const s=await this._createCancellableDialTarget(r,t);if(0===s.addrs.length)throw j(new Error("The dial request has no valid addresses"),Mk.ERR_NO_VALID_ADDRESSES);const i=this.pendingDials.get(s.id)??this._createPendingDial(s,t);try{const e=await i.promise;return JR("dial succeeded to %s",s.id),e}catch(e){throw JR("dial failed to %s",s.id,e),i.controller.signal.aborted&&(e.code=Mk.ERR_TIMEOUT),JR.error(e),e}finally{i.destroy()}}async _createCancellableDialTarget(e,t){const r=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,n=new Promise(((e,t)=>{this.pendingDialTargets.set(r,{resolve:e,reject:t})}));try{return await Promise.race([this._createDialTarget(e,t),n])}finally{this.pendingDialTargets.delete(r)}}async _createDialTarget(e,t){const r=this._resolve.bind(this),n=await(0,vi.zG)(await this.components.peerStore.addressBook.get(e),(t=>(0,Ei.Z)(t,(async t=>!await this.components.connectionGater.denyDialMultiaddr(e,t.multiaddr)))),(e=>(0,zg.Z)(e,this.addressSorter)),(async function*(e){for await(const n of e)yield*await r(n.multiaddr,t)}),(e=>(0,Ei.Z)(e,(e=>Boolean(this.components.transportManager.transportForMultiaddr(e))))),(t=>(0,_i.Z)(t,(t=>e.toString()===t.getPeerId()?t:t.encapsulate(`/p2p/${e.toString()}`)))),(async e=>await(0,Ti.Z)(e)));if(n.length>this.maxAddrsToDial)throw await this.components.peerStore.delete(e),j(new Error("dial with more addresses than allowed"),Mk.ERR_TOO_MANY_ADDRESSES);return{id:e.toString(),addrs:n}}_createPendingDial(e,t={}){const r=new YR({addrs:e.addrs,dialAction:async(e,t={})=>{if(!0===t.signal?.aborted)throw j(new Error("already aborted"),Mk.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(e,t).catch((t=>{throw JR.error("dial to %s failed",e,t),t}))},dialer:this}),n=new Gr.TimeoutController(this.timeout),s=[n.signal];null!=t.signal&&s.push(t.signal);const i=(0,dn.anySignal)(s);try{(0,Fk.setMaxListeners)?.(1/0,i)}catch{}const o={dialRequest:r,controller:n,promise:r.run({...t,signal:i}),destroy:()=>{n.clear(),this.pendingDials.delete(e.id)}};return this.pendingDials.set(e.id,o),o}getTokens(e){const t=Math.min(e,this.maxDialsPerPeer,this.tokens.length),r=this.tokens.splice(0,t);return JR("%d tokens request, returning %d, %d remaining",e,t,this.tokens.length),r}releaseToken(e){this.tokens.includes(e)||(JR("token %d released",e),this.tokens.push(e))}async _resolve(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const r=await this._resolveRecord(e,t);return(await Promise.all(r.map((async e=>await this._resolve(e,t))))).flat().reduce(((e,t)=>(null==e.find((e=>e.equals(t)))&&e.push(t),e)),[])}async _resolveRecord(e,t){try{return e=(0,Zr.HM)(e.toString()),await e.resolve(t)}catch(t){return JR.error(`multiaddr ${e.toString()} could not be resolved`,t),[]}}}const eI=(0,z.kg)("libp2p");class tI extends ny.v{constructor(e){super(),this.started=!1,this.peerId=e.peerId;const t=this.components=new FR({peerId:e.peerId,datastore:e.datastore??new Ns.a,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...e.connectionGater}});t.peerStore=new zR.o(t,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore}),this.services=[t],e.metrics.enabled&&(this.metrics=this.components.metrics=new tR(e.metrics)),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",(e=>{const{detail:t}=e;this.dispatchEvent(new ny.A("peer:discovery",{detail:t}))})),null!=e.connectionProtector&&(this.components.connectionProtector=e.connectionProtector(t)),this.components.upgrader=new mR(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((e=>this.configureComponent(e(this.components)))),muxers:(e.streamMuxers??[]).map((e=>this.configureComponent(e(this.components)))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new XR(this.components,e.connectionManager),this.connectionManager=this.components.connectionManager=new aS(this.components,e.connectionManager),this.registrar=this.components.registrar=new fR(this.components),this.components.transportManager=new oR(this.components,e.transportManager),this.components.addressManager=new Kk(this.components,e.addresses),this.configureComponent(new BR(this.components)),this.configureComponent(new hS(this.components,{enabled:e.connectionManager.autoDial,minConnections:e.connectionManager.minConnections,autoDialInterval:e.connectionManager.autoDialInterval}));const r=WS.generateOptions();this.keychain=this.configureComponent(new WS(this.components,{...r,...e.keychain})),this.services.push(new LR(this.components,e.nat)),e.transports.forEach((e=>{this.components.transportManager.add(this.configureComponent(e(this.components)))})),this.identifyService=new vR(this.components,{...e.identify}),this.configureComponent(this.identifyService),null!=e.dht?this.dht=this.components.dht=e.dht(this.components):this.dht=new GR,null!=e.pubsub?this.pubsub=this.components.pubsub=e.pubsub(this.components):this.pubsub=new qR;const n=(e.peerRouters??[]).map((e=>this.configureComponent(e(this.components))));null!=e.dht&&(n.push(this.configureComponent(new UR(this.dht))),this.dht.addEventListener("peer",(e=>{this.onDiscoveryPeer(e)}))),this.peerRouting=this.components.peerRouting=this.configureComponent(new $k(this.components,{...e.peerRouting,routers:n}));const s=(e.contentRouters??[]).map((e=>this.configureComponent(e(this.components))));null!=e.dht&&s.push(this.configureComponent(new jR(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new Hk(this.components,{routers:s})),e.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new kS(this.components,e.relay))),this.configureComponent(new CS(this.components,{addressSorter:e.connectionManager.addressSorter,...e.relay}))),this.fetchService=this.configureComponent(new IR(this.components,{...e.fetch})),this.pingService=this.configureComponent(new AR(this.components,{...e.ping}));for(const t of e.peerDiscovery??[])this.configureComponent(t(this.components)).addEventListener("peer",(e=>{this.onDiscoveryPeer(e)}))}configureComponent(e){return(0,iw.qK)(e)&&this.services.push(e),e}async start(){if(!this.started){this.started=!0,eI("libp2p is starting");try{await Promise.all(this.services.map((async e=>{null!=e.beforeStart&&await e.beforeStart()}))),await Promise.all(this.services.map((e=>e.start()))),await Promise.all(this.services.map((async e=>{null!=e.afterStart&&await e.afterStart()}))),eI("libp2p has started")}catch(e){throw eI.error("An error occurred starting libp2p",e),await this.stop(),e}}}async stop(){this.started&&(eI("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map((async e=>{null!=e.beforeStop&&await e.beforeStop()}))),await Promise.all(this.services.map((e=>e.stop()))),await Promise.all(this.services.map((async e=>{null!=e.afterStop&&await e.afterStop()}))),eI("libp2p has stopped"))}isStarted(){return this.started}getConnections(e){return this.components.connectionManager.getConnections(e)}getPeers(){const e=new eS.fd;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){const{id:r,multiaddrs:n}=Gk(e);return await this.components.peerStore.addressBook.add(r,n),await this.components.connectionManager.openConnection(r,t)}async dialProtocol(e,t,r={}){if(null==t)throw j(new Error("no protocols were provided to open a stream"),Mk.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw j(new Error("no protocols were provided to open a stream"),Mk.ERR_INVALID_PROTOCOLS_FOR_STREAM);const n=await this.dial(e,r);return await n.newStream(t,r)}getMultiaddrs(){return this.components.addressManager.getAddresses()}async hangUp(e){const{id:t}=Gk(e);await this.components.connectionManager.closeConnections(t)}async getPublicKey(e,t={}){if(eI("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;const r=await this.peerStore.get(e);if(null!=r.pubKey)return r.pubKey;if(null==this.dht)throw j(new Error("Public key was not in the peer store and the DHT is not enabled"),Mk.ERR_NO_ROUTERS_AVAILABLE);const n=(0,Qn.z)([(0,Hr.m)("/pk/"),e.multihash.digest]);for await(const r of this.dht.get(n,t))if("VALUE"===r.name){const t=(0,qn.unmarshalPublicKey)(r.value);return await this.peerStore.keyBook.set(e,r.value),t.bytes}throw j(new Error(`Node not responding with its public key: ${e.toString()}`),Mk.ERR_INVALID_RECORD)}async fetch(e,t,r={}){const{id:n,multiaddrs:s}=Gk(e);return null!=s&&await this.components.peerStore.addressBook.add(n,s),await this.fetchService.fetch(n,t,r)}async ping(e,t={}){const{id:r,multiaddrs:n}=Gk(e);return n.length>0&&await this.components.peerStore.addressBook.add(r,n),await this.pingService.ping(r,t)}async handle(e,t,r){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,r)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}onDiscoveryPeer(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?(t.multiaddrs.length>0&&this.components.peerStore.addressBook.add(t.id,t.multiaddrs).catch((e=>eI.error(e))),t.protocols.length>0&&this.components.peerStore.protoBook.set(t.id,t.protocols).catch((e=>eI.error(e))),this.dispatchEvent(new ny.A("peer:discovery",{detail:t}))):eI.error(new Error(Mk.ERR_DISCOVERED_SELF))}}var rI=r(26665);const nI="/dht/provider",sI=20,iI=3,oI=Number(3e5),aI=Number(3e4),cI=Number(3e5),lI=Number(3e4),hI=Number(3e4),dI=(0,Hr.m)("/pk/");function uI(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{const[[t,r]]=e.stringTuples();return(4===t||6===t)&&null!=r&&!OR(r)}))}}function pI(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{const[[t,r]]=e.stringTuples();return(4===t||6===t)&&null!=r&&OR(r)}))}}async function fI(e){return(await zi.sha256.digest(e)).digest}async function gI(e){return await fI(e.toBytes())}function yI(e){return new hn.s(`/dht/record/${(0,Qr.B)(e,"base32")}`,!1)}function mI(e,t){const r=new Date;return new $s(e,t,r).serialize()}const wI="routing-table-size";class bI{constructor(e,t){const{kBucketSize:r,pingTimeout:n,lan:s,pingConcurrency:i,protocol:o,tagName:a,tagValue:c}=t;this.components=e,this.log=(0,z.kg)(`libp2p:kad-dht:${s?"lan":"wan"}:routing-table`),this.kBucketSize=r??20,this.pingTimeout=n??1e4,this.pingConcurrency=i??10,this.lan=s,this.running=!1,this.protocol=o,this.tagName=a??"kad-close",this.tagValue=c??50;const l=()=>{this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:"ping-queue-size",value:this.pingQueue.size}),this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:"ping-running",value:this.pingQueue.pending})};this.pingQueue=new Dn.Z({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",l),this.pingQueue.addListener("next",l),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0;const e=new rI({localNodeId:await gI(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.on("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new eS.fd;const r=function(e,t=100){let r;return()=>{clearTimeout(r),r=setTimeout((()=>e()),t)}}((()=>{const r=new eS.fd(e.closest(e.localNodeId,20).map((e=>e.peer))),n=r.difference(t),s=t.difference(r);Promise.resolve().then((async()=>{for(const e of n)await this.components.peerStore.tagPeer(e,this.tagName,{value:this.tagValue});for(const e of s)await this.components.peerStore.unTagPeer(e,this.tagName)})).catch((e=>{this.log.error("Could not update peer tags",e)})),t=r}));e.on("added",(()=>{r()})),e.on("removed",(()=>{r()}))}_onPing(e,t){this.pingQueue.add((async()=>{if(!this.running)return;let r=0;try{await Promise.all(e.map((async e=>{let t;try{t=new Gr.TimeoutController(this.pingTimeout);const n={signal:t.signal};this.log("pinging old contact %p",e.peer);const s=await this.components.connectionManager.openConnection(e.peer,n);(await s.newStream(this.protocol,n)).close(),r++}catch(t){this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",e.peer,t),this.log("evicting old contact after ping failed %p",e),this.kb.remove(e.id))}finally{null!=t&&t.clear(),this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:wI,value:this.size})}}))),this.running&&r<e.length&&null!=this.kb&&(this.log("adding new contact %p",t.peer),this.kb.add(t))}catch(e){this.log.error("could not process k-bucket ping event",e)}})).catch((e=>{this.log.error("could not process k-bucket ping event",e)}))}get size(){return null==this.kb?0:this.kb.count()}async find(e){const t=await gI(e),r=this.closestPeer(t);if(null!=r&&e.equals(r))return r}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return null==this.kb?[]:this.kb.closest(e,t).map((e=>e.peer))}async add(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await gI(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:wI,value:this.size})}async remove(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await gI(e);this.kb.remove(t),this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:wI,value:this.size})}}var _I=r(93889),EI=r(36565);function vI(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");const r=(0,_I.E)(e.length);for(let n=0;n<e.length;n++)r[n]=e[n]^t[n];return(0,EI.P)(r)}const kI=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];class SI{constructor(e){const{peerRouting:t,routingTable:r,refreshInterval:n,refreshQueryTimeout:s,lan:i}=e;this.log=(0,z.kg)(`libp2p:kad-dht:${i?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=r,this.refreshInterval=n??cI,this.refreshQueryTimeout=s??lI,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${r.map((e=>e.toISOString())).join(", ")} ]`),Promise.all(r.map((async(n,s)=>{try{if(await this._refreshCommonPrefixLength(s,n,e),0===this._numPeersForCpl(t)){const t=Math.min(2*(s+1),r.length-1);for(let r=s+1;r<t+1;r++)try{await this._refreshCommonPrefixLength(r,n,e)}catch(e){this.log.error(e)}}}catch(e){this.log.error(e)}}))).catch((e=>{this.log.error(e)})).then((()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()})).catch((e=>{this.log.error(e)}))}async _refreshCommonPrefixLength(e,t,r){if(!r&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);const n=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,n,this.routingTable.size);const s=new Gr.TimeoutController(this.refreshQueryTimeout);try{const t=await Dp(this.peerRouting.getClosestPeers(n.toBytes(),{signal:s.signal}));this.log(`found ${t} peers that were close to imaginary peer %p`,n),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,n,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}async _generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");const t=(0,bw.O6)(2),r=(t[1]<<8)+t[0],n=await this._makePeerId(this.routingTable.kb.localNodeId,r,e);return(0,Ln.cv)(n)}async _makePeerId(e,t,r){if(r>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1),s=65535<<16-(r+1),i=kI[(n^32768>>r)&s|t&~s],o=new ArrayBuffer(34),a=new DataView(o,0,o.byteLength);return a.setUint8(0,zi.sha256.code),a.setUint8(1,32),a.setUint32(2,i,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb)for(const{id:e}of this.routingTable.kb.toIterable()){const t=vI(this.routingTable.kb.localNodeId,e);let r=0;for(const e of t){if(0!==e)break;r++}yield r}}}var RI,II;!function(e){let t;e.codec=()=>(null==t&&(t=(0,Jn.yw)(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 3:r.author=e.bytes();break;case 4:r.signature=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(RI||(RI={})),function(e){let t,r,n,s,i,o;!function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(t=e.MessageType||(e.MessageType={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(r||(r={})),function(e){e.codec=()=>(0,Jn.Ji)(r)}(t=e.MessageType||(e.MessageType={})),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(n=e.ConnectionType||(e.ConnectionType={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(s||(s={})),function(e){e.codec=()=>(0,Jn.Ji)(s)}(n=e.ConnectionType||(e.ConnectionType={})),function(t){let r;t.codec=()=>(null==r&&(r=(0,Jn.yw)(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.id&&(r.uint32(10),r.bytes(t.id)),null==t.addrs)throw new Error('Protocol error: required field "addrs" was not found in object');for(const e of t.addrs)r.uint32(18),r.bytes(e);null!=t.connection&&(r.uint32(24),e.ConnectionType.codec().encode(t.connection,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{const n={addrs:[]},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const r=t.uint32();switch(r>>>3){case 1:n.id=t.bytes();break;case 2:n.addrs.push(t.bytes());break;case 3:n.connection=e.ConnectionType.codec().decode(t);break;default:t.skipType(7&r)}}return n}))),r),t.encode=e=>(0,Jn.LE)(e,t.codec()),t.decode=e=>(0,Jn.C6)(e,t.codec())}(i=e.Peer||(e.Peer={})),e.codec=()=>(null==o&&(o=(0,Jn.yw)(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.MessageType.codec().encode(t.type,r)),null!=t.clusterLevelRaw&&(r.uint32(80),r.int32(t.clusterLevelRaw)),null!=t.key&&(r.uint32(18),r.bytes(t.key)),null!=t.record&&(r.uint32(26),r.bytes(t.record)),null==t.closerPeers)throw new Error('Protocol error: required field "closerPeers" was not found in object');for(const n of t.closerPeers)r.uint32(66),e.Peer.codec().encode(n,r);if(null==t.providerPeers)throw new Error('Protocol error: required field "providerPeers" was not found in object');for(const n of t.providerPeers)r.uint32(74),e.Peer.codec().encode(n,r);!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{const n={closerPeers:[],providerPeers:[]},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const r=t.uint32();switch(r>>>3){case 1:n.type=e.MessageType.codec().decode(t);break;case 10:n.clusterLevelRaw=t.int32();break;case 2:n.key=t.bytes();break;case 3:n.record=t.bytes();break;case 8:n.closerPeers.push(e.Peer.codec().decode(t,t.uint32()));break;case 9:n.providerPeers.push(e.Peer.codec().decode(t,t.uint32()));break;default:t.skipType(7&r)}}return n}))),o),e.encode=t=>(0,Jn.LE)(t,e.codec()),e.decode=t=>(0,Jn.C6)(t,e.codec())}(II||(II={}));const TI=II.MessageType,AI=II.ConnectionType,PI=Object.keys(TI);class DI{constructor(e,t,r){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=r,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return II.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(OI),providerPeers:this.providerPeers.map(OI),record:null==this.record?void 0:this.record.serialize().subarray()})}static deserialize(e){const t=II.decode(e),r=new DI(t.type??II.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return r.closerPeers=t.closerPeers.map(NI),r.providerPeers=t.providerPeers.map(NI),null!=t.record?.length&&(r.record=$s.deserialize(t.record)),r}}function OI(e){return{id:e.id.toBytes(),addrs:(e.multiaddrs??[]).map((e=>e.bytes)),connection:AI.CONNECTED}}function NI(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:(0,Ln.cv)(e.id),multiaddrs:(e.addrs??[]).map((e=>(0,Zr.HM)(e))),protocols:[]}}function CI(e){return{...e,name:"SENDING_QUERY",type:0,messageName:e.type,messageType:PI.indexOf(e.type.toString())}}function MI(e){return{...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:null!=e.closer?e.closer:[],providers:null!=e.providers?e.providers:[]}}function LI(e){return{...e,name:"FINAL_PEER",type:2}}function xI(e){return{...e,name:"QUERY_ERROR",type:3}}function BI(e){return{...e,name:"PROVIDER",type:4}}function UI(e){return{...e,name:"VALUE",type:5}}function zI(e){return{...e,name:"DIALING_PEER",type:7}}class jI extends ny.v{constructor(e,t){super();const{protocol:r,lan:n}=t;this.components=e,this.log=(0,z.kg)(`libp2p:kad-dht:${n?"lan":"wan"}:network`),this.running=!1,this.protocol=r}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,r={}){if(this.running){this.log("sending %s to %p",t.type,e),yield zI({peer:e}),yield CI({to:e,type:t.type});try{const n=await this.components.connectionManager.openConnection(e,r),s=await n.newStream(this.protocol,r),i=await this._writeReadMessage(s,t.serialize(),r);yield MI({from:e,messageType:i.type,closer:i.closerPeers,providers:i.providerPeers,record:i.record})}catch(t){yield xI({from:e,error:t})}finally{null!=s&&s.close()}}}async*sendMessage(e,t,r={}){if(this.running){this.log("sending %s to %p",t.type,e),yield zI({peer:e}),yield CI({to:e,type:t.type});try{const n=await this.components.connectionManager.openConnection(e,r),s=await n.newStream(this.protocol,r);await this._writeMessage(s,t.serialize(),r),yield MI({from:e,messageType:t.type})}catch(t){yield xI({from:e,error:t})}finally{null!=s&&s.close()}}}async _writeMessage(e,t,r){null!=r.signal&&(e=(0,Zb.D7)(e,r.signal)),await(0,vi.zG)([t],Yb.c(),e,qs.Z)}async _writeReadMessage(e,t,r){null!=r.signal&&(e=(0,Zb.D7)(e,r.signal));const n=await(0,vi.zG)([t],Yb.c(),e,Yb.J(),(async e=>{const t=await(0,bd.Z)(e);if(null!=t)return t;throw j(new Error("No message received"),"ERR_NO_MESSAGE_RECEIVED")})),s=DI.deserialize(n);return s.closerPeers.forEach((e=>{this.dispatchEvent(new ny.A("peer",{detail:e}))})),s.providerPeers.forEach((e=>{this.dispatchEvent(new ny.A("peer",{detail:e}))})),s}}function FI(e,t){const r=t.key,n=(0,Qr.B)(r).split("/");if(n.length<3)return;const s=e[n[1].toString()];if(null==s)throw j(new Error("Invalid record keytype"),"ERR_INVALID_RECORD_KEY_TYPE");return s(r,t.value)}const VI={pk:async(e,t)=>{if(!(e instanceof Uint8Array))throw j(new Error('"key" must be a Uint8Array'),"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(e.byteLength<5)throw j(new Error("invalid public key record"),"ERR_INVALID_RECORD_KEY_TOO_SHORT");if("/pk/"!==(0,Qr.B)(e.subarray(0,4)))throw j(new Error("key was not prefixed with /pk/"),"ERR_INVALID_RECORD_KEY_BAD_PREFIX");const r=e.slice(4),n=await zi.sha256.digest(t);if(!(0,Hn.f)(r,n.bytes))throw j(new Error("public key does not match passed in key"),"ERR_INVALID_RECORD_HASH_MISMATCH")}},$I={pk:function(e,t){return 0}};class HI{constructor(e,t){const{validators:r,selectors:n,peerRouting:s,queryManager:i,routingTable:o,network:a,lan:c}=t;this.components=e,this.log=(0,z.kg)(`libp2p:kad-dht:${c?"lan":"wan"}:content-fetching`),this.validators=r,this.selectors=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.network=a}async putLocal(e,t){const r=yI(e);await this.components.datastore.put(r,t)}async getLocal(e){this.log("getLocal %b",e);const t=yI(e);this.log("fetching record for key %k",t);const r=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const n=$s.deserialize(r);return await FI(this.validators,n),n}async*sendCorrectionRecord(e,t,r,n={}){this.log("sendCorrection for %b",e);const s=await mI(e,r);for(const{value:i,from:o}of t){if((0,Hn.f)(i,r)){this.log("record was ok");continue}if(this.components.peerId.equals(o)){try{const t=yI(e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,s.subarray())}catch(e){this.log.error("Failed error correcting self",e)}continue}let t=!1;const a=new DI(TI.PUT_VALUE,e,0);a.record=$s.deserialize(s);for await(const e of this.network.sendRequest(o,a,n))"PEER_RESPONSE"===e.name&&null!=e.record&&(0,Hn.f)(e.record.value,$s.deserialize(s).value)&&(t=!0),yield e;t||(yield xI({from:o,error:j(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(e,t,r={}){this.log("put key %b value %b",e,t);const n=await mI(e,t),s=yI(e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,n.subarray()),yield*(0,vi.zG)(this.peerRouting.getClosestPeers(e,{signal:r.signal}),(t=>(0,_i.Z)(t,(t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const s=[],i=new DI(TI.PUT_VALUE,e,0);i.record=$s.deserialize(n),this.log("send put to %p",t.peer.id);for await(const e of this.network.sendRequest(t.peer.id,i,r))s.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&(0,Hn.f)(e.record.value,$s.deserialize(n).value)||s.push(xI({from:t.peer.id,error:j(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})));return s}))),(e=>bi(e,{ordered:!1,concurrency:iI})),(async function*(e){for await(const t of e)yield*t}))}async*get(e,t={}){this.log("get %b",e);const r=[];for await(const n of this.getMany(e,t))"VALUE"===n.name&&r.push(n),yield n;if(0===r.length)return;const n=r.map((e=>e.value));let s=0;try{s=function(e,t,r){if(0===r.length)throw j(new Error("No records given"),"ERR_NO_RECORDS_RECEIVED");const n=(0,Qr.B)(t).split("/");if(n.length<3)throw j(new Error("Record key does not have a selector function"),"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY");const s=e[n[1].toString()];if(null==s){const e=`Unrecognized key prefix: ${n[1]}`;throw j(new Error(e),"ERR_UNRECOGNIZED_KEY_PREFIX")}return 1===r.length?0:s(t,r)}(this.selectors,e,n)}catch(e){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==e.code)throw e}const i=n[s];if(this.log("GetValue %b %b",e,i),null==i)throw j(new Error("best value was not found"),"ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,r,i,t),yield r[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const t=await this.getLocal(e);yield UI({value:t.value,from:this.components.peerId})}catch(t){this.log("error getting local value for %b",e,t)}const r=await fI(e),n=this.routingTable.closestPeers(r);this.log("found %d peers in routing table",n.length);const s=this;yield*this.queryManager.run(e,n,(async function*({peer:t,signal:r}){for await(const n of s.peerRouting.getValueOrPeers(t,e,{signal:r}))yield n,"PEER_RESPONSE"===n.name&&null!=n.record&&(yield UI({from:t,value:n.record.value}))}),t)}}class GI{constructor(e,t){const{network:r,peerRouting:n,queryManager:s,routingTable:i,providers:o,lan:a}=t;this.components=e,this.log=(0,z.kg)(`libp2p:kad-dht:${a?"lan":"wan"}:content-routing`),this.network=r,this.peerRouting=n,this.queryManager=s,this.routingTable=i,this.providers=o}async*provide(e,t,r={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);const n=new DI(TI.ADD_PROVIDER,e.bytes,0);n.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let s=0;const i=t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const i=[];this.log("putProvider %s to %p",e,t.peer.id);try{this.log("sending provider record for %s to %p",e,t.peer.id);for await(const o of this.network.sendMessage(t.peer.id,n,r))"PEER_RESPONSE"===o.name&&(this.log("sent provider record for %s to %p",e,t.peer.id),s++),i.push(o)}catch(e){this.log.error("error sending provide record to peer %p",t.peer.id,e),i.push(xI({from:t.peer.id,error:e}))}return i};yield*(0,vi.zG)(this.peerRouting.getClosestPeers(e.multihash.bytes,r),(e=>(0,_i.Z)(e,(e=>i(e)))),(e=>bi(e,{ordered:!1,concurrency:iI})),(async function*(e){for await(const t of e)yield*t})),this.log("sent provider records to %d peers",s)}async*findProviders(e,t){const r=this.routingTable.kBucketSize,n=e.multihash.bytes,s=await fI(n),i=this;this.log("findProviders %c",e);const o=await this.providers.getProviders(e);if(o.length>0){const e=[];for(const t of o.slice(0,r))e.push({id:t,multiaddrs:(await this.components.peerStore.addressBook.get(t)??[]).map((e=>e.multiaddr)),protocols:[]});yield MI({from:this.components.peerId,messageType:TI.GET_PROVIDERS,providers:e}),yield BI({from:this.components.peerId,providers:e})}if(o.length>=r)return;const a=async function*({peer:e,signal:t}){const r=new DI(TI.GET_PROVIDERS,n,0);yield*i.network.sendRequest(e,r,{signal:t})},c=new Set(o.map((e=>e.toString())));for await(const i of this.queryManager.run(n,this.routingTable.closestPeers(s),a,t))if(yield i,"PEER_RESPONSE"===i.name){this.log("Found %d provider entries for %c and %d closer peers",i.providers.length,e,i.closer.length);const t=[];for(const e of i.providers)c.has(e.id.toString())||(c.add(e.id.toString()),t.push(e));if(t.length>0&&(yield BI({from:i.from,providers:t})),c.size===r)return}}}class qI{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map((e=>e.peerId))}async add(e){if(null!=this.peerDistances.find((t=>t.peerId.equals(e))))return;const t=await gI(e),r={peerId:e,distance:vI(this.originDhtKey,t)};this.peerDistances.push(r),this.peerDistances.sort(((e,t)=>Kp(e.distance,t.distance))),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(0===e.length)return!1;if(0===this.length)return!0;const t=await Promise.all(e.map(gI)),r=this.peerDistances[this.peerDistances.length-1].distance;for(const e of t)if(Kp(vI(this.originDhtKey,e),r)<0)return!0;return!1}}class KI{constructor(e,t){const{routingTable:r,network:n,validators:s,queryManager:i,lan:o}=t;this.components=e,this.routingTable=r,this.network=n,this.validators=s,this.queryManager=i,this.log=(0,z.kg)(`libp2p:kad-dht:${o?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t;const r=await this.routingTable.find(e);if(null!=r){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(r)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}if(null==t)try{t=await this.components.peerStore.get(e)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr)),protocols:[]}}async*_getValueSingle(e,t,r={}){const n=new DI(TI.GET_VALUE,t,0);yield*this.network.sendRequest(e,n,r)}async*getPublicKeyFromNode(e,t={}){const r=function(e){return(0,Qn.z)([dI,e.toBytes()])}(e);for await(const n of this._getValueSingle(e,r,t))if(yield n,"PEER_RESPONSE"===n.name&&null!=n.record){const t=await(0,Ln.y5)(bw.XP.marshalPublicKey({bytes:n.record.value}));if(!t.equals(e))throw j(new Error("public key does not match id"),"ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==t.publicKey)throw j(new Error("public key missing"),"ERR_PUBLIC_KEY_MISSING");yield UI({from:e,value:t.publicKey})}throw j(new Error(`Node not responding with its public key: ${e.toString()}`),"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);const r=await this.findPeerLocal(e);if(null!=r)return this.log("found local"),void(yield LI({from:this.components.peerId,peer:r}));const n=await gI(e),s=this.routingTable.closestPeers(n);if(null!=s.find((t=>t.equals(e))))try{const t=await this.components.peerStore.get(e);return this.log("found in peerStore"),void(yield LI({from:this.components.peerId,peer:{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr)),protocols:[]}}))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}const i=this,o=async function*({peer:t,signal:r}){const n=new DI(TI.FIND_NODE,e.toBytes(),0);for await(const s of i.network.sendRequest(t,n,{signal:r}))if(yield s,"PEER_RESPONSE"===s.name){const t=s.closer.find((t=>t.id.equals(e)));null!=t&&(yield LI({from:s.from,peer:t}))}};let a=!1;for await(const r of this.queryManager.run(e.toBytes(),s,o,t))"FINAL_PEER"===r.name&&(a=!0),yield r;a||(yield xI({from:this.components.peerId,error:j(new Error("Not found"),"ERR_NOT_FOUND")}))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await fI(e),n=this.routingTable.closestPeers(r),s=this,i=new qI(r,this.routingTable.kBucketSize);await Promise.all(n.map((async e=>await i.add(e))));const o=async function*({peer:t,signal:r}){s.log("closerPeersSingle %s from %p",(0,Qr.B)(e,"base32"),t);const n=new DI(TI.FIND_NODE,e,0);yield*s.network.sendRequest(t,n,{signal:r})};for await(const r of this.queryManager.run(e,n,o,t))yield r,"PEER_RESPONSE"===r.name&&await Promise.all(r.closer.map((async e=>await i.add(e.id))));this.log("found %d peers close to %b",i.length,e);for(const e of i.peers)yield LI({from:this.components.peerId,peer:{id:e,multiaddrs:(await this.components.peerStore.addressBook.get(e)??[]).map((e=>e.multiaddr)),protocols:[]}})}async*getValueOrPeers(e,t,r={}){for await(const n of this._getValueSingle(e,t,r)){if("PEER_RESPONSE"===n.name&&null!=n.record)try{await this._verifyRecordOnline(n.record)}catch(e){const t="invalid record received, discarded";this.log(t),yield xI({from:n.from,error:j(new Error(t),"ERR_INVALID_RECORD")});continue}yield n}}async _verifyRecordOnline(e){if(null==e.timeReceived)throw j(new Error("invalid record received"),"ERR_INVALID_RECORD");await FI(this.validators,new $s(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const r=await fI(e),n=this.routingTable.closestPeers(r),s=[];for(const e of n)if(!e.equals(t))try{const t=await this.components.peerStore.addressBook.get(e),r=await this.components.peerStore.protoBook.get(e);s.push({id:e,multiaddrs:t.map((e=>e.multiaddr)),protocols:r})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return s.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",s.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),s}}const WI=(0,z.kg)("libp2p:kad-dht:providers");class ZI{constructor(e,t={}){const{cacheSize:r,cleanupInterval:n,provideValidity:s}=t;this.components=e,this.cleanupInterval=n??36e5,this.provideValidity=s??864e5,this.cache=Pn(r??256),this.syncQueue=new Dn.Z({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval((()=>{this._cleanup().catch((e=>{WI.error(e)}))}),this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){return await this.syncQueue.add((async()=>{const e=Date.now();let t=0,r=0;const n=new Map,s=this.components.datastore.batch(),i=this.components.datastore.query({prefix:nI});for await(const e of i)try{const{cid:i,peerId:o}=JI(e.key),a=QI(e.value).getTime(),c=Date.now(),l=c-a,h=l>this.provideValidity;if(WI("comparing: %d - %d = %d > %d %s",c,a,l,this.provideValidity,h?"(expired)":""),h){r++,s.delete(e.key);const t=n.get(i)??new Set;t.add(o),n.set(i,t)}t++}catch(e){WI.error(e.message)}n.size>0?(WI("deleting %d / %d entries",r,t),await s.commit()):WI("nothing to delete");for(const[e,t]of n){const r=YI(e),n=this.cache.get(r);if(null!=n){for(const e of t)n.delete(e);0===n.size?this.cache.remove(r):this.cache.set(r,n)}}WI("Cleanup successful (%dms)",Date.now()-e)}))}async _getProvidersMap(e){const t=YI(e);let r=this.cache.get(t);return null==r&&(r=await async function(e,t){const r=new Map,n=e.query({prefix:YI(t)});for await(const e of n){const{peerId:t}=JI(e.key);r.set(t,QI(e.value))}return r}(this.components.datastore,e),this.cache.set(t,r)),r}async addProvider(e,t){return await this.syncQueue.add((async()=>{WI("%p provides %s",t,e);const r=await this._getProvidersMap(e);WI("loaded %s provs",r.size);const n=new Date;r.set(t.toString(),n);const s=YI(e);this.cache.set(s,r),await async function(e,t,r,n){const s=[YI(t),"/",r.toString()].join(""),i=new hn.s(s),o=Uint8Array.from(Xh.encode(n.getTime()));return await e.put(i,o)}(this.components.datastore,e,t,n)}))}async getProviders(e){return await this.syncQueue.add((async()=>(WI("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map((e=>(0,Ln.jE)(e))))))}}function YI(e){const t="string"==typeof e?e:(0,Qr.B)(e.multihash.bytes,"base32");return`${nI}/${t}`}function JI(e){const t=e.toString().split("/");if(5!==t.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:t[3],peerId:t[4]}}function QI(e){return new Date(Xh.decode(e))}const XI=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");const eT="running-queries";class tT{constructor(e,t){const{lan:r=!1,disjointPaths:n=sI,alpha:s=iI}=t;this.components=e,this.disjointPaths=n??sI,this.controllers=new Set,this.running=!1,this.alpha=s??iI,this.lan=r,this.queries=0}isStarted(){return this.running}async start(){this.running=!0}async stop(){this.running=!1;for(const e of this.controllers)e.abort();this.controllers.clear()}async*run(e,t,r,n={}){if(!this.running)throw new Error("QueryManager not started");let s;if(null==n.signal){s=new Gr.TimeoutController(hI),n.signal=s.signal;try{null!=Fk.setMaxListeners&&(0,Fk.setMaxListeners)(1/0,s.signal)}catch{}}const i=new AbortController;this.controllers.add(i);const o=[i.signal];null!=n.signal&&o.push(n.signal);const a=(0,dn.anySignal)(o);try{null!=Fk.setMaxListeners&&(0,Fk.setMaxListeners)(1/0,a)}catch{}const c=(0,z.kg)(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+(0,Qr.B)(e,"base58btc")),l=t.slice(0,Math.min(this.disjointPaths,t.length)),h=Date.now(),d=new ny.v;try{if(c("query:start"),this.queries++,this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:eT,value:this.queries}),0===t.length)return void c.error("Running query with no peers");const o=new eS.fd,u=l.map(((t,s)=>async function*(e){const{key:t,startingPeer:r,ourPeerId:n,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:h,log:d,peersSeen:u}=e,p=new Dn.Z({concurrency:o}),f=await fI(t);!function e(r,o){if(null==r)return;u.add(r);const l=BigInt("0x"+(0,Qr.B)(vI(o,f),"base16"));p.add((async()=>{let o;const g=[s];null!=h&&(o=new Gr.TimeoutController(h),g.push(o.signal));const y=(0,dn.anySignal)(g);try{for await(const s of i({key:t,peer:r,signal:y,pathIndex:a,numPaths:c})){if(y.aborted)return;if("PEER_RESPONSE"===s.name)for(const i of s.closer){if(u.has(i.id)){d("already seen %p in query",i.id);continue}if(n.equals(i.id)){d("not querying ourselves");continue}const s=await gI(i.id);BigInt("0x"+(0,Qr.B)(vI(s,f),"base16"))>l?d("skipping %p as they are not closer to %b than %p",i.id,t,r):(d("querying closer peer %p",i.id),e(i.id,s))}p.emit("completed",s)}o?.clear()}catch(e){s.aborted?p.emit("error",e):p.emit("completed",xI({from:r,error:e}))}finally{o?.clear()}}),{priority:XI-l}).catch((e=>{d.error(e)}))}(r,await gI(r)),yield*async function*(e,t,r,n){let s=(0,mi.Z)(),i=!0;const o=[],a=()=>{i&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,e.size,e.pending),i=!1,e.clear(),o.splice(0,o.length))};for(e.on("completed",(e=>{o.push(e),s.resolve()})),e.on("error",(e=>{n("queue error",e),a(),s.reject(e)})),e.on("idle",(()=>{n("queue idle"),i=!1,s.resolve()})),t.addEventListener("abort",(()=>{n("abort queue");const e=i;a(),e&&s.reject(j(new Error("Query aborted"),"ERR_QUERY_ABORTED"))})),r.addEventListener("cleanup",(()=>{a(),s.resolve()}));i;)for(await s.promise,s=(0,mi.Z)();o.length>0;){const e=o.shift();null!=e&&(yield e)}yield*o}(p,s,l,d)}({key:e,startingPeer:t,ourPeerId:this.components.peerId,signal:a,query:r,pathIndex:s,numPaths:l.length,alpha:this.alpha,cleanUp:d,queryFuncTimeout:n.queryFuncTimeout,log:c,peersSeen:o})));for await(const e of(0,Dg.Z)(...u))yield e,"QUERY_ERROR"===e.name&&c("error",e.error)}catch(e){if(this.running||"ERR_QUERY_ABORTED"!==e.code)throw e}finally{this.controllers.delete(i),null!=s&&s.clear(),this.queries--,this.components.metrics?.updateComponentMetric({system:"libp2p",component:"kad-dht-"+(this.lan?"lan":"wan"),metric:eT,value:this.queries}),d.dispatchEvent(new ny.A("cleanup")),c("query:done in %dms",Date.now()-h)}}}const rT=(0,z.kg)("libp2p:kad-dht:rpc:handlers:add-provider");class nT{constructor(e){const{providers:t}=e;this.providers=t}async handle(e,t){if(rT("start"),null==t.key||0===t.key.length)throw j(new Error("Missing key"),"ERR_MISSING_KEY");let r;try{r=te.k.decode(t.key)}catch(e){throw j(new Error("Invalid CID"),"ERR_INVALID_CID")}null!=t.providerPeers&&0!==t.providerPeers.length||rT.error("no providers found in message"),await Promise.all(t.providerPeers.map((async t=>{t.id.equals(e)?t.multiaddrs.length<1?rT("no valid addresses for provider %p. Ignore",e):(rT("received provider %p for %s (addrs %s)",e,r,t.multiaddrs.map((e=>e.toString()))),await this.providers.addProvider(r,t.id)):rT("invalid provider peer %p from %p",t.id,e)})))}}var sT=r(5629);const iT=(0,z.kg)("libp2p:kad-dht:rpc:handlers:find-node");class oT{constructor(e,t){const{peerRouting:r,lan:n}=t;this.components=e,this.peerRouting=r,this.lan=Boolean(n)}async handle(e,t){iT("incoming request from %p for peers closer to %b",e,t.key);let r=[];r=(0,sT.fS)(this.components.peerId.toBytes(),t.key)?[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,Zr.a_)("p2p").code))),protocols:[]}]:await this.peerRouting.getCloserPeersOffline(t.key,e),r=r.map(this.lan?pI:uI).filter((({multiaddrs:e})=>e.length));const n=new DI(t.type,new Uint8Array(0),t.clusterLevel);return r.length>0?n.closerPeers=r:iT("could not find any peers closer to %b than %p",t.key,e),n}}const aT=(0,z.kg)("libp2p:kad-dht:rpc:handlers:get-providers");class cT{constructor(e,t){const{peerRouting:r,providers:n,lan:s}=t;this.components=e,this.peerRouting=r,this.providers=n,this.lan=Boolean(s)}async handle(e,t){let r;try{r=te.k.decode(t.key)}catch(e){throw j(new Error("Invalid CID"),"ERR_INVALID_CID")}aT("%p asking for providers for %s",e,r);const[n,s]=await Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(t.key,e)]),i=await this._getPeers(n),o=await this._getPeers(s.map((({id:e})=>e))),a=new DI(t.type,t.key,t.clusterLevel);return i.length>0&&(a.providerPeers=i),o.length>0&&(a.closerPeers=o),aT("got %s providers %s closerPeers",i.length,o.length),a}async _getAddresses(e){return(await this.components.peerStore.addressBook.get(e)).map((e=>e.multiaddr))}async _getPeers(e){const t=[],r=this.lan?pI:uI;for(const n of e){const e=r({id:n,multiaddrs:await this._getAddresses(n),protocols:[]});e.multiaddrs.length>0&&t.push(e)}return t}}const lT=(0,z.kg)("libp2p:kad-dht:rpc:handlers:get-value");class hT{constructor(e,t){const{peerRouting:r}=t;this.components=e,this.peerRouting=r}async handle(e,t){const r=t.key;if(lT("%p asked for key %b",e,r),null==r||0===r.length)throw j(new Error("Invalid key"),"ERR_INVALID_KEY");const n=new DI(TI.GET_VALUE,r,t.clusterLevel);if(function(e){return"/pk/"===(0,Qr.B)(e.subarray(0,4))}(r)){lT("is public key");const e=function(e){return(0,Ln.cv)(e.subarray(4))}(r);let t;try{const r=await this.components.peerStore.keyBook.get(e);if(null==r)throw j(new Error("No public key found in key book"),"ERR_NOT_FOUND");t=r}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return lT("returning found public key"),n.record=new $s(r,t,new Date),n}const[s,i]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(t.key,e)]);return null!=s&&(lT("had record for %b in local datastore",r),n.record=s),i.length>0&&(lT("had %s closer peers in routing table",i.length),n.closerPeers=i),n}async _checkLocalDatastore(e){lT("checkLocalDatastore looking for %b",e);const t=yI(e);let r;try{r=await this.components.datastore.get(t)}catch(e){if("ERR_NOT_FOUND"===e.code)return;throw e}const n=$s.deserialize(r);if(null==n)throw j(new Error("Invalid record"),"ERR_INVALID_RECORD");if(!(null==n.timeReceived||Date.now()-n.timeReceived.getTime()>1296e5))return n;await this.components.datastore.delete(t)}}const dT=(0,z.kg)("libp2p:kad-dht:rpc:handlers:ping");class uT{async handle(e,t){return dT("ping from %p",e),t}}class pT{constructor(e,t){const{validators:r}=t;this.components=e,this.log=(0,z.kg)("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=r}async handle(e,t){const r=t.key;this.log("%p asked us to store value for key %b",e,r);const n=t.record;if(null==n){const t=`Empty record from: ${e.toString()}`;throw this.log.error(t),j(new Error(t),"ERR_EMPTY_RECORD")}try{await FI(this.validators,n),n.timeReceived=new Date;const e=yI(n.key);await this.components.datastore.put(e,n.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,e)}catch(e){this.log("did not put record for key %b into datastore %o",r,e)}return t}}class fT{constructor(e,t){const{providers:r,peerRouting:n,validators:s,lan:i}=t;this.log=(0,z.kg)("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[TI.GET_VALUE]:new hT(e,{peerRouting:n}),[TI.PUT_VALUE]:new pT(e,{validators:s}),[TI.FIND_NODE]:new oT(e,{peerRouting:n,lan:i}),[TI.ADD_PROVIDER]:new nT({providers:r}),[TI.GET_PROVIDERS]:new cT(e,{peerRouting:n,providers:r,lan:i}),[TI.PING]:new uT}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(e){this.log.error("Failed to update the kbucket store",e)}const r=this.handlers[t.type];if(null!=r)return await r.handle(e,t);this.log.error(`no handler found for message type: ${t.type}`)}onIncomingStream(e){Promise.resolve().then((async()=>{const{stream:t,connection:r}=e,n=r.remotePeer;try{await this.routingTable.add(n)}catch(e){this.log.error(e)}const s=this;await(0,vi.zG)(t,Yb.J(),(async function*(e){for await(const t of e){const e=DI.deserialize(t);s.log("incoming %s from %p",e.type,n);const r=await s.handleMessage(n,e);null!=r&&(yield r.serialize())}}),Yb.c(),t)})).catch((e=>{this.log.error(e)}))}}class gT extends ny.v{constructor(e,t){super();const{protocol:r,lan:n}=t;this.components=e,this.log=(0,z.kg)("libp2p:kad-dht:topology-listener:"+(n?"lan":"wan")),this.running=!1,this.protocol=r}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const e=ry({onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new ny.A("peer",{detail:e}))}});this.registrarId=await this.components.registrar.register(this.protocol,e)}stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class yT{constructor(e,t){const{peerRouting:r,lan:n,count:s,interval:i,queryTimeout:o}=t;this.components=e,this.log=(0,z.kg)(`libp2p:kad-dht:${n?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=r,this.count=s??sI,this.interval=i??oI,this.queryTimeout=o??aI}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}_querySelf(){Promise.resolve().then((async()=>{const e=new Gr.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const t=(0,dn.anySignal)([this.controller.signal,e.signal]);try{null!=Fk.setMaxListeners&&(0,Fk.setMaxListeners)(1/0,t)}catch{}const r=await(0,vi.zG)(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:t}),(e=>async function*(e,t){let r=0;if(!(t<1))for await(const n of e)if(yield n,r++,r===t)return}(e,this.count)),(async e=>await Dp(e)));this.log("query ran successfully - found %d peers",r)}catch(e){this.log("query error",e)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),e.clear()}})).catch((e=>{this.log("query error",e)}))}}class mT extends ny.v{constructor(e,t){super();const{kBucketSize:r,clientMode:n,validators:s,selectors:i,querySelfInterval:o,lan:a,protocolPrefix:c,pingTimeout:l,pingConcurrency:h,maxInboundStreams:d,maxOutboundStreams:u}=t;this.running=!1,this.components=e,this.lan=Boolean(a),this.log=(0,z.kg)("libp2p:kad-dht:"+(!0===a?"lan":"wan")),this.protocol=`${c??"/ipfs"}${!0===a?"/lan":""}/kad/1.0.0`,this.kBucketSize=r??20,this.clientMode=n??!0,this.maxInboundStreams=d??32,this.maxOutboundStreams=u??64,this.routingTable=new bI(e,{kBucketSize:r,lan:this.lan,pingTimeout:l,pingConcurrency:h,protocol:this.protocol}),this.providers=new ZI(e),this.validators={...VI,...s},this.selectors={...$I,...i},this.network=new jI(e,{protocol:this.protocol,lan:this.lan}),this.queryManager=new tT(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:a}),this.peerRouting=new KI(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new HI(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new GI(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new SI({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new fT(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new gT(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new yT(e,{peerRouting:this.peerRouting,interval:o,lan:this.lan}),this.network.addEventListener("peer",(e=>{const t=e.detail;this.onPeerConnect(t).catch((e=>{this.log.error("could not add %p to routing table",t.id,e)})),this.dispatchEvent(new ny.A("peer",{detail:t}))})),this.topologyListener.addEventListener("peer",(e=>{const t=e.detail;Promise.resolve().then((async()=>{const e=await this.components.peerStore.addressBook.get(t),r={id:t,multiaddrs:e.map((e=>e.multiaddr)),protocols:[]};await this.onPeerConnect(r)})).catch((e=>{this.log.error("could not add %p to routing table",t,e)}))}))}get[HR.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(e){if(this.log("peer %p connected with protocols %s",e.id,e.protocols),0!==(e=this.lan?pI(e):uI(e)).multiaddrs.length)try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}else this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map((e=>e.toString())))}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),"client"===e?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(e,t,r={}){yield*this.contentFetching.put(e,t,r)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){await this.routingTableRefresh.refreshTable(!0)}}const wT=(0,z.kg)("libp2p:kad-dht");class bT extends ny.v{constructor(e,t,r){super(),this.components=e,this.wan=t,this.lan=r,this.wan.addEventListener("peer",(e=>{this.dispatchEvent(new ny.A("peer",{detail:e.detail}))})),this.lan.addEventListener("peer",(e=>{this.dispatchEvent(new ny.A("peer",{detail:e.detail}))}))}get[HR.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,r={}){for await(const n of(0,Dg.Z)(this.lan.put(e,t,r),this.wan.put(e,t,r)))yield n}async*get(e,t={}){let r=!1,n=!1;for await(const s of(0,Dg.Z)(this.lan.get(e,t),this.wan.get(e,t)))yield s,"DIALING_PEER"===s.name&&(r=!0),"VALUE"===s.name&&(r=!0,null!=s.value&&(n=!0)),"SENDING_QUERY"===s.name&&(r=!0);if(!r)throw j(new Error("No peers found in routing table!"),"ERR_NO_PEERS_IN_ROUTING_TABLE");n||(yield xI({from:this.components.peerId,error:j(new Error("Not found"),"ERR_NOT_FOUND")}))}async*provide(e,t={}){let r=0,n=0;const s=[],i=[this.lan];"server"===await this.wan.getMode()&&i.push(this.wan);for await(const o of(0,Dg.Z)(...i.map((r=>r.provide(e,t)))))yield o,"SENDING_QUERY"===o.name&&r++,"QUERY_ERROR"===o.name&&s.push(o.error),"PEER_RESPONSE"===o.name&&"ADD_PROVIDER"===o.messageName&&(wT("sent provider record for %s to %p",e,o.from),n++);if(0===n){if(s.length>0)throw j(new Error(`Failed to provide to ${s.length} of ${r} peers`),"ERR_PROVIDES_FAILED",{errors:s});throw j(new Error("Failed to provide - no peers found"),"ERR_PROVIDES_FAILED")}}async*findProviders(e,t={}){yield*(0,Dg.Z)(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let r=!1;for await(const n of(0,Dg.Z)(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield n,"SENDING_QUERY"!==n.name&&"FINAL_PEER"!==n.name||(r=!0);if(!r)throw j(new Error("Peer lookup failed"),"ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*(0,Dg.Z)(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class _T extends bT{constructor(e,t){super(e,new mT(e,{protocolPrefix:"/ipfs",...t,lan:!1}),new mT(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}))}}var ET=r(49830),vT=r(66461),kT=r(39748),ST=r(77955);const RT=B.Z.bind({ignoreUndefined:!0,concatArrays:!0});function IT({options:e={},peerId:t,multiaddrs:r=[],repo:a,keychainConfig:c={},config:l={}}){const{datastore:h}=a,d=function({options:e,config:t,datastore:r,keychainConfig:a,peerId:c,multiaddrs:l}){const h={datastore:r,peerId:c},d={addresses:{listen:l.map((e=>e.toString())),announce:Ds(e,"addresses.announce",Ds(t,"Addresses.Announce",[])),noAnnounce:Ds(e,"addresses.noAnnounce",Ds(t,"Addresses.NoAnnounce",[]))},connectionManager:Ds(e,"connectionManager",{maxConnections:Ds(e,"config.Swarm.ConnMgr.HighWater",Ds(t,"Swarm.ConnMgr.HighWater")),minConnections:Ds(e,"config.Swarm.ConnMgr.LowWater",Ds(t,"Swarm.ConnMgr.LowWater"))}),keychain:a,identify:{host:{agentVersion:`js-ipfs/${zh}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[(0,kT.R)({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[(0,ST.t)()],relay:{enabled:Ds(e,"relay.enabled",Ds(t,"relay.enabled",!0)),hop:{enabled:Ds(e,"relay.hop.enabled",Ds(t,"relay.hop.enabled",!1)),active:Ds(e,"relay.hop.active",Ds(t,"relay.hop.active",!1))}},nat:{enabled:!Ds(t,"Swarm.DisableNatPortMap",!1)}};var u;Ds(e,"config.Pubsub.Enabled",Ds(t,"Pubsub.Enabled",!0))&&(d.pubsub=(()=>{const e=Ds(t,"Pubsub.Router")||"gossipsub",r={gossipsub:e=>{const t=new Xb({allowPublishToZeroPeers:!0,fallbackToFloodsub:!0,emitSelf:!0,maxInboundStreams:64,maxOutboundStreams:128});return t.init({getPeerId:()=>e.peerId,getPeerStore:()=>e.peerStore,getRegistrar:()=>e.registrar,getConnectionManager:()=>e.connectionManager}),t}};if(!r[e])throw j(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${e} router.`),"ERR_NOT_SUPPORTED");return r[e]})()),"none"!==Ds(t,"Routing.Type","dhtclient")&&(d.dht=(u={clientMode:"dhtserver"!==Ds(t,"Routing.Type","dht"),kBucketSize:Ds(e,"dht.kBucketSize",20),validators:{ipns:ws},selectors:{ipns:Os}},e=>new _T(e,u)));const p=Ds(e,"config.Bootstrap",Ds(t,"Bootstrap",[]));p.length>0&&d.peerDiscovery?.push((0,ET.U)({list:p}));let f=Ds(e,"libp2p",void 0);"function"==typeof f&&(f=void 0);const g=RT(h,function(){const e=(0,xk.n)();return{transports:[e.transport],peerDiscovery:[e.discovery],connectionManager:{maxParallelDials:150,maxDialsPerPeer:4,dialTimeout:1e4,autoDial:!0},nat:{enabled:!1},metrics:{enabled:!0}}}(),d,f),y=Ds(e,"config.Addresses.Delegates",Ds(t,"Addresses.Delegates",[]));if(y.length>0){const e=y[Math.floor(Math.random()*y.length)],t=(0,Zr.HM)(e).toOptions(),r=function(e={}){const t={name:Lr.identity.name,code:Lr.identity.code,encode:e=>e,decode:e=>e},r=Object.values(xr.gh);(e.ipld&&e.ipld.bases?e.ipld.bases:[]).forEach((e=>r.push(e)));const a=new h_({bases:r,loadBase:e.ipld&&e.ipld.loadBase}),c=Object.values(xr.QB);[n,s,i,o,t].concat(e.ipld&&e.ipld.codecs||[]).forEach((e=>c.push(e)));const l=new u_({codecs:c,loadCodec:e.ipld&&e.ipld.loadCodec}),h=Object.values(xr.kq);(e.ipld&&e.ipld.hashers?e.ipld.hashers:[]).forEach((e=>h.push(e)));const d=new f_({hashers:h,loadHasher:e.ipld&&e.ipld.loadHasher});return{add:mk(e),addAll:pk(e),bitswap:C_(e),block:H_(e),bootstrap:Y_(e),cat:wk(e),commands:bk(e),config:oE(e),dag:pE(l,e),dht:EE(e),diag:RE(e),dns:_k(e),files:jE(e),get:vk(e),getEndpointConfig:Ek(e),id:kk(e),isOnline:Sk(e),key:WE(e),log:QE(e),ls:Rk(e),mount:Tk(e),name:iv(e),object:mv(l,e),pin:Fv(e),ping:Ak(e),pubsub:Qv(e),refs:ek(e),repo:sk(e),resolve:Pk(e),start:Dk(e),stats:ok(e),stop:Ok(e),swarm:uk(e),version:Nk(e),bases:a,codecs:l,hashers:d}}({host:t.host,protocol:443===parseInt(t.port)?"https":"http",port:t.port});g.contentRouters?.push((m=r,()=>new c_(m))),g.peerRouters?.push(function(e){return()=>new n_(e)}(r))}var m;return Ds(e,"config.Discovery.MDNS.Enabled",Ds(t,"Discovery.MDNS.Enabled",!0))||(g.peerDiscovery=g.peerDiscovery?.filter((e=>{try{if("function"==typeof e)return"@libp2p/mdns"!==e({})[Symbol.toStringTag]}catch{}return!0}))),null==g.transports&&(g.transports=[]),null==g.transports.find((e=>{try{if("function"==typeof e)return"@libp2p/websockets"===e({})[Symbol.toStringTag]}catch{}return!1}))&&g.transports.push((0,vT.E)()),g}({options:e,config:l,datastore:h,keychainConfig:c,peerId:t,multiaddrs:r});return"function"==typeof e.libp2p?e.libp2p({libp2pOptions:d,options:e,config:l,datastore:h,peerId:t}):async function(e){return await async function(e){return null==e.peerId&&(e.peerId=await(0,$R.n9)()),new tI(function(e){const t=(0,B.Z)(VR,e);if(null==t.transports||t.transports.length<1)throw j(new Error(Ck.ERR_TRANSPORTS_REQUIRED),Mk.ERR_TRANSPORTS_REQUIRED);if(null==t.connectionEncryption||0===t.connectionEncryption.length)throw j(new Error(Ck.CONN_ENCRYPTION_REQUIRED),Mk.CONN_ENCRYPTION_REQUIRED);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw j(new Error(Ck.ERR_PROTECTOR_REQUIRED),Mk.ERR_PROTECTOR_REQUIRED);return t.identify.host.agentVersion===_R&&(DR.UG||DR.$l?t.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(DR.jU||DR.n2||DR.iP||DR.b$)&&(t.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),t}(e))}(e)}(d)}const TT=B.Z.bind({ignoreUndefined:!0}),AT=(0,z.kg)("ipfs:components:peer:storage");class PT{constructor(e,t,r,n,s){this.print=n,this.peerId=e,this.keychain=t,this.repo=r,this.print=n,this.isNew=s}static async start(e,t,r){const{repoAutoMigrate:n,repo:s,onMigrationProgress:i}=r,o="string"==typeof s||null==s?Jg(e,t,{path:s,autoMigrate:n,onMigrationProgress:i}):s,{peerId:a,keychain:c,isNew:l}=await DT(e,o,r);return new PT(a,c,o,e,l)}}const DT=async(e,t,r)=>{if(!t.closed)return{...await LT(t,r),isNew:!1};try{return await t.open(),{...await LT(t,r),isNew:!1}}catch(n){if(n.code!==ig)throw n;if(r.init&&!1===r.init.allowNew)throw new $r("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await OT(e,t,r),isNew:!0}}},OT=async(e,t,r)=>{const n=r.init||{},s=await t.exists();if(AT("repo exists?",s),!0===s)throw new Error("repo already exists");const i=n.privateKey?await NT(n.privateKey):await CT(e,n),o=MT(i);AT("peer identity: %s",o.PeerID);const a={...TT(BT({Addresses:{Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},Discovery:{MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},Bootstrap:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],Pubsub:{Enabled:!0},Swarm:{ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},Routing:{Type:"dhtclient"}},n.profiles),r.config),Identity:o};await t.init(a),await t.open(),AT("repo opened");const c={pass:r.pass};try{c.dek=await t.config.get("Keychain.DEK")}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}const l=await IT({options:void 0,multiaddrs:void 0,peerId:i,repo:t,config:a,keychainConfig:c});return await t.datastore.has(new hn.s("/info/self"))||await l.keychain.importPeer("self",i),await t.config.set("Keychain",{DEK:l.keychain.init.dek}),{peerId:i,keychain:l.keychain}},NT=async e=>{if(AT("using user-supplied private-key"),(0,Vn.I)(e))return e;const t=(0,Hr.m)(e,"base64pad"),r=await(0,qn.unmarshalPrivateKey)(t);return await(0,Ln.y5)(r.public.bytes,r.bytes)},CT=(e,{algorithm:t="Ed25519",bits:r=2048})=>{if(e("generating %s keypair...",t),"Ed25519"===t)return(0,$R.n9)();if("RSA"===t)return(0,$R.W$)({bits:r});throw j(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},MT=e=>{if(null==e.privateKey)throw j(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:e.toString(),PrivKey:(0,Qr.B)(e.privateKey,"base64pad")}},LT=async(e,t)=>{const r=t.config,n=t.init&&t.init.profiles||[],s=t.pass,i=await e.config.getAll(),o=xT(BT(i,n),r);if(i!==o&&await e.config.replace(o),!o.Identity||!o.Identity.PrivKey)throw new Br("No private key was found in the config, please intialize the repo");const a=(0,Hr.m)(o.Identity.PrivKey,"base64pad"),c=await(0,qn.unmarshalPrivateKey)(a),l=await(0,Ln.y5)(c.public.bytes,c.bytes);return{peerId:l,keychain:(await IT({options:void 0,multiaddrs:void 0,peerId:l,repo:e,config:o,keychainConfig:{pass:s,...o.Keychain}})).keychain}},xT=(e,t)=>t?TT(e,t):e,BT=(e,t)=>(t||[]).reduce(((e,t)=>{const r=$h[t];if(!r)throw new Error(`Could not find profile with name '${t}'`);return AT("applying profile %s",t),r.transform(e)}),e);var UT=r(56566);const zT=function(e){let t=new Uint8Array(e.reduce(((e,t)=>e+Xh.encodingLength(t)),0)),r=0;for(const n of e)t=Xh.encode(n,t,r),r+=Xh.encodingLength(n);return t};class jT{constructor(e,t,r){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=r}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(qr.base58btc)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}const FT=F.Reader,VT=F.Writer,$T=F.util,HT=F.roots["ipfs-bitswap"]||(F.roots["ipfs-bitswap"]={}),GT=HT.Message=(()=>{function e(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.wantlist=null,e.prototype.blocks=$T.emptyArray,e.prototype.payload=$T.emptyArray,e.prototype.blockPresences=$T.emptyArray,e.prototype.pendingBytes=0,e.encode=function(e,t){if(t||(t=VT.create()),null!=e.wantlist&&Object.hasOwnProperty.call(e,"wantlist")&&HT.Message.Wantlist.encode(e.wantlist,t.uint32(10).fork()).ldelim(),null!=e.blocks&&e.blocks.length)for(var r=0;r<e.blocks.length;++r)t.uint32(18).bytes(e.blocks[r]);if(null!=e.payload&&e.payload.length)for(r=0;r<e.payload.length;++r)HT.Message.Block.encode(e.payload[r],t.uint32(26).fork()).ldelim();if(null!=e.blockPresences&&e.blockPresences.length)for(r=0;r<e.blockPresences.length;++r)HT.Message.BlockPresence.encode(e.blockPresences[r],t.uint32(34).fork()).ldelim();return null!=e.pendingBytes&&Object.hasOwnProperty.call(e,"pendingBytes")&&t.uint32(40).int32(e.pendingBytes),t},e.decode=function(e,t){e instanceof FT||(e=FT.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new HT.Message;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.wantlist=HT.Message.Wantlist.decode(e,e.uint32());break;case 2:n.blocks&&n.blocks.length||(n.blocks=[]),n.blocks.push(e.bytes());break;case 3:n.payload&&n.payload.length||(n.payload=[]),n.payload.push(HT.Message.Block.decode(e,e.uint32()));break;case 4:n.blockPresences&&n.blockPresences.length||(n.blockPresences=[]),n.blockPresences.push(HT.Message.BlockPresence.decode(e,e.uint32()));break;case 5:n.pendingBytes=e.int32();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof HT.Message)return e;var t=new HT.Message;if(null!=e.wantlist){if("object"!=typeof e.wantlist)throw TypeError(".Message.wantlist: object expected");t.wantlist=HT.Message.Wantlist.fromObject(e.wantlist)}if(e.blocks){if(!Array.isArray(e.blocks))throw TypeError(".Message.blocks: array expected");t.blocks=[];for(var r=0;r<e.blocks.length;++r)"string"==typeof e.blocks[r]?$T.base64.decode(e.blocks[r],t.blocks[r]=$T.newBuffer($T.base64.length(e.blocks[r])),0):e.blocks[r].length>=0&&(t.blocks[r]=e.blocks[r])}if(e.payload){if(!Array.isArray(e.payload))throw TypeError(".Message.payload: array expected");for(t.payload=[],r=0;r<e.payload.length;++r){if("object"!=typeof e.payload[r])throw TypeError(".Message.payload: object expected");t.payload[r]=HT.Message.Block.fromObject(e.payload[r])}}if(e.blockPresences){if(!Array.isArray(e.blockPresences))throw TypeError(".Message.blockPresences: array expected");for(t.blockPresences=[],r=0;r<e.blockPresences.length;++r){if("object"!=typeof e.blockPresences[r])throw TypeError(".Message.blockPresences: object expected");t.blockPresences[r]=HT.Message.BlockPresence.fromObject(e.blockPresences[r])}}return null!=e.pendingBytes&&(t.pendingBytes=0|e.pendingBytes),t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.blocks=[],r.payload=[],r.blockPresences=[]),t.defaults&&(r.wantlist=null,r.pendingBytes=0),null!=e.wantlist&&e.hasOwnProperty("wantlist")&&(r.wantlist=HT.Message.Wantlist.toObject(e.wantlist,t)),e.blocks&&e.blocks.length){r.blocks=[];for(var n=0;n<e.blocks.length;++n)r.blocks[n]=t.bytes===String?$T.base64.encode(e.blocks[n],0,e.blocks[n].length):t.bytes===Array?Array.prototype.slice.call(e.blocks[n]):e.blocks[n]}if(e.payload&&e.payload.length)for(r.payload=[],n=0;n<e.payload.length;++n)r.payload[n]=HT.Message.Block.toObject(e.payload[n],t);if(e.blockPresences&&e.blockPresences.length)for(r.blockPresences=[],n=0;n<e.blockPresences.length;++n)r.blockPresences[n]=HT.Message.BlockPresence.toObject(e.blockPresences[n],t);return null!=e.pendingBytes&&e.hasOwnProperty("pendingBytes")&&(r.pendingBytes=e.pendingBytes),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message"},e.Wantlist=function(){function e(e){if(this.entries=[],e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.entries=$T.emptyArray,e.prototype.full=!1,e.encode=function(e,t){if(t||(t=VT.create()),null!=e.entries&&e.entries.length)for(var r=0;r<e.entries.length;++r)HT.Message.Wantlist.Entry.encode(e.entries[r],t.uint32(10).fork()).ldelim();return null!=e.full&&Object.hasOwnProperty.call(e,"full")&&t.uint32(16).bool(e.full),t},e.decode=function(e,t){e instanceof FT||(e=FT.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new HT.Message.Wantlist;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.entries&&n.entries.length||(n.entries=[]),n.entries.push(HT.Message.Wantlist.Entry.decode(e,e.uint32()));break;case 2:n.full=e.bool();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof HT.Message.Wantlist)return e;var t=new HT.Message.Wantlist;if(e.entries){if(!Array.isArray(e.entries))throw TypeError(".Message.Wantlist.entries: array expected");t.entries=[];for(var r=0;r<e.entries.length;++r){if("object"!=typeof e.entries[r])throw TypeError(".Message.Wantlist.entries: object expected");t.entries[r]=HT.Message.Wantlist.Entry.fromObject(e.entries[r])}}return null!=e.full&&(t.full=Boolean(e.full)),t},e.toObject=function(e,t){t||(t={});var r={};if((t.arrays||t.defaults)&&(r.entries=[]),t.defaults&&(r.full=!1),e.entries&&e.entries.length){r.entries=[];for(var n=0;n<e.entries.length;++n)r.entries[n]=HT.Message.Wantlist.Entry.toObject(e.entries[n],t)}return null!=e.full&&e.hasOwnProperty("full")&&(r.full=e.full),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Wantlist"},e.WantType=function(){const e={},t=Object.create(e);return t[e[0]="Block"]=0,t[e[1]="Have"]=1,t}(),e.Entry=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.block=$T.newBuffer([]),e.prototype.priority=0,e.prototype.cancel=!1,e.prototype.wantType=0,e.prototype.sendDontHave=!1,e.encode=function(e,t){return t||(t=VT.create()),null!=e.block&&Object.hasOwnProperty.call(e,"block")&&t.uint32(10).bytes(e.block),null!=e.priority&&Object.hasOwnProperty.call(e,"priority")&&t.uint32(16).int32(e.priority),null!=e.cancel&&Object.hasOwnProperty.call(e,"cancel")&&t.uint32(24).bool(e.cancel),null!=e.wantType&&Object.hasOwnProperty.call(e,"wantType")&&t.uint32(32).int32(e.wantType),null!=e.sendDontHave&&Object.hasOwnProperty.call(e,"sendDontHave")&&t.uint32(40).bool(e.sendDontHave),t},e.decode=function(e,t){e instanceof FT||(e=FT.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new HT.Message.Wantlist.Entry;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.block=e.bytes();break;case 2:n.priority=e.int32();break;case 3:n.cancel=e.bool();break;case 4:n.wantType=e.int32();break;case 5:n.sendDontHave=e.bool();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof HT.Message.Wantlist.Entry)return e;var t=new HT.Message.Wantlist.Entry;switch(null!=e.block&&("string"==typeof e.block?$T.base64.decode(e.block,t.block=$T.newBuffer($T.base64.length(e.block)),0):e.block.length>=0&&(t.block=e.block)),null!=e.priority&&(t.priority=0|e.priority),null!=e.cancel&&(t.cancel=Boolean(e.cancel)),e.wantType){case"Block":case 0:t.wantType=0;break;case"Have":case 1:t.wantType=1}return null!=e.sendDontHave&&(t.sendDontHave=Boolean(e.sendDontHave)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.block="":(r.block=[],t.bytes!==Array&&(r.block=$T.newBuffer(r.block))),r.priority=0,r.cancel=!1,r.wantType=t.enums===String?"Block":0,r.sendDontHave=!1),null!=e.block&&e.hasOwnProperty("block")&&(r.block=t.bytes===String?$T.base64.encode(e.block,0,e.block.length):t.bytes===Array?Array.prototype.slice.call(e.block):e.block),null!=e.priority&&e.hasOwnProperty("priority")&&(r.priority=e.priority),null!=e.cancel&&e.hasOwnProperty("cancel")&&(r.cancel=e.cancel),null!=e.wantType&&e.hasOwnProperty("wantType")&&(r.wantType=t.enums===String?HT.Message.Wantlist.WantType[e.wantType]:e.wantType),null!=e.sendDontHave&&e.hasOwnProperty("sendDontHave")&&(r.sendDontHave=e.sendDontHave),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Wantlist.Entry"},e}(),e}(),e.Block=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.prefix=$T.newBuffer([]),e.prototype.data=$T.newBuffer([]),e.encode=function(e,t){return t||(t=VT.create()),null!=e.prefix&&Object.hasOwnProperty.call(e,"prefix")&&t.uint32(10).bytes(e.prefix),null!=e.data&&Object.hasOwnProperty.call(e,"data")&&t.uint32(18).bytes(e.data),t},e.decode=function(e,t){e instanceof FT||(e=FT.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new HT.Message.Block;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.prefix=e.bytes();break;case 2:n.data=e.bytes();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof HT.Message.Block)return e;var t=new HT.Message.Block;return null!=e.prefix&&("string"==typeof e.prefix?$T.base64.decode(e.prefix,t.prefix=$T.newBuffer($T.base64.length(e.prefix)),0):e.prefix.length>=0&&(t.prefix=e.prefix)),null!=e.data&&("string"==typeof e.data?$T.base64.decode(e.data,t.data=$T.newBuffer($T.base64.length(e.data)),0):e.data.length>=0&&(t.data=e.data)),t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.prefix="":(r.prefix=[],t.bytes!==Array&&(r.prefix=$T.newBuffer(r.prefix))),t.bytes===String?r.data="":(r.data=[],t.bytes!==Array&&(r.data=$T.newBuffer(r.data)))),null!=e.prefix&&e.hasOwnProperty("prefix")&&(r.prefix=t.bytes===String?$T.base64.encode(e.prefix,0,e.prefix.length):t.bytes===Array?Array.prototype.slice.call(e.prefix):e.prefix),null!=e.data&&e.hasOwnProperty("data")&&(r.data=t.bytes===String?$T.base64.encode(e.data,0,e.data.length):t.bytes===Array?Array.prototype.slice.call(e.data):e.data),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Block"},e}(),e.BlockPresenceType=function(){const e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),e.BlockPresence=function(){function e(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)null!=e[t[r]]&&(this[t[r]]=e[t[r]])}return e.prototype.cid=$T.newBuffer([]),e.prototype.type=0,e.encode=function(e,t){return t||(t=VT.create()),null!=e.cid&&Object.hasOwnProperty.call(e,"cid")&&t.uint32(10).bytes(e.cid),null!=e.type&&Object.hasOwnProperty.call(e,"type")&&t.uint32(16).int32(e.type),t},e.decode=function(e,t){e instanceof FT||(e=FT.create(e));for(var r=void 0===t?e.len:e.pos+t,n=new HT.Message.BlockPresence;e.pos<r;){var s=e.uint32();switch(s>>>3){case 1:n.cid=e.bytes();break;case 2:n.type=e.int32();break;default:e.skipType(7&s)}}return n},e.fromObject=function(e){if(e instanceof HT.Message.BlockPresence)return e;var t=new HT.Message.BlockPresence;switch(null!=e.cid&&("string"==typeof e.cid?$T.base64.decode(e.cid,t.cid=$T.newBuffer($T.base64.length(e.cid)),0):e.cid.length>=0&&(t.cid=e.cid)),e.type){case"Have":case 0:t.type=0;break;case"DontHave":case 1:t.type=1}return t},e.toObject=function(e,t){t||(t={});var r={};return t.defaults&&(t.bytes===String?r.cid="":(r.cid=[],t.bytes!==Array&&(r.cid=$T.newBuffer(r.cid))),r.type=t.enums===String?"Have":0),null!=e.cid&&e.hasOwnProperty("cid")&&(r.cid=t.bytes===String?$T.base64.encode(e.cid,0,e.cid.length):t.bytes===Array?Array.prototype.slice.call(e.cid):e.cid),null!=e.type&&e.hasOwnProperty("type")&&(r.type=t.enums===String?HT.Message.BlockPresenceType[e.type]:e.type),r},e.prototype.toJSON=function(){return this.constructor.toObject(this,F.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.BlockPresence"},e}(),e})(),qT=GT.Wantlist.WantType.Block,KT=GT.Wantlist.WantType.Have;class WT{constructor(e,t){this.set=t?sR({system:"ipfs",component:"bitswap",metric:"wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,r){const n=e.toString(qr.base58btc),s=this.set.get(n);s?(s.inc(),s.priority=t,s.wantType===KT&&r===qT&&(s.wantType=r)):(this.set.set(n,new jT(e,t,r)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){const t=e.toString(qr.base58btc),r=this.set.get(t);r&&(r.dec(),r.hasRefs()||(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map((e=e=>e[1].key,t=Array.from(this.set.entries()),Array.prototype.slice.call(t,0).sort(((t,r)=>{const n=e(t),s=e(r);return n<s?-1:n>s?1:0}))));var e,t}contains(e){const t=e.toString(qr.base58btc);return this.set.has(t)}get(e){const t=e.toString(qr.base58btc);return this.set.get(t)}}WT.Entry=jT;const ZT=WT.Entry;class YT{constructor(e,t,r,n,s){this.entry=new ZT(e,t,r),this.cancel=Boolean(n),this.sendDontHave=Boolean(s)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(qr.base58btc)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const JT=(e,t)=>{const r=["bitswap"];return t&&r.push(t),e&&r.push(`${e.toString().slice(0,8)}`),Object.assign(Pp(r.join(":")),{error:Pp(r.concat(["error"]).join(":"))})},QT=(e,t)=>{if(e.size!==t.size)return!1;for(const[r,n]of e){const e=t.get(r);if(void 0===e)return!1;if(n instanceof Uint8Array&&e instanceof Uint8Array&&!(0,Hn.f)(n,e))return!1;if(n instanceof YT&&e instanceof YT&&!n.equals(e))return!1}return!0};class XT{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return 0===this.blocks.size&&0===this.wantlist.size&&0===this.blockPresences.size}addEntry(e,t,r,n,s){null==r&&(r=XT.WantType.Block);const i=e.toString(qr.base58btc),o=this.wantlist.get(i);o?(o.wantType===r&&(o.priority=t),n&&(o.cancel=Boolean(n)),s&&(o.sendDontHave=Boolean(s)),r===XT.WantType.Block&&o.wantType===XT.WantType.Have&&(o.wantType=r)):this.wantlist.set(i,new YT(e,t,r,n,s))}addBlock(e,t){const r=e.toString(qr.base58btc);this.blocks.set(r,t)}addHave(e){const t=e.toString(qr.base58btc);this.blockPresences.has(t)||this.blockPresences.set(t,XT.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(qr.base58btc);this.blockPresences.has(t)||this.blockPresences.set(t,XT.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(qr.base58btc);this.wantlist.delete(t),this.addEntry(e,0,XT.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:Boolean(e.cancel)}))),full:!!this.full||void 0},blocks:Array.from(this.blocks.values())};return GT.encode(e).finish()}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),wantType:e.wantType,cancel:Boolean(e.cancel),sendDontHave:Boolean(e.sendDontHave)}))),full:!!this.full||void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[t,r]of this.blocks.entries()){const n=te.k.parse(t),s=n.version,i=n.code,o=n.multihash.code,a=n.multihash.digest.length,c=zT([s,i,o,a]);e.payload.push(new GT.Block({prefix:c,data:r}))}for(const[t,r]of this.blockPresences)e.blockPresences.push(new GT.BlockPresence({cid:te.k.parse(t).bytes,type:r}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),GT.encode(e).finish()}equals(e){return!!(this.full===e.full&&this.pendingBytes===e.pendingBytes&&QT(this.wantlist,e.wantlist)&&QT(this.blocks,e.blocks)&&QT(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}XT.deserialize=async(e,t)=>{const r=GT.decode(e),n=r.wantlist&&r.wantlist.full||!1,s=new XT(n);return r.wantlist&&r.wantlist.entries&&r.wantlist.entries.forEach((e=>{if(!e.block)return;const t=te.k.decode(e.block);s.addEntry(t,e.priority||0,e.wantType,Boolean(e.cancel),Boolean(e.sendDontHave))})),r.blockPresences&&r.blockPresences.forEach((e=>{if(!e.cid)return;const t=te.k.decode(e.cid);e.type===XT.BlockPresenceType.Have?s.addHave(t):s.addDontHave(t)})),r.blocks.length>0?(await Promise.all(r.blocks.map((async e=>{const t=await zi.sha256.digest(e),r=te.k.createV0(t);s.addBlock(r,e)}))),s):r.payload.length>0?(await Promise.all(r.payload.map((async e=>{if(!e.prefix||!e.data)return;const r=UT(e.prefix),n=r[0],i=r[1],o=r[2],a=o===zi.sha256.code?zi.sha256:t&&await t.getHasher(o);if(!a)throw j(new Error("Unknown hash algorithm"),"ERR_UNKNOWN_HASH_ALG");const c=await a.digest(e.data),l=te.k.create(n,i,c);s.addBlock(l,e.data)}))),s.setPendingBytes(r.pendingBytes),s):s},XT.blockPresenceSize=e=>e.bytes.length+1,XT.Entry=YT,XT.WantType={Block:GT.Wantlist.WantType.Block,Have:GT.Wantlist.WantType.Have},XT.BlockPresenceType={Have:GT.BlockPresenceType.Have,DontHave:GT.BlockPresenceType.DontHave};const eA=Math.pow(2,31)-1;class tA{constructor(e,t,r){var n,s,i,o,a,c,l;this.peerId=t,this.network=r,this.refcnt=1,this._entries=[],this._log=JT(e,"msgqueue"),this.sendEntries=(n=this._sendEntries.bind(this),s=1,o=null,a=null,c=function(){o&&(clearTimeout(o),a=null,o=null)},l=function(){if(!s)return n.apply(this,arguments);var e=this,t=arguments,r=i&&!o;return c(),a=function(){n.apply(e,t)},o=setTimeout((function(){if(o=null,!r){var e=a;return a=null,e()}}),s),r?a():void 0},l.cancel=c,l.flush=function(){var e=a;c(),e&&e()},l)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const e=new XT(!1);this._entries.forEach((t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)})),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(e){return void this._log.error("cant connect to peer %s: %s",this.peerId.toString(),e.message)}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch((e=>{this._log.error("send error: %s",e.message)}))}}class rA{constructor(e,t,r,n){this.peers=sR({system:"ipfs",component:"bitswap",metric:"want-manager-peers",metrics:n.metrics}),this.wantlist=new WT(r,n),this.network=t,this._stats=r,this._peerId=e,this._log=JT(e,"want")}_addEntries(e,t,r){const n=e.map(((e,r)=>new XT.Entry(e,eA-r,XT.WantType.Block,t)));n.forEach((e=>{e.cancel?r?this.wantlist.removeForce(e.cid.toString(qr.base58btc)):this.wantlist.remove(e.cid):(this._log("adding to wl"),this.wantlist.add(e.cid,e.priority))}));for(const e of this.peers.values())e.addEntries(n)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t)return void t.refcnt++;t=new tA(this._peerId,e,this.network);const r=new XT(!0);for(const e of this.wantlist.entries())r.addEntry(e[1].cid,e[1].priority);return t.addMessage(r),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());t&&(t.refcnt--,t.refcnt>0||this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",(()=>{this.cancelWants(e)}))}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach((e=>this.disconnected(e.peerId)))}}const nA="/ipfs/bitswap/1.0.0",sA="/ipfs/bitswap/1.1.0",iA="/ipfs/bitswap/1.2.0";class oA{constructor(e,t,r,n={}){this._log=JT(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[nA],n.b100Only||(this._protocols.unshift(sA),this._protocols.unshift(iA)),this._stats=r,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=n.hashLoader,this._maxInboundStreams=n.maxInboundStreams??32,this._maxOutboundStreams=n.maxOutboundStreams??128,this._incomingStreamTimeout=n.incomingStreamTimeout??3e4}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e=ry({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.registrar.register(t,e));this._libp2p.getConnections().forEach((e=>{this._onPeerConnect(e.remotePeer)}))}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),null!=this._registrarIds){for(const e of this._registrarIds)this._libp2p.registrar.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;const r=new Gr.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then((async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await(0,vi.zG)((0,Zb.wJ)(e.source,r.signal),Yb.J(),(async e=>{for await(const n of e){try{const e=await XT.deserialize(n.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,e)}catch(e){this._bitswap._receiveError(e);break}r.reset()}}))})).catch((t=>{this._log(t),e.abort(t)})).finally((()=>{r.clear(),e.close()}))}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){const r=[];let n=0;for await(const s of this.findProviders(e,t))if(this._log(`connecting to provider ${s.id}`),r.push(this.connectTo(s.id,t).catch((e=>{this._log.error(e)}))),n++,3===n)break;await Promise.all(r)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");const r=e.toString();this._log("sendMessage to %s",r,t);const n=await this._libp2p.dial(e),s=await n.newStream([iA,sA,nA]);await async function(e,t,r){try{let r;switch(e.stat.protocol){case nA:r=t.serializeToBitswap100();break;case sA:case iA:r=t.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+e.stat.protocol)}await(0,vi.zG)([r],Yb.c(),e)}catch(e){r(e)}finally{e.close()}}(s,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){const r=e.toString();if(this._stats){for(const e of t.values())this._stats.push(r,"dataSent",e.length);this._stats.push(r,"blocksSent",t.size)}}}class aA{constructor(e){this.partner=e,this.wantlist=new WT,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesRecv+=e}wants(e,t,r){this.wantlist.add(e,t,r)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class cA extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(const[t,r]of e||[])this.set(t,r)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const r=this._find(t);this._keys.splice(r,0,t)}set(e,t){if(this.has(e)){const t=this.indexOf(e);this._keys.splice(t,1)}super.set(e,t);const r=this._find(e);return this._keys.splice(r,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let r=1;r<this._keys.length;r++){if(this._keys[t+r]===e)return t+r;if(this._keys[t-r]===e)return t-r}return-1}_find(e){let t=0,r=this._keys.length;for(;t<r;){const n=t+r>>>1,s=this._kCmp(this._keys[n],e);if(s<0)t=n+1;else{if(!(s>0))return n;r=n}}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(e)for(const r of this._keys)e.apply(t,[[r,this.get(r)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const lA={hasNewInfo:()=>!1,merge(){}};class hA{constructor(e=lA){this._taskMerger=e,this._byPeer=new cA([],dA.compare)}pushTasks(e,t){let r=this._byPeer.get(e.toString());r||(r=new dA(e,this._taskMerger)),r.pushTasks(t),this._byPeer.set(e.toString(),r)}popTasks(e){const t=this._head();if(void 0===t)return{tasks:[],pendingSize:0};const{tasks:r,pendingSize:n}=t.popTasks(e);if(0===r.length)return{tasks:r,pendingSize:n};const s=t.peerId;return t.isIdle()?this._byPeer.delete(s.toString()):this._byPeer.update(0),{peerId:s,tasks:r,pendingSize:n}}_head(){if(0!==this._byPeer.size)for(const[,e]of this._byPeer)return e}remove(e,t){const r=this._byPeer.get(t.toString());r&&r.remove(e)}tasksDone(e,t){const r=this._byPeer.get(e.toString());if(!r)return;const n=this._byPeer.indexOf(e.toString());for(const e of t)r.taskDone(e);this._byPeer.update(n)}}class dA{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new uA,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(t)return e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),void this._taskMerger.merge(e,t);this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const r of this._active)r.topic===e.topic&&t.push(r);return 0===t.length||this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const r=[],n=this._pending.tasks();for(let s=0;s<n.length&&t<e;s++){const e=n[s];r.push(e),t+=e.size,this._pending.delete(e.topic),this._activeTotalSize+=e.size,this._active.add(e)}return{tasks:r,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return 0===this._pending.length&&0===this._active.size}static compare(e,t){return 0===e[1]._pending.length?1:0===t[1]._pending.length?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class uA{constructor(){this._tasks=new cA([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce(((e,t)=>e+t.task.size),0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map((e=>e.task))}updatePriority(e,t){const r=this._tasks.get(e);if(!r)return;const n=this._tasks.indexOf(e);r.task.priority=t,this._tasks.update(n)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const pA={hasNewInfo(e,t){let r=!1,n=!1;for(const e of t)e.data.haveBlock&&(r=!0),e.data.isWantBlock&&(n=!0);return!(n||!e.data.isWantBlock)||!(r||!e.data.haveBlock)},merge(e,t){const r=e.data,n=t.data;!n.haveBlock&&r.haveBlock&&(n.haveBlock=r.haveBlock,n.blockSize=r.blockSize),!n.isWantBlock&&r.isWantBlock&&(n.isWantBlock=!0,n.haveBlock&&!r.haveBlock||(n.haveBlock=r.haveBlock,t.size=e.size)),n.isWantBlock&&n.haveBlock&&(t.size=n.blockSize)}},fA=XT.WantType;class gA{constructor(e,t,r,n,s,i={}){this._log=JT(e,"engine"),this.blockstore=t,this.network=r,this._stats=n,this._opts=this._processOpts(i),this.ledgerMap=sR({system:"ipfs",component:"bitswap",metric:"ledger-map",metrics:s.metrics}),this._running=!1,this._requestQueue=new hA(pA)}_processOpts(e){return{maxSizeReplaceHasWithBlock:1024,targetMessageSize:16384,...e}}_scheduleProcessTasks(){setTimeout((()=>{this._processTasks()}))}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:r}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(0===t.length)return;const n=new XT(!1);n.setPendingBytes(r);const s=[],i=new Map;for(const e of t){const t=te.k.parse(e.topic);e.data.haveBlock?e.data.isWantBlock?(s.push(t),i.set(e.topic,e.data)):n.addHave(t):n.addDontHave(t)}const o=await this._getBlocks(s);for(const[e,t]of i){const r=te.k.parse(e),s=o.get(e);s?n.addBlock(r,s):t.sendDontHave&&n.addDontHave(r)}if(n.empty)return e&&this._requestQueue.tasksDone(e,t),void this._scheduleProcessTasks();try{e&&await this.network.sendMessage(e,n);for(const[t,r]of o.entries())e&&this.messageSent(e,te.k.parse(t),r)}catch(e){this._log.error(e)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),r=this.ledgerMap.get(t);return r?r.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),r=this.ledgerMap.get(t);return r?{peer:r.partner,value:r.debtRatio(),sent:r.accounting.bytesSent,recv:r.accounting.bytesRecv,exchanged:r.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map((e=>e.partner))}receivedBlocks(e){if(e.length){for(const t of this.ledgerMap.values())for(const r of e){const e=t.wantlistContains(r.cid);if(!e)continue;const n=r.data.length,s=this._sendAsBlock(e.wantType,n);let i=n;s||(i=XT.blockPresenceSize(e.cid)),this._requestQueue.pushTasks(t.partner,[{topic:e.cid.toString(qr.base58btc),priority:e.priority,size:i,data:{blockSize:n,isWantBlock:s,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const r=this._findOrCreate(e);if(t.empty)return;if(t.full&&(r.wantlist=new WT),this._updateBlockAccounting(t.blocks,r),0===t.wantlist.size)return void this._scheduleProcessTasks();const n=[],s=[];t.wantlist.forEach((e=>{e.cancel?(r.cancelWant(e.cid),n.push(e.cid)):(r.wants(e.cid,e.priority,e.wantType),s.push(e))})),this._cancelWants(e,n),await this._addWants(e,s),this._scheduleProcessTasks()}_cancelWants(e,t){for(const r of t)this._requestQueue.remove(r.toString(qr.base58btc),e)}async _addWants(e,t){const r=await this._getBlockSizes(t.map((e=>e.cid))),n=[];for(const s of t){const t=s.cid.toString(qr.base58btc),i=r.get(t);if(null==i)s.sendDontHave&&n.push({topic:t,priority:s.priority,size:XT.blockPresenceSize(s.cid),data:{isWantBlock:s.wantType===fA.Block,blockSize:0,haveBlock:!1,sendDontHave:s.sendDontHave}});else{const e=this._sendAsBlock(s.wantType,i);let r=i;e||(r=XT.blockPresenceSize(s.cid)),n.push({topic:t,priority:s.priority,size:r,data:{isWantBlock:e,blockSize:i,haveBlock:!0,sendDontHave:s.sendDontHave}})}this._requestQueue.pushTasks(e,n)}}_sendAsBlock(e,t){return e===fA.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map((([e,t])=>[e,t.length])))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map((async e=>{try{const r=await this.blockstore.get(e);t.set(e.toString(qr.base58btc),r)}catch(t){"ERR_NOT_FOUND"!==t.code&&this._log.error("failed to query blockstore for %s: %s",e,t)}}))),t}_updateBlockAccounting(e,t){for(const r of e.values())this._log("got block (%s bytes)",r.length),t.receivedBytes(r.length)}messageSent(e,t,r){const n=this._findOrCreate(e);n.sentBytes(r.length),n.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),r=this.ledgerMap.get(t);if(r)return r;const n=new aA(e);return this.ledgerMap.set(t,n),this._stats&&this._stats.push(t,"peerCount",1),n}start(){this._running=!0}stop(){this._running=!1}}const yA=e=>`unwant:${(0,Qr.B)(e.multihash.bytes,"base64")}`,mA=e=>`block:${(0,Qr.B)(e.multihash.bytes,"base64")}`;class wA extends Fk.EventEmitter{constructor(e){super(),this.setMaxListeners(1e3),this._log=JT(e,"notif")}hasBlock(e,t){const r=mA(e);this._log(r),this.emit(r,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");const r=mA(e),n=yA(e);return this._log(`wantBlock:${e}`),new Promise(((s,i)=>{const o=()=>{this.removeListener(r,a),i(new Error(`Block for ${e} unwanted`))},a=e=>{this.removeListener(n,o),s(e)};this.once(n,o),this.once(r,a),t&&t.signal&&t.signal.addEventListener("abort",(()=>{this.removeListener(r,a),this.removeListener(n,o),i(new Error(`Want for ${e} aborted`))}))}))}unwantBlock(e){const t=yA(e);this._log(t),this.emit(t)}}var bA=r(3024);class _A extends Fk.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach((e=>{this._stats[e]=BigInt(0),this._movingAverages[e]={},this._options.movingAverageIntervals.forEach((t=>{(this._movingAverages[e][t]=bA(t)).push(this._frequencyLastTime,0)}))})),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){const t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach((r=>{this._updateFrequencyFor(r,t,e)})),this._frequencyLastTime=e}_updateFrequencyFor(e,t,r){const n=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;const s=n/t*1e3;let i=this._movingAverages[e];i||(i=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach((e=>{let t=i[e];t||(t=i[e]=bA(e)),t.push(r,s)}))}_applyOp(e){const t=e[0],r=e[1];if("number"!=typeof r)throw new Error(`invalid increment number: ${r}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(r),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=r}}const EA={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[6e4,3e5,9e5]};class vA extends Fk.EventEmitter{constructor(e,t=[],r=EA){super();const n=Object.assign({},EA,r);if("number"!=typeof n.computeThrottleTimeout)throw new Error("need computeThrottleTimeout");if("number"!=typeof n.computeThrottleMaxQueueSize)throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=n,this._enabled=this._options.enabled,this._global=new _A(t,n),this._global.on("update",(e=>this.emit("update",e))),this._peers=sR({system:"ipfs",component:"bitswap",metric:"stats-peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t="string"!=typeof e&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,r){if(this._enabled&&(this._global.push(t,r),e)){let n=this._peers.get(e);n||(n=new _A(this._initialCounters,this._options),this._peers.set(e,n)),n.push(t,r)}}disconnected(e){const t=e.toString(),r=this._peers.get(t);r&&(r.stop(),this._peers.delete(t))}}const kA={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},SA=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class RA extends qg{constructor(e,t,r={}){super(),this._libp2p=e,this._log=JT(this.peerId),this._options=Object.assign({},kA,r),this._stats=new vA(e,SA,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new oA(e,this,this._stats,{hashLoader:r.hashLoader,maxInboundStreams:r.maxInboundStreams,maxOutboundStreams:r.maxOutboundStreams,incomingStreamTimeout:r.incomingStreamTimeout}),this.blockstore=t,this.engine=new gA(this.peerId,t,this.network,this._stats,e),this.wm=new rA(this.peerId,this.network,this._stats,e),this.notifications=new wA(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch(e){this._log("failed to receive message",t)}if(0===t.blocks.size)return;const r=[];for(const[e,n]of t.blocks.entries()){const t=te.k.parse(e);r.push({wasWanted:this.wm.wantlist.contains(t),cid:t,data:n})}this.wm.cancelWants(r.filter((({wasWanted:e})=>e)).map((({cid:e})=>e))),await Promise.all(r.map((({cid:t,wasWanted:r,data:n})=>this._handleReceivedBlock(e,t,n,r))))}async _handleReceivedBlock(e,t,r,n){this._log("received block");const s=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,r,s),n&&await this.put(t,r)}_updateReceiveCounters(e,t,r,n){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",r.length),n&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",r.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){const r=(e,t)=>(this.wm.wantBlocks([e],t),this.notifications.wantBlock(e,t));let n=!1;const s=async(e,t)=>{try{return await this.blockstore.get(e,t)}catch(s){if("ERR_NOT_FOUND"!==s.code)throw s;return n||(n=!0,this.network.findAndConnect(e,t).catch((e=>this._log.error(e)))),r(e,t)}},i=new AbortController,o=t.signal?(0,dn.anySignal)([t.signal,i.signal]):i.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:o}),s(e,{signal:o})])}finally{i.abort()}}async*getMany(e,t={}){for await(const r of e)yield this.get(r,t)}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach((e=>this.notifications.unwantBlock(e)))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,r){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(const{key:r,value:n}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(r,n),yield{key:r,value:n}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch((e=>{this._log.error("Failed to provide: %s",e.message)}))}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}}function IA(e){return e=e||new Error("Not Found"),j(e,"ERR_NOT_FOUND")}function TA(e){return e=e||new Error("Aborted"),j(e,"ERR_ABORTED")}class AA extends qg{constructor(e,t){super(),this.child=e,this.bitswap=t}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(e,t,r={}){await this.has(e)||(this.bitswap.isStarted()?await this.bitswap.put(e,t,r):await this.child.put(e,t,r))}async*putMany(e,t={}){const r=(0,Ei.Z)(e,(async({key:e})=>!await this.has(e)));this.bitswap.isStarted()?yield*this.bitswap.putMany(r,t):yield*this.child.putMany(r,t)}async get(e,t={}){return!await this.has(e)&&this.bitswap.isStarted()?this.bitswap.get(e,t):this.child.get(e,t)}async*getMany(e,t={}){const r=(0,Is.d)({objectMode:!0}),n=(0,Is.d)({objectMode:!0});Promise.resolve().then((async()=>{for await(const t of e)!await this.has(t)&&this.bitswap.isStarted()?r.push(t):n.push(t);r.end(),n.end()})),yield*(0,Dg.Z)(this.bitswap.getMany(r,t),this.child.getMany(n,t))}async delete(e,t){await this.child.delete(e,t)}async*deleteMany(e,t){yield*this.child.deleteMany(e,t)}async has(e,t={}){return this.child.has(e,t)}async*query(e,t={}){yield*this.child.query(e,t)}async*queryKeys(e,t={}){yield*this.child.queryKeys(e,t)}}class PA{constructor(e,t,r,n,s){this.peerId=e,this.libp2p=t,this.bitswap=r,this.repo=n,this.blockstore=s}static async start({peerId:e,repo:t,print:r,hashers:n,options:s}){t.closed&&await t.open();const i=await t.config.getAll(),o=await IT({options:s,repo:t,peerId:e,multiaddrs:DA(e,i),config:i,keychainConfig:void 0});await o.start();for(const e of o.getMultiaddrs())r(`Swarm listening on ${e.toString()}`);const a=((e,t,r={})=>new RA(e,t,r))(o,t.blocks,{statsEnabled:!0,hashLoader:n,maxInboundStreams:1024,maxOutboundStreams:1024});await a.start();const c=new AA(t.blocks,a);return t.blocks=c,t.pins.blockstore=c,new PA(e,o,a,t,c)}static async stop(e){e.repo.blocks=e.blockstore.unwrap(),e.repo.pins.blockstore=e.blockstore.unwrap(),await e.bitswap.stop(),await e.libp2p.stop()}}const DA=(e,t)=>{const r=e.toString(),n=[],s=t.Addresses&&t.Addresses.Swarm||[];for(const e of s){let t=(0,Zr.HM)(e);if(t.protoCodes().includes(OA))throw j(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const s=t.getPeerId();s&&s!==r&&(t=t.encapsulate(`/p2p/${r}`)),n.push(t)}return n},OA=479;class NA{constructor({network:e}){this.addrs=function({network:e}){return mn((async function(t={}){const r=[],{libp2p:n}=await e.use(t);return await n.peerStore.forEach((e=>{r.push({id:e.id,addrs:e.addresses.map((e=>e.multiaddr))})})),r}))}({network:e}),this.connect=function({network:e}){return mn((async function(t,r={}){const{libp2p:n}=await e.use(r);await n.dial(t,r)}))}({network:e}),this.disconnect=function({network:e}){return mn((async function(t,r={}){const{libp2p:n}=await e.use(r);await n.hangUp(t)}))}({network:e}),this.localAddrs=function({network:e}){return mn((async function(t={}){const{libp2p:r}=await e.use(t);return r.getMultiaddrs()}))}({network:e}),this.peers=function({network:e}){return mn((async function(t={}){const{libp2p:r}=await e.use(t);if(t.verbose){const e=[];for(const n of r.getConnections()){const r={addr:n.remoteAddr,peer:n.remotePeer};(t.verbose||t.direction)&&(r.direction=n.stat.direction),t.verbose&&(r.muxer=n.stat.multiplexer,r.latency="n/a",r.streams=[]),e.push(r)}return e}const n=new Map;for(const e of r.getConnections()){const t={addr:e.remoteAddr,peer:e.remotePeer};n.set(e.remotePeer.toString(),t)}return Array.from(n.values())}))}({network:e})}}const CA={success:!0,time:0,text:""},MA="/ipns/";function LA(e){let t;if(e.startsWith(MA)&&(e=e.substring(MA.length)),"1"!==e[0]&&"Q"!==e[0]||(e=`z${e}`),"z"===e[0]&&(t=qr.base58btc.decode(e)),"k"===e[0]&&(t=Xs.base36.decode(e)),!t)throw new Error("Could not parse string");if(1!==t[0]&&114!==t[1]&&(t=(0,Qn.z)([[1,114],t])),40!==t.length)throw new Error("Incorrect length "+t.length);return(0,Qn.z)([(0,Hr.m)(MA),t.subarray(2)])}const xA=async(e,t,r)=>{const n=await e.use(r);if(null!=n.libp2p.dht)return n;{const e=async function*(){yield{from:t,name:"QUERY_ERROR",type:3,error:new $r("dht not enabled")}};return{libp2p:{dht:{get:e,put:e,findProviders:e,findPeer:e,provide:e,getClosestPeers:e}}}}},BA=async()=>{throw new $r("pubsub not enabled")};var UA=r(82784);const zA=B.Z.bind({ignoreUndefined:!0}),jA=(0,z.kg)("ipfs");class FA{constructor({print:e,storage:t,codecs:r,options:n}){const{peerId:s,repo:i,keychain:o}=t,a=An.create(PA),c=Md(n.preload),l=mn((async(e,t={recursive:!0})=>{if("string"!=typeof e)throw new Error("Invalid arguments, domain must be a string");return async function(e,t){return(async(e,t={})=>{const r=new URLSearchParams(t);r.set("arg",e);const n=r.toString();if(!t.nocache&&Nn.has(n)){const e=Nn.get(n);return Mn(e)}const s=await Cn.add((async()=>{const e=await On.get("https://ipfs.io/api/v0/dns",{searchParams:r}),t=new URL(e.url).search.slice(1),n=await e.json();return Nn.set(t,n,6e4),n}));return Mn(s)})(e,t)}(e=function(e){return e.endsWith(".eth")&&(e=e.replace(/.eth$/,".eth.link")),e}(e),t)})),h=function({network:e}){return()=>{const t=e.try();return null!=t&&Boolean(t.libp2p.isStarted())}}({network:a}),d=new Ys(n),u=Object.values(xr.kq);(n.ipld&&n.ipld.hashers?n.ipld.hashers:[]).forEach((e=>u.push(e))),this.hashers=new f_({hashers:u,loadHasher:n.ipld&&n.ipld.loadHasher});const p=Object.values(xr.gh);(n.ipld&&n.ipld.bases?n.ipld.bases:[]).forEach((e=>p.push(e))),this.bases=new h_({bases:p,loadBase:n.ipld&&n.ipld.loadBase});const f=new Fn({repo:i,codecs:r}),g=new Si({codecs:r,hashers:this.hashers,preload:c,repo:i}),y=new oi({dns:l,ipns:d,repo:i,codecs:r,peerId:s,isOnline:h,keychain:o,options:n}),m=function({repo:e,codecs:t,bases:r,name:n}){return mn((async function(s,i={}){if(!cn(s))throw new Error("invalid argument "+s);if(ln(s))for await(const e of n.resolve(s,i))s=e;const[,o,a,...c]=s.split("/"),l=i.cidBase?await r.getBase(i.cidBase):void 0,h=function(e){try{return(0,Ln.jE)(e).toBytes()}catch{return te.k.parse(e).bytes}}(a);if(0===c.length)return`/${o}/${l?l.encoder.encode(h):a}`;const d=te.k.decode(h);s=c.join("/");const u=Tn(d,s,t,e,i);let p=d,f=s;for await(const e of u)te.k.asCID(e.value)&&(p=e.value,f=e.remainderPath);return`/ipfs/${p.toString(l&&l.encoder)}${f?"/"+f:""}`}))}({repo:i,codecs:r,bases:this.bases,name:y}),w=new Ad({repo:i,codecs:r,hashers:this.hashers,preload:c}),b=Object.assign(function({repo:e,codecs:t,resolve:r,preload:n}){return async function*(s,i={}){if(0===i.maxDepth)return;if(i.edges&&i.format&&i.format!==ci)throw new Error("Cannot set edges to true and also specify format");if(i.format=i.edges?"<src> -> <dst>":i.format,"number"!=typeof i.maxDepth&&(i.maxDepth=i.recursive?1/0:1),i.timeout){const e=[new Gr.TimeoutController(i.timeout).signal];i.signal&&e.push(i.signal),i.signal=(0,dn.anySignal)(e)}const o=(Array.isArray(s)?s:[s]).map((e=>function(e,t,r){const{cid:n,path:s}=bn(t);return!1!==r.preload&&e(n),`/ipfs/${n}${s||""}`}(n,e,i)));for(const n of o)try{yield*li(r,e,t,n,i)}catch(e){yield{ref:"",err:e.message}}}}({repo:i,codecs:r,resolve:m,preload:c}),{local:ui({repo:t.repo})}),{add:_,addAll:E,cat:v,get:k,ls:S}=new Uh({preload:c,repo:i,options:n.EXPERIMENTAL,hashers:this.hashers}),R=function({repo:e,preload:t,hashers:r,options:n}){const s=function(e){const{repoOwner:t}=Object.assign({},fp||{},e),r=Ud(t),n={};return pp({options:e,mfs:n,operations:hp,lock:e=>r.readLock(e)}),pp({options:e,mfs:n,operations:dp,lock:e=>r.writeLock(e)}),Object.keys(up).forEach((t=>{n[t]=up[t](e)})),n}({repo:e,repoOwner:!1!==n.repoOwner,hashers:r}),i=e=>(...r)=>{const n=r.filter((e=>nn(e,Xr)||rn(e)));if(n.length){const e=r[r.length-1];e&&!1!==e.preload&&n.forEach((e=>t(e)))}return e(...r)};return{...s,chmod:s.chmod,cp:i(s.cp),mkdir:s.mkdir,stat:i(s.stat),rm:s.rm,read:i(s.read),touch:s.touch,write:s.write,mv:i(s.mv),flush:s.flush,ls:i((async function*(...e){for await(const t of s.ls(...e))yield{...t,size:t.size||0}}))}}({repo:i,preload:c,hashers:this.hashers,options:n}),I=function({preload:e,files:t,options:r={}}){if(r.interval=r.interval||3e4,!r.enabled){Ld("MFS preload disabled");const e=async()=>{};return{start:e,stop:e}}let n,s="";const i=async()=>{try{const o=await t.stat("/"),a=o.cid.toString();s!==a&&(Ld(`preloading updated MFS root ${s} -> ${o.cid}`),await e(o.cid),s=a)}catch(e){Ld.error("failed to preload MFS root",e)}finally{n=setTimeout(i,r.interval)}};return{async start(){const e=await t.stat("/");s=e.cid.toString(),Ld(`monitoring MFS root ${e.cid}`),n=setTimeout(i,r.interval)},stop(){clearTimeout(n)}}}({files:R,preload:c,options:n.preload});this.preload=c,this.name=y,this.ipns=d,this.pin=f,this.resolve=m,this.block=g,this.refs=b,this.start=function({network:e,preload:t,peerId:r,keychain:n,repo:s,ipns:i,mfsPreload:o,print:a,hashers:c,options:l}){return async()=>{const{libp2p:h}=await An.start(e,{peerId:r,repo:s,print:a,hashers:c,options:l});await Promise.all([i.startOnline({keychain:n,libp2p:h,peerId:r,repo:s}),t.start(),o.start()])}}({network:a,peerId:s,repo:i,preload:c,ipns:d,mfsPreload:I,print:e,keychain:o,hashers:this.hashers,options:n}),this.stop=function({network:e,preload:t,ipns:r,repo:n,mfsPreload:s}){return async()=>{await Promise.all([t.stop(),r.stop(),s.stop()]),await An.stop(e),await n.close()}}({network:a,preload:c,mfsPreload:I,ipns:d,repo:i}),this.dht=function({network:e,repo:t,peerId:r}){const{get:n,put:s,findProvs:i,findPeer:o,provide:a,query:c}={async*get(t,n={}){const{libp2p:s}=await xA(e,r,n),i=t instanceof Uint8Array?t:LA(t);if(null==s.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.get(i,n)},async*put(t,n,s){const{libp2p:i}=await xA(e,r,s),o=t instanceof Uint8Array?t:LA(t);if(null==i.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*i.dht.put(o,n,s)},async*findProvs(t,n={}){const{libp2p:s}=await xA(e,r,n);if(null==s.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.findProviders(t,{signal:n.signal})},async*findPeer(t,n={}){const{libp2p:s}=await xA(e,r,n);if(null==s.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.findPeer(t,{signal:n.signal})},async*provide(n,s={recursive:!1}){const{libp2p:i}=await xA(e,r,s);if(!await t.blocks.has(n))throw j(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(s.recursive)throw j(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(null==i.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*i.dht.provide(n)},async*query(t,n={}){const{libp2p:s}=await xA(e,r,n);let i;const o=te.k.asCID(t);if(i=null!=o?o.multihash.bytes:(0,Ln.jE)(t.toString()).toBytes(),null==s.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.getClosestPeers(i,n)}};return{get:mn(n),put:mn(s),findProvs:mn(i),findPeer:mn(o),provide:mn(a),query:mn(c)}}({network:a,repo:i,peerId:s}),this.pubsub=function({network:e,config:t}){const r=Ds(t||{},"Pubsub.Enabled",!0),n={};let s;return{subscribe:r?mn((async function(t,r,i={}){const{libp2p:o}=await e.use(i);o.pubsub.subscribe(t),null==s&&(s=e=>{const t=e.detail;n[t.topic]&&n[t.topic].forEach((e=>{"function"!=typeof e?null!=e&&null!=e.handleEvent&&e.handleEvent(t):e(t)}))},o.pubsub.addEventListener("message",s)),null!=r&&(null==n[t]&&(n[t]=[]),n[t].push(r))})):BA,unsubscribe:r?mn((async function(t,r,i={}){const{libp2p:o}=await e.use(i);null!=r&&null!=n[t]&&(n[t]=n[t].filter((e=>e!==r)),0===n[t].length&&delete n[t]),"function"!=typeof r&&delete n[t],null==n[t]&&o.pubsub.unsubscribe(t),0===Object.keys(n).length&&(o.pubsub.removeEventListener("message",s),s=void 0)})):BA,publish:r?mn((async function(t,r,n={}){const{libp2p:s}=await e.use(n);if(!r)throw j(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await s.pubsub.publish(t,r)})):BA,ls:r?mn((async function(t={}){const{libp2p:r}=await e.use(t);return r.pubsub.getTopics()})):BA,peers:r?mn((async function(t,r={}){const{libp2p:n}=await e.use(r);return n.pubsub.getSubscribers(t)})):BA}}({network:a,config:n.config}),this.dns=l,this.isOnline=h,this.id=function({peerId:e,network:t}){return mn((async function(r={}){const n=t.try();if(!n){if(r.peerId)throw new jr;if(null==e.publicKey)throw j(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:e,publicKey:(0,Qr.B)(e.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${zh}`,protocolVersion:"9000",protocols:[]}}const{libp2p:s}=n,i=r.peerId?r.peerId:e,o=await async function(e,t,r){let n=await t.peerStore.get(e);n||(n=await async function(e,t,r){if(null==t.dht)throw j(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const n of t.dht.findPeer(e,r))if("FINAL_PEER"===n.name)break;const n=await t.peerStore.get(e);if(!n)throw j(new Error("Could not find peer"),"ERR_NOT_FOUND");return n}(e,t,r));let s=e.publicKey?e.publicKey:await t.peerStore.keyBook.get(e);if(null==s)try{s=await t.getPublicKey(e,r)}catch(t){jh.error("Could not load public key for",e.toString(),t)}return{...n,publicKey:s,metadata:n.metadata||new Map,addresses:n.addresses.map((e=>e.multiaddr))}}(i,s,r),a=(0,Qr.B)(o.metadata.get("AgentVersion")||new Uint8Array),c=(0,Qr.B)(o.metadata.get("ProtocolVersion")||new Uint8Array),l=o.id.toString();return{id:i,publicKey:o.publicKey?(0,Qr.B)(o.publicKey,"base64pad"):"",addresses:(o.addresses||[]).map((e=>{const t=e.toString();return t.endsWith(`/p2p/${l}`)?t:`${t}/p2p/${l}`})).sort().map((e=>(0,Zr.HM)(e))),agentVersion:a,protocolVersion:c,protocols:(o.protocols||[]).sort()}}))}({network:a,peerId:s}),this.version=function({repo:e}){return mn((async function(t={}){const r=await e.version.get();return{version:zh,commit:"e8b7b66bfa98c2a1c0d0bfc19f698d7d00b6c888",repo:`${r}`,"ipfs-core":zh,"interface-ipfs-core":"^0.157.0"}}))}({repo:i}),this.bitswap=new fi({network:a}),this.bootstrap=new yi({repo:i}),this.config=function({repo:e}){return{getAll:mn((async function(t={}){return e.config.getAll(t)})),get:mn((async function(t,r){return t?e.config.get(t,r):Promise.reject(new Error("key argument is required"))})),set:mn((async function(t,r,n){return e.config.set(t,r,n)})),replace:mn((async function(t,r){return e.config.replace(t,r)})),profiles:{apply:mn((async function(t,r={dryRun:!1}){const{dryRun:n}=r,s=$h[t];if(!s)throw new Error(`No profile with name '${t}' exists`);try{const t=await e.config.getAll(r);let i=JSON.parse(JSON.stringify(t));return i=s.transform(i),n||await e.config.replace(i,r),delete t.Identity.PrivKey,delete i.Identity.PrivKey,{original:t,updated:i}}catch(e){throw Hh(e),new Error(`Could not apply profile '${t}' to config: ${e.message}`)}})),list:mn(Gh)}}}({repo:i}),this.ping=function({network:e}){return mn((async function*(t,r={}){const{libp2p:n}=await e.use();r.count=r.count||10;const s=await n.peerStore.get(t);let i=s&&s.id;if(!i){yield{...CA,text:`Looking up peer ${t}`};const e=await n.peerRouting.findPeer(t);i=e&&e.id}if(!i)throw new Error("Peer was not found");yield{...CA,text:`PING ${i.toString()}`};let o=0,a=0;for(let e=0;e<r.count;e++)try{const e=await n.ping(i);a+=e,o++,yield{...CA,time:e}}catch(e){yield{...CA,success:!1,text:e.toString()}}if(o){const e=a/o;yield{...CA,text:`Average latency: ${e}ms`}}}))}({network:a}),this.add=_,this.addAll=E,this.cat=v,this.get=k,this.ls=S,this.dag=w,this.files=R,this.key=new yp({keychain:o}),this.object=new vp({preload:c,codecs:r,repo:i}),this.repo=new Rp({repo:i,hashers:this.hashers}),this.stats=new Tp({repo:i,network:a}),this.swarm=new NA({network:a}),Object.defineProperty(this,"libp2p",{get(){const e=a.try();return e?e.libp2p:void 0}});const T=()=>Promise.reject(j(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED"));this.commands=T,this.diag={cmds:T,net:T,sys:T},this.log={level:T,ls:T,tail:async function*(){throw j(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}},this.mount=T,this.codecs=r}async init(){throw new zr}}r(52596);const VA=async function(e={}){const t=(e=zA({start:!0,EXPERIMENTAL:{},preload:{enabled:!U.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}},e)).init||{},r={name:Lr.identity.name,code:Lr.identity.code,encode:e=>e,decode:e=>e},a=Object.values(xr.QB);[n,s,i,o,r].concat(e.ipld&&e.ipld.codecs||[]).forEach((e=>a.push(e)));const c=new u_({codecs:a,loadCodec:e.ipld&&e.ipld.loadCodec}),l=e.silent?jA:UA.log;jA("creating repo");const h=await PT.start(l,c,e);jA("getting repo config");const d=await h.repo.config.getAll(),u=new FA({storage:h,print:l,codecs:c,options:{...e,config:d}});if(jA("starting preload"),await u.preload.start(),jA("starting storage"),u.ipns.startOffline(h),h.isNew&&!t.emptyRepo){const e=await(async e=>{const t=Ie({Data:new ee({type:"directory"}).marshal(),Links:[]}),r=await e.block.put(t,{mhtype:"sha2-256",format:"dag-pb"});return await e.pin.add(r),r})(u);if(jA("adding default assets"),await void u.addAll,jA("initializing IPNS keyspace"),null==h.peerId.publicKey)throw j(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const t=new Gr.TimeoutController(3e4);try{await u.ipns.initializeKeyspace(h.peerId,(0,Hr.m)(`/ipfs/${e}`),{signal:t.signal})}finally{t.clear()}}return!1!==e.start&&(jA("starting node"),await u.start()),u}}}]);
//# sourceMappingURL=vendors-node_modules_core-js_modules_es_regexp_to-string_js-node_modules_ipfs-core_src_index_js.048953d5.js.map